<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session d01c3a84-74a2-421a-a234-191f18f16096 (2026-01-21 07:37Z) -->

# High-end electric skateboard cost structure CSV (2026-01-21 07:37Z)

_**User**_

為何語言選擇繁體中文，但訊息呈現的都還是英文訊息？如何改善？
所有訊息都依據選擇的語言作為回應並呈現的語言

---

_**Agent (model default, mode Agent)**_


檢查相關程式碼，找出訊息語言未依選擇語言顯示的原因。


---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: d:\_Code\_GitHub\eigent-260119\backend\app\utils\toolkit\slack_toolkit.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: d:\_Code\_GitHub\eigent-260119\backend\app\utils\agent.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: d:\_Code\_GitHub\eigent-260119\electron\main\index.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="semantic_search_full">
<details>
<summary>Tool use: **semantic_search_full**</summary>


Parameters:

```json
{
  "query": "How is language preference stored and used for generating messages and responses?",
  "topK": 10,
  "explanation": ""
}
```
Result:

```json
{
  "codeResults": [
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\model\\chat.py",
        "range": {
          "startPosition": {
            "line": 31,
            "column": 5
          },
          "endPosition": {
            "line": 102
          }
        },
        "contents": "McpServers = dict[Literal[\"mcpServers\"], dict[str, dict]]\n\nPLATFORM_MAPPING = {\n    \"Z.ai\": \"openai-compatible-model\",\n}\n\nclass Chat(BaseModel):\n    task_id: str\n    project_id: str\n    question: str\n    email: str\n    attaches: list[str] = []\n    model_platform: str\n    model_type: str\n    api_key: str\n    api_url: str | None = None  # for cloud version, user don't need to set api_url\n    language: str = \"en\"\n    browser_port: int = 9222\n    max_retries: int = 3\n    allow_local_system: bool = False\n    installed_mcp: McpServers = {\"mcpServers\": {}}\n    bun_mirror: str = \"\"\n    uvx_mirror: str = \"\"\n    env_path: str | None = None\n    summary_prompt: str = (\n        \"After completing the task, please generate a summary of the entire task completion. \"\n        \"The summary must be enclosed in &lt;summary&gt;&lt;/summary&gt; tags and include:\\n\"\n        \"1. A confirmation of task completion, referencing the original goal.\\n\"\n        \"2. A high-level overview of the work performed and the final outcome.\\n\"\n        \"3. A bulleted list of key results or accomplishments.\\n\"\n        \"Adopt a confident and professional tone.\"\n    )\n    new_agents: list[\"NewAgent\"] = []\n    extra_params: dict | None = None  # For provider-specific parameters like Azure\n    search_config: dict[str, str] | None = None  # User-specific search engine configurations (e.g., GOOGLE_API_KEY, SEARCH_ENGINE_ID)\n\n    @field_validator(\"model_platform\")\n    @classmethod\n    def map_model_platform(cls, v: str) -&gt; str:\n        return PLATFORM_MAPPING.get(v, v)\n\n    @field_validator(\"model_type\")\n    @classmethod\n    def check_model_type(cls, model_type: str):\n        try:\n            ModelType(model_type)\n        except ValueError:\n            # raise ValueError(\"Invalid model type\")\n            logger.debug(\"model_type is invalid\")\n        return model_type\n\n    def get_bun_env(self) -&gt; dict[str, str]:\n        return {\"NPM_CONFIG_REGISTRY\": self.bun_mirror} if self.bun_mirror else {}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "McpServers = dict[Literal[\"mcpServers\"], dict[str, dict]]",
            "lineNumber": 35
          },
          {
            "lineNumber": 36
          },
          {
            "text": "PLATFORM_MAPPING = {",
            "lineNumber": 37
          },
          {
            "text": "    \"Z.ai\": \"openai-compatible-model\",",
            "lineNumber": 38
          },
          {
            "text": "}",
            "lineNumber": 39
          },
          {
            "lineNumber": 40
          },
          {
            "text": "class Chat(BaseModel):",
            "lineNumber": 41,
            "isSignature": true
          },
          {
            "text": "    task_id: str",
            "lineNumber": 42
          },
          {
            "text": "    project_id: str",
            "lineNumber": 43
          },
          {
            "text": "    question: str",
            "lineNumber": 44
          },
          {
            "text": "    email: str",
            "lineNumber": 45
          },
          {
            "text": "    attaches: list[str] = []",
            "lineNumber": 46
          },
          {
            "text": "    model_platform: str",
            "lineNumber": 47
          },
          {
            "text": "    model_type: str",
            "lineNumber": 48
          },
          {
            "text": "    api_key: str",
            "lineNumber": 49
          },
          {
            "text": "    api_url: str | None = None  # for cloud version, user don't need to set api_url",
            "lineNumber": 50
          },
          {
            "text": "    language: str = \"en\"",
            "lineNumber": 51
          },
          {
            "text": "    browser_port: int = 9222",
            "lineNumber": 52
          },
          {
            "text": "    max_retries: int = 3",
            "lineNumber": 53
          },
          {
            "text": "    allow_local_system: bool = False",
            "lineNumber": 54
          },
          {
            "text": "    installed_mcp: McpServers = {\"mcpServers\": {}}",
            "lineNumber": 55
          },
          {
            "text": "    bun_mirror: str = \"\"",
            "lineNumber": 56
          },
          {
            "text": "    uvx_mirror: str = \"\"",
            "lineNumber": 57
          },
          {
            "text": "    env_path: str | None = None",
            "lineNumber": 58
          },
          {
            "text": "    summary_prompt: str = (",
            "lineNumber": 59
          },
          {
            "text": "        \"After completing the task, please generate a summary of the entire task completion. \"",
            "lineNumber": 60
          },
          {
            "text": "        \"The summary must be enclosed in &lt;summary&gt;&lt;/summary&gt; tags and include:\\n\"",
            "lineNumber": 61
          },
          {
            "text": "        \"1. A confirmation of task completion, referencing the original goal.\\n\"",
            "lineNumber": 62
          },
          {
            "text": "        \"2. A high-level overview of the work performed and the final outcome.\\n\"",
            "lineNumber": 63
          },
          {
            "text": "        \"3. A bulleted list of key results or accomplishments.\\n\"",
            "lineNumber": 64
          },
          {
            "text": "        \"Adopt a confident and professional tone.\"",
            "lineNumber": 65
          },
          {
            "text": "    )",
            "lineNumber": 66
          },
          {
            "text": "    new_agents: list[\"NewAgent\"] = []",
            "lineNumber": 67
          },
          {
            "text": "    extra_params: dict | None = None  # For provider-specific parameters like Azure",
            "lineNumber": 68
          },
          {
            "text": "    search_config: dict[str, str] | None = None  # User-specific search engine configurations (e.g., GOOGLE_API_KEY, SEARCH_ENGINE_ID)",
            "lineNumber": 69
          },
          {
            "lineNumber": 70
          },
          {
            "text": "    @field_validator(\"model_platform\")",
            "lineNumber": 71
          },
          {
            "text": "    @classmethod",
            "lineNumber": 72
          },
          {
            "text": "    def map_model_platform(cls, v: str) -&gt; str:",
            "lineNumber": 73
          },
          {
            "text": "        return PLATFORM_MAPPING.get(v, v)",
            "lineNumber": 74
          },
          {
            "lineNumber": 75
          },
          {
            "text": "    @field_validator(\"model_type\")",
            "lineNumber": 76
          },
          {
            "text": "    @classmethod",
            "lineNumber": 77
          },
          {
            "text": "    def check_model_type(cls, model_type: str):",
            "lineNumber": 78
          },
          {
            "text": "        try:",
            "lineNumber": 79
          },
          {
            "text": "            ModelType(model_type)",
            "lineNumber": 80
          },
          {
            "text": "        except ValueError:",
            "lineNumber": 81
          },
          {
            "text": "            # raise ValueError(\"Invalid model type\")",
            "lineNumber": 82
          },
          {
            "text": "            logger.debug(\"model_type is invalid\")",
            "lineNumber": 83
          },
          {
            "text": "        return model_type",
            "lineNumber": 84
          },
          {
            "lineNumber": 85
          },
          {
            "text": "    def get_bun_env(self) -&gt; dict[str, str]:",
            "lineNumber": 86
          },
          {
            "text": "        return {\"NPM_CONFIG_REGISTRY\": self.bun_mirror} if self.bun_mirror else {}",
            "lineNumber": 87
          }
        ]
      },
      "score": 0.3235692083835602
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\controller\\chat_controller.py",
        "range": {
          "startPosition": {
            "line": 70,
            "column": 13
          },
          "endPosition": {
            "line": 126
          }
        },
        "contents": "@router.post(\"/chat\", name=\"start chat\")\n@traceroot.trace()\nasync def post(data: Chat, request: Request):\n    chat_logger.info(\n        \"Starting new chat session\", extra={\"project_id\": data.project_id, \"task_id\": data.task_id, \"user\": data.email}\n    )\n    task_lock = get_or_create_task_lock(data.project_id)\n\n    # Set user-specific environment path for this thread\n    set_user_env_path(data.env_path)\n    load_dotenv(dotenv_path=data.env_path)\n\n    os.environ[\"file_save_path\"] = data.file_save_path()\n    os.environ[\"browser_port\"] = str(data.browser_port)\n    os.environ[\"OPENAI_API_KEY\"] = data.api_key\n    os.environ[\"OPENAI_API_BASE_URL\"] = data.api_url or \"https://api.openai.com/v1\"\n    os.environ[\"CAMEL_MODEL_LOG_ENABLED\"] = \"true\"\n\n    # Set user-specific search engine configuration if provided\n    if data.search_config:\n        for key, value in data.search_config.items():\n            if value:  # Only set non-empty values\n                os.environ[key] = value\n                chat_logger.info(f\"Set search config: {key}\", extra={\"project_id\": data.project_id})\n\n    email_sanitized = re.sub(r'[\\\\/*?:\"&lt;&gt;|\\s]', \"_\", data.email.split(\"@\")[0]).strip(\".\")\n    camel_log = (\n        Path.home()\n        / \".eigent\"\n        / email_sanitized\n        / (\"project_\" + data.project_id)\n        / (\"task_\" + data.task_id)\n        / \"camel_logs\"\n    )\n    camel_log.mkdir(parents=True, exist_ok=True)\n\n    os.environ[\"CAMEL_LOG_DIR\"] = str(camel_log)\n\n    if data.is_cloud():\n        os.environ[\"cloud_api_key\"] = data.api_key\n\n    # Set the initial current_task_id in task_lock\n    set_current_task_id(data.project_id, data.task_id)\n\n    # Put initial action in queue to start processing\n    await task_lock.put_queue(ActionImproveData(data=data.question, new_task_id=data.task_id))\n\n    chat_logger.info",
        "signatures": {},
        "detailedLines": [
          {
            "text": "@router.post(\"/chat\", name=\"start chat\")",
            "lineNumber": 74
          },
          {
            "text": "@traceroot.trace()",
            "lineNumber": 75
          },
          {
            "text": "async def post(data: Chat, request: Request):",
            "lineNumber": 76,
            "isSignature": true
          },
          {
            "text": "    chat_logger.info(",
            "lineNumber": 77
          },
          {
            "text": "        \"Starting new chat session\", extra={\"project_id\": data.project_id, \"task_id\": data.task_id, \"user\": data.email}",
            "lineNumber": 78
          },
          {
            "text": "    )",
            "lineNumber": 79
          },
          {
            "text": "    task_lock = get_or_create_task_lock(data.project_id)",
            "lineNumber": 80
          },
          {
            "lineNumber": 81
          },
          {
            "text": "    # Set user-specific environment path for this thread",
            "lineNumber": 82
          },
          {
            "text": "    set_user_env_path(data.env_path)",
            "lineNumber": 83
          },
          {
            "text": "    load_dotenv(dotenv_path=data.env_path)",
            "lineNumber": 84
          },
          {
            "lineNumber": 85
          },
          {
            "text": "    os.environ[\"file_save_path\"] = data.file_save_path()",
            "lineNumber": 86
          },
          {
            "text": "    os.environ[\"browser_port\"] = str(data.browser_port)",
            "lineNumber": 87
          },
          {
            "text": "    os.environ[\"OPENAI_API_KEY\"] = data.api_key",
            "lineNumber": 88
          },
          {
            "text": "    os.environ[\"OPENAI_API_BASE_URL\"] = data.api_url or \"https://api.openai.com/v1\"",
            "lineNumber": 89
          },
          {
            "text": "    os.environ[\"CAMEL_MODEL_LOG_ENABLED\"] = \"true\"",
            "lineNumber": 90
          },
          {
            "lineNumber": 91
          },
          {
            "text": "    # Set user-specific search engine configuration if provided",
            "lineNumber": 92
          },
          {
            "text": "    if data.search_config:",
            "lineNumber": 93
          },
          {
            "text": "        for key, value in data.search_config.items():",
            "lineNumber": 94
          },
          {
            "text": "            if value:  # Only set non-empty values",
            "lineNumber": 95
          },
          {
            "text": "                os.environ[key] = value",
            "lineNumber": 96
          },
          {
            "text": "                chat_logger.info(f\"Set search config: {key}\", extra={\"project_id\": data.project_id})",
            "lineNumber": 97
          },
          {
            "lineNumber": 98
          },
          {
            "text": "    email_sanitized = re.sub(r'[\\\\/*?:\"&lt;&gt;|\\s]', \"_\", data.email.split(\"@\")[0]).strip(\".\")",
            "lineNumber": 99
          },
          {
            "text": "    camel_log = (",
            "lineNumber": 100
          },
          {
            "text": "        Path.home()",
            "lineNumber": 101
          },
          {
            "text": "        / \".eigent\"",
            "lineNumber": 102
          },
          {
            "text": "        / email_sanitized",
            "lineNumber": 103
          },
          {
            "text": "        / (\"project_\" + data.project_id)",
            "lineNumber": 104
          },
          {
            "text": "        / (\"task_\" + data.task_id)",
            "lineNumber": 105
          },
          {
            "text": "        / \"camel_logs\"",
            "lineNumber": 106
          },
          {
            "text": "    )",
            "lineNumber": 107
          },
          {
            "text": "    camel_log.mkdir(parents=True, exist_ok=True)",
            "lineNumber": 108
          },
          {
            "lineNumber": 109
          },
          {
            "text": "    os.environ[\"CAMEL_LOG_DIR\"] = str(camel_log)",
            "lineNumber": 110
          },
          {
            "lineNumber": 111
          },
          {
            "text": "    if data.is_cloud():",
            "lineNumber": 112
          },
          {
            "text": "        os.environ[\"cloud_api_key\"] = data.api_key",
            "lineNumber": 113
          },
          {
            "lineNumber": 114
          },
          {
            "text": "    # Set the initial current_task_id in task_lock",
            "lineNumber": 115
          },
          {
            "text": "    set_current_task_id(data.project_id, data.task_id)",
            "lineNumber": 116
          },
          {
            "lineNumber": 117
          },
          {
            "text": "    # Put initial action in queue to start processing",
            "lineNumber": 118
          },
          {
            "text": "    await task_lock.put_queue(ActionImproveData(data=data.question, new_task_id=data.task_id))",
            "lineNumber": 119
          },
          {
            "lineNumber": 120
          },
          {
            "text": "    chat_logger.info",
            "lineNumber": 121
          }
        ]
      },
      "score": 0.30646753311157227
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\src\\store\\authStore.ts",
        "range": {
          "startPosition": {
            "line": 63,
            "column": 2
          },
          "endPosition": {
            "line": 174,
            "column": 1
          }
        },
        "contents": "// create store\nconst authStore = create&lt;AuthState&gt;()(\n\tpersist(\n\t\t(set, get) =&gt; ({\n\t\t\t// initial state\n\t\t\ttoken: null,\n\t\t\tusername: null,\n\t\t\temail: null,\n\t\t\tuser_id: null,\n\t\t\tappearance: 'light',\n\t\t\tlanguage: 'system',\n\t\t\tisFirstLaunch: true,\n\t\t\tmodelType: 'cloud',\n\t\t\tcloud_model_type: getRandomDefaultModel(),\n\t\t\tinitState: 'permissions',\n\t\t\tshare_token: null,\n\t\t\tlocalProxyValue: null,\n\t\t\tworkerListData: {},\n\n\t\t\t// auth related methods\n\t\t\tsetAuth: ({ token, username, email, user_id }) =&gt;\n\t\t\t\tset({ token, username, email, user_id }),\n\n\t\t\tlogout: () =&gt;\n\t\t\t\tset({\n\t\t\t\t\ttoken: null,\n\t\t\t\t\tusername: null,\n\t\t\t\t\temail: null,\n\t\t\t\t\tuser_id: null,\n\t\t\t\t\tinitState: 'carousel',\n\t\t\t\t\tlocalProxyValue: null\n\t\t\t\t}),\n\n\t\t\t// set related methods\n\t\t\tsetAppearance: (appearance) =&gt; set({ appearance }),\n\n\t\t\tsetLanguage: (language) =&gt; set({ language }),\n\n\t\t\tsetInitState: (initState) =&gt; {\n\t\t\t\tconsole.log('set({ initState })', initState);\n\t\t\t\tset({ initState });\n\t\t\t},\n\n\t\t\tsetModelType: (modelType) =&gt; set({ modelType }),\n\n\t\t\tsetCloudModelType: (cloud_model_type) =&gt; set({ cloud_model_type }),\n\n\t\t\tsetIsFirstLaunch: (isFirstLaunch) =&gt; set({ isFirstLaunch }),\n\n\t\t\tsetLocalProxyValue: (value) =&gt; set({ localProxyValue: value }),\n\n\t\t\t// worker related methods\n\t\t\tsetWorkerList: (workerList) =&gt; {\n\t\t\t\tconst { email } = get();\n\t\t\t\tset((state) =&gt; ({\n\t\t\t\t\t...state,\n\t\t\t\t\tworkerListData: {\n\t\t\t\t\t\t...state.workerListData,\n\t\t\t\t\t\t[email as string]: workerList\n\t\t\t\t\t}\n\t\t\t\t}));\n\t\t\t},\n\n\t\t\tcheckAgentTool: (tool) =&gt; {\n\t\t\t\tconst { email } = get();\n\t\t\t}\n)\n\n;",
        "signatures": {},
        "detailedLines": [
          {
            "text": "// create store",
            "lineNumber": 66
          },
          {
            "text": "const authStore = create&lt;AuthState&gt;()(",
            "lineNumber": 67
          },
          {
            "text": "\tpersist(",
            "lineNumber": 68
          },
          {
            "text": "\t\t(set, get) =&gt; ({",
            "lineNumber": 69
          },
          {
            "text": "\t\t\t// initial state",
            "lineNumber": 70
          },
          {
            "text": "\t\t\ttoken: null,",
            "lineNumber": 71
          },
          {
            "text": "\t\t\tusername: null,",
            "lineNumber": 72
          },
          {
            "text": "\t\t\temail: null,",
            "lineNumber": 73
          },
          {
            "text": "\t\t\tuser_id: null,",
            "lineNumber": 74
          },
          {
            "text": "\t\t\tappearance: 'light',",
            "lineNumber": 75
          },
          {
            "text": "\t\t\tlanguage: 'system',",
            "lineNumber": 76
          },
          {
            "text": "\t\t\tisFirstLaunch: true,",
            "lineNumber": 77
          },
          {
            "text": "\t\t\tmodelType: 'cloud',",
            "lineNumber": 78
          },
          {
            "text": "\t\t\tcloud_model_type: getRandomDefaultModel(),",
            "lineNumber": 79
          },
          {
            "text": "\t\t\tinitState: 'permissions',",
            "lineNumber": 80
          },
          {
            "text": "\t\t\tshare_token: null,",
            "lineNumber": 81
          },
          {
            "text": "\t\t\tlocalProxyValue: null,",
            "lineNumber": 82
          },
          {
            "text": "\t\t\tworkerListData: {},",
            "lineNumber": 83
          },
          {
            "lineNumber": 84
          },
          {
            "text": "\t\t\t// auth related methods",
            "lineNumber": 85
          },
          {
            "text": "\t\t\tsetAuth: ({ token, username, email, user_id }) =&gt;",
            "lineNumber": 86
          },
          {
            "text": "\t\t\t\tset({ token, username, email, user_id }),",
            "lineNumber": 87
          },
          {
            "lineNumber": 88
          },
          {
            "text": "\t\t\tlogout: () =&gt;",
            "lineNumber": 89
          },
          {
            "text": "\t\t\t\tset({",
            "lineNumber": 90
          },
          {
            "text": "\t\t\t\t\ttoken: null,",
            "lineNumber": 91
          },
          {
            "text": "\t\t\t\t\tusername: null,",
            "lineNumber": 92
          },
          {
            "text": "\t\t\t\t\temail: null,",
            "lineNumber": 93
          },
          {
            "text": "\t\t\t\t\tuser_id: null,",
            "lineNumber": 94
          },
          {
            "text": "\t\t\t\t\tinitState: 'carousel',",
            "lineNumber": 95
          },
          {
            "text": "\t\t\t\t\tlocalProxyValue: null",
            "lineNumber": 96
          },
          {
            "text": "\t\t\t\t}),",
            "lineNumber": 97
          },
          {
            "lineNumber": 98
          },
          {
            "text": "\t\t\t// set related methods",
            "lineNumber": 99
          },
          {
            "text": "\t\t\tsetAppearance: (appearance) =&gt; set({ appearance }),",
            "lineNumber": 100
          },
          {
            "lineNumber": 101
          },
          {
            "text": "\t\t\tsetLanguage: (language) =&gt; set({ language }),",
            "lineNumber": 102
          },
          {
            "lineNumber": 103
          },
          {
            "text": "\t\t\tsetInitState: (initState) =&gt; {",
            "lineNumber": 104
          },
          {
            "text": "\t\t\t\tconsole.log('set({ initState })', initState);",
            "lineNumber": 105
          },
          {
            "text": "\t\t\t\tset({ initState });",
            "lineNumber": 106
          },
          {
            "text": "\t\t\t},",
            "lineNumber": 107
          },
          {
            "lineNumber": 108
          },
          {
            "text": "\t\t\tsetModelType: (modelType) =&gt; set({ modelType }),",
            "lineNumber": 109
          },
          {
            "lineNumber": 110
          },
          {
            "text": "\t\t\tsetCloudModelType: (cloud_model_type) =&gt; set({ cloud_model_type }),",
            "lineNumber": 111
          },
          {
            "lineNumber": 112
          },
          {
            "text": "\t\t\tsetIsFirstLaunch: (isFirstLaunch) =&gt; set({ isFirstLaunch }),",
            "lineNumber": 113
          },
          {
            "lineNumber": 114
          },
          {
            "text": "\t\t\tsetLocalProxyValue: (value) =&gt; set({ localProxyValue: value }),",
            "lineNumber": 115
          },
          {
            "lineNumber": 116
          },
          {
            "text": "\t\t\t// worker related methods",
            "lineNumber": 117
          },
          {
            "text": "\t\t\tsetWorkerList: (workerList) =&gt; {",
            "lineNumber": 118
          },
          {
            "text": "\t\t\t\tconst { email } = get();",
            "lineNumber": 119
          },
          {
            "text": "\t\t\t\tset((state) =&gt; ({",
            "lineNumber": 120
          },
          {
            "text": "\t\t\t\t\t...state,",
            "lineNumber": 121
          },
          {
            "text": "\t\t\t\t\tworkerListData: {",
            "lineNumber": 122
          },
          {
            "text": "\t\t\t\t\t\t...state.workerListData,",
            "lineNumber": 123
          },
          {
            "text": "\t\t\t\t\t\t[email as string]: workerList",
            "lineNumber": 124
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 125
          },
          {
            "text": "\t\t\t\t}));",
            "lineNumber": 126
          },
          {
            "text": "\t\t\t},",
            "lineNumber": 127
          },
          {
            "lineNumber": 128
          },
          {
            "text": "\t\t\tcheckAgentTool: (tool) =&gt; {",
            "lineNumber": 129
          },
          {
            "text": "\t\t\t\tconst { email } = get();",
            "lineNumber": 130
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 155
          },
          {
            "text": ")",
            "lineNumber": 156
          },
          {
            "lineNumber": 174
          },
          {
            "text": ";",
            "lineNumber": 175
          }
        ]
      },
      "score": 0.30274176597595215
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\src\\store\\chatStore.ts",
        "range": {
          "startPosition": {
            "line": 162
          },
          "endPosition": {
            "line": 2594,
            "column": 1
          }
        },
        "contents": "const chatStore = \n(set, get) =&gt; (\nasync (taskId: string, type?: string, shareToken?: string, delayTime?: number, messageContent?: string, messageAttaches?: File[]) =&gt; {\n\n\t\t\tif (modelType === 'custom' || modelType === 'local') {\n\t\t\t\tconst res = await proxyFetchGet('/api/providers', {\n\t\t\t\t\tprefer: true\n\t\t\t\t});\n\t\t\t\tconst providerList = res.items || []\n\t\t\t\tconsole.log('providerList', providerList)\n\t\t\t\tconst provider = providerList[0]\n\n\t\t\t\tif (!provider) {\n\t\t\t\t\tthrow new Error('No model provider configured. Please go to Settings &gt; Models and configure at least one model provider as default.');\n\t\t\t\t}\n\n\t\t\t\tapiModel = {\n\t\t\t\t\tapi_key: provider.api_key,\n\t\t\t\t\tmodel_type: provider.model_type,\n\t\t\t\t\tmodel_platform: provider.provider_name,\n\t\t\t\t\tapi_url: provider.endpoint_url || provider.api_url,\n\t\t\t\t\textra_params: provider.encrypted_config\n\t\t\t\t}\n\t\t\t} else if (modelType === 'cloud') {\n\t\t\t\t// get current model\n\t\t\t\tconst res = await proxyFetchGet('/api/user/key');\n\t\t\t\tif (res.warning_code &amp;&amp; res.warning_code === '21') {\n\t\t\t\t\tshowStorageToast()\n\t\t\t\t}\n\t\t\t\tapiModel = {\n\t\t\t\t\tapi_key: res.value,\n\t\t\t\t\tmodel_type: cloud_model_type,\n\t\t\t\t\tmodel_platform: cloud_model_type.includes('gpt') ? 'openai' :\n\t\t\t\t\t\tcloud_model_type.includes('claude') ? 'anthropic' :\n\t\t\t\t\t\t\tcloud_model_type.includes('gemini') ? 'gemini' : 'openai-compatible-model',\n\t\t\t\t\tapi_url: res.api_url,\n\t\t\t\t\textra_params: {}\n\t\t\t\t}\n\t\t\t}\n\n\n\n\n\n\t\t\tlet mcpLocal = {}\n\t\t\tif (window.ipcRenderer) {\n\t\t\t\tmcpLocal = await window.ipcRenderer.invoke(\"mcp-list\");\n\t\t\t}\n\t\t\tconsole.log('mcpLocal', mcpLocal)\n\n\t\t\t// Get search engine configuration for custom mode\n\t\t\tlet searchConfig: Record&lt;string, string&gt; = {}\n\t\t\tif (modelType === 'custom') {\n\t\t\t\ttry\n\t\t}\n)\n;",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 163,
                "column": 1
              },
              "endPosition": {
                "line": 163,
                "column": 7
              }
            },
            {
              "startPosition": {
                "line": 163,
                "column": 7
              },
              "endPosition": {
                "line": 163,
                "column": 19
              }
            },
            {
              "startPosition": {
                "line": 163,
                "column": 53
              },
              "endPosition": {
                "line": 163,
                "column": 53
              }
            },
            {
              "startPosition": {
                "line": 164,
                "column": 2
              },
              "endPosition": {
                "line": 164,
                "column": 17
              }
            },
            {
              "startPosition": {
                "line": 331,
                "column": 14
              },
              "endPosition": {
                "line": 332,
                "column": 4
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "const chatStore = ",
            "lineNumber": 163
          },
          {
            "text": "(set, get) =&gt; (",
            "lineNumber": 164
          },
          {
            "text": "async (taskId: string, type?: string, shareToken?: string, delayTime?: number, messageContent?: string, messageAttaches?: File[]) =&gt; {",
            "lineNumber": 331
          },
          {
            "lineNumber": 425
          },
          {
            "text": "\t\t\tif (modelType === 'custom' || modelType === 'local') {",
            "lineNumber": 426
          },
          {
            "text": "\t\t\t\tconst res = await proxyFetchGet('/api/providers', {",
            "lineNumber": 427
          },
          {
            "text": "\t\t\t\t\tprefer: true",
            "lineNumber": 428
          },
          {
            "text": "\t\t\t\t});",
            "lineNumber": 429
          },
          {
            "text": "\t\t\t\tconst providerList = res.items || []",
            "lineNumber": 430
          },
          {
            "text": "\t\t\t\tconsole.log('providerList', providerList)",
            "lineNumber": 431
          },
          {
            "text": "\t\t\t\tconst provider = providerList[0]",
            "lineNumber": 432
          },
          {
            "lineNumber": 433
          },
          {
            "text": "\t\t\t\tif (!provider) {",
            "lineNumber": 434
          },
          {
            "text": "\t\t\t\t\tthrow new Error('No model provider configured. Please go to Settings &gt; Models and configure at least one model provider as default.');",
            "lineNumber": 435
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 436
          },
          {
            "lineNumber": 437
          },
          {
            "text": "\t\t\t\tapiModel = {",
            "lineNumber": 438
          },
          {
            "text": "\t\t\t\t\tapi_key: provider.api_key,",
            "lineNumber": 439
          },
          {
            "text": "\t\t\t\t\tmodel_type: provider.model_type,",
            "lineNumber": 440
          },
          {
            "text": "\t\t\t\t\tmodel_platform: provider.provider_name,",
            "lineNumber": 441
          },
          {
            "text": "\t\t\t\t\tapi_url: provider.endpoint_url || provider.api_url,",
            "lineNumber": 442
          },
          {
            "text": "\t\t\t\t\textra_params: provider.encrypted_config",
            "lineNumber": 443
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 444
          },
          {
            "text": "\t\t\t} else if (modelType === 'cloud') {",
            "lineNumber": 445
          },
          {
            "text": "\t\t\t\t// get current model",
            "lineNumber": 446
          },
          {
            "text": "\t\t\t\tconst res = await proxyFetchGet('/api/user/key');",
            "lineNumber": 447
          },
          {
            "text": "\t\t\t\tif (res.warning_code &amp;&amp; res.warning_code === '21') {",
            "lineNumber": 448
          },
          {
            "text": "\t\t\t\t\tshowStorageToast()",
            "lineNumber": 449
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 450
          },
          {
            "text": "\t\t\t\tapiModel = {",
            "lineNumber": 451
          },
          {
            "text": "\t\t\t\t\tapi_key: res.value,",
            "lineNumber": 452
          },
          {
            "text": "\t\t\t\t\tmodel_type: cloud_model_type,",
            "lineNumber": 453
          },
          {
            "text": "\t\t\t\t\tmodel_platform: cloud_model_type.includes('gpt') ? 'openai' :",
            "lineNumber": 454
          },
          {
            "text": "\t\t\t\t\t\tcloud_model_type.includes('claude') ? 'anthropic' :",
            "lineNumber": 455
          },
          {
            "text": "\t\t\t\t\t\t\tcloud_model_type.includes('gemini') ? 'gemini' : 'openai-compatible-model',",
            "lineNumber": 456
          },
          {
            "text": "\t\t\t\t\tapi_url: res.api_url,",
            "lineNumber": 457
          },
          {
            "text": "\t\t\t\t\textra_params: {}",
            "lineNumber": 458
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 459
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 460
          },
          {
            "lineNumber": 461
          },
          {
            "lineNumber": 462
          },
          {
            "lineNumber": 463
          },
          {
            "lineNumber": 464
          },
          {
            "lineNumber": 465
          },
          {
            "text": "\t\t\tlet mcpLocal = {}",
            "lineNumber": 466
          },
          {
            "text": "\t\t\tif (window.ipcRenderer) {",
            "lineNumber": 467
          },
          {
            "text": "\t\t\t\tmcpLocal = await window.ipcRenderer.invoke(\"mcp-list\");",
            "lineNumber": 468
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 469
          },
          {
            "text": "\t\t\tconsole.log('mcpLocal', mcpLocal)",
            "lineNumber": 470
          },
          {
            "lineNumber": 471
          },
          {
            "text": "\t\t\t// Get search engine configuration for custom mode",
            "lineNumber": 472
          },
          {
            "text": "\t\t\tlet searchConfig: Record&lt;string, string&gt; = {}",
            "lineNumber": 473
          },
          {
            "text": "\t\t\tif (modelType === 'custom') {",
            "lineNumber": 474
          },
          {
            "text": "\t\t\t\ttry",
            "lineNumber": 475
          },
          {
            "text": "\t\t}",
            "lineNumber": 1888
          },
          {
            "text": ")",
            "lineNumber": 2594
          },
          {
            "text": ";",
            "lineNumber": 2595
          }
        ]
      },
      "score": 0.29570043087005615
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\src\\i18n\\index.ts",
        "range": {
          "startPosition": {
            "line": 17,
            "column": 1
          },
          "endPosition": {
            "line": 48,
            "column": 1
          }
        },
        "contents": "const { language } = getAuthStore();\n\nconst savedLanguage = language?.toLowerCase();\nconst systemLanguage = navigator.language.toLowerCase();\nconst availableLanguages = Object.values(LocaleEnum);\n\nlet initialLanguage: string;\n\nif (savedLanguage &amp;&amp; availableLanguages.includes(savedLanguage as LocaleEnum)) {\n  initialLanguage = savedLanguage;\n} else {\n  const matched = availableLanguages.find(lang =&gt; systemLanguage.startsWith(lang));\n  initialLanguage = matched || LocaleEnum.English;\n}\n\n\ni18n.use(initReactI18next).init({\n  resources,\n  fallbackLng: LocaleEnum.English,\n  lng: initialLanguage,\n  interpolation: {\n    escapeValue: false,\n  },\n});\n\nexport const switchLanguage = (lang: LocaleEnum) =&gt;\n;",
        "signatures": {},
        "detailedLines": [
          {
            "text": "const { language } = getAuthStore();",
            "lineNumber": 20
          },
          {
            "lineNumber": 21
          },
          {
            "text": "const savedLanguage = language?.toLowerCase();",
            "lineNumber": 22
          },
          {
            "text": "const systemLanguage = navigator.language.toLowerCase();",
            "lineNumber": 23
          },
          {
            "text": "const availableLanguages = Object.values(LocaleEnum);",
            "lineNumber": 24
          },
          {
            "lineNumber": 25
          },
          {
            "text": "let initialLanguage: string;",
            "lineNumber": 26
          },
          {
            "lineNumber": 27
          },
          {
            "text": "if (savedLanguage &amp;&amp; availableLanguages.includes(savedLanguage as LocaleEnum)) {",
            "lineNumber": 28
          },
          {
            "text": "  initialLanguage = savedLanguage;",
            "lineNumber": 29
          },
          {
            "text": "} else {",
            "lineNumber": 30
          },
          {
            "text": "  const matched = availableLanguages.find(lang =&gt; systemLanguage.startsWith(lang));",
            "lineNumber": 31
          },
          {
            "text": "  initialLanguage = matched || LocaleEnum.English;",
            "lineNumber": 32
          },
          {
            "text": "}",
            "lineNumber": 33
          },
          {
            "lineNumber": 34
          },
          {
            "lineNumber": 35
          },
          {
            "text": "i18n.use(initReactI18next).init({",
            "lineNumber": 36
          },
          {
            "text": "  resources,",
            "lineNumber": 37
          },
          {
            "text": "  fallbackLng: LocaleEnum.English,",
            "lineNumber": 38
          },
          {
            "text": "  lng: initialLanguage,",
            "lineNumber": 39
          },
          {
            "text": "  interpolation: {",
            "lineNumber": 40
          },
          {
            "text": "    escapeValue: false,",
            "lineNumber": 41
          },
          {
            "text": "  },",
            "lineNumber": 42
          },
          {
            "text": "});",
            "lineNumber": 43
          },
          {
            "lineNumber": 44
          },
          {
            "text": "export const switchLanguage = (lang: LocaleEnum) =&gt;",
            "lineNumber": 45
          },
          {
            "text": ";",
            "lineNumber": 49
          }
        ]
      },
      "score": 0.2934999465942383
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\src\\store\\chatStore.ts",
        "range": {
          "startPosition": {
            "line": 162
          },
          "endPosition": {
            "line": 2594,
            "column": 1
          }
        },
        "contents": "const chatStore = \n(set, get) =&gt; (\n,\n\t\tstartTask: async (taskId: string, type?: string, shareToken?: string, delayTime?: number, messageContent?: string, messageAttaches?: File[]) =&gt; {\n\t\t\t// ✅ Wait for backend to be ready before starting task (except for replay/share)\n\t\t\tif (!type || type === 'normal') {\n\t\t\t\tconsole.log('[startTask] Checking if backend is ready...');\n\t\t\t\tconst isBackendReady = await waitForBackendReady(15000, 500); // Wait up to 15 seconds\n\n\t\t\t\tif (!isBackendReady) {\n\t\t\t\t\tconsole.error('[startTask] Backend is not ready, cannot start task');\n\t\t\t\t\tconst { addMessages } = get();\n\t\t\t\t\taddMessages(taskId, {\n\t\t\t\t\t\tid: generateUniqueId(),\n\t\t\t\t\t\trole: 'agent',\n\t\t\t\t\t\tcontent: '❌ Backend service is not ready. Please wait a moment and try again, or restart the application if the problem persists.',\n\t\t\t\t\t});\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tconsole.log('[startTask] Backend is ready, proceeding with task...');\n\t\t\t}\n\n\t\t\tconst { token, language, modelType, cloud_model_type, email } = getAuthStore()\n\t\t\tconst workerList = useWorkerList();\n\t\t\tconst { getLastUserMessage, setDelayTime, setType } = get();\n\t\t\tconst baseURL = await getBaseURL();\n\t\t\tlet systemLanguage = language\n\t\t\tif (language === 'system') {\n\t\t\t\tsystemLanguage = await window.ipcRenderer.invoke('get-system-language');\n\t\t\t}\n\t\t\tif (type === 'replay') {\n\t\t\t\tsetDelayTime(taskId, delayTime as number)\n\t\t\t\tsetType(taskId, type)\n\t\t\t}\n\n\t\t\t//ProjectStore must exist as chatStore is already\n\t\t\tconst projectStore = useProjectStore.getState();\n\t\t\tconst project_id = projectStore.activeProjectId;\n\t\t\t//Create a new chatStore on Start\n\t\t\tlet newTaskId = taskId;\n\t\t\tlet targetChatStore = { getState: () =&gt; get() }; // Default to current store\n\t\t\t/**\n\t\t\t * Replay creates its own chatStore for each task with replayProject\n\t\t\t */\n\t\t}\n)\n;",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 163,
                "column": 1
              },
              "endPosition": {
                "line": 163,
                "column": 7
              }
            },
            {
              "startPosition": {
                "line": 163,
                "column": 7
              },
              "endPosition": {
                "line": 163,
                "column": 19
              }
            },
            {
              "startPosition": {
                "line": 163,
                "column": 53
              },
              "endPosition": {
                "line": 163,
                "column": 53
              }
            },
            {
              "startPosition": {
                "line": 164,
                "column": 2
              },
              "endPosition": {
                "line": 164,
                "column": 17
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "const chatStore = ",
            "lineNumber": 163
          },
          {
            "text": "(set, get) =&gt; (",
            "lineNumber": 164
          },
          {
            "text": ",",
            "lineNumber": 330
          },
          {
            "text": "\t\tstartTask: async (taskId: string, type?: string, shareToken?: string, delayTime?: number, messageContent?: string, messageAttaches?: File[]) =&gt; {",
            "lineNumber": 331
          },
          {
            "text": "\t\t\t// ✅ Wait for backend to be ready before starting task (except for replay/share)",
            "lineNumber": 332
          },
          {
            "text": "\t\t\tif (!type || type === 'normal') {",
            "lineNumber": 333
          },
          {
            "text": "\t\t\t\tconsole.log('[startTask] Checking if backend is ready...');",
            "lineNumber": 334
          },
          {
            "text": "\t\t\t\tconst isBackendReady = await waitForBackendReady(15000, 500); // Wait up to 15 seconds",
            "lineNumber": 335
          },
          {
            "lineNumber": 336
          },
          {
            "text": "\t\t\t\tif (!isBackendReady) {",
            "lineNumber": 337
          },
          {
            "text": "\t\t\t\t\tconsole.error('[startTask] Backend is not ready, cannot start task');",
            "lineNumber": 338
          },
          {
            "text": "\t\t\t\t\tconst { addMessages } = get();",
            "lineNumber": 339
          },
          {
            "text": "\t\t\t\t\taddMessages(taskId, {",
            "lineNumber": 340
          },
          {
            "text": "\t\t\t\t\t\tid: generateUniqueId(),",
            "lineNumber": 341
          },
          {
            "text": "\t\t\t\t\t\trole: 'agent',",
            "lineNumber": 342
          },
          {
            "text": "\t\t\t\t\t\tcontent: '❌ Backend service is not ready. Please wait a moment and try again, or restart the application if the problem persists.',",
            "lineNumber": 343
          },
          {
            "text": "\t\t\t\t\t});",
            "lineNumber": 344
          },
          {
            "text": "\t\t\t\t\treturn;",
            "lineNumber": 345
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 346
          },
          {
            "text": "\t\t\t\tconsole.log('[startTask] Backend is ready, proceeding with task...');",
            "lineNumber": 347
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 348
          },
          {
            "lineNumber": 349
          },
          {
            "text": "\t\t\tconst { token, language, modelType, cloud_model_type, email } = getAuthStore()",
            "lineNumber": 350
          },
          {
            "text": "\t\t\tconst workerList = useWorkerList();",
            "lineNumber": 351
          },
          {
            "text": "\t\t\tconst { getLastUserMessage, setDelayTime, setType } = get();",
            "lineNumber": 352
          },
          {
            "text": "\t\t\tconst baseURL = await getBaseURL();",
            "lineNumber": 353
          },
          {
            "text": "\t\t\tlet systemLanguage = language",
            "lineNumber": 354
          },
          {
            "text": "\t\t\tif (language === 'system') {",
            "lineNumber": 355
          },
          {
            "text": "\t\t\t\tsystemLanguage = await window.ipcRenderer.invoke('get-system-language');",
            "lineNumber": 356
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 357
          },
          {
            "text": "\t\t\tif (type === 'replay') {",
            "lineNumber": 358
          },
          {
            "text": "\t\t\t\tsetDelayTime(taskId, delayTime as number)",
            "lineNumber": 359
          },
          {
            "text": "\t\t\t\tsetType(taskId, type)",
            "lineNumber": 360
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 361
          },
          {
            "lineNumber": 362
          },
          {
            "text": "\t\t\t//ProjectStore must exist as chatStore is already",
            "lineNumber": 363
          },
          {
            "text": "\t\t\tconst projectStore = useProjectStore.getState();",
            "lineNumber": 364
          },
          {
            "text": "\t\t\tconst project_id = projectStore.activeProjectId;",
            "lineNumber": 365
          },
          {
            "text": "\t\t\t//Create a new chatStore on Start",
            "lineNumber": 366
          },
          {
            "text": "\t\t\tlet newTaskId = taskId;",
            "lineNumber": 367
          },
          {
            "text": "\t\t\tlet targetChatStore = { getState: () =&gt; get() }; // Default to current store",
            "lineNumber": 368
          },
          {
            "text": "\t\t\t/**",
            "lineNumber": 369
          },
          {
            "text": "\t\t\t * Replay creates its own chatStore for each task with replayProject",
            "lineNumber": 370
          },
          {
            "text": "\t\t\t */",
            "lineNumber": 371
          },
          {
            "text": "\t\t}",
            "lineNumber": 1888
          },
          {
            "text": ")",
            "lineNumber": 2594
          },
          {
            "text": ";",
            "lineNumber": 2595
          }
        ]
      },
      "score": 0.2916325330734253
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\component\\pydantic\\i18n.py",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 56,
            "column": 64
          }
        },
        "contents": "from pathlib import Path\nfrom app.component.babel import babel_configs, babel\nimport re, os\nfrom fastapi_babel.middleware import Babel, LANGUAGES_PATTERN\nfrom pydantic_i18n import JsonLoader, PydanticI18n\n\n\ndef get_language(lang_code: str | None = None):\n    \"\"\"Ported from fastapi_babel.middleware.BabelMiddleware.get_language\n    Applies an available language.\n\n    To apply an available language it will be searched in the language folder for an available one\n    and will also priotize the one with the highest quality value. The Fallback language will be the\n    taken from the BABEL_DEFAULT_LOCALE var.\n\n        Args:\n            babel (Babel): Request scoped Babel instance\n            lang_code (str): The Value of the Accept-Language Header.\n\n        Returns:\n            str: The language that should be used.\n    \"\"\"\n\n    if not lang_code:\n        return babel.config.BABEL_DEFAULT_LOCALE\n\n    matches = re.finditer(LANGUAGES_PATTERN, lang_code)\n    languages = [\n        (f\"{m.group(1)}{f'_{m.group(2)}' if m.group(2) else ''}\", m.group(3) or \"\")\n        for m in matches\n    ]\n    languages = sorted(\n        languages, key=lambda x: x[1], reverse=True\n    )  # sort the priority, no priority comes last\n    translation_directory = Path(babel.config.BABEL_TRANSLATION_DIRECTORY)\n    translation_files = [i.name for i in translation_directory.iterdir()]\n    explicit_priority = None\n\n    for lang, quality in languages:\n        if lang in translation_files:\n            if (\n                not quality\n            ):  # languages without quality value having the highest priority 1\n                return lang\n\n            elif (\n                not explicit_priority\n            ):  # set language with explicit priority &lt;= priority 1\n                explicit_priority = lang\n\n    # Return language with explicit priority or default value\n    return (\n        explicit_priority if explicit_priority else babel_configs.BABEL_DEFAULT_LOCALE\n    )\n\n\nloader = JsonLoader(os.path.dirname(__file__) + \"/translations\")",
        "signatures": {},
        "detailedLines": [
          {
            "text": "from pathlib import Path",
            "lineNumber": 1
          },
          {
            "text": "from app.component.babel import babel_configs, babel",
            "lineNumber": 2
          },
          {
            "text": "import re, os",
            "lineNumber": 3
          },
          {
            "text": "from fastapi_babel.middleware import Babel, LANGUAGES_PATTERN",
            "lineNumber": 4
          },
          {
            "text": "from pydantic_i18n import JsonLoader, PydanticI18n",
            "lineNumber": 5
          },
          {
            "lineNumber": 6
          },
          {
            "lineNumber": 7
          },
          {
            "text": "def get_language(lang_code: str | None = None):",
            "lineNumber": 8,
            "isSignature": true
          },
          {
            "text": "    \"\"\"Ported from fastapi_babel.middleware.BabelMiddleware.get_language",
            "lineNumber": 9
          },
          {
            "text": "    Applies an available language.",
            "lineNumber": 10
          },
          {
            "lineNumber": 11
          },
          {
            "text": "    To apply an available language it will be searched in the language folder for an available one",
            "lineNumber": 12
          },
          {
            "text": "    and will also priotize the one with the highest quality value. The Fallback language will be the",
            "lineNumber": 13
          },
          {
            "text": "    taken from the BABEL_DEFAULT_LOCALE var.",
            "lineNumber": 14
          },
          {
            "lineNumber": 15
          },
          {
            "text": "        Args:",
            "lineNumber": 16
          },
          {
            "text": "            babel (Babel): Request scoped Babel instance",
            "lineNumber": 17
          },
          {
            "text": "            lang_code (str): The Value of the Accept-Language Header.",
            "lineNumber": 18
          },
          {
            "lineNumber": 19
          },
          {
            "text": "        Returns:",
            "lineNumber": 20
          },
          {
            "text": "            str: The language that should be used.",
            "lineNumber": 21
          },
          {
            "text": "    \"\"\"",
            "lineNumber": 22
          },
          {
            "lineNumber": 23
          },
          {
            "text": "    if not lang_code:",
            "lineNumber": 24
          },
          {
            "text": "        return babel.config.BABEL_DEFAULT_LOCALE",
            "lineNumber": 25
          },
          {
            "lineNumber": 26
          },
          {
            "text": "    matches = re.finditer(LANGUAGES_PATTERN, lang_code)",
            "lineNumber": 27
          },
          {
            "text": "    languages = [",
            "lineNumber": 28
          },
          {
            "text": "        (f\"{m.group(1)}{f'_{m.group(2)}' if m.group(2) else ''}\", m.group(3) or \"\")",
            "lineNumber": 29
          },
          {
            "text": "        for m in matches",
            "lineNumber": 30
          },
          {
            "text": "    ]",
            "lineNumber": 31
          },
          {
            "text": "    languages = sorted(",
            "lineNumber": 32
          },
          {
            "text": "        languages, key=lambda x: x[1], reverse=True",
            "lineNumber": 33
          },
          {
            "text": "    )  # sort the priority, no priority comes last",
            "lineNumber": 34
          },
          {
            "text": "    translation_directory = Path(babel.config.BABEL_TRANSLATION_DIRECTORY)",
            "lineNumber": 35
          },
          {
            "text": "    translation_files = [i.name for i in translation_directory.iterdir()]",
            "lineNumber": 36
          },
          {
            "text": "    explicit_priority = None",
            "lineNumber": 37
          },
          {
            "lineNumber": 38
          },
          {
            "text": "    for lang, quality in languages:",
            "lineNumber": 39
          },
          {
            "text": "        if lang in translation_files:",
            "lineNumber": 40
          },
          {
            "text": "            if (",
            "lineNumber": 41
          },
          {
            "text": "                not quality",
            "lineNumber": 42
          },
          {
            "text": "            ):  # languages without quality value having the highest priority 1",
            "lineNumber": 43
          },
          {
            "text": "                return lang",
            "lineNumber": 44
          },
          {
            "lineNumber": 45
          },
          {
            "text": "            elif (",
            "lineNumber": 46
          },
          {
            "text": "                not explicit_priority",
            "lineNumber": 47
          },
          {
            "text": "            ):  # set language with explicit priority &lt;= priority 1",
            "lineNumber": 48
          },
          {
            "text": "                explicit_priority = lang",
            "lineNumber": 49
          },
          {
            "lineNumber": 50
          },
          {
            "text": "    # Return language with explicit priority or default value",
            "lineNumber": 51
          },
          {
            "text": "    return (",
            "lineNumber": 52
          },
          {
            "text": "        explicit_priority if explicit_priority else babel_configs.BABEL_DEFAULT_LOCALE",
            "lineNumber": 53
          },
          {
            "text": "    )",
            "lineNumber": 54,
            "isSignature": true
          },
          {
            "lineNumber": 55
          },
          {
            "lineNumber": 56
          },
          {
            "text": "loader = JsonLoader(os.path.dirname(__file__) + \"/translations\")",
            "lineNumber": 57
          }
        ]
      },
      "score": 0.28154289722442627
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\ref\\DATA_MODELS.md",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 56
          }
        },
        "contents": "# 核心資料模型\n\n&gt; 本文件說明 Eigent 專案中的核心資料結構與型別定義。\n\n## 前端資料模型 (TypeScript)\n\n### AuthState\n\n認證與使用者偏好狀態。\n\n&#96;&#96;&#96;typescript\n// src/store/authStore.ts\n\ninterface AuthState {\n  // 認證資訊\n  token: string | null;\n  username: string | null;\n  email: string | null;\n  user_id: number | null;\n\n  // 應用設定\n  appearance: 'light' | 'dark';\n  language: 'system' | 'en' | 'zh-cn' | 'zh-tw' | 'ja' | 'ko';\n  isFirstLaunch: boolean;\n  initState: 'permissions' | 'carousel' | 'done';\n  \n  // 模型設定\n  modelType: 'cloud' | 'local' | 'custom';\n  cloud_model_type: CloudModelType;\n  \n  // 共享相關\n  share_token: string | null;\n  \n  // Worker 清單\n  workerListData: { [email: string]: Agent[] };\n}\n\ntype CloudModelType = \n  | 'gpt-4.1' | 'gpt-4.1-mini' \n  | 'gpt-5' | 'gpt-5.1' | 'gpt-5.2' | 'gpt-5-mini'\n  | 'claude-sonnet-4-5' | 'claude-sonnet-4-20250514' | 'claude-3-5-haiku-20241022'\n  | 'gemini/gemini-2.5-pro' | 'gemini-2.5-flash' | 'gemini-3-pro-preview';\n&#96;&#96;&#96;\n\n---\n\n### Task\n\n任務狀態（每個對話/任務的完整狀態）。\n\n&#96;&#96;&#96;typescript\n// src/store/chatStore.ts\n\ninterface Task {\n  // 訊息與內容\n  messages: Message[];",
        "signatures": {},
        "detailedLines": [
          {
            "text": "# 核心資料模型",
            "lineNumber": 1
          },
          {
            "lineNumber": 2
          },
          {
            "text": "&gt; 本文件說明 Eigent 專案中的核心資料結構與型別定義。",
            "lineNumber": 3
          },
          {
            "lineNumber": 4
          },
          {
            "text": "## 前端資料模型 (TypeScript)",
            "lineNumber": 5
          },
          {
            "lineNumber": 6
          },
          {
            "text": "### AuthState",
            "lineNumber": 7
          },
          {
            "lineNumber": 8
          },
          {
            "text": "認證與使用者偏好狀態。",
            "lineNumber": 9
          },
          {
            "lineNumber": 10
          },
          {
            "text": "&#96;&#96;&#96;typescript",
            "lineNumber": 11
          },
          {
            "text": "// src/store/authStore.ts",
            "lineNumber": 12
          },
          {
            "lineNumber": 13
          },
          {
            "text": "interface AuthState {",
            "lineNumber": 14
          },
          {
            "text": "  // 認證資訊",
            "lineNumber": 15
          },
          {
            "text": "  token: string | null;",
            "lineNumber": 16
          },
          {
            "text": "  username: string | null;",
            "lineNumber": 17
          },
          {
            "text": "  email: string | null;",
            "lineNumber": 18
          },
          {
            "text": "  user_id: number | null;",
            "lineNumber": 19
          },
          {
            "lineNumber": 20
          },
          {
            "text": "  // 應用設定",
            "lineNumber": 21
          },
          {
            "text": "  appearance: 'light' | 'dark';",
            "lineNumber": 22
          },
          {
            "text": "  language: 'system' | 'en' | 'zh-cn' | 'zh-tw' | 'ja' | 'ko';",
            "lineNumber": 23
          },
          {
            "text": "  isFirstLaunch: boolean;",
            "lineNumber": 24
          },
          {
            "text": "  initState: 'permissions' | 'carousel' | 'done';",
            "lineNumber": 25
          },
          {
            "text": "  ",
            "lineNumber": 26
          },
          {
            "text": "  // 模型設定",
            "lineNumber": 27
          },
          {
            "text": "  modelType: 'cloud' | 'local' | 'custom';",
            "lineNumber": 28
          },
          {
            "text": "  cloud_model_type: CloudModelType;",
            "lineNumber": 29
          },
          {
            "text": "  ",
            "lineNumber": 30
          },
          {
            "text": "  // 共享相關",
            "lineNumber": 31
          },
          {
            "text": "  share_token: string | null;",
            "lineNumber": 32
          },
          {
            "text": "  ",
            "lineNumber": 33
          },
          {
            "text": "  // Worker 清單",
            "lineNumber": 34
          },
          {
            "text": "  workerListData: { [email: string]: Agent[] };",
            "lineNumber": 35
          },
          {
            "text": "}",
            "lineNumber": 36
          },
          {
            "lineNumber": 37
          },
          {
            "text": "type CloudModelType = ",
            "lineNumber": 38
          },
          {
            "text": "  | 'gpt-4.1' | 'gpt-4.1-mini' ",
            "lineNumber": 39
          },
          {
            "text": "  | 'gpt-5' | 'gpt-5.1' | 'gpt-5.2' | 'gpt-5-mini'",
            "lineNumber": 40
          },
          {
            "text": "  | 'claude-sonnet-4-5' | 'claude-sonnet-4-20250514' | 'claude-3-5-haiku-20241022'",
            "lineNumber": 41
          },
          {
            "text": "  | 'gemini/gemini-2.5-pro' | 'gemini-2.5-flash' | 'gemini-3-pro-preview';",
            "lineNumber": 42
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 43
          },
          {
            "lineNumber": 44
          },
          {
            "text": "---",
            "lineNumber": 45
          },
          {
            "lineNumber": 46
          },
          {
            "text": "### Task",
            "lineNumber": 47
          },
          {
            "lineNumber": 48
          },
          {
            "text": "任務狀態（每個對話/任務的完整狀態）。",
            "lineNumber": 49
          },
          {
            "lineNumber": 50
          },
          {
            "text": "&#96;&#96;&#96;typescript",
            "lineNumber": 51
          },
          {
            "text": "// src/store/chatStore.ts",
            "lineNumber": 52
          },
          {
            "lineNumber": 53
          },
          {
            "text": "interface Task {",
            "lineNumber": 54
          },
          {
            "text": "  // 訊息與內容",
            "lineNumber": 55
          },
          {
            "text": "  messages: Message[];",
            "lineNumber": 56
          }
        ]
      },
      "score": 0.27286195755004883
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\service\\chat_service.py",
        "range": {
          "startPosition": {
            "line": 1297,
            "column": 17
          },
          "endPosition": {
            "line": 1424
          }
        },
        "contents": "@traceroot.trace()\nasync def construct_workforce(options: Chat) -&gt; tuple[Workforce, ListenChatAgent]:\n    logger.info(\"Constructing workforce\", extra={\"project_id\": options.project_id, \"task_id\": options.task_id})\n    working_directory = get_working_directory(options)\n    logger.debug(\"Working directory set\", extra={\"working_directory\": working_directory})\n    [coordinator_agent, task_agent] = [\n        agent_model(\n            key,\n            prompt,\n            options,\n            [\n                *(\n                    ToolkitMessageIntegration(\n                        message_handler=HumanToolkit(options.project_id, key).send_message_to_user\n                    ).register_toolkits(NoteTakingToolkit(options.project_id, working_directory=working_directory))\n                ).get_tools()\n            ],\n        )\n        for key, prompt in {\n            Agents.coordinator_agent:",
        "signatures": {},
        "detailedLines": [
          {
            "text": "@traceroot.trace()",
            "lineNumber": 1301
          },
          {
            "text": "async def construct_workforce(options: Chat) -&gt; tuple[Workforce, ListenChatAgent]:",
            "lineNumber": 1302,
            "isSignature": true
          },
          {
            "text": "    logger.info(\"Constructing workforce\", extra={\"project_id\": options.project_id, \"task_id\": options.task_id})",
            "lineNumber": 1303
          },
          {
            "text": "    working_directory = get_working_directory(options)",
            "lineNumber": 1304
          },
          {
            "text": "    logger.debug(\"Working directory set\", extra={\"working_directory\": working_directory})",
            "lineNumber": 1305
          },
          {
            "text": "    [coordinator_agent, task_agent] = [",
            "lineNumber": 1306
          },
          {
            "text": "        agent_model(",
            "lineNumber": 1307
          },
          {
            "text": "            key,",
            "lineNumber": 1308
          },
          {
            "text": "            prompt,",
            "lineNumber": 1309
          },
          {
            "text": "            options,",
            "lineNumber": 1310
          },
          {
            "text": "            [",
            "lineNumber": 1311
          },
          {
            "text": "                *(",
            "lineNumber": 1312
          },
          {
            "text": "                    ToolkitMessageIntegration(",
            "lineNumber": 1313
          },
          {
            "text": "                        message_handler=HumanToolkit(options.project_id, key).send_message_to_user",
            "lineNumber": 1314
          },
          {
            "text": "                    ).register_toolkits(NoteTakingToolkit(options.project_id, working_directory=working_directory))",
            "lineNumber": 1315
          },
          {
            "text": "                ).get_tools()",
            "lineNumber": 1316
          },
          {
            "text": "            ],",
            "lineNumber": 1317
          },
          {
            "text": "        )",
            "lineNumber": 1318
          },
          {
            "text": "        for key, prompt in {",
            "lineNumber": 1319
          },
          {
            "text": "            Agents.coordinator_agent:",
            "lineNumber": 1320
          }
        ]
      },
      "score": 0.2727566361427307
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\server\\app\\component\\pydantic\\i18n.py",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 46,
            "column": 64
          }
        },
        "contents": "from pathlib import Path\nfrom app.component.babel import babel_configs, babel\nimport re\nimport os\nfrom fastapi_babel.middleware import LANGUAGES_PATTERN\nfrom pydantic_i18n import JsonLoader, PydanticI18n\n\n\ndef get_language(lang_code: str | None = None):\n    \"\"\"移植于fastapi_babel.middleware.BabelMiddleware.get_language\n    Applies an available language.\n\n    To apply an available language it will be searched in the language folder for an available one\n    and will also priotize the one with the highest quality value. The Fallback language will be the\n    taken from the BABEL_DEFAULT_LOCALE var.\n\n        Args:\n            babel (Babel): Request scoped Babel instance\n            lang_code (str): The Value of the Accept-Language Header.\n\n        Returns:\n            str: The language that should be used.\n    \"\"\"\n\n    if not lang_code:\n        return babel.config.BABEL_DEFAULT_LOCALE\n\n    matches = re.finditer(LANGUAGES_PATTERN, lang_code)\n    languages = [(f\"{m.group(1)}{f'_{m.group(2)}' if m.group(2) else ''}\", m.group(3) or \"\") for m in matches]\n    languages = sorted(languages, key=lambda x: x[1], reverse=True)  # sort the priority, no priority comes last\n    translation_directory = Path(babel.config.BABEL_TRANSLATION_DIRECTORY)\n    translation_files = [i.name for i in translation_directory.iterdir()]\n    explicit_priority = None\n\n    for lang, quality in languages:\n        if lang in translation_files:\n            if not quality:  # languages without quality value having the highest priority 1\n                return lang\n\n            elif not explicit_priority:  # set language with explicit priority &lt;= priority 1\n                explicit_priority = lang\n\n    # Return language with explicit priority or default value\n    return explicit_priority if explicit_priority else babel_configs.BABEL_DEFAULT_LOCALE\n\n\nloader = JsonLoader(os.path.dirname(__file__) + \"/translations\")",
        "signatures": {},
        "detailedLines": [
          {
            "text": "from pathlib import Path",
            "lineNumber": 1
          },
          {
            "text": "from app.component.babel import babel_configs, babel",
            "lineNumber": 2
          },
          {
            "text": "import re",
            "lineNumber": 3
          },
          {
            "text": "import os",
            "lineNumber": 4
          },
          {
            "text": "from fastapi_babel.middleware import LANGUAGES_PATTERN",
            "lineNumber": 5
          },
          {
            "text": "from pydantic_i18n import JsonLoader, PydanticI18n",
            "lineNumber": 6
          },
          {
            "lineNumber": 7
          },
          {
            "lineNumber": 8
          },
          {
            "text": "def get_language(lang_code: str | None = None):",
            "lineNumber": 9,
            "isSignature": true
          },
          {
            "text": "    \"\"\"移植于fastapi_babel.middleware.BabelMiddleware.get_language",
            "lineNumber": 10
          },
          {
            "text": "    Applies an available language.",
            "lineNumber": 11
          },
          {
            "lineNumber": 12
          },
          {
            "text": "    To apply an available language it will be searched in the language folder for an available one",
            "lineNumber": 13
          },
          {
            "text": "    and will also priotize the one with the highest quality value. The Fallback language will be the",
            "lineNumber": 14
          },
          {
            "text": "    taken from the BABEL_DEFAULT_LOCALE var.",
            "lineNumber": 15
          },
          {
            "lineNumber": 16
          },
          {
            "text": "        Args:",
            "lineNumber": 17
          },
          {
            "text": "            babel (Babel): Request scoped Babel instance",
            "lineNumber": 18
          },
          {
            "text": "            lang_code (str): The Value of the Accept-Language Header.",
            "lineNumber": 19
          },
          {
            "lineNumber": 20
          },
          {
            "text": "        Returns:",
            "lineNumber": 21
          },
          {
            "text": "            str: The language that should be used.",
            "lineNumber": 22
          },
          {
            "text": "    \"\"\"",
            "lineNumber": 23
          },
          {
            "lineNumber": 24
          },
          {
            "text": "    if not lang_code:",
            "lineNumber": 25
          },
          {
            "text": "        return babel.config.BABEL_DEFAULT_LOCALE",
            "lineNumber": 26
          },
          {
            "lineNumber": 27
          },
          {
            "text": "    matches = re.finditer(LANGUAGES_PATTERN, lang_code)",
            "lineNumber": 28
          },
          {
            "text": "    languages = [(f\"{m.group(1)}{f'_{m.group(2)}' if m.group(2) else ''}\", m.group(3) or \"\") for m in matches]",
            "lineNumber": 29
          },
          {
            "text": "    languages = sorted(languages, key=lambda x: x[1], reverse=True)  # sort the priority, no priority comes last",
            "lineNumber": 30
          },
          {
            "text": "    translation_directory = Path(babel.config.BABEL_TRANSLATION_DIRECTORY)",
            "lineNumber": 31
          },
          {
            "text": "    translation_files = [i.name for i in translation_directory.iterdir()]",
            "lineNumber": 32
          },
          {
            "text": "    explicit_priority = None",
            "lineNumber": 33
          },
          {
            "lineNumber": 34
          },
          {
            "text": "    for lang, quality in languages:",
            "lineNumber": 35
          },
          {
            "text": "        if lang in translation_files:",
            "lineNumber": 36
          },
          {
            "text": "            if not quality:  # languages without quality value having the highest priority 1",
            "lineNumber": 37
          },
          {
            "text": "                return lang",
            "lineNumber": 38
          },
          {
            "lineNumber": 39
          },
          {
            "text": "            elif not explicit_priority:  # set language with explicit priority &lt;= priority 1",
            "lineNumber": 40
          },
          {
            "text": "                explicit_priority = lang",
            "lineNumber": 41
          },
          {
            "lineNumber": 42
          },
          {
            "text": "    # Return language with explicit priority or default value",
            "lineNumber": 43
          },
          {
            "text": "    return explicit_priority if explicit_priority else babel_configs.BABEL_DEFAULT_LOCALE",
            "lineNumber": 44,
            "isSignature": true
          },
          {
            "lineNumber": 45
          },
          {
            "lineNumber": 46
          },
          {
            "text": "loader = JsonLoader(os.path.dirname(__file__) + \"/translations\")",
            "lineNumber": 47
          }
        ]
      },
      "score": 0.2682889699935913
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\service\\chat_service.py",
        "range": {
          "startPosition": {
            "line": 1300
          },
          "endPosition": {
            "line": 1424
          }
        },
        "contents": "@traceroot.trace()\nasync def construct_workforce(options: Chat) -&gt; tuple[Workforce, ListenChatAgent]:\n\"\"\",\n        }.items()\n    ]\n    new_worker_agent = agent_model(\n        Agents.new_worker_agent,\n        f\"\"\"\n        You are a helpful assistant.\n- You are now working in system {platform.system()} with architecture\n{platform.machine()} at working directory &#96;{working_directory}&#96;. All local file operations must occur here, but you can access files from any place in the file system. For all file system operations, you MUST use absolute paths to ensure precision and avoid ambiguity.\nThe current date is {datetime.date.today()}. For any date-related tasks, you MUST use this as the current date.\n        \"\"\",\n        options,\n        [\n            *HumanToolkit.get_can_use_tools(options.project_id, Agents.new_worker_agent),\n            *(\n                ToolkitMessageIntegration(\n                    message_handler=HumanToolkit(options.project_id, Agents.new_worker_agent).send_message_to_user\n                ).register_toolkits(NoteTakingToolkit(options.project_id, working_directory=working_directory))\n            ).get_tools(),\n        ],\n    )\n    # msg_toolkit = AgentCommunicationToolkit(max_message_history=100)\n\n    searcher = browser_agent(options)\n    developer = await developer_agent(options)\n    documenter = await document_agent(options)\n    multi_modaler = multi_modal_agent(options)\n\n    # msg_toolkit.register_agent(\"Worker\", new_worker_agent)\n    # msg_toolkit.register_agent(\"Browser_Agent\", searcher)\n    # msg_toolkit.register_agent(\"Developer_Agent\", developer)\n    # msg_toolkit.register_agent(\"Document_Agent\", documenter)\n    # msg_toolkit.register_agent(\"Multi_Modal_Agent\", multi_modaler)\n\n    # Convert string model_platform to enum for comparison\n    try:\n        model_platform_enum = ModelPlatformType(options.model_platform.lower())\n    except (ValueError, AttributeError):\n        # If conversion fails, default to non-OpenAI behavior\n        model_platform_enum = None\n\n    workforce =",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 1301,
                "column": 1
              },
              "endPosition": {
                "line": 1302,
                "column": 1
              }
            },
            {
              "startPosition": {
                "line": 1302,
                "column": 1
              },
              "endPosition": {
                "line": 1303,
                "column": 5
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "@traceroot.trace()",
            "lineNumber": 1301
          },
          {
            "text": "async def construct_workforce(options: Chat) -&gt; tuple[Workforce, ListenChatAgent]:",
            "lineNumber": 1302,
            "isSignature": true
          },
          {
            "text": "\"\"\",",
            "lineNumber": 1335
          },
          {
            "text": "        }.items()",
            "lineNumber": 1336
          },
          {
            "text": "    ]",
            "lineNumber": 1337
          },
          {
            "text": "    new_worker_agent = agent_model(",
            "lineNumber": 1338
          },
          {
            "text": "        Agents.new_worker_agent,",
            "lineNumber": 1339
          },
          {
            "text": "        f\"\"\"",
            "lineNumber": 1340
          },
          {
            "text": "        You are a helpful assistant.",
            "lineNumber": 1341
          },
          {
            "text": "- You are now working in system {platform.system()} with architecture",
            "lineNumber": 1342
          },
          {
            "text": "{platform.machine()} at working directory &#96;{working_directory}&#96;. All local file operations must occur here, but you can access files from any place in the file system. For all file system operations, you MUST use absolute paths to ensure precision and avoid ambiguity.",
            "lineNumber": 1343
          },
          {
            "text": "The current date is {datetime.date.today()}. For any date-related tasks, you MUST use this as the current date.",
            "lineNumber": 1344
          },
          {
            "text": "        \"\"\",",
            "lineNumber": 1345
          },
          {
            "text": "        options,",
            "lineNumber": 1346
          },
          {
            "text": "        [",
            "lineNumber": 1347
          },
          {
            "text": "            *HumanToolkit.get_can_use_tools(options.project_id, Agents.new_worker_agent),",
            "lineNumber": 1348
          },
          {
            "text": "            *(",
            "lineNumber": 1349
          },
          {
            "text": "                ToolkitMessageIntegration(",
            "lineNumber": 1350
          },
          {
            "text": "                    message_handler=HumanToolkit(options.project_id, Agents.new_worker_agent).send_message_to_user",
            "lineNumber": 1351
          },
          {
            "text": "                ).register_toolkits(NoteTakingToolkit(options.project_id, working_directory=working_directory))",
            "lineNumber": 1352
          },
          {
            "text": "            ).get_tools(),",
            "lineNumber": 1353
          },
          {
            "text": "        ],",
            "lineNumber": 1354
          },
          {
            "text": "    )",
            "lineNumber": 1355
          },
          {
            "text": "    # msg_toolkit = AgentCommunicationToolkit(max_message_history=100)",
            "lineNumber": 1356
          },
          {
            "lineNumber": 1357
          },
          {
            "text": "    searcher = browser_agent(options)",
            "lineNumber": 1358
          },
          {
            "text": "    developer = await developer_agent(options)",
            "lineNumber": 1359
          },
          {
            "text": "    documenter = await document_agent(options)",
            "lineNumber": 1360
          },
          {
            "text": "    multi_modaler = multi_modal_agent(options)",
            "lineNumber": 1361
          },
          {
            "lineNumber": 1362
          },
          {
            "text": "    # msg_toolkit.register_agent(\"Worker\", new_worker_agent)",
            "lineNumber": 1363
          },
          {
            "text": "    # msg_toolkit.register_agent(\"Browser_Agent\", searcher)",
            "lineNumber": 1364
          },
          {
            "text": "    # msg_toolkit.register_agent(\"Developer_Agent\", developer)",
            "lineNumber": 1365
          },
          {
            "text": "    # msg_toolkit.register_agent(\"Document_Agent\", documenter)",
            "lineNumber": 1366
          },
          {
            "text": "    # msg_toolkit.register_agent(\"Multi_Modal_Agent\", multi_modaler)",
            "lineNumber": 1367
          },
          {
            "lineNumber": 1368
          },
          {
            "text": "    # Convert string model_platform to enum for comparison",
            "lineNumber": 1369
          },
          {
            "text": "    try:",
            "lineNumber": 1370
          },
          {
            "text": "        model_platform_enum = ModelPlatformType(options.model_platform.lower())",
            "lineNumber": 1371
          },
          {
            "text": "    except (ValueError, AttributeError):",
            "lineNumber": 1372
          },
          {
            "text": "        # If conversion fails, default to non-OpenAI behavior",
            "lineNumber": 1373
          },
          {
            "text": "        model_platform_enum = None",
            "lineNumber": 1374
          },
          {
            "lineNumber": 1375
          },
          {
            "text": "    workforce =",
            "lineNumber": 1376
          }
        ]
      },
      "score": 0.2657127380371094
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\src\\store\\chatStore.ts",
        "range": {
          "startPosition": {
            "line": 162
          },
          "endPosition": {
            "line": 2594,
            "column": 1
          }
        },
        "contents": "const chatStore = \n(set, get) =&gt; (\nasync (taskId: string, type?: string, shareToken?: string, delayTime?: number, messageContent?: string, messageAttaches?: File[]) =&gt; {\nconst \n;\n\n\t\t\t// Get the locked task ID - this won't change during the SSE session\n\t\t\tconst getCurrentTaskId = () =&gt; {\n\t\t\t\treturn lockedTaskId;\n\t\t\t};\n\n\t\t\t// Function to update locked references (only for special cases like replay)\n\t\t\tconst updateLockedReferences = (newChatStore: VanillaChatStore, newTaskId: string) =&gt; {\n\t\t\t\tlockedChatStore = newChatStore;\n\t\t\t\tlockedTaskId = newTaskId;\n\t\t\t};\n\n\t\t\tfetchEventSource(api, {\n\t\t\t\tmethod: !type ? \"POST\" : \"GET\",\n\t\t\t\topenWhenHidden: true,\n\t\t\t\tsignal: abortController.signal, // Add abort signal for proper cleanup\n\t\t\t\theaders: { \"Content-Type\": \"application/json\", \"Authorization\": type == 'replay' ? &#96;Bearer ${token}&#96; : undefined as unknown as string },\n\t\t\t\tbody: !type ? JSON.stringify({\n\t\t\t\t\tproject_id: project_id,\n\t\t\t\t\ttask_id: newTaskId,\n\t\t\t\t\tquestion: messageContent || targetChatStore.getState().getLastUserMessage()?.content,\n\t\t\t\t\tmodel_platform: apiModel.model_platform,\n\t\t\t\t\temail,\n\t\t\t\t\tmodel_type: apiModel.model_type,\n\t\t\t\t\tapi_key: apiModel.api_key,\n\t\t\t\t\tapi_url: apiModel.api_url,\n\t\t\t\t\textra_params: apiModel.extra_params,\n\t\t\t\t\tinstalled_mcp: { mcpServers: {} },\n\t\t\t\t\tlanguage: systemLanguage,\n\t\t\t\t\tallow_local_system: true,\n\t\t\t\t\tattaches: (messageAttaches || targetChatStore.getState().tasks[newTaskId]?.attaches || []).map(f =&gt; f.filePath),\n\t\t\t\t\tsummary_prompt: &#96;&#96;,\n\t\t\t\t\tnew_agents: [...addWorkers],\n\t\t\t\t\tbrowser_port: browser_port,\n\t\t\t\t\tenv_path: envPath,\n\t\t\t\t\tsearch_config: searchConfig\n\t\t\t\t}) : undefined,\n\n\t\t\t\tasync onmessage(event: any) {\n\t\t\t\t\tlet agentMessages: AgentMessage;\n\t\t\t\t}\n\n\t\t}\n)\n;",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 163,
                "column": 1
              },
              "endPosition": {
                "line": 163,
                "column": 7
              }
            },
            {
              "startPosition": {
                "line": 163,
                "column": 7
              },
              "endPosition": {
                "line": 163,
                "column": 19
              }
            },
            {
              "startPosition": {
                "line": 163,
                "column": 53
              },
              "endPosition": {
                "line": 163,
                "column": 53
              }
            },
            {
              "startPosition": {
                "line": 164,
                "column": 2
              },
              "endPosition": {
                "line": 164,
                "column": 17
              }
            },
            {
              "startPosition": {
                "line": 331,
                "column": 14
              },
              "endPosition": {
                "line": 332,
                "column": 4
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "const chatStore = ",
            "lineNumber": 163
          },
          {
            "text": "(set, get) =&gt; (",
            "lineNumber": 164
          },
          {
            "text": "async (taskId: string, type?: string, shareToken?: string, delayTime?: number, messageContent?: string, messageAttaches?: File[]) =&gt; {",
            "lineNumber": 331
          },
          {
            "text": "const ",
            "lineNumber": 571
          },
          {
            "text": ";",
            "lineNumber": 573
          },
          {
            "lineNumber": 574
          },
          {
            "text": "\t\t\t// Get the locked task ID - this won't change during the SSE session",
            "lineNumber": 575
          },
          {
            "text": "\t\t\tconst getCurrentTaskId = () =&gt; {",
            "lineNumber": 576
          },
          {
            "text": "\t\t\t\treturn lockedTaskId;",
            "lineNumber": 577
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 578
          },
          {
            "lineNumber": 579
          },
          {
            "text": "\t\t\t// Function to update locked references (only for special cases like replay)",
            "lineNumber": 580
          },
          {
            "text": "\t\t\tconst updateLockedReferences = (newChatStore: VanillaChatStore, newTaskId: string) =&gt; {",
            "lineNumber": 581
          },
          {
            "text": "\t\t\t\tlockedChatStore = newChatStore;",
            "lineNumber": 582
          },
          {
            "text": "\t\t\t\tlockedTaskId = newTaskId;",
            "lineNumber": 583
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 584
          },
          {
            "lineNumber": 585
          },
          {
            "text": "\t\t\tfetchEventSource(api, {",
            "lineNumber": 586
          },
          {
            "text": "\t\t\t\tmethod: !type ? \"POST\" : \"GET\",",
            "lineNumber": 587
          },
          {
            "text": "\t\t\t\topenWhenHidden: true,",
            "lineNumber": 588
          },
          {
            "text": "\t\t\t\tsignal: abortController.signal, // Add abort signal for proper cleanup",
            "lineNumber": 589
          },
          {
            "text": "\t\t\t\theaders: { \"Content-Type\": \"application/json\", \"Authorization\": type == 'replay' ? &#96;Bearer ${token}&#96; : undefined as unknown as string },",
            "lineNumber": 590
          },
          {
            "text": "\t\t\t\tbody: !type ? JSON.stringify({",
            "lineNumber": 591
          },
          {
            "text": "\t\t\t\t\tproject_id: project_id,",
            "lineNumber": 592
          },
          {
            "text": "\t\t\t\t\ttask_id: newTaskId,",
            "lineNumber": 593
          },
          {
            "text": "\t\t\t\t\tquestion: messageContent || targetChatStore.getState().getLastUserMessage()?.content,",
            "lineNumber": 594
          },
          {
            "text": "\t\t\t\t\tmodel_platform: apiModel.model_platform,",
            "lineNumber": 595
          },
          {
            "text": "\t\t\t\t\temail,",
            "lineNumber": 596
          },
          {
            "text": "\t\t\t\t\tmodel_type: apiModel.model_type,",
            "lineNumber": 597
          },
          {
            "text": "\t\t\t\t\tapi_key: apiModel.api_key,",
            "lineNumber": 598
          },
          {
            "text": "\t\t\t\t\tapi_url: apiModel.api_url,",
            "lineNumber": 599
          },
          {
            "text": "\t\t\t\t\textra_params: apiModel.extra_params,",
            "lineNumber": 600
          },
          {
            "text": "\t\t\t\t\tinstalled_mcp: { mcpServers: {} },",
            "lineNumber": 601
          },
          {
            "text": "\t\t\t\t\tlanguage: systemLanguage,",
            "lineNumber": 602
          },
          {
            "text": "\t\t\t\t\tallow_local_system: true,",
            "lineNumber": 603
          },
          {
            "text": "\t\t\t\t\tattaches: (messageAttaches || targetChatStore.getState().tasks[newTaskId]?.attaches || []).map(f =&gt; f.filePath),",
            "lineNumber": 604
          },
          {
            "text": "\t\t\t\t\tsummary_prompt: &#96;&#96;,",
            "lineNumber": 605
          },
          {
            "text": "\t\t\t\t\tnew_agents: [...addWorkers],",
            "lineNumber": 606
          },
          {
            "text": "\t\t\t\t\tbrowser_port: browser_port,",
            "lineNumber": 607
          },
          {
            "text": "\t\t\t\t\tenv_path: envPath,",
            "lineNumber": 608
          },
          {
            "text": "\t\t\t\t\tsearch_config: searchConfig",
            "lineNumber": 609
          },
          {
            "text": "\t\t\t\t}) : undefined,",
            "lineNumber": 610
          },
          {
            "lineNumber": 611
          },
          {
            "text": "\t\t\t\tasync onmessage(event: any) {",
            "lineNumber": 612
          },
          {
            "text": "\t\t\t\t\tlet agentMessages: AgentMessage;",
            "lineNumber": 613
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 1836
          },
          {
            "lineNumber": 1886
          },
          {
            "text": "\t\t}",
            "lineNumber": 1888
          },
          {
            "text": ")",
            "lineNumber": 2594
          },
          {
            "text": ";",
            "lineNumber": 2595
          }
        ]
      },
      "score": 0.2608915865421295
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\src\\store\\chatStore.ts",
        "range": {
          "startPosition": {
            "line": 162
          },
          "endPosition": {
            "line": 2594,
            "column": 1
          }
        },
        "contents": "const chatStore = \n(set, get) =&gt; (\nasync (taskId: string, type?: string, shareToken?: string, delayTime?: number, messageContent?: string, messageAttaches?: File[]) =&gt; {\n\n\t\t\tif (modelType === 'custom') {\n\t\t\t\ttry {\n\t\t\t\t\tconst configsRes = await proxyFetchGet('/api/configs');\n\t\t\t\t\tconst configs = Array.isArray(configsRes) ? configsRes : [];\n\n\t\t\t\t\t// Extract Google Search API keys\n\t\t\t\t\tconst googleApiKey = configs.find((c: any) =&gt;\n\t\t\t\t\t\tc.config_group?.toLowerCase() === 'search' &amp;&amp;\n\t\t\t\t\t\tc.config_name === 'GOOGLE_API_KEY'\n\t\t\t\t\t)?.config_value;\n\n\t\t\t\t\tconst searchEngineId = configs.find((c: any) =&gt;\n\t\t\t\t\t\tc.config_group?.toLowerCase() === 'search' &amp;&amp;\n\t\t\t\t\t\tc.config_name === 'SEARCH_ENGINE_ID'\n\t\t\t\t\t)?.config_value;\n\n\t\t\t\t\tif (googleApiKey &amp;&amp; searchEngineId) {\n\t\t\t\t\t\tsearchConfig = {\n\t\t\t\t\t\t\tGOOGLE_API_KEY: googleApiKey,\n\t\t\t\t\t\t\tSEARCH_ENGINE_ID: searchEngineId\n\t\t\t\t\t\t};\n\t\t\t\t\t\tconsole.log('Loaded custom search configuration');\n\t\t\t\t\t}\n\t\t\t\t} catch (error) {\n\t\t\t\t\tconsole.error('Failed to load search configuration:', error);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst addWorkers = workerList.map((worker) =&gt; {\n\t\t\t\treturn {\n\t\t\t\t\tname: worker.workerInfo?.name,\n\t\t\t\t\tdescription: worker.workerInfo?.description,\n\t\t\t\t\ttools: worker.workerInfo?.tools,\n\t\t\t\t\tmcp_tools: worker.workerInfo?.mcp_tools,\n\t\t\t\t}\n\t\t\t});\n\n\t\t\t// get env path\n\t\t\tlet envPath = ''\n\t\t\ttry {\n\t\t\t\tenvPath = await window.ipcRenderer.invoke('get-env-path', email);\n\t\t\t} catch (error) {\n\t\t\t\tconsole.log('get-env-path error', error)\n\t\t\t}\n\n\t\t\t// create history\n\t\t\tif (!type) {\n\t\t\t\tconst authStore = getAuthStore();\n\t\t}\n)\n;",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 163,
                "column": 1
              },
              "endPosition": {
                "line": 163,
                "column": 7
              }
            },
            {
              "startPosition": {
                "line": 163,
                "column": 7
              },
              "endPosition": {
                "line": 163,
                "column": 19
              }
            },
            {
              "startPosition": {
                "line": 163,
                "column": 53
              },
              "endPosition": {
                "line": 163,
                "column": 53
              }
            },
            {
              "startPosition": {
                "line": 164,
                "column": 2
              },
              "endPosition": {
                "line": 164,
                "column": 17
              }
            },
            {
              "startPosition": {
                "line": 331,
                "column": 14
              },
              "endPosition": {
                "line": 332,
                "column": 4
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "const chatStore = ",
            "lineNumber": 163
          },
          {
            "text": "(set, get) =&gt; (",
            "lineNumber": 164
          },
          {
            "text": "async (taskId: string, type?: string, shareToken?: string, delayTime?: number, messageContent?: string, messageAttaches?: File[]) =&gt; {",
            "lineNumber": 331
          },
          {
            "lineNumber": 473
          },
          {
            "text": "\t\t\tif (modelType === 'custom') {",
            "lineNumber": 474
          },
          {
            "text": "\t\t\t\ttry {",
            "lineNumber": 475
          },
          {
            "text": "\t\t\t\t\tconst configsRes = await proxyFetchGet('/api/configs');",
            "lineNumber": 476
          },
          {
            "text": "\t\t\t\t\tconst configs = Array.isArray(configsRes) ? configsRes : [];",
            "lineNumber": 477
          },
          {
            "lineNumber": 478
          },
          {
            "text": "\t\t\t\t\t// Extract Google Search API keys",
            "lineNumber": 479
          },
          {
            "text": "\t\t\t\t\tconst googleApiKey = configs.find((c: any) =&gt;",
            "lineNumber": 480
          },
          {
            "text": "\t\t\t\t\t\tc.config_group?.toLowerCase() === 'search' &amp;&amp;",
            "lineNumber": 481
          },
          {
            "text": "\t\t\t\t\t\tc.config_name === 'GOOGLE_API_KEY'",
            "lineNumber": 482
          },
          {
            "text": "\t\t\t\t\t)?.config_value;",
            "lineNumber": 483
          },
          {
            "lineNumber": 484
          },
          {
            "text": "\t\t\t\t\tconst searchEngineId = configs.find((c: any) =&gt;",
            "lineNumber": 485
          },
          {
            "text": "\t\t\t\t\t\tc.config_group?.toLowerCase() === 'search' &amp;&amp;",
            "lineNumber": 486
          },
          {
            "text": "\t\t\t\t\t\tc.config_name === 'SEARCH_ENGINE_ID'",
            "lineNumber": 487
          },
          {
            "text": "\t\t\t\t\t)?.config_value;",
            "lineNumber": 488
          },
          {
            "lineNumber": 489
          },
          {
            "text": "\t\t\t\t\tif (googleApiKey &amp;&amp; searchEngineId) {",
            "lineNumber": 490
          },
          {
            "text": "\t\t\t\t\t\tsearchConfig = {",
            "lineNumber": 491
          },
          {
            "text": "\t\t\t\t\t\t\tGOOGLE_API_KEY: googleApiKey,",
            "lineNumber": 492
          },
          {
            "text": "\t\t\t\t\t\t\tSEARCH_ENGINE_ID: searchEngineId",
            "lineNumber": 493
          },
          {
            "text": "\t\t\t\t\t\t};",
            "lineNumber": 494
          },
          {
            "text": "\t\t\t\t\t\tconsole.log('Loaded custom search configuration');",
            "lineNumber": 495
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 496
          },
          {
            "text": "\t\t\t\t} catch (error) {",
            "lineNumber": 497
          },
          {
            "text": "\t\t\t\t\tconsole.error('Failed to load search configuration:', error);",
            "lineNumber": 498
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 499
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 500
          },
          {
            "lineNumber": 501
          },
          {
            "text": "\t\t\tconst addWorkers = workerList.map((worker) =&gt; {",
            "lineNumber": 502
          },
          {
            "text": "\t\t\t\treturn {",
            "lineNumber": 503
          },
          {
            "text": "\t\t\t\t\tname: worker.workerInfo?.name,",
            "lineNumber": 504
          },
          {
            "text": "\t\t\t\t\tdescription: worker.workerInfo?.description,",
            "lineNumber": 505
          },
          {
            "text": "\t\t\t\t\ttools: worker.workerInfo?.tools,",
            "lineNumber": 506
          },
          {
            "text": "\t\t\t\t\tmcp_tools: worker.workerInfo?.mcp_tools,",
            "lineNumber": 507
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 508
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 509
          },
          {
            "lineNumber": 510
          },
          {
            "text": "\t\t\t// get env path",
            "lineNumber": 511
          },
          {
            "text": "\t\t\tlet envPath = ''",
            "lineNumber": 512
          },
          {
            "text": "\t\t\ttry {",
            "lineNumber": 513
          },
          {
            "text": "\t\t\t\tenvPath = await window.ipcRenderer.invoke('get-env-path', email);",
            "lineNumber": 514
          },
          {
            "text": "\t\t\t} catch (error) {",
            "lineNumber": 515
          },
          {
            "text": "\t\t\t\tconsole.log('get-env-path error', error)",
            "lineNumber": 516
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 517
          },
          {
            "lineNumber": 518
          },
          {
            "text": "\t\t\t// create history",
            "lineNumber": 519
          },
          {
            "text": "\t\t\tif (!type) {",
            "lineNumber": 520
          },
          {
            "text": "\t\t\t\tconst authStore = getAuthStore();",
            "lineNumber": 521
          },
          {
            "text": "\t\t}",
            "lineNumber": 1888
          },
          {
            "text": ")",
            "lineNumber": 2594
          },
          {
            "text": ";",
            "lineNumber": 2595
          }
        ]
      },
      "score": 0.2608147859573364
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\src\\store\\chatStore.ts",
        "range": {
          "startPosition": {
            "line": 162
          },
          "endPosition": {
            "line": 2594,
            "column": 1
          }
        },
        "contents": "const chatStore = \n(set, get) =&gt; (\nasync (taskId: string, type?: string, shareToken?: string, delayTime?: number, messageContent?: string, messageAttaches?: File[]) =&gt; {\n // Default to current store\n\t\t\t/**\n\t\t\t * Replay creates its own chatStore for each task with replayProject\n\t\t\t */\n\t\t\tif (project_id &amp;&amp; type !== \"replay\") {\n\t\t\t\tconsole.log(\"Creating a new Chat Instance for current project on end\")\n\t\t\t\tconst newChatResult = projectStore.appendInitChatStore(project_id);\n\n\t\t\t\tif (newChatResult) {\n\t\t\t\t\tnewTaskId = newChatResult.taskId;\n\t\t\t\t\ttargetChatStore = newChatResult.chatStore;\n\t\t\t\t\ttargetChatStore.getState().setIsPending(newTaskId, true);\n\n\t\t\t\t\t//From handleSend if message is given\n\t\t\t\t\t// Add the message to the new chatStore if provided\n\t\t\t\t\tif (messageContent) {\n\t\t\t\t\t\ttargetChatStore.getState().addMessages(newTaskId, {\n\t\t\t\t\t\t\tid: generateUniqueId(),\n\t\t\t\t\t\t\trole: \"user\",\n\t\t\t\t\t\t\tcontent: messageContent,\n\t\t\t\t\t\t\tattaches: messageAttaches || [],\n\t\t\t\t\t\t});\n\t\t\t\t\t\ttargetChatStore.getState().setHasMessages(newTaskId, true);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst base_Url = import.meta.env.DEV ? import.meta.env.VITE_PROXY_URL : import.meta.env.VITE_BASE_URL\n\t\t\tconst api = type == 'share' ?\n\t\t\t\t&#96;${base_Url}/api/chat/share/playback/${shareToken}?delay_time=${delayTime}&#96;\n\t\t\t\t: type == 'replay' ?\n\t\t\t\t\t&#96;${base_Url}/api/chat/steps/playback/${newTaskId}?delay_time=${delayTime}&#96;\n\t\t\t\t\t: &#96;${baseURL}/chat&#96;\n\n\t\t\tconst { tasks } = get()\n\t\t\tlet historyId: string | null = projectStore.getHistoryId(project_id);\n\t\t\tlet snapshots: any = [];\n\t\t\tlet skipFirstConfirm = true;\n\n\t\t\t// replay or share request\n\t\t\tif (type) {\n\t\t\t\tconst res = await proxyFetchGet(&#96;/api/chat/snapshots&#96;, {\n\t\t\t\t\tapi_task_id: taskId\n\t\t\t\t});\n\t\t\t\tif (res) {\n\t\t\t\t\tsnapshots = [...new Map(res.map((item: any) =&gt; [item.camel_task_id, item])).values()];\n\t\t\t\t}\n\t\t\t}\n\n\n\t\t\t// get current model\n\t\t\tlet apiModel = {\n\t\t\t\tapi_key: '',\n\t\t\t\tmodel_type: '',\n\t\t\t\tmodel_platform: '',\n\t\t\t\tapi_url: '',\n\t\t\t\textra_params: {}\n\t\t\t}\n\t\t\tif (modelType === 'custom' || modelType === 'local') {\n\t\t\t\tconst res = await proxyFetchGet('/api/providers', {\n\t\t\t\t\tprefer: true\n\t\t\t\t});\n\t\t}\n)\n;",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 163,
                "column": 1
              },
              "endPosition": {
                "line": 163,
                "column": 7
              }
            },
            {
              "startPosition": {
                "line": 163,
                "column": 7
              },
              "endPosition": {
                "line": 163,
                "column": 19
              }
            },
            {
              "startPosition": {
                "line": 163,
                "column": 53
              },
              "endPosition": {
                "line": 163,
                "column": 53
              }
            },
            {
              "startPosition": {
                "line": 164,
                "column": 2
              },
              "endPosition": {
                "line": 164,
                "column": 17
              }
            },
            {
              "startPosition": {
                "line": 331,
                "column": 14
              },
              "endPosition": {
                "line": 332,
                "column": 4
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "const chatStore = ",
            "lineNumber": 163
          },
          {
            "text": "(set, get) =&gt; (",
            "lineNumber": 164
          },
          {
            "text": "async (taskId: string, type?: string, shareToken?: string, delayTime?: number, messageContent?: string, messageAttaches?: File[]) =&gt; {",
            "lineNumber": 331
          },
          {
            "text": " // Default to current store",
            "lineNumber": 368
          },
          {
            "text": "\t\t\t/**",
            "lineNumber": 369
          },
          {
            "text": "\t\t\t * Replay creates its own chatStore for each task with replayProject",
            "lineNumber": 370
          },
          {
            "text": "\t\t\t */",
            "lineNumber": 371
          },
          {
            "text": "\t\t\tif (project_id &amp;&amp; type !== \"replay\") {",
            "lineNumber": 372
          },
          {
            "text": "\t\t\t\tconsole.log(\"Creating a new Chat Instance for current project on end\")",
            "lineNumber": 373
          },
          {
            "text": "\t\t\t\tconst newChatResult = projectStore.appendInitChatStore(project_id);",
            "lineNumber": 374
          },
          {
            "lineNumber": 375
          },
          {
            "text": "\t\t\t\tif (newChatResult) {",
            "lineNumber": 376
          },
          {
            "text": "\t\t\t\t\tnewTaskId = newChatResult.taskId;",
            "lineNumber": 377
          },
          {
            "text": "\t\t\t\t\ttargetChatStore = newChatResult.chatStore;",
            "lineNumber": 378
          },
          {
            "text": "\t\t\t\t\ttargetChatStore.getState().setIsPending(newTaskId, true);",
            "lineNumber": 379
          },
          {
            "lineNumber": 380
          },
          {
            "text": "\t\t\t\t\t//From handleSend if message is given",
            "lineNumber": 381
          },
          {
            "text": "\t\t\t\t\t// Add the message to the new chatStore if provided",
            "lineNumber": 382
          },
          {
            "text": "\t\t\t\t\tif (messageContent) {",
            "lineNumber": 383
          },
          {
            "text": "\t\t\t\t\t\ttargetChatStore.getState().addMessages(newTaskId, {",
            "lineNumber": 384
          },
          {
            "text": "\t\t\t\t\t\t\tid: generateUniqueId(),",
            "lineNumber": 385
          },
          {
            "text": "\t\t\t\t\t\t\trole: \"user\",",
            "lineNumber": 386
          },
          {
            "text": "\t\t\t\t\t\t\tcontent: messageContent,",
            "lineNumber": 387
          },
          {
            "text": "\t\t\t\t\t\t\tattaches: messageAttaches || [],",
            "lineNumber": 388
          },
          {
            "text": "\t\t\t\t\t\t});",
            "lineNumber": 389
          },
          {
            "text": "\t\t\t\t\t\ttargetChatStore.getState().setHasMessages(newTaskId, true);",
            "lineNumber": 390
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 391
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 392
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 393
          },
          {
            "lineNumber": 394
          },
          {
            "text": "\t\t\tconst base_Url = import.meta.env.DEV ? import.meta.env.VITE_PROXY_URL : import.meta.env.VITE_BASE_URL",
            "lineNumber": 395
          },
          {
            "text": "\t\t\tconst api = type == 'share' ?",
            "lineNumber": 396
          },
          {
            "text": "\t\t\t\t&#96;${base_Url}/api/chat/share/playback/${shareToken}?delay_time=${delayTime}&#96;",
            "lineNumber": 397
          },
          {
            "text": "\t\t\t\t: type == 'replay' ?",
            "lineNumber": 398
          },
          {
            "text": "\t\t\t\t\t&#96;${base_Url}/api/chat/steps/playback/${newTaskId}?delay_time=${delayTime}&#96;",
            "lineNumber": 399
          },
          {
            "text": "\t\t\t\t\t: &#96;${baseURL}/chat&#96;",
            "lineNumber": 400
          },
          {
            "lineNumber": 401
          },
          {
            "text": "\t\t\tconst { tasks } = get()",
            "lineNumber": 402
          },
          {
            "text": "\t\t\tlet historyId: string | null = projectStore.getHistoryId(project_id);",
            "lineNumber": 403
          },
          {
            "text": "\t\t\tlet snapshots: any = [];",
            "lineNumber": 404
          },
          {
            "text": "\t\t\tlet skipFirstConfirm = true;",
            "lineNumber": 405
          },
          {
            "lineNumber": 406
          },
          {
            "text": "\t\t\t// replay or share request",
            "lineNumber": 407
          },
          {
            "text": "\t\t\tif (type) {",
            "lineNumber": 408
          },
          {
            "text": "\t\t\t\tconst res = await proxyFetchGet(&#96;/api/chat/snapshots&#96;, {",
            "lineNumber": 409
          },
          {
            "text": "\t\t\t\t\tapi_task_id: taskId",
            "lineNumber": 410
          },
          {
            "text": "\t\t\t\t});",
            "lineNumber": 411
          },
          {
            "text": "\t\t\t\tif (res) {",
            "lineNumber": 412
          },
          {
            "text": "\t\t\t\t\tsnapshots = [...new Map(res.map((item: any) =&gt; [item.camel_task_id, item])).values()];",
            "lineNumber": 413
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 414
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 415
          },
          {
            "lineNumber": 416
          },
          {
            "lineNumber": 417
          },
          {
            "text": "\t\t\t// get current model",
            "lineNumber": 418
          },
          {
            "text": "\t\t\tlet apiModel = {",
            "lineNumber": 419
          },
          {
            "text": "\t\t\t\tapi_key: '',",
            "lineNumber": 420
          },
          {
            "text": "\t\t\t\tmodel_type: '',",
            "lineNumber": 421
          },
          {
            "text": "\t\t\t\tmodel_platform: '',",
            "lineNumber": 422
          },
          {
            "text": "\t\t\t\tapi_url: '',",
            "lineNumber": 423
          },
          {
            "text": "\t\t\t\textra_params: {}",
            "lineNumber": 424
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 425
          },
          {
            "text": "\t\t\tif (modelType === 'custom' || modelType === 'local') {",
            "lineNumber": 426
          },
          {
            "text": "\t\t\t\tconst res = await proxyFetchGet('/api/providers', {",
            "lineNumber": 427
          },
          {
            "text": "\t\t\t\t\tprefer: true",
            "lineNumber": 428
          },
          {
            "text": "\t\t\t\t});",
            "lineNumber": 429
          },
          {
            "text": "\t\t}",
            "lineNumber": 1888
          },
          {
            "text": ")",
            "lineNumber": 2594
          },
          {
            "text": ";",
            "lineNumber": 2595
          }
        ]
      },
      "score": 0.258617639541626
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\src\\components\\ChatBox\\index.tsx",
        "range": {
          "startPosition": {
            "line": 20
          },
          "endPosition": {
            "line": 1174,
            "column": 1
          }
        },
        "contents": "export default function ChatBox(): JSX.Element {\nconst handleSend = async \n\n    try {\n      if (requiresHumanReply) {\n        chatStore.addMessages(_taskId, {\n          id: generateUniqueId(),\n          role: 'user',\n          content: tempMessageContent,\n          attaches:\n            JSON.parse(JSON.stringify(chatStore.tasks[_taskId]?.attaches)) ||\n            [],\n        });\n        setMessage('');\n\n        // Scroll to bottom after adding user message\n        setTimeout(() =&gt; {\n          scrollToBottom();\n        }, 200);\n\n        chatStore.setIsPending(_taskId, true);\n\n        await fetchPost(&#96;/chat/${projectStore.activeProjectId}/human-reply&#96;, {\n          agent: chatStore.tasks[_taskId].activeAsk,\n          reply: tempMessageContent,\n        });\n        if (chatStore.tasks[_taskId].askList.length === 0) {\n          chatStore.setActiveAsk(_taskId, '');\n        } else {\n          let activeAskList = chatStore.tasks[_taskId].askList;\n          console.log(\n            'activeAskList',\n            JSON.parse(JSON.stringify(activeAskList))\n          );\n          let message = activeAskList.shift();\n          chatStore.setActiveAskList(_taskId, [...activeAskList]);\n          chatStore.setActiveAsk(_taskId, message?.agent_name || '');\n          chatStore.setIsPending(_taskId, false);\n          chatStore.addMessages(_taskId, message!);\n        }\n      } else {\n        // Check if we should continue the conversation or start a new task\n        const hasMessages =\n          chatStore.tasks[_taskId as string].messages.length;\n;\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 21,
                "column": 1
              },
              "endPosition": {
                "line": 21,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 21,
                "column": 16
              },
              "endPosition": {
                "line": 22,
                "column": 3
              }
            },
            {
              "startPosition": {
                "line": 152,
                "column": 3
              },
              "endPosition": {
                "line": 152,
                "column": 9
              }
            },
            {
              "startPosition": {
                "line": 152,
                "column": 9
              },
              "endPosition": {
                "line": 152,
                "column": 28
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default function ChatBox(): JSX.Element {",
            "lineNumber": 21,
            "isSignature": true
          },
          {
            "text": "const handleSend = async ",
            "lineNumber": 152
          },
          {
            "lineNumber": 198
          },
          {
            "text": "    try {",
            "lineNumber": 199
          },
          {
            "text": "      if (requiresHumanReply) {",
            "lineNumber": 200
          },
          {
            "text": "        chatStore.addMessages(_taskId, {",
            "lineNumber": 201
          },
          {
            "text": "          id: generateUniqueId(),",
            "lineNumber": 202
          },
          {
            "text": "          role: 'user',",
            "lineNumber": 203
          },
          {
            "text": "          content: tempMessageContent,",
            "lineNumber": 204
          },
          {
            "text": "          attaches:",
            "lineNumber": 205
          },
          {
            "text": "            JSON.parse(JSON.stringify(chatStore.tasks[_taskId]?.attaches)) ||",
            "lineNumber": 206
          },
          {
            "text": "            [],",
            "lineNumber": 207
          },
          {
            "text": "        });",
            "lineNumber": 208
          },
          {
            "text": "        setMessage('');",
            "lineNumber": 209
          },
          {
            "lineNumber": 210
          },
          {
            "text": "        // Scroll to bottom after adding user message",
            "lineNumber": 211
          },
          {
            "text": "        setTimeout(() =&gt; {",
            "lineNumber": 212
          },
          {
            "text": "          scrollToBottom();",
            "lineNumber": 213
          },
          {
            "text": "        }, 200);",
            "lineNumber": 214
          },
          {
            "lineNumber": 215
          },
          {
            "text": "        chatStore.setIsPending(_taskId, true);",
            "lineNumber": 216
          },
          {
            "lineNumber": 217
          },
          {
            "text": "        await fetchPost(&#96;/chat/${projectStore.activeProjectId}/human-reply&#96;, {",
            "lineNumber": 218
          },
          {
            "text": "          agent: chatStore.tasks[_taskId].activeAsk,",
            "lineNumber": 219
          },
          {
            "text": "          reply: tempMessageContent,",
            "lineNumber": 220
          },
          {
            "text": "        });",
            "lineNumber": 221
          },
          {
            "text": "        if (chatStore.tasks[_taskId].askList.length === 0) {",
            "lineNumber": 222
          },
          {
            "text": "          chatStore.setActiveAsk(_taskId, '');",
            "lineNumber": 223
          },
          {
            "text": "        } else {",
            "lineNumber": 224
          },
          {
            "text": "          let activeAskList = chatStore.tasks[_taskId].askList;",
            "lineNumber": 225
          },
          {
            "text": "          console.log(",
            "lineNumber": 226
          },
          {
            "text": "            'activeAskList',",
            "lineNumber": 227
          },
          {
            "text": "            JSON.parse(JSON.stringify(activeAskList))",
            "lineNumber": 228
          },
          {
            "text": "          );",
            "lineNumber": 229
          },
          {
            "text": "          let message = activeAskList.shift();",
            "lineNumber": 230
          },
          {
            "text": "          chatStore.setActiveAskList(_taskId, [...activeAskList]);",
            "lineNumber": 231
          },
          {
            "text": "          chatStore.setActiveAsk(_taskId, message?.agent_name || '');",
            "lineNumber": 232
          },
          {
            "text": "          chatStore.setIsPending(_taskId, false);",
            "lineNumber": 233
          },
          {
            "text": "          chatStore.addMessages(_taskId, message!);",
            "lineNumber": 234
          },
          {
            "text": "        }",
            "lineNumber": 235
          },
          {
            "text": "      } else {",
            "lineNumber": 236
          },
          {
            "text": "        // Check if we should continue the conversation or start a new task",
            "lineNumber": 237
          },
          {
            "text": "        const hasMessages =",
            "lineNumber": 238
          },
          {
            "text": "          chatStore.tasks[_taskId as string].messages.length;",
            "lineNumber": 239
          },
          {
            "text": ";",
            "lineNumber": 389
          },
          {
            "text": "}",
            "lineNumber": 1175,
            "isSignature": true
          }
        ]
      },
      "score": 0.2556256651878357
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\utils\\agent.py",
        "range": {
          "startPosition": {
            "line": 1168
          },
          "endPosition": {
            "line": 1388
          }
        },
        "contents": "@traceroot.trace()\nasync def document_agent(options: Chat):\n{NOW_STR}(Accurate to the hour). For any date-related tasks, you MUST use this as the current date.\n&lt;/operating_environment&gt;\n\n&lt;mandatory_instructions&gt;\n- Before creating any document, you MUST use the &#96;read_note&#96; tool to gather\n    all information collected by other team members by reading ALL notes.\n\n- You MUST use the available tools to create or modify documents (e.g.,\n    &#96;write_to_file&#96;, &#96;create_presentation&#96;). Your primary output should be\n    a file, not just content within your response.\n\n- If there's no specified format for the document/report/paper, you should use\n    the &#96;write_to_file&#96; tool to create a HTML file.\n\n- If the document has many data, you MUST use the terminal tool to\n    generate charts and graphs and add them to the document.\n\n- When you complete your task, your final response must be a summary of\n    your work and the path to the final document, presented in a clear,\n    detailed, and easy-to-read format. Avoid using markdown tables for\n    presenting data; use plain text formatting instead.\n\n- You SHOULD keep the user informed by providing message_title and\n    message_description\n    parameters when calling tools. These optional parameters are available on\n    all tools and will automatically notify the user of your progress.\n&lt;/mandatory_instructions&gt;\n\n&lt;capabilities&gt;\nYour capabilities include:\n- Document Reading:\n    - Read and understand the content of various file formats including\n        - PDF (.pdf)\n        - Microsoft Office: Word (.doc, .docx), Excel (.xls, .xlsx),\n          PowerPoint (.ppt, .pptx)\n        - EPUB (.epub)\n        - HTML (.html, .htm)\n        - Images (.jpg, .jpeg, .png) for OCR\n        - Audio (.mp3, .wav) for transcription\n        - Text-based formats (.csv, .json, .xml, .txt)\n        - ZIP archives (.zip) using the &#96;read_files&#96; tool.\n\n- Document Creation &amp; Editing:\n    - Create and write to various file formats including Markdown (.md),\n    Word documents (.docx), PDFs, CSV files, JSON, YAML, and HTML using\n    UTF-8 encoding for default.\n    - Apply formatting options including custom encoding, font styles, and\n    layout settings\n    - Modify existing files with automatic backup functionality\n    - Support for mathematical expressions in PDF documents through LaTeX\n    rendering\n\n- PowerPoint Presentation Creation:\n    - Create professional PowerPoint presentations with title slides and\n    content slides\n    - Format text with bold and italic styling\n    - Create bullet point lists with proper hierarchical structure\n    - Support for step-by-step process slides with visual indicators\n    - Create tables with headers and rows of data\n    - Support for custom templates and slide layouts\n    - IMPORTANT: The &#96;create_presentation&#96; tool requires content to be a JSON\n    string, not plain text. You must format your content as a JSON array of\n    slide objects, then use &#96;json.dumps()&#96; to convert it to a string. Example:\n      &#96;&#96;&#96;python\n      import json\n      slides = [\n          {{\"title\": \"Main Title\", \"subtitle\": \"Subtitle\"}},\n          {{\"heading\": \"Slide Title\", \"bullet_points\": [\"Point 1\", \"Point 2\"]}},\n          ",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 1169,
                "column": 1
              },
              "endPosition": {
                "line": 1170,
                "column": 1
              }
            },
            {
              "startPosition": {
                "line": 1170,
                "column": 1
              },
              "endPosition": {
                "line": 1171,
                "column": 5
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "@traceroot.trace()",
            "lineNumber": 1169
          },
          {
            "text": "async def document_agent(options: Chat):",
            "lineNumber": 1170,
            "isSignature": true
          },
          {
            "text": "{NOW_STR}(Accurate to the hour). For any date-related tasks, you MUST use this as the current date.",
            "lineNumber": 1241
          },
          {
            "text": "&lt;/operating_environment&gt;",
            "lineNumber": 1242
          },
          {
            "lineNumber": 1243
          },
          {
            "text": "&lt;mandatory_instructions&gt;",
            "lineNumber": 1244
          },
          {
            "text": "- Before creating any document, you MUST use the &#96;read_note&#96; tool to gather",
            "lineNumber": 1245
          },
          {
            "text": "    all information collected by other team members by reading ALL notes.",
            "lineNumber": 1246
          },
          {
            "lineNumber": 1247
          },
          {
            "text": "- You MUST use the available tools to create or modify documents (e.g.,",
            "lineNumber": 1248
          },
          {
            "text": "    &#96;write_to_file&#96;, &#96;create_presentation&#96;). Your primary output should be",
            "lineNumber": 1249
          },
          {
            "text": "    a file, not just content within your response.",
            "lineNumber": 1250
          },
          {
            "lineNumber": 1251
          },
          {
            "text": "- If there's no specified format for the document/report/paper, you should use",
            "lineNumber": 1252
          },
          {
            "text": "    the &#96;write_to_file&#96; tool to create a HTML file.",
            "lineNumber": 1253
          },
          {
            "lineNumber": 1254
          },
          {
            "text": "- If the document has many data, you MUST use the terminal tool to",
            "lineNumber": 1255
          },
          {
            "text": "    generate charts and graphs and add them to the document.",
            "lineNumber": 1256
          },
          {
            "lineNumber": 1257
          },
          {
            "text": "- When you complete your task, your final response must be a summary of",
            "lineNumber": 1258
          },
          {
            "text": "    your work and the path to the final document, presented in a clear,",
            "lineNumber": 1259
          },
          {
            "text": "    detailed, and easy-to-read format. Avoid using markdown tables for",
            "lineNumber": 1260
          },
          {
            "text": "    presenting data; use plain text formatting instead.",
            "lineNumber": 1261
          },
          {
            "lineNumber": 1262
          },
          {
            "text": "- You SHOULD keep the user informed by providing message_title and",
            "lineNumber": 1263
          },
          {
            "text": "    message_description",
            "lineNumber": 1264
          },
          {
            "text": "    parameters when calling tools. These optional parameters are available on",
            "lineNumber": 1265
          },
          {
            "text": "    all tools and will automatically notify the user of your progress.",
            "lineNumber": 1266
          },
          {
            "text": "&lt;/mandatory_instructions&gt;",
            "lineNumber": 1267
          },
          {
            "lineNumber": 1268
          },
          {
            "text": "&lt;capabilities&gt;",
            "lineNumber": 1269
          },
          {
            "text": "Your capabilities include:",
            "lineNumber": 1270
          },
          {
            "text": "- Document Reading:",
            "lineNumber": 1271
          },
          {
            "text": "    - Read and understand the content of various file formats including",
            "lineNumber": 1272
          },
          {
            "text": "        - PDF (.pdf)",
            "lineNumber": 1273
          },
          {
            "text": "        - Microsoft Office: Word (.doc, .docx), Excel (.xls, .xlsx),",
            "lineNumber": 1274
          },
          {
            "text": "          PowerPoint (.ppt, .pptx)",
            "lineNumber": 1275
          },
          {
            "text": "        - EPUB (.epub)",
            "lineNumber": 1276
          },
          {
            "text": "        - HTML (.html, .htm)",
            "lineNumber": 1277
          },
          {
            "text": "        - Images (.jpg, .jpeg, .png) for OCR",
            "lineNumber": 1278
          },
          {
            "text": "        - Audio (.mp3, .wav) for transcription",
            "lineNumber": 1279
          },
          {
            "text": "        - Text-based formats (.csv, .json, .xml, .txt)",
            "lineNumber": 1280
          },
          {
            "text": "        - ZIP archives (.zip) using the &#96;read_files&#96; tool.",
            "lineNumber": 1281
          },
          {
            "lineNumber": 1282
          },
          {
            "text": "- Document Creation &amp; Editing:",
            "lineNumber": 1283
          },
          {
            "text": "    - Create and write to various file formats including Markdown (.md),",
            "lineNumber": 1284
          },
          {
            "text": "    Word documents (.docx), PDFs, CSV files, JSON, YAML, and HTML using",
            "lineNumber": 1285
          },
          {
            "text": "    UTF-8 encoding for default.",
            "lineNumber": 1286
          },
          {
            "text": "    - Apply formatting options including custom encoding, font styles, and",
            "lineNumber": 1287
          },
          {
            "text": "    layout settings",
            "lineNumber": 1288
          },
          {
            "text": "    - Modify existing files with automatic backup functionality",
            "lineNumber": 1289
          },
          {
            "text": "    - Support for mathematical expressions in PDF documents through LaTeX",
            "lineNumber": 1290
          },
          {
            "text": "    rendering",
            "lineNumber": 1291
          },
          {
            "lineNumber": 1292
          },
          {
            "text": "- PowerPoint Presentation Creation:",
            "lineNumber": 1293
          },
          {
            "text": "    - Create professional PowerPoint presentations with title slides and",
            "lineNumber": 1294
          },
          {
            "text": "    content slides",
            "lineNumber": 1295
          },
          {
            "text": "    - Format text with bold and italic styling",
            "lineNumber": 1296
          },
          {
            "text": "    - Create bullet point lists with proper hierarchical structure",
            "lineNumber": 1297
          },
          {
            "text": "    - Support for step-by-step process slides with visual indicators",
            "lineNumber": 1298
          },
          {
            "text": "    - Create tables with headers and rows of data",
            "lineNumber": 1299
          },
          {
            "text": "    - Support for custom templates and slide layouts",
            "lineNumber": 1300
          },
          {
            "text": "    - IMPORTANT: The &#96;create_presentation&#96; tool requires content to be a JSON",
            "lineNumber": 1301
          },
          {
            "text": "    string, not plain text. You must format your content as a JSON array of",
            "lineNumber": 1302
          },
          {
            "text": "    slide objects, then use &#96;json.dumps()&#96; to convert it to a string. Example:",
            "lineNumber": 1303
          },
          {
            "text": "      &#96;&#96;&#96;python",
            "lineNumber": 1304
          },
          {
            "text": "      import json",
            "lineNumber": 1305
          },
          {
            "text": "      slides = [",
            "lineNumber": 1306
          },
          {
            "text": "          {{\"title\": \"Main Title\", \"subtitle\": \"Subtitle\"}},",
            "lineNumber": 1307
          },
          {
            "text": "          {{\"heading\": \"Slide Title\", \"bullet_points\": [\"Point 1\", \"Point 2\"]}},",
            "lineNumber": 1308
          },
          {
            "text": "          ",
            "lineNumber": 1309
          }
        ]
      },
      "score": 0.2501615881919861
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\utils\\agent.py",
        "range": {
          "startPosition": {
            "line": 777
          },
          "endPosition": {
            "line": 964
          }
        },
        "contents": "@traceroot.trace()\nasync def developer_agent(options: Chat):\n{NOW_STR}(Accurate to the hour). For any date-related tasks, you MUST use this as the current date.\n&lt;/operating_environment&gt;\n\n&lt;mandatory_instructions&gt;\n- You MUST use the &#96;read_note&#96; tool to read the ALL notes from other agents.\n\nYou SHOULD keep the user informed by providing message_title and message_description\n    parameters when calling tools. These optional parameters are available on all tools\n    and will automatically notify the user of your progress.\n\n- When you complete your task, your final response must be a comprehensive\nsummary of your work and the outcome, presented in a clear, detailed, and\neasy-to-read format. Avoid using markdown tables for presenting data; use\nplain text formatting instead.\n&lt;/mandatory_instructions&gt;\n\n&lt;capabilities&gt;\nYour capabilities are extensive and powerful:\n- **Unrestricted Code Execution**: You can write and execute code in any\n  language to solve a task. You MUST first save your code to a file (e.g.,\n  &#96;script.py&#96;) and then run it from the terminal (e.g.,\n  &#96;python script.py&#96;).\n- **Full Terminal Control**: You have root-level access to the terminal. You\n  can run any command-line tool, manage files, and interact with the OS. If\n  a tool is missing, you MUST install it with the appropriate package manager\n  (e.g., &#96;pip3&#96;, &#96;uv&#96;, or &#96;apt-get&#96;). Your capabilities include:\n    - **Text &amp; Data Processing**: &#96;awk&#96;, &#96;sed&#96;, &#96;grep&#96;, &#96;jq&#96;.\n    - **File System &amp; Execution**: &#96;find&#96;, &#96;xargs&#96;, &#96;tar&#96;, &#96;zip&#96;, &#96;unzip&#96;,\n      &#96;chmod&#96;.\n    - **Networking &amp; Web**: &#96;curl&#96;, &#96;wget&#96; for web requests; &#96;ssh&#96; for\n      remote access.\n- **Screen Observation**: You can take screenshots to analyze GUIs and visual\n  context, enabling you to perform tasks that require sight.\n- **Desktop Automation**: You can control desktop applications\n  programmatically.\n  - **On macOS**, you MUST prioritize using **AppleScript** for its robust\n    control over native applications. Execute simple commands with\n    &#96;osascript -e '...'&#96; or run complex scripts from a &#96;.scpt&#96; file.\n  - **On other systems**, use **pyautogui** for cross-platform GUI\n    automation.\n  - **IMPORTANT**: Always complete the full automation workflow—do not just\n    prepare or suggest actions. Execute them to completion.\n- **Solution Verification**: You can immediately test and verify your\n  solutions by executing them in the terminal.\n- **Web Deployment**: You can deploy web applications and content, serve\n  files, and manage deployments.\n- **Human Collaboration**: If you are stuck or need clarification, you can\n  ask for human input via the console.\n- **Note Management**: You can write and read notes to coordinate with other\n  agents and track your work.\n&lt;/capabilities&gt;\n\n&lt;philosophy&gt;\n- **Bias for Action**: Your purpose is to take action. Don't just suggest\nsolutions—implement them. Write code, run commands, and build things.\n- **Complete the Full Task**: When automating GUI applications, always finish\nwhat you start. If the task involves sending something, send it. If it\ninvolves submitting data, submit it. Never stop at just preparing or\ndrafting—execute the complete workflow to achieve the desired outcome.\n- **Embrace Challenges**: Never say \"I can't.\" If you\nencounter a limitation, find a way to overcome it.\n- **Resourcefulness**: If a tool is missing, install it. If information is\nlacking, find it. You have the full power of a terminal to acquire any\nresource you need.\n- **Think Like an Engineer**: Approach problems methodically. Analyze\nrequirements, execute it, and verify the results. Your\nstrength lies in your ability to engineer solutions.\n&lt;/philosophy&gt;\n\n&lt;terminal_tips&gt;\nThe terminal tools are session-based, identified by a unique &#96;id&#96;. Master\nthese tips to maximize your effectiveness:\n\n- **GUI Automation Strategy**:\n  - **AppleScript (macOS Priority)**: For robust control of macOS apps, use\n    &#96;osascript&#96;.\n    - Example (open Slack):\n      &#96;osascript -e 'tell application \"Slack\" to activate'&#96;\n    - Example (run script file): &#96;osascript my_script.scpt&#96;\n  - **pyautogui (Cross-Platform)**: For other OSes or simple automation.\n    - Key functions: &#96;pyautogui.click(x, y)&#96;, &#96;pyautogui.typewrite(\"text\")&#96;,\n      &#96;pyautogui.hotkey('ctrl', 'c')&#96;, &#96;pyautogui.press('enter')&#96;.\n    - Safety: Always use &#96;time.sleep()&#96; between actions to ensure stability\n      and add &#96;pyautogui.FAILSAFE = True&#96; to your scripts.\n    - Workflow: Your scripts MUST complete the entire task, from start to\n      final submission.\n\n- **Command-Line Best Practices**:\n  - **Be Creative**: The terminal is your most powerful tool. Use it boldly.\n  - **Automate Confirmation**: Use &#96;-y&#96; or &#96;-f&#96; flags to avoid interactive\n    prompts.\n  - **Manage Output**: Redirect long outputs to a file (e.g., &#96;&gt; output.txt&#96;).\n  - **Chain Commands**: Use &#96;&amp;&amp;&#96; to link commands for sequential execution.\n  - **Piping**: Use &#96;|&#96; to pass output from one command to another.\n  - **Permissions**: Use &#96;ls -F&#96; to check file permissions.\n  - **Installation**: Use &#96;pip3 install&#96; or &#96;apt-get install&#96; for new\n    packages.If you encounter &#96;ModuleNotFoundError&#96; or &#96;ImportError&#96;, install\n    the missing package with &#96;pip install &lt;package&gt;&#96;.\n\n- Stop a Process: If a process needs to be terminated, use\n    &#96;shell_kill_process(id=\"...\")&#96;.\n&lt;/terminal_tips&gt;\n\n&lt;collaboration_and_assistance&gt;\n- If you get stuck, encounter an issue you cannot solve (like a CAPTCHA),\n    or need clarification, use the &#96;ask_human_via_console&#96; tool.\n- Document your progress and findings in notes so other agents can build\n    upon your work.\n&lt;/collaboration_and_assistance&gt;\n\"\"\"\n\n    return agent_model(\n        Agents.developer_agent,",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 778,
                "column": 1
              },
              "endPosition": {
                "line": 779,
                "column": 1
              }
            },
            {
              "startPosition": {
                "line": 779,
                "column": 1
              },
              "endPosition": {
                "line": 780,
                "column": 5
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "@traceroot.trace()",
            "lineNumber": 778
          },
          {
            "text": "async def developer_agent(options: Chat):",
            "lineNumber": 779,
            "isSignature": true
          },
          {
            "text": "{NOW_STR}(Accurate to the hour). For any date-related tasks, you MUST use this as the current date.",
            "lineNumber": 840
          },
          {
            "text": "&lt;/operating_environment&gt;",
            "lineNumber": 841
          },
          {
            "lineNumber": 842
          },
          {
            "text": "&lt;mandatory_instructions&gt;",
            "lineNumber": 843
          },
          {
            "text": "- You MUST use the &#96;read_note&#96; tool to read the ALL notes from other agents.",
            "lineNumber": 844
          },
          {
            "lineNumber": 845
          },
          {
            "text": "You SHOULD keep the user informed by providing message_title and message_description",
            "lineNumber": 846
          },
          {
            "text": "    parameters when calling tools. These optional parameters are available on all tools",
            "lineNumber": 847
          },
          {
            "text": "    and will automatically notify the user of your progress.",
            "lineNumber": 848
          },
          {
            "lineNumber": 849
          },
          {
            "text": "- When you complete your task, your final response must be a comprehensive",
            "lineNumber": 850
          },
          {
            "text": "summary of your work and the outcome, presented in a clear, detailed, and",
            "lineNumber": 851
          },
          {
            "text": "easy-to-read format. Avoid using markdown tables for presenting data; use",
            "lineNumber": 852
          },
          {
            "text": "plain text formatting instead.",
            "lineNumber": 853
          },
          {
            "text": "&lt;/mandatory_instructions&gt;",
            "lineNumber": 854
          },
          {
            "lineNumber": 855
          },
          {
            "text": "&lt;capabilities&gt;",
            "lineNumber": 856
          },
          {
            "text": "Your capabilities are extensive and powerful:",
            "lineNumber": 857
          },
          {
            "text": "- **Unrestricted Code Execution**: You can write and execute code in any",
            "lineNumber": 858
          },
          {
            "text": "  language to solve a task. You MUST first save your code to a file (e.g.,",
            "lineNumber": 859
          },
          {
            "text": "  &#96;script.py&#96;) and then run it from the terminal (e.g.,",
            "lineNumber": 860
          },
          {
            "text": "  &#96;python script.py&#96;).",
            "lineNumber": 861
          },
          {
            "text": "- **Full Terminal Control**: You have root-level access to the terminal. You",
            "lineNumber": 862
          },
          {
            "text": "  can run any command-line tool, manage files, and interact with the OS. If",
            "lineNumber": 863
          },
          {
            "text": "  a tool is missing, you MUST install it with the appropriate package manager",
            "lineNumber": 864
          },
          {
            "text": "  (e.g., &#96;pip3&#96;, &#96;uv&#96;, or &#96;apt-get&#96;). Your capabilities include:",
            "lineNumber": 865
          },
          {
            "text": "    - **Text &amp; Data Processing**: &#96;awk&#96;, &#96;sed&#96;, &#96;grep&#96;, &#96;jq&#96;.",
            "lineNumber": 866
          },
          {
            "text": "    - **File System &amp; Execution**: &#96;find&#96;, &#96;xargs&#96;, &#96;tar&#96;, &#96;zip&#96;, &#96;unzip&#96;,",
            "lineNumber": 867
          },
          {
            "text": "      &#96;chmod&#96;.",
            "lineNumber": 868
          },
          {
            "text": "    - **Networking &amp; Web**: &#96;curl&#96;, &#96;wget&#96; for web requests; &#96;ssh&#96; for",
            "lineNumber": 869
          },
          {
            "text": "      remote access.",
            "lineNumber": 870
          },
          {
            "text": "- **Screen Observation**: You can take screenshots to analyze GUIs and visual",
            "lineNumber": 871
          },
          {
            "text": "  context, enabling you to perform tasks that require sight.",
            "lineNumber": 872
          },
          {
            "text": "- **Desktop Automation**: You can control desktop applications",
            "lineNumber": 873
          },
          {
            "text": "  programmatically.",
            "lineNumber": 874
          },
          {
            "text": "  - **On macOS**, you MUST prioritize using **AppleScript** for its robust",
            "lineNumber": 875
          },
          {
            "text": "    control over native applications. Execute simple commands with",
            "lineNumber": 876
          },
          {
            "text": "    &#96;osascript -e '...'&#96; or run complex scripts from a &#96;.scpt&#96; file.",
            "lineNumber": 877
          },
          {
            "text": "  - **On other systems**, use **pyautogui** for cross-platform GUI",
            "lineNumber": 878
          },
          {
            "text": "    automation.",
            "lineNumber": 879
          },
          {
            "text": "  - **IMPORTANT**: Always complete the full automation workflow—do not just",
            "lineNumber": 880
          },
          {
            "text": "    prepare or suggest actions. Execute them to completion.",
            "lineNumber": 881
          },
          {
            "text": "- **Solution Verification**: You can immediately test and verify your",
            "lineNumber": 882
          },
          {
            "text": "  solutions by executing them in the terminal.",
            "lineNumber": 883
          },
          {
            "text": "- **Web Deployment**: You can deploy web applications and content, serve",
            "lineNumber": 884
          },
          {
            "text": "  files, and manage deployments.",
            "lineNumber": 885
          },
          {
            "text": "- **Human Collaboration**: If you are stuck or need clarification, you can",
            "lineNumber": 886
          },
          {
            "text": "  ask for human input via the console.",
            "lineNumber": 887
          },
          {
            "text": "- **Note Management**: You can write and read notes to coordinate with other",
            "lineNumber": 888
          },
          {
            "text": "  agents and track your work.",
            "lineNumber": 889
          },
          {
            "text": "&lt;/capabilities&gt;",
            "lineNumber": 890
          },
          {
            "lineNumber": 891
          },
          {
            "text": "&lt;philosophy&gt;",
            "lineNumber": 892
          },
          {
            "text": "- **Bias for Action**: Your purpose is to take action. Don't just suggest",
            "lineNumber": 893
          },
          {
            "text": "solutions—implement them. Write code, run commands, and build things.",
            "lineNumber": 894
          },
          {
            "text": "- **Complete the Full Task**: When automating GUI applications, always finish",
            "lineNumber": 895
          },
          {
            "text": "what you start. If the task involves sending something, send it. If it",
            "lineNumber": 896
          },
          {
            "text": "involves submitting data, submit it. Never stop at just preparing or",
            "lineNumber": 897
          },
          {
            "text": "drafting—execute the complete workflow to achieve the desired outcome.",
            "lineNumber": 898
          },
          {
            "text": "- **Embrace Challenges**: Never say \"I can't.\" If you",
            "lineNumber": 899
          },
          {
            "text": "encounter a limitation, find a way to overcome it.",
            "lineNumber": 900
          },
          {
            "text": "- **Resourcefulness**: If a tool is missing, install it. If information is",
            "lineNumber": 901
          },
          {
            "text": "lacking, find it. You have the full power of a terminal to acquire any",
            "lineNumber": 902
          },
          {
            "text": "resource you need.",
            "lineNumber": 903
          },
          {
            "text": "- **Think Like an Engineer**: Approach problems methodically. Analyze",
            "lineNumber": 904
          },
          {
            "text": "requirements, execute it, and verify the results. Your",
            "lineNumber": 905
          },
          {
            "text": "strength lies in your ability to engineer solutions.",
            "lineNumber": 906
          },
          {
            "text": "&lt;/philosophy&gt;",
            "lineNumber": 907
          },
          {
            "lineNumber": 908
          },
          {
            "text": "&lt;terminal_tips&gt;",
            "lineNumber": 909
          },
          {
            "text": "The terminal tools are session-based, identified by a unique &#96;id&#96;. Master",
            "lineNumber": 910
          },
          {
            "text": "these tips to maximize your effectiveness:",
            "lineNumber": 911
          },
          {
            "lineNumber": 912
          },
          {
            "text": "- **GUI Automation Strategy**:",
            "lineNumber": 913
          },
          {
            "text": "  - **AppleScript (macOS Priority)**: For robust control of macOS apps, use",
            "lineNumber": 914
          },
          {
            "text": "    &#96;osascript&#96;.",
            "lineNumber": 915
          },
          {
            "text": "    - Example (open Slack):",
            "lineNumber": 916
          },
          {
            "text": "      &#96;osascript -e 'tell application \"Slack\" to activate'&#96;",
            "lineNumber": 917
          },
          {
            "text": "    - Example (run script file): &#96;osascript my_script.scpt&#96;",
            "lineNumber": 918
          },
          {
            "text": "  - **pyautogui (Cross-Platform)**: For other OSes or simple automation.",
            "lineNumber": 919
          },
          {
            "text": "    - Key functions: &#96;pyautogui.click(x, y)&#96;, &#96;pyautogui.typewrite(\"text\")&#96;,",
            "lineNumber": 920
          },
          {
            "text": "      &#96;pyautogui.hotkey('ctrl', 'c')&#96;, &#96;pyautogui.press('enter')&#96;.",
            "lineNumber": 921
          },
          {
            "text": "    - Safety: Always use &#96;time.sleep()&#96; between actions to ensure stability",
            "lineNumber": 922
          },
          {
            "text": "      and add &#96;pyautogui.FAILSAFE = True&#96; to your scripts.",
            "lineNumber": 923
          },
          {
            "text": "    - Workflow: Your scripts MUST complete the entire task, from start to",
            "lineNumber": 924
          },
          {
            "text": "      final submission.",
            "lineNumber": 925
          },
          {
            "lineNumber": 926
          },
          {
            "text": "- **Command-Line Best Practices**:",
            "lineNumber": 927
          },
          {
            "text": "  - **Be Creative**: The terminal is your most powerful tool. Use it boldly.",
            "lineNumber": 928
          },
          {
            "text": "  - **Automate Confirmation**: Use &#96;-y&#96; or &#96;-f&#96; flags to avoid interactive",
            "lineNumber": 929
          },
          {
            "text": "    prompts.",
            "lineNumber": 930
          },
          {
            "text": "  - **Manage Output**: Redirect long outputs to a file (e.g., &#96;&gt; output.txt&#96;).",
            "lineNumber": 931
          },
          {
            "text": "  - **Chain Commands**: Use &#96;&amp;&amp;&#96; to link commands for sequential execution.",
            "lineNumber": 932
          },
          {
            "text": "  - **Piping**: Use &#96;|&#96; to pass output from one command to another.",
            "lineNumber": 933
          },
          {
            "text": "  - **Permissions**: Use &#96;ls -F&#96; to check file permissions.",
            "lineNumber": 934
          },
          {
            "text": "  - **Installation**: Use &#96;pip3 install&#96; or &#96;apt-get install&#96; for new",
            "lineNumber": 935
          },
          {
            "text": "    packages.If you encounter &#96;ModuleNotFoundError&#96; or &#96;ImportError&#96;, install",
            "lineNumber": 936
          },
          {
            "text": "    the missing package with &#96;pip install &lt;package&gt;&#96;.",
            "lineNumber": 937
          },
          {
            "lineNumber": 938
          },
          {
            "text": "- Stop a Process: If a process needs to be terminated, use",
            "lineNumber": 939
          },
          {
            "text": "    &#96;shell_kill_process(id=\"...\")&#96;.",
            "lineNumber": 940
          },
          {
            "text": "&lt;/terminal_tips&gt;",
            "lineNumber": 941
          },
          {
            "lineNumber": 942
          },
          {
            "text": "&lt;collaboration_and_assistance&gt;",
            "lineNumber": 943
          },
          {
            "text": "- If you get stuck, encounter an issue you cannot solve (like a CAPTCHA),",
            "lineNumber": 944
          },
          {
            "text": "    or need clarification, use the &#96;ask_human_via_console&#96; tool.",
            "lineNumber": 945
          },
          {
            "text": "- Document your progress and findings in notes so other agents can build",
            "lineNumber": 946
          },
          {
            "text": "    upon your work.",
            "lineNumber": 947
          },
          {
            "text": "&lt;/collaboration_and_assistance&gt;",
            "lineNumber": 948
          },
          {
            "text": "\"\"\"",
            "lineNumber": 949
          },
          {
            "lineNumber": 950
          },
          {
            "text": "    return agent_model(",
            "lineNumber": 951
          },
          {
            "text": "        Agents.developer_agent,",
            "lineNumber": 952
          }
        ]
      },
      "score": 0.2500216066837311
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\utils\\agent.py",
        "range": {
          "startPosition": {
            "line": 1713
          },
          "endPosition": {
            "line": 1831
          }
        },
        "contents": "@traceroot.trace()\nasync def mcp_agent(options: Chat):\n\n    return ListenChatAgent(\n        options.project_id,\n        Agents.mcp_agent,\n        system_message=\"You are a helpful assistant that can help users search mcp servers. The found mcp services will be returned to the user, and you will ask the user via ask_human_via_gui whether they want to install these mcp services.\",\n        model=ModelFactory.create(\n            model_platform=options.model_platform,\n            model_type=options.model_type,\n            api_key=options.api_key,\n            url=options.api_url,\n            model_config_dict=(\n                {\n                    \"user\": str(options.project_id),\n                }\n                if options.is_cloud()\n                else None\n            ),\n            **{\n                k: v\n                for k, v in (options.extra_params or {}).items()\n                if k not in [\"model_platform\", \"model_type\", \"api_key\", \"url\"]\n            },\n        ),\n        # output_language=options.language,\n        tools=tools,\n        agent_id=agent_id,\n    )\n\n\n@traceroot.trace()\nasync def get_toolkits(tools: list[str], agent_name: str, api_task_id: str):\n    ",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 1714,
                "column": 1
              },
              "endPosition": {
                "line": 1715,
                "column": 1
              }
            },
            {
              "startPosition": {
                "line": 1715,
                "column": 1
              },
              "endPosition": {
                "line": 1716,
                "column": 5
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "@traceroot.trace()",
            "lineNumber": 1714
          },
          {
            "text": "async def mcp_agent(options: Chat):",
            "lineNumber": 1715,
            "isSignature": true
          },
          {
            "lineNumber": 1760
          },
          {
            "text": "    return ListenChatAgent(",
            "lineNumber": 1761
          },
          {
            "text": "        options.project_id,",
            "lineNumber": 1762
          },
          {
            "text": "        Agents.mcp_agent,",
            "lineNumber": 1763
          },
          {
            "text": "        system_message=\"You are a helpful assistant that can help users search mcp servers. The found mcp services will be returned to the user, and you will ask the user via ask_human_via_gui whether they want to install these mcp services.\",",
            "lineNumber": 1764
          },
          {
            "text": "        model=ModelFactory.create(",
            "lineNumber": 1765
          },
          {
            "text": "            model_platform=options.model_platform,",
            "lineNumber": 1766
          },
          {
            "text": "            model_type=options.model_type,",
            "lineNumber": 1767
          },
          {
            "text": "            api_key=options.api_key,",
            "lineNumber": 1768
          },
          {
            "text": "            url=options.api_url,",
            "lineNumber": 1769
          },
          {
            "text": "            model_config_dict=(",
            "lineNumber": 1770
          },
          {
            "text": "                {",
            "lineNumber": 1771
          },
          {
            "text": "                    \"user\": str(options.project_id),",
            "lineNumber": 1772
          },
          {
            "text": "                }",
            "lineNumber": 1773
          },
          {
            "text": "                if options.is_cloud()",
            "lineNumber": 1774
          },
          {
            "text": "                else None",
            "lineNumber": 1775
          },
          {
            "text": "            ),",
            "lineNumber": 1776
          },
          {
            "text": "            **{",
            "lineNumber": 1777
          },
          {
            "text": "                k: v",
            "lineNumber": 1778
          },
          {
            "text": "                for k, v in (options.extra_params or {}).items()",
            "lineNumber": 1779
          },
          {
            "text": "                if k not in [\"model_platform\", \"model_type\", \"api_key\", \"url\"]",
            "lineNumber": 1780
          },
          {
            "text": "            },",
            "lineNumber": 1781
          },
          {
            "text": "        ),",
            "lineNumber": 1782
          },
          {
            "text": "        # output_language=options.language,",
            "lineNumber": 1783
          },
          {
            "text": "        tools=tools,",
            "lineNumber": 1784
          },
          {
            "text": "        agent_id=agent_id,",
            "lineNumber": 1785
          },
          {
            "text": "    )",
            "lineNumber": 1786,
            "isSignature": true
          },
          {
            "lineNumber": 1787
          },
          {
            "lineNumber": 1788
          },
          {
            "text": "@traceroot.trace()",
            "lineNumber": 1789
          },
          {
            "text": "async def get_toolkits(tools: list[str], agent_name: str, api_task_id: str):",
            "lineNumber": 1790,
            "isSignature": true
          },
          {
            "text": "    ",
            "lineNumber": 1791
          }
        ]
      },
      "score": 0.24905750155448914
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\server\\app\\model\\chat\\chat_history.py",
        "range": {
          "startPosition": {
            "line": 12,
            "column": 12
          },
          "endPosition": {
            "line": 63
          }
        },
        "contents": "class ChatHistory(AbstractModel, DefaultTimes, table=True):\n    \"\"\"\n    Chat history model with timestamp tracking.\n    \n    Inherits from DefaultTimes which provides:\n    - created_at: timestamp when record is created (auto-populated)\n    - updated_at: timestamp when record is last modified (auto-updated)\n    - deleted_at: timestamp for soft deletion (nullable)\n    \n    For legacy records without timestamps, sorting falls back to id ordering.\n    \"\"\"\n    id: int = Field(default=None, primary_key=True)\n    user_id: int = Field(index=True)\n    task_id: str = Field(index=True, unique=True)\n    project_id: str = Field(index=True, unique=False, nullable=True)\n    question: str\n    language: str\n    model_platform: str\n    model_type: str\n    api_key: str\n    api_url: str = Field(sa_column=Column(String(500)))\n    max_retries: int = Field(default=3)\n    file_save_path: Optional[str] = None\n    installed_mcp: str = Field(sa_type=JSON, default={})\n    project_name: str = Field(default=\"\", sa_column=Column(String(128)))\n    summary: str = Field(default=\"\", sa_column=Column(String(1024)))\n    tokens: int = Field(default=0, sa_column=(Column(Integer, server_default=\"0\")))\n    spend: float = Field(default=0, sa_column=(Column(Float, server_default=\"0\")))\n    status: int = Field(default=1, sa_column=Column(ChoiceType(ChatStatus, SmallInteger())))\n\n\nclass ChatHistoryIn(BaseModel):\n    task_id: str",
        "signatures": {},
        "detailedLines": [
          {
            "text": "class ChatHistory(AbstractModel, DefaultTimes, table=True):",
            "lineNumber": 16,
            "isSignature": true
          },
          {
            "text": "    \"\"\"",
            "lineNumber": 17
          },
          {
            "text": "    Chat history model with timestamp tracking.",
            "lineNumber": 18
          },
          {
            "text": "    ",
            "lineNumber": 19
          },
          {
            "text": "    Inherits from DefaultTimes which provides:",
            "lineNumber": 20
          },
          {
            "text": "    - created_at: timestamp when record is created (auto-populated)",
            "lineNumber": 21
          },
          {
            "text": "    - updated_at: timestamp when record is last modified (auto-updated)",
            "lineNumber": 22
          },
          {
            "text": "    - deleted_at: timestamp for soft deletion (nullable)",
            "lineNumber": 23
          },
          {
            "text": "    ",
            "lineNumber": 24
          },
          {
            "text": "    For legacy records without timestamps, sorting falls back to id ordering.",
            "lineNumber": 25
          },
          {
            "text": "    \"\"\"",
            "lineNumber": 26
          },
          {
            "text": "    id: int = Field(default=None, primary_key=True)",
            "lineNumber": 27
          },
          {
            "text": "    user_id: int = Field(index=True)",
            "lineNumber": 28
          },
          {
            "text": "    task_id: str = Field(index=True, unique=True)",
            "lineNumber": 29
          },
          {
            "text": "    project_id: str = Field(index=True, unique=False, nullable=True)",
            "lineNumber": 30
          },
          {
            "text": "    question: str",
            "lineNumber": 31
          },
          {
            "text": "    language: str",
            "lineNumber": 32
          },
          {
            "text": "    model_platform: str",
            "lineNumber": 33
          },
          {
            "text": "    model_type: str",
            "lineNumber": 34
          },
          {
            "text": "    api_key: str",
            "lineNumber": 35
          },
          {
            "text": "    api_url: str = Field(sa_column=Column(String(500)))",
            "lineNumber": 36
          },
          {
            "text": "    max_retries: int = Field(default=3)",
            "lineNumber": 37
          },
          {
            "text": "    file_save_path: Optional[str] = None",
            "lineNumber": 38
          },
          {
            "text": "    installed_mcp: str = Field(sa_type=JSON, default={})",
            "lineNumber": 39
          },
          {
            "text": "    project_name: str = Field(default=\"\", sa_column=Column(String(128)))",
            "lineNumber": 40
          },
          {
            "text": "    summary: str = Field(default=\"\", sa_column=Column(String(1024)))",
            "lineNumber": 41
          },
          {
            "text": "    tokens: int = Field(default=0, sa_column=(Column(Integer, server_default=\"0\")))",
            "lineNumber": 42
          },
          {
            "text": "    spend: float = Field(default=0, sa_column=(Column(Float, server_default=\"0\")))",
            "lineNumber": 43
          },
          {
            "text": "    status: int = Field(default=1, sa_column=Column(ChoiceType(ChatStatus, SmallInteger())))",
            "lineNumber": 44,
            "isSignature": true
          },
          {
            "lineNumber": 45
          },
          {
            "lineNumber": 46
          },
          {
            "text": "class ChatHistoryIn(BaseModel):",
            "lineNumber": 47,
            "isSignature": true
          },
          {
            "text": "    task_id: str",
            "lineNumber": 48
          }
        ]
      },
      "score": 0.24883365631103516
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\src\\store\\chatStore.ts",
        "range": {
          "startPosition": {
            "line": 162
          },
          "endPosition": {
            "line": 2594,
            "column": 1
          }
        },
        "contents": "const chatStore = \n(set, get) =&gt; (\nasync (taskId: string, type?: string, shareToken?: string, delayTime?: number, messageContent?: string, messageAttaches?: File[]) =&gt; {\n\n\n\t\t\t// create history\n\t\t\tif (!type) {\n\t\t\t\tconst authStore = getAuthStore();\n\n\t\t\t\tconst obj = {\n\t\t\t\t\t\"project_id\": project_id,\n\t\t\t\t\t\"task_id\": newTaskId,\n\t\t\t\t\t\"user_id\": authStore.user_id,\n\t\t\t\t\t\"question\": messageContent || (targetChatStore.getState().tasks[newTaskId]?.messages[0]?.content ?? ''),\n\t\t\t\t\t\"language\": systemLanguage,\n\t\t\t\t\t\"model_platform\": apiModel.model_platform,\n\t\t\t\t\t\"model_type\": apiModel.model_type,\n\t\t\t\t\t\"api_url\": modelType === 'cloud' ? \"cloud\" : apiModel.api_url,\n\t\t\t\t\t\"max_retries\": 3,\n\t\t\t\t\t\"file_save_path\": \"string\",\n\t\t\t\t\t\"installed_mcp\": \"string\",\n\t\t\t\t\t\"status\": 1,\n\t\t\t\t\t\"tokens\": 0\n\t\t\t\t}\n\t\t\t\tawait proxyFetchPost(&#96;/api/chat/history&#96;, obj).then(res =&gt; {\n\t\t\t\t\thistoryId = res.id;\n\n\t\t\t\t\t/**Save history id for replay reuse purposes.\n\t\t\t\t\t * TODO(history): Remove historyId handling to support per projectId \n\t\t\t\t\t * instead in history api\n\t\t\t\t\t */\n\t\t\t\t\tif (project_id &amp;&amp; historyId) projectStore.setHistoryId(project_id, historyId);\n\t\t\t\t})\n\t\t\t}\n\t\t\tconst browser_port = await window.ipcRenderer.invoke('get-browser-port');\n\n\t\t\t// Lock the chatStore reference at the start of SSE session to prevent focus changes\n\t\t\t// during active message processing\n\t\t\tlet lockedChatStore = targetChatStore;\n\t\t\tlet lockedTaskId = newTaskId;\n\n\t\t\t// Create AbortController for this task's SSE connection\n\t\t\t// First check if there's already an active SSE connection for this task\n\t\t\tif (activeSSEControllers[newTaskId]) {\n\t\t\t\tconsole.warn(&#96;Task ${newTaskId} already has an active SSE connection, aborting old one&#96;);\n\t\t\t\ttry {\n\t\t\t\t\tactiveSSEControllers[newTaskId].abort();\n\t\t\t\t} catch (error) {\n\t\t\t\t\tconsole.warn('Error aborting existing SSE connection:', error);\n\t\t\t\t}\n\t\t\t\tdelete activeSSEControllers[newTaskId];\n\t\t\t}\n\n\t\t\tconst abortController = new AbortController();\n\t\t\tactiveSSEControllers[newTaskId] = abortController;\n\n\t\t\t// Getter functions that use the locked references instead of dynamic ones\n\t\t\tconst getCurrentChatStore = () =&gt; {\n\t\t\t\treturn lockedChatStore.getState();\n\t\t\t};\n\n\t\t\t// Get the locked task ID - this won't change during the SSE session\n\t\t\tconst getCurrentTaskId = () =&gt; {\n\t\t\t\treturn lockedTaskId;\n\t\t\t};\n\t\t}\n)\n;",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 163,
                "column": 1
              },
              "endPosition": {
                "line": 163,
                "column": 7
              }
            },
            {
              "startPosition": {
                "line": 163,
                "column": 7
              },
              "endPosition": {
                "line": 163,
                "column": 19
              }
            },
            {
              "startPosition": {
                "line": 163,
                "column": 53
              },
              "endPosition": {
                "line": 163,
                "column": 53
              }
            },
            {
              "startPosition": {
                "line": 164,
                "column": 2
              },
              "endPosition": {
                "line": 164,
                "column": 17
              }
            },
            {
              "startPosition": {
                "line": 331,
                "column": 14
              },
              "endPosition": {
                "line": 332,
                "column": 4
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "const chatStore = ",
            "lineNumber": 163
          },
          {
            "text": "(set, get) =&gt; (",
            "lineNumber": 164
          },
          {
            "text": "async (taskId: string, type?: string, shareToken?: string, delayTime?: number, messageContent?: string, messageAttaches?: File[]) =&gt; {",
            "lineNumber": 331
          },
          {
            "lineNumber": 517
          },
          {
            "lineNumber": 518
          },
          {
            "text": "\t\t\t// create history",
            "lineNumber": 519
          },
          {
            "text": "\t\t\tif (!type) {",
            "lineNumber": 520
          },
          {
            "text": "\t\t\t\tconst authStore = getAuthStore();",
            "lineNumber": 521
          },
          {
            "lineNumber": 522
          },
          {
            "text": "\t\t\t\tconst obj = {",
            "lineNumber": 523
          },
          {
            "text": "\t\t\t\t\t\"project_id\": project_id,",
            "lineNumber": 524
          },
          {
            "text": "\t\t\t\t\t\"task_id\": newTaskId,",
            "lineNumber": 525
          },
          {
            "text": "\t\t\t\t\t\"user_id\": authStore.user_id,",
            "lineNumber": 526
          },
          {
            "text": "\t\t\t\t\t\"question\": messageContent || (targetChatStore.getState().tasks[newTaskId]?.messages[0]?.content ?? ''),",
            "lineNumber": 527
          },
          {
            "text": "\t\t\t\t\t\"language\": systemLanguage,",
            "lineNumber": 528
          },
          {
            "text": "\t\t\t\t\t\"model_platform\": apiModel.model_platform,",
            "lineNumber": 529
          },
          {
            "text": "\t\t\t\t\t\"model_type\": apiModel.model_type,",
            "lineNumber": 530
          },
          {
            "text": "\t\t\t\t\t\"api_url\": modelType === 'cloud' ? \"cloud\" : apiModel.api_url,",
            "lineNumber": 531
          },
          {
            "text": "\t\t\t\t\t\"max_retries\": 3,",
            "lineNumber": 532
          },
          {
            "text": "\t\t\t\t\t\"file_save_path\": \"string\",",
            "lineNumber": 533
          },
          {
            "text": "\t\t\t\t\t\"installed_mcp\": \"string\",",
            "lineNumber": 534
          },
          {
            "text": "\t\t\t\t\t\"status\": 1,",
            "lineNumber": 535
          },
          {
            "text": "\t\t\t\t\t\"tokens\": 0",
            "lineNumber": 536
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 537
          },
          {
            "text": "\t\t\t\tawait proxyFetchPost(&#96;/api/chat/history&#96;, obj).then(res =&gt; {",
            "lineNumber": 538
          },
          {
            "text": "\t\t\t\t\thistoryId = res.id;",
            "lineNumber": 539
          },
          {
            "lineNumber": 540
          },
          {
            "text": "\t\t\t\t\t/**Save history id for replay reuse purposes.",
            "lineNumber": 541
          },
          {
            "text": "\t\t\t\t\t * TODO(history): Remove historyId handling to support per projectId ",
            "lineNumber": 542
          },
          {
            "text": "\t\t\t\t\t * instead in history api",
            "lineNumber": 543
          },
          {
            "text": "\t\t\t\t\t */",
            "lineNumber": 544
          },
          {
            "text": "\t\t\t\t\tif (project_id &amp;&amp; historyId) projectStore.setHistoryId(project_id, historyId);",
            "lineNumber": 545
          },
          {
            "text": "\t\t\t\t})",
            "lineNumber": 546
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 547
          },
          {
            "text": "\t\t\tconst browser_port = await window.ipcRenderer.invoke('get-browser-port');",
            "lineNumber": 548
          },
          {
            "lineNumber": 549
          },
          {
            "text": "\t\t\t// Lock the chatStore reference at the start of SSE session to prevent focus changes",
            "lineNumber": 550
          },
          {
            "text": "\t\t\t// during active message processing",
            "lineNumber": 551
          },
          {
            "text": "\t\t\tlet lockedChatStore = targetChatStore;",
            "lineNumber": 552
          },
          {
            "text": "\t\t\tlet lockedTaskId = newTaskId;",
            "lineNumber": 553
          },
          {
            "lineNumber": 554
          },
          {
            "text": "\t\t\t// Create AbortController for this task's SSE connection",
            "lineNumber": 555
          },
          {
            "text": "\t\t\t// First check if there's already an active SSE connection for this task",
            "lineNumber": 556
          },
          {
            "text": "\t\t\tif (activeSSEControllers[newTaskId]) {",
            "lineNumber": 557
          },
          {
            "text": "\t\t\t\tconsole.warn(&#96;Task ${newTaskId} already has an active SSE connection, aborting old one&#96;);",
            "lineNumber": 558
          },
          {
            "text": "\t\t\t\ttry {",
            "lineNumber": 559
          },
          {
            "text": "\t\t\t\t\tactiveSSEControllers[newTaskId].abort();",
            "lineNumber": 560
          },
          {
            "text": "\t\t\t\t} catch (error) {",
            "lineNumber": 561
          },
          {
            "text": "\t\t\t\t\tconsole.warn('Error aborting existing SSE connection:', error);",
            "lineNumber": 562
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 563
          },
          {
            "text": "\t\t\t\tdelete activeSSEControllers[newTaskId];",
            "lineNumber": 564
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 565
          },
          {
            "lineNumber": 566
          },
          {
            "text": "\t\t\tconst abortController = new AbortController();",
            "lineNumber": 567
          },
          {
            "text": "\t\t\tactiveSSEControllers[newTaskId] = abortController;",
            "lineNumber": 568
          },
          {
            "lineNumber": 569
          },
          {
            "text": "\t\t\t// Getter functions that use the locked references instead of dynamic ones",
            "lineNumber": 570
          },
          {
            "text": "\t\t\tconst getCurrentChatStore = () =&gt; {",
            "lineNumber": 571
          },
          {
            "text": "\t\t\t\treturn lockedChatStore.getState();",
            "lineNumber": 572
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 573
          },
          {
            "lineNumber": 574
          },
          {
            "text": "\t\t\t// Get the locked task ID - this won't change during the SSE session",
            "lineNumber": 575
          },
          {
            "text": "\t\t\tconst getCurrentTaskId = () =&gt; {",
            "lineNumber": 576
          },
          {
            "text": "\t\t\t\treturn lockedTaskId;",
            "lineNumber": 577
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 578
          },
          {
            "text": "\t\t}",
            "lineNumber": 1888
          },
          {
            "text": ")",
            "lineNumber": 2594
          },
          {
            "text": ";",
            "lineNumber": 2595
          }
        ]
      },
      "score": 0.2434965968132019
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\src\\pages\\Setting\\General.tsx",
        "range": {
          "startPosition": {
            "line": 27,
            "column": 62
          },
          "endPosition": {
            "line": 234,
            "column": 1
          }
        },
        "contents": "export default function SettingGeneral() {\n\tconst { t } = useTranslation();\n\tconst authStore = useAuthStore();\n\n\tconst resetInstallation = useInstallationStore(state =&gt; state.reset);\n\tconst setNeedsBackendRestart = useInstallationStore(state =&gt; state.setNeedsBackendRestart);\n\n\tconst navigate = useNavigate();\n\tconst [isLoading, setIsLoading] = useState(false);\n\tconst setAppearance = authStore.setAppearance;\n\tconst language = authStore.language;\n\tconst setLanguage = authStore.setLanguage;\n\tconst appearance = authStore.appearance;\n\tconst fullNameRef: RefObject&lt;HTMLInputElement&gt; = createRef();\n\tconst nickNameRef: RefObject&lt;HTMLInputElement&gt; = createRef();\n\tconst workDescRef: RefObject&lt;HTMLInputElement&gt; = createRef();\n\t//Get Chatstore for the active project's task\n\tconst { chatStore } = useChatStoreAdapter();\n\tif (!chatStore) {\n\t\treturn &lt;div&gt;Loading...&lt;/div&gt;;\n\t}\n\t\n\n\tconst [themeList, setThemeList] = useState&lt;any&gt;([\n\t\t{\n\t\t\timg: light,\n\t\t\tlabel: \"setting.light\",\n\t\t\tvalue: \"light\",\n\t\t},\n\t\t{\n\t\t\timg: transparent,\n\t\t\tlabel: \"setting.transparent\",\n\t\t\tvalue: \"transparent\",\n\t\t},\n\t]);\n\n\tconst languageList = [\n\t\t{\n\t\t\tkey: LocaleEnum.English,\n\t\t\tlabel: \"English\",\n\t\t},\n\t\t{\n\t\t\tkey: LocaleEnum.SimplifiedChinese,\n\t\t\tlabel: \"简体中文\",\n\t\t},\n\t\t{\n\t\t\tkey: LocaleEnum.TraditionalChinese,\n\t\t\tlabel: \"繁體中文\",\n\t\t},\n\t\t{\n\t\t\tkey: LocaleEnum.Japanese,\n\t\t\tlabel: \"日本語\",\n\t\t},\n\t\t{\n\t\t\tkey: LocaleEnum.Arabic,\n\t\t\tlabel: \"العربية\",\n\t\t},\n\t\t{\n\t\t\tkey: LocaleEnum.French,\n\t\t\tlabel: \"Français\",\n\t\t},\n\t\t{\n\t\t\tkey: LocaleEnum.German,\n\t\t\tlabel: \"Deutsch\",\n\t\t},\n\t\t{\n\t\t\tkey: LocaleEnum.Russian,\n\t\t\tlabel: \"Русский\",\n\t\t},\n\t\t{\n\t\t\tkey: LocaleEnum.Spanish,\n\t\t\tlabel: \"Español\",\n\t\t},\n\t\t{\n\t\t\tkey: LocaleEnum.Korean,\n\t\t\tlabel: \"한국어\",\n\t\t},\n\t\t{\n\t\t\tkey: LocaleEnum.Italian,\n\t\t\tlabel: \"Italiano\",\n\t\t},\n\t];\n\n\tuseEffect(() =&gt; {\n\t\tconst platform = window.electronAPI.getPlatform();\n\t}\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "export default function SettingGeneral() {",
            "lineNumber": 30,
            "isSignature": true
          },
          {
            "text": "\tconst { t } = useTranslation();",
            "lineNumber": 31
          },
          {
            "text": "\tconst authStore = useAuthStore();",
            "lineNumber": 32
          },
          {
            "lineNumber": 33
          },
          {
            "text": "\tconst resetInstallation = useInstallationStore(state =&gt; state.reset);",
            "lineNumber": 34
          },
          {
            "text": "\tconst setNeedsBackendRestart = useInstallationStore(state =&gt; state.setNeedsBackendRestart);",
            "lineNumber": 35
          },
          {
            "lineNumber": 36
          },
          {
            "text": "\tconst navigate = useNavigate();",
            "lineNumber": 37
          },
          {
            "text": "\tconst [isLoading, setIsLoading] = useState(false);",
            "lineNumber": 38
          },
          {
            "text": "\tconst setAppearance = authStore.setAppearance;",
            "lineNumber": 39
          },
          {
            "text": "\tconst language = authStore.language;",
            "lineNumber": 40
          },
          {
            "text": "\tconst setLanguage = authStore.setLanguage;",
            "lineNumber": 41
          },
          {
            "text": "\tconst appearance = authStore.appearance;",
            "lineNumber": 42
          },
          {
            "text": "\tconst fullNameRef: RefObject&lt;HTMLInputElement&gt; = createRef();",
            "lineNumber": 43
          },
          {
            "text": "\tconst nickNameRef: RefObject&lt;HTMLInputElement&gt; = createRef();",
            "lineNumber": 44
          },
          {
            "text": "\tconst workDescRef: RefObject&lt;HTMLInputElement&gt; = createRef();",
            "lineNumber": 45
          },
          {
            "text": "\t//Get Chatstore for the active project's task",
            "lineNumber": 46
          },
          {
            "text": "\tconst { chatStore } = useChatStoreAdapter();",
            "lineNumber": 47
          },
          {
            "text": "\tif (!chatStore) {",
            "lineNumber": 48
          },
          {
            "text": "\t\treturn &lt;div&gt;Loading...&lt;/div&gt;;",
            "lineNumber": 49
          },
          {
            "text": "\t}",
            "lineNumber": 50
          },
          {
            "text": "\t",
            "lineNumber": 51
          },
          {
            "lineNumber": 52
          },
          {
            "text": "\tconst [themeList, setThemeList] = useState&lt;any&gt;([",
            "lineNumber": 53
          },
          {
            "text": "\t\t{",
            "lineNumber": 54
          },
          {
            "text": "\t\t\timg: light,",
            "lineNumber": 55
          },
          {
            "text": "\t\t\tlabel: \"setting.light\",",
            "lineNumber": 56
          },
          {
            "text": "\t\t\tvalue: \"light\",",
            "lineNumber": 57
          },
          {
            "text": "\t\t},",
            "lineNumber": 58
          },
          {
            "text": "\t\t{",
            "lineNumber": 59
          },
          {
            "text": "\t\t\timg: transparent,",
            "lineNumber": 60
          },
          {
            "text": "\t\t\tlabel: \"setting.transparent\",",
            "lineNumber": 61
          },
          {
            "text": "\t\t\tvalue: \"transparent\",",
            "lineNumber": 62
          },
          {
            "text": "\t\t},",
            "lineNumber": 63
          },
          {
            "text": "\t]);",
            "lineNumber": 64
          },
          {
            "lineNumber": 65
          },
          {
            "text": "\tconst languageList = [",
            "lineNumber": 66
          },
          {
            "text": "\t\t{",
            "lineNumber": 67
          },
          {
            "text": "\t\t\tkey: LocaleEnum.English,",
            "lineNumber": 68
          },
          {
            "text": "\t\t\tlabel: \"English\",",
            "lineNumber": 69
          },
          {
            "text": "\t\t},",
            "lineNumber": 70
          },
          {
            "text": "\t\t{",
            "lineNumber": 71
          },
          {
            "text": "\t\t\tkey: LocaleEnum.SimplifiedChinese,",
            "lineNumber": 72
          },
          {
            "text": "\t\t\tlabel: \"简体中文\",",
            "lineNumber": 73
          },
          {
            "text": "\t\t},",
            "lineNumber": 74
          },
          {
            "text": "\t\t{",
            "lineNumber": 75
          },
          {
            "text": "\t\t\tkey: LocaleEnum.TraditionalChinese,",
            "lineNumber": 76
          },
          {
            "text": "\t\t\tlabel: \"繁體中文\",",
            "lineNumber": 77
          },
          {
            "text": "\t\t},",
            "lineNumber": 78
          },
          {
            "text": "\t\t{",
            "lineNumber": 79
          },
          {
            "text": "\t\t\tkey: LocaleEnum.Japanese,",
            "lineNumber": 80
          },
          {
            "text": "\t\t\tlabel: \"日本語\",",
            "lineNumber": 81
          },
          {
            "text": "\t\t},",
            "lineNumber": 82
          },
          {
            "text": "\t\t{",
            "lineNumber": 83
          },
          {
            "text": "\t\t\tkey: LocaleEnum.Arabic,",
            "lineNumber": 84
          },
          {
            "text": "\t\t\tlabel: \"العربية\",",
            "lineNumber": 85
          },
          {
            "text": "\t\t},",
            "lineNumber": 86
          },
          {
            "text": "\t\t{",
            "lineNumber": 87
          },
          {
            "text": "\t\t\tkey: LocaleEnum.French,",
            "lineNumber": 88
          },
          {
            "text": "\t\t\tlabel: \"Français\",",
            "lineNumber": 89
          },
          {
            "text": "\t\t},",
            "lineNumber": 90
          },
          {
            "text": "\t\t{",
            "lineNumber": 91
          },
          {
            "text": "\t\t\tkey: LocaleEnum.German,",
            "lineNumber": 92
          },
          {
            "text": "\t\t\tlabel: \"Deutsch\",",
            "lineNumber": 93
          },
          {
            "text": "\t\t},",
            "lineNumber": 94
          },
          {
            "text": "\t\t{",
            "lineNumber": 95
          },
          {
            "text": "\t\t\tkey: LocaleEnum.Russian,",
            "lineNumber": 96
          },
          {
            "text": "\t\t\tlabel: \"Русский\",",
            "lineNumber": 97
          },
          {
            "text": "\t\t},",
            "lineNumber": 98
          },
          {
            "text": "\t\t{",
            "lineNumber": 99
          },
          {
            "text": "\t\t\tkey: LocaleEnum.Spanish,",
            "lineNumber": 100
          },
          {
            "text": "\t\t\tlabel: \"Español\",",
            "lineNumber": 101
          },
          {
            "text": "\t\t},",
            "lineNumber": 102
          },
          {
            "text": "\t\t{",
            "lineNumber": 103
          },
          {
            "text": "\t\t\tkey: LocaleEnum.Korean,",
            "lineNumber": 104
          },
          {
            "text": "\t\t\tlabel: \"한국어\",",
            "lineNumber": 105
          },
          {
            "text": "\t\t},",
            "lineNumber": 106
          },
          {
            "text": "\t\t{",
            "lineNumber": 107
          },
          {
            "text": "\t\t\tkey: LocaleEnum.Italian,",
            "lineNumber": 108
          },
          {
            "text": "\t\t\tlabel: \"Italiano\",",
            "lineNumber": 109
          },
          {
            "text": "\t\t},",
            "lineNumber": 110
          },
          {
            "text": "\t];",
            "lineNumber": 111
          },
          {
            "lineNumber": 112
          },
          {
            "text": "\tuseEffect(() =&gt; {",
            "lineNumber": 113
          },
          {
            "text": "\t\tconst platform = window.electronAPI.getPlatform();",
            "lineNumber": 114
          },
          {
            "text": "\t}",
            "lineNumber": 138
          },
          {
            "text": "}",
            "lineNumber": 235,
            "isSignature": true
          }
        ]
      },
      "score": 0.24085719883441925
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\utils\\agent.py",
        "range": {
          "startPosition": {
            "line": 1165,
            "column": 5
          },
          "endPosition": {
            "line": 1388
          }
        },
        "contents": "@traceroot.trace()\nasync def document_agent(options: Chat):\n    working_directory = get_working_directory(options)\n    traceroot_logger.info(\n        f\"Creating document agent for project: {options.project_id} in directory: {working_directory}\"\n    )\n    message_integration = ToolkitMessageIntegration(\n        message_handler=HumanToolkit(\n            options.project_id, Agents.task_agent\n        ).send_message_to_user\n    )\n    file_write_toolkit = FileToolkit(\n        options.project_id, working_directory=working_directory\n    )\n    pptx_toolkit = PPTXToolkit(options.project_id, working_directory=working_directory)\n    pptx_toolkit = message_integration.register_toolkits(pptx_toolkit)\n    mark_it_down_toolkit = MarkItDownToolkit(options.project_id)\n    mark_it_down_toolkit = message_integration.register_toolkits(mark_it_down_toolkit)\n    excel_toolkit = ExcelToolkit(\n        options.project_id, working_directory=working_directory\n    )\n    excel_toolkit = message_integration.register_toolkits(excel_toolkit)\n    note_toolkit = NoteTakingToolkit(\n        options.project_id, Agents.document_agent, working_directory=working_directory\n    )\n    note_toolkit = message_integration.register_toolkits(note_toolkit)\n    terminal_toolkit = TerminalToolkit(\n        options.project_id,\n        Agents.document_agent,\n        safe_mode=True,\n        clone_current_env=False,\n    )\n    terminal_toolkit = message_integration.register_toolkits(terminal_toolkit)\n    tools = [\n        *file_write_toolkit.get_tools(),\n        *pptx_toolkit.get_tools(),\n        *HumanToolkit.get_can_use_tools(options.project_id, Agents.document_agent),\n        *mark_it_down_toolkit.get_tools(),\n        *excel_toolkit.get_tools(),\n        *note_toolkit.get_tools(),\n        *terminal_toolkit.get_tools(),\n        *await GoogleDriveMCPToolkit.get_can_use_tools(\n            options.project_id, options.get_bun_env()\n        ),\n    ]\n    # if env(\"EXA_API_KEY\") or options.is_cloud():\n    #     search_toolkit = SearchToolkit(options.project_id, Agents.document_agent).search_exa",
        "signatures": {},
        "detailedLines": [
          {
            "text": "@traceroot.trace()",
            "lineNumber": 1169
          },
          {
            "text": "async def document_agent(options: Chat):",
            "lineNumber": 1170,
            "isSignature": true
          },
          {
            "text": "    working_directory = get_working_directory(options)",
            "lineNumber": 1171
          },
          {
            "text": "    traceroot_logger.info(",
            "lineNumber": 1172
          },
          {
            "text": "        f\"Creating document agent for project: {options.project_id} in directory: {working_directory}\"",
            "lineNumber": 1173
          },
          {
            "text": "    )",
            "lineNumber": 1174
          },
          {
            "text": "    message_integration = ToolkitMessageIntegration(",
            "lineNumber": 1175
          },
          {
            "text": "        message_handler=HumanToolkit(",
            "lineNumber": 1176
          },
          {
            "text": "            options.project_id, Agents.task_agent",
            "lineNumber": 1177
          },
          {
            "text": "        ).send_message_to_user",
            "lineNumber": 1178
          },
          {
            "text": "    )",
            "lineNumber": 1179
          },
          {
            "text": "    file_write_toolkit = FileToolkit(",
            "lineNumber": 1180
          },
          {
            "text": "        options.project_id, working_directory=working_directory",
            "lineNumber": 1181
          },
          {
            "text": "    )",
            "lineNumber": 1182
          },
          {
            "text": "    pptx_toolkit = PPTXToolkit(options.project_id, working_directory=working_directory)",
            "lineNumber": 1183
          },
          {
            "text": "    pptx_toolkit = message_integration.register_toolkits(pptx_toolkit)",
            "lineNumber": 1184
          },
          {
            "text": "    mark_it_down_toolkit = MarkItDownToolkit(options.project_id)",
            "lineNumber": 1185
          },
          {
            "text": "    mark_it_down_toolkit = message_integration.register_toolkits(mark_it_down_toolkit)",
            "lineNumber": 1186
          },
          {
            "text": "    excel_toolkit = ExcelToolkit(",
            "lineNumber": 1187
          },
          {
            "text": "        options.project_id, working_directory=working_directory",
            "lineNumber": 1188
          },
          {
            "text": "    )",
            "lineNumber": 1189
          },
          {
            "text": "    excel_toolkit = message_integration.register_toolkits(excel_toolkit)",
            "lineNumber": 1190
          },
          {
            "text": "    note_toolkit = NoteTakingToolkit(",
            "lineNumber": 1191
          },
          {
            "text": "        options.project_id, Agents.document_agent, working_directory=working_directory",
            "lineNumber": 1192
          },
          {
            "text": "    )",
            "lineNumber": 1193
          },
          {
            "text": "    note_toolkit = message_integration.register_toolkits(note_toolkit)",
            "lineNumber": 1194
          },
          {
            "text": "    terminal_toolkit = TerminalToolkit(",
            "lineNumber": 1195
          },
          {
            "text": "        options.project_id,",
            "lineNumber": 1196
          },
          {
            "text": "        Agents.document_agent,",
            "lineNumber": 1197
          },
          {
            "text": "        safe_mode=True,",
            "lineNumber": 1198
          },
          {
            "text": "        clone_current_env=False,",
            "lineNumber": 1199
          },
          {
            "text": "    )",
            "lineNumber": 1200
          },
          {
            "text": "    terminal_toolkit = message_integration.register_toolkits(terminal_toolkit)",
            "lineNumber": 1201
          },
          {
            "text": "    tools = [",
            "lineNumber": 1202
          },
          {
            "text": "        *file_write_toolkit.get_tools(),",
            "lineNumber": 1203
          },
          {
            "text": "        *pptx_toolkit.get_tools(),",
            "lineNumber": 1204
          },
          {
            "text": "        *HumanToolkit.get_can_use_tools(options.project_id, Agents.document_agent),",
            "lineNumber": 1205
          },
          {
            "text": "        *mark_it_down_toolkit.get_tools(),",
            "lineNumber": 1206
          },
          {
            "text": "        *excel_toolkit.get_tools(),",
            "lineNumber": 1207
          },
          {
            "text": "        *note_toolkit.get_tools(),",
            "lineNumber": 1208
          },
          {
            "text": "        *terminal_toolkit.get_tools(),",
            "lineNumber": 1209
          },
          {
            "text": "        *await GoogleDriveMCPToolkit.get_can_use_tools(",
            "lineNumber": 1210
          },
          {
            "text": "            options.project_id, options.get_bun_env()",
            "lineNumber": 1211
          },
          {
            "text": "        ),",
            "lineNumber": 1212
          },
          {
            "text": "    ]",
            "lineNumber": 1213
          },
          {
            "text": "    # if env(\"EXA_API_KEY\") or options.is_cloud():",
            "lineNumber": 1214
          },
          {
            "text": "    #     search_toolkit = SearchToolkit(options.project_id, Agents.document_agent).search_exa",
            "lineNumber": 1215
          }
        ]
      },
      "score": 0.2381698042154312
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\utils\\agent.py",
        "range": {
          "startPosition": {
            "line": 1391
          },
          "endPosition": {
            "line": 1581
          }
        },
        "contents": "@traceroot.trace()\ndef multi_modal_agent(options: Chat):\n{NOW_STR}(Accurate to the hour). For any date-related tasks, you MUST use this as the current date.\n&lt;/operating_environment&gt;\n\n&lt;mandatory_instructions&gt;\n- You MUST use the &#96;read_note&#96; tool to to gather all information collected\n    by other team members by reading ALL notes and write down your findings in\n    the notes.\n\n- When you complete your task, your final response must be a comprehensive\n    summary of your analysis or the generated media, presented in a clear,\n    detailed, and easy-to-read format. Avoid using markdown tables for\n    presenting data; use plain text formatting instead.\n\n- You SHOULD keep the user informed by providing message_title and\n    message_description\n    parameters when calling tools. These optional parameters are available on\n    all tools and will automatically notify the user of your progress.\n&lt;mandatory_instructions&gt;\n\n&lt;capabilities&gt;\nYour capabilities include:\n- Video &amp; Audio Analysis:\n    - Download videos from URLs for analysis.\n    - Transcribe speech from audio files to text with high accuracy\n    - Answer specific questions about audio content\n    - Process audio from both local files and URLs\n    - Handle various audio formats including MP3, WAV, and OGG\n\n- Image Analysis &amp; Understanding:\n    - Generate detailed descriptions of image content\n    - Answer specific questions about images\n    - Identify objects, text, people, and scenes in images\n    - Process images from both local files and URLs\n\n- Image Generation:\n    - Create high-quality images based on detailed text prompts using DALL-E\n    - Generate images in 1024x1792 resolution\n    - Save generated images to specified directories\n\n- Terminal and File System:\n    - You have access to terminal tools to manage media files. You can\n    leverage powerful CLI tools like &#96;ffmpeg&#96; for any necessary video\n    and audio conversion or manipulation. You can also use tools like &#96;find&#96;\n    to locate media files, &#96;wget&#96; or &#96;curl&#96; to download them, and &#96;du&#96; or\n    &#96;df&#96; to monitor disk space.\n\n- Human Interaction:\n    - Ask questions to users and receive their responses\n    - Send informative messages to users without requiring responses\n\n&lt;/capabilities&gt;\n\n&lt;multi_modal_processing_workflow&gt;\nWhen working with multi-modal content, you should:\n- Provide detailed and accurate descriptions of media content\n- Extract relevant information based on user queries\n- Generate appropriate media when requested\n- Explain your analysis process and reasoning\n- Ask clarifying questions when user requirements are ambiguous\n&lt;/multi_modal_processing_workflow&gt;\n\nYour goal is to help users effectively process, understand, and create\nmulti-modal content across audio and visual domains.\n\"\"\"\n\n    return agent_model(\n        Agents.multi_modal_agent,",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 1392,
                "column": 1
              },
              "endPosition": {
                "line": 1393,
                "column": 1
              }
            },
            {
              "startPosition": {
                "line": 1393,
                "column": 1
              },
              "endPosition": {
                "line": 1394,
                "column": 5
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "@traceroot.trace()",
            "lineNumber": 1392
          },
          {
            "text": "def multi_modal_agent(options: Chat):",
            "lineNumber": 1393,
            "isSignature": true
          },
          {
            "text": "{NOW_STR}(Accurate to the hour). For any date-related tasks, you MUST use this as the current date.",
            "lineNumber": 1499
          },
          {
            "text": "&lt;/operating_environment&gt;",
            "lineNumber": 1500
          },
          {
            "lineNumber": 1501
          },
          {
            "text": "&lt;mandatory_instructions&gt;",
            "lineNumber": 1502
          },
          {
            "text": "- You MUST use the &#96;read_note&#96; tool to to gather all information collected",
            "lineNumber": 1503
          },
          {
            "text": "    by other team members by reading ALL notes and write down your findings in",
            "lineNumber": 1504
          },
          {
            "text": "    the notes.",
            "lineNumber": 1505
          },
          {
            "lineNumber": 1506
          },
          {
            "text": "- When you complete your task, your final response must be a comprehensive",
            "lineNumber": 1507
          },
          {
            "text": "    summary of your analysis or the generated media, presented in a clear,",
            "lineNumber": 1508
          },
          {
            "text": "    detailed, and easy-to-read format. Avoid using markdown tables for",
            "lineNumber": 1509
          },
          {
            "text": "    presenting data; use plain text formatting instead.",
            "lineNumber": 1510
          },
          {
            "lineNumber": 1511
          },
          {
            "text": "- You SHOULD keep the user informed by providing message_title and",
            "lineNumber": 1512
          },
          {
            "text": "    message_description",
            "lineNumber": 1513
          },
          {
            "text": "    parameters when calling tools. These optional parameters are available on",
            "lineNumber": 1514
          },
          {
            "text": "    all tools and will automatically notify the user of your progress.",
            "lineNumber": 1515
          },
          {
            "text": "&lt;mandatory_instructions&gt;",
            "lineNumber": 1516
          },
          {
            "lineNumber": 1517
          },
          {
            "text": "&lt;capabilities&gt;",
            "lineNumber": 1518
          },
          {
            "text": "Your capabilities include:",
            "lineNumber": 1519
          },
          {
            "text": "- Video &amp; Audio Analysis:",
            "lineNumber": 1520
          },
          {
            "text": "    - Download videos from URLs for analysis.",
            "lineNumber": 1521
          },
          {
            "text": "    - Transcribe speech from audio files to text with high accuracy",
            "lineNumber": 1522
          },
          {
            "text": "    - Answer specific questions about audio content",
            "lineNumber": 1523
          },
          {
            "text": "    - Process audio from both local files and URLs",
            "lineNumber": 1524
          },
          {
            "text": "    - Handle various audio formats including MP3, WAV, and OGG",
            "lineNumber": 1525
          },
          {
            "lineNumber": 1526
          },
          {
            "text": "- Image Analysis &amp; Understanding:",
            "lineNumber": 1527
          },
          {
            "text": "    - Generate detailed descriptions of image content",
            "lineNumber": 1528
          },
          {
            "text": "    - Answer specific questions about images",
            "lineNumber": 1529
          },
          {
            "text": "    - Identify objects, text, people, and scenes in images",
            "lineNumber": 1530
          },
          {
            "text": "    - Process images from both local files and URLs",
            "lineNumber": 1531
          },
          {
            "lineNumber": 1532
          },
          {
            "text": "- Image Generation:",
            "lineNumber": 1533
          },
          {
            "text": "    - Create high-quality images based on detailed text prompts using DALL-E",
            "lineNumber": 1534
          },
          {
            "text": "    - Generate images in 1024x1792 resolution",
            "lineNumber": 1535
          },
          {
            "text": "    - Save generated images to specified directories",
            "lineNumber": 1536
          },
          {
            "lineNumber": 1537
          },
          {
            "text": "- Terminal and File System:",
            "lineNumber": 1538
          },
          {
            "text": "    - You have access to terminal tools to manage media files. You can",
            "lineNumber": 1539
          },
          {
            "text": "    leverage powerful CLI tools like &#96;ffmpeg&#96; for any necessary video",
            "lineNumber": 1540
          },
          {
            "text": "    and audio conversion or manipulation. You can also use tools like &#96;find&#96;",
            "lineNumber": 1541
          },
          {
            "text": "    to locate media files, &#96;wget&#96; or &#96;curl&#96; to download them, and &#96;du&#96; or",
            "lineNumber": 1542
          },
          {
            "text": "    &#96;df&#96; to monitor disk space.",
            "lineNumber": 1543
          },
          {
            "lineNumber": 1544
          },
          {
            "text": "- Human Interaction:",
            "lineNumber": 1545
          },
          {
            "text": "    - Ask questions to users and receive their responses",
            "lineNumber": 1546
          },
          {
            "text": "    - Send informative messages to users without requiring responses",
            "lineNumber": 1547
          },
          {
            "lineNumber": 1548
          },
          {
            "text": "&lt;/capabilities&gt;",
            "lineNumber": 1549
          },
          {
            "lineNumber": 1550
          },
          {
            "text": "&lt;multi_modal_processing_workflow&gt;",
            "lineNumber": 1551
          },
          {
            "text": "When working with multi-modal content, you should:",
            "lineNumber": 1552
          },
          {
            "text": "- Provide detailed and accurate descriptions of media content",
            "lineNumber": 1553
          },
          {
            "text": "- Extract relevant information based on user queries",
            "lineNumber": 1554
          },
          {
            "text": "- Generate appropriate media when requested",
            "lineNumber": 1555
          },
          {
            "text": "- Explain your analysis process and reasoning",
            "lineNumber": 1556
          },
          {
            "text": "- Ask clarifying questions when user requirements are ambiguous",
            "lineNumber": 1557
          },
          {
            "text": "&lt;/multi_modal_processing_workflow&gt;",
            "lineNumber": 1558
          },
          {
            "lineNumber": 1559
          },
          {
            "text": "Your goal is to help users effectively process, understand, and create",
            "lineNumber": 1560
          },
          {
            "text": "multi-modal content across audio and visual domains.",
            "lineNumber": 1561
          },
          {
            "text": "\"\"\"",
            "lineNumber": 1562
          },
          {
            "lineNumber": 1563
          },
          {
            "text": "    return agent_model(",
            "lineNumber": 1564
          },
          {
            "text": "        Agents.multi_modal_agent,",
            "lineNumber": 1565
          }
        ]
      },
      "score": 0.23673665523529053
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\src\\store\\chatStore.ts",
        "range": {
          "startPosition": {
            "column": 152
          },
          "endPosition": {
            "line": 109,
            "column": 1
          }
        },
        "contents": ";\nimport { fetchEventSource } from '@microsoft/fetch-event-source';\nimport { createStore } from 'zustand';\nimport { generateUniqueId, uploadLog } from \"@/lib\";\nimport { FileText } from 'lucide-react';\nimport { getAuthStore, useWorkerList } from './authStore';\nimport { useProjectStore } from './projectStore';\nimport { showCreditsToast } from '@/components/Toast/creditsToast';\nimport { showStorageToast } from '@/components/Toast/storageToast';\nimport { toast } from 'sonner';\n\n\ninterface Task {\n\tmessages: Message[];\n\ttype: string;\n\tsummaryTask: string;\n\ttaskInfo: TaskInfo[];\n\tattaches: File[];\n\ttaskRunning: TaskInfo[];\n\ttaskAssigning: Agent[];\n\tfileList: FileInfo[];\n\twebViewUrls: { url: string, processTaskId: string }[]\n\tactiveAsk: string\n\taskList: Message[]\n\tprogressValue: number\n\tisPending: boolean\n\tactiveWorkSpace: string | null;\n\thasMessages: boolean;\n\tactiveAgent: string;\n\tstatus: 'running' | 'finished' | 'pending' | 'pause';\n\ttaskTime: number;\n\telapsed: number;\n\ttokens: number;\n\thasWaitComfirm: boolean;\n\tcotList: string[];\n\thasAddWorker: boolean\n\tnuwFileNum: number\n\tdelayTime: number\n\tselectedFile: FileInfo | null;\n\tsnapshots: any[];\n\tsnapshotsTemp: any[];\n\tisTakeControl: boolean;\n\tisTaskEdit: boolean;\n\tisContextExceeded?: boolean;\n\t// Streaming decompose text - stored separately to avoid frequent re-renders\n\tstreamingDecomposeText: string;\n}\n\nexport interface ChatStore {\n\tupdateCount: number;\n\tactiveTaskId: string | null\n;\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": ";",
            "lineNumber": 1
          },
          {
            "text": "import { fetchEventSource } from '@microsoft/fetch-event-source';",
            "lineNumber": 2
          },
          {
            "text": "import { createStore } from 'zustand';",
            "lineNumber": 3
          },
          {
            "text": "import { generateUniqueId, uploadLog } from \"@/lib\";",
            "lineNumber": 4
          },
          {
            "text": "import { FileText } from 'lucide-react';",
            "lineNumber": 5
          },
          {
            "text": "import { getAuthStore, useWorkerList } from './authStore';",
            "lineNumber": 6
          },
          {
            "text": "import { useProjectStore } from './projectStore';",
            "lineNumber": 7
          },
          {
            "text": "import { showCreditsToast } from '@/components/Toast/creditsToast';",
            "lineNumber": 8
          },
          {
            "text": "import { showStorageToast } from '@/components/Toast/storageToast';",
            "lineNumber": 9
          },
          {
            "text": "import { toast } from 'sonner';",
            "lineNumber": 10
          },
          {
            "lineNumber": 11
          },
          {
            "lineNumber": 12
          },
          {
            "text": "interface Task {",
            "lineNumber": 13,
            "isSignature": true
          },
          {
            "text": "\tmessages: Message[];",
            "lineNumber": 14
          },
          {
            "text": "\ttype: string;",
            "lineNumber": 15
          },
          {
            "text": "\tsummaryTask: string;",
            "lineNumber": 16
          },
          {
            "text": "\ttaskInfo: TaskInfo[];",
            "lineNumber": 17
          },
          {
            "text": "\tattaches: File[];",
            "lineNumber": 18
          },
          {
            "text": "\ttaskRunning: TaskInfo[];",
            "lineNumber": 19
          },
          {
            "text": "\ttaskAssigning: Agent[];",
            "lineNumber": 20
          },
          {
            "text": "\tfileList: FileInfo[];",
            "lineNumber": 21
          },
          {
            "text": "\twebViewUrls: { url: string, processTaskId: string }[]",
            "lineNumber": 22
          },
          {
            "text": "\tactiveAsk: string",
            "lineNumber": 23
          },
          {
            "text": "\taskList: Message[]",
            "lineNumber": 24
          },
          {
            "text": "\tprogressValue: number",
            "lineNumber": 25
          },
          {
            "text": "\tisPending: boolean",
            "lineNumber": 26
          },
          {
            "text": "\tactiveWorkSpace: string | null;",
            "lineNumber": 27
          },
          {
            "text": "\thasMessages: boolean;",
            "lineNumber": 28
          },
          {
            "text": "\tactiveAgent: string;",
            "lineNumber": 29
          },
          {
            "text": "\tstatus: 'running' | 'finished' | 'pending' | 'pause';",
            "lineNumber": 30
          },
          {
            "text": "\ttaskTime: number;",
            "lineNumber": 31
          },
          {
            "text": "\telapsed: number;",
            "lineNumber": 32
          },
          {
            "text": "\ttokens: number;",
            "lineNumber": 33
          },
          {
            "text": "\thasWaitComfirm: boolean;",
            "lineNumber": 34
          },
          {
            "text": "\tcotList: string[];",
            "lineNumber": 35
          },
          {
            "text": "\thasAddWorker: boolean",
            "lineNumber": 36
          },
          {
            "text": "\tnuwFileNum: number",
            "lineNumber": 37
          },
          {
            "text": "\tdelayTime: number",
            "lineNumber": 38
          },
          {
            "text": "\tselectedFile: FileInfo | null;",
            "lineNumber": 39
          },
          {
            "text": "\tsnapshots: any[];",
            "lineNumber": 40
          },
          {
            "text": "\tsnapshotsTemp: any[];",
            "lineNumber": 41
          },
          {
            "text": "\tisTakeControl: boolean;",
            "lineNumber": 42
          },
          {
            "text": "\tisTaskEdit: boolean;",
            "lineNumber": 43
          },
          {
            "text": "\tisContextExceeded?: boolean;",
            "lineNumber": 44
          },
          {
            "text": "\t// Streaming decompose text - stored separately to avoid frequent re-renders",
            "lineNumber": 45
          },
          {
            "text": "\tstreamingDecomposeText: string;",
            "lineNumber": 46,
            "isSignature": true
          },
          {
            "text": "}",
            "lineNumber": 47,
            "isSignature": true
          },
          {
            "lineNumber": 48
          },
          {
            "text": "export interface ChatStore {",
            "lineNumber": 49,
            "isSignature": true
          },
          {
            "text": "\tupdateCount: number;",
            "lineNumber": 50
          },
          {
            "text": "\tactiveTaskId: string | null",
            "lineNumber": 51
          },
          {
            "text": ";",
            "lineNumber": 109,
            "isSignature": true
          },
          {
            "text": "}",
            "lineNumber": 110,
            "isSignature": true
          }
        ]
      },
      "score": 0.23525124788284302
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\src\\i18n\\index.ts",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 21,
            "column": 45
          }
        },
        "contents": "import i18n from \"i18next\";\nimport { initReactI18next } from \"react-i18next\";\nimport { resources } from \"./locales\";\nimport { getAuthStore } from \"@/store/authStore\";\n\nexport enum LocaleEnum {\n  SimplifiedChinese = \"zh-Hans\",\n  TraditionalChinese = \"zh-Hant\",\n  English = \"en-US\",\n  German = \"de\",\n  Korean = \"ko\",\n  Japanese = \"ja\",\n  French = \"fr\",\n  Russian = \"ru\",\n  Italian = \"it\",\n  Arabic = \"ar\",\n  Spanish = \"es\",\n}\n\nconst { language } = getAuthStore();\n\nconst savedLanguage = language?.toLowerCase();",
        "signatures": {},
        "detailedLines": [
          {
            "text": "import i18n from \"i18next\";",
            "lineNumber": 1
          },
          {
            "text": "import { initReactI18next } from \"react-i18next\";",
            "lineNumber": 2
          },
          {
            "text": "import { resources } from \"./locales\";",
            "lineNumber": 3
          },
          {
            "text": "import { getAuthStore } from \"@/store/authStore\";",
            "lineNumber": 4
          },
          {
            "lineNumber": 5
          },
          {
            "text": "export enum LocaleEnum {",
            "lineNumber": 6
          },
          {
            "text": "  SimplifiedChinese = \"zh-Hans\",",
            "lineNumber": 7
          },
          {
            "text": "  TraditionalChinese = \"zh-Hant\",",
            "lineNumber": 8
          },
          {
            "text": "  English = \"en-US\",",
            "lineNumber": 9
          },
          {
            "text": "  German = \"de\",",
            "lineNumber": 10
          },
          {
            "text": "  Korean = \"ko\",",
            "lineNumber": 11
          },
          {
            "text": "  Japanese = \"ja\",",
            "lineNumber": 12
          },
          {
            "text": "  French = \"fr\",",
            "lineNumber": 13
          },
          {
            "text": "  Russian = \"ru\",",
            "lineNumber": 14
          },
          {
            "text": "  Italian = \"it\",",
            "lineNumber": 15
          },
          {
            "text": "  Arabic = \"ar\",",
            "lineNumber": 16
          },
          {
            "text": "  Spanish = \"es\",",
            "lineNumber": 17
          },
          {
            "text": "}",
            "lineNumber": 18
          },
          {
            "lineNumber": 19
          },
          {
            "text": "const { language } = getAuthStore();",
            "lineNumber": 20
          },
          {
            "lineNumber": 21
          },
          {
            "text": "const savedLanguage = language?.toLowerCase();",
            "lineNumber": 22
          }
        ]
      },
      "score": 0.23371917009353638
    }
  ]
}
```
Status: **completed**


</details>
</tool-use>

---


檢查前端如何傳遞語言參數，以及 task_agent 的建立方式：


---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "language",
  "path": "src/store/chatStore.ts",
  "context": 5,
  "caseInsensitive": true
}
```
Result:

```json
{
  "success": {
    "pattern": "language",
    "path": "src/store/chatStore.ts",
    "outputMode": "content",
    "workspaceResults": {
      "d:\\_Code\\_GitHub\\eigent-260119": {
        "content": {
          "matches": [
            {
              "file": "src\\store\\chatStore.ts",
              "matches": [
                {
                  "lineNumber": 345,
                  "content": "\t\t\t\t\treturn;",
                  "isContextLine": true
                },
                {
                  "lineNumber": 346,
                  "content": "\t\t\t\t}",
                  "isContextLine": true
                },
                {
                  "lineNumber": 347,
                  "content": "\t\t\t\tconsole.log('[startTask] Backend is ready, proceeding with task...');",
                  "isContextLine": true
                },
                {
                  "lineNumber": 348,
                  "content": "\t\t\t}",
                  "isContextLine": true
                },
                {
                  "lineNumber": 349,
                  "isContextLine": true
                },
                {
                  "lineNumber": 350,
                  "content": "\t\t\tconst { token, language, modelType, cloud_model_type, email } = getAuthStore()"
                },
                {
                  "lineNumber": 351,
                  "content": "\t\t\tconst workerList = useWorkerList();",
                  "isContextLine": true
                },
                {
                  "lineNumber": 352,
                  "content": "\t\t\tconst { getLastUserMessage, setDelayTime, setType } = get();",
                  "isContextLine": true
                },
                {
                  "lineNumber": 353,
                  "content": "\t\t\tconst baseURL = await getBaseURL();",
                  "isContextLine": true
                },
                {
                  "lineNumber": 354,
                  "content": "\t\t\tlet systemLanguage = language"
                },
                {
                  "lineNumber": 355,
                  "content": "\t\t\tif (language === 'system') {"
                },
                {
                  "lineNumber": 356,
                  "content": "\t\t\t\tsystemLanguage = await window.ipcRenderer.invoke('get-system-language');"
                },
                {
                  "lineNumber": 357,
                  "content": "\t\t\t}",
                  "isContextLine": true
                },
                {
                  "lineNumber": 358,
                  "content": "\t\t\tif (type === 'replay') {",
                  "isContextLine": true
                },
                {
                  "lineNumber": 359,
                  "content": "\t\t\t\tsetDelayTime(taskId, delayTime as number)",
                  "isContextLine": true
                },
                {
                  "lineNumber": 360,
                  "content": "\t\t\t\tsetType(taskId, type)",
                  "isContextLine": true
                },
                {
                  "lineNumber": 361,
                  "content": "\t\t\t}",
                  "isContextLine": true
                },
                {
                  "lineNumber": 523,
                  "content": "\t\t\t\tconst obj = {",
                  "isContextLine": true
                },
                {
                  "lineNumber": 524,
                  "content": "\t\t\t\t\t\"project_id\": project_id,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 525,
                  "content": "\t\t\t\t\t\"task_id\": newTaskId,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 526,
                  "content": "\t\t\t\t\t\"user_id\": authStore.user_id,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 527,
                  "content": "\t\t\t\t\t\"question\": messageContent || (targetChatStore.getState().tasks[newTaskId]?.messages[0]?.content ?? ''),",
                  "isContextLine": true
                },
                {
                  "lineNumber": 528,
                  "content": "\t\t\t\t\t\"language\": systemLanguage,"
                },
                {
                  "lineNumber": 529,
                  "content": "\t\t\t\t\t\"model_platform\": apiModel.model_platform,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 530,
                  "content": "\t\t\t\t\t\"model_type\": apiModel.model_type,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 531,
                  "content": "\t\t\t\t\t\"api_url\": modelType === 'cloud' ? \"cloud\" : apiModel.api_url,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 532,
                  "content": "\t\t\t\t\t\"max_retries\": 3,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 533,
                  "content": "\t\t\t\t\t\"file_save_path\": \"string\",",
                  "isContextLine": true
                },
                {
                  "lineNumber": 597,
                  "content": "\t\t\t\t\tmodel_type: apiModel.model_type,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 598,
                  "content": "\t\t\t\t\tapi_key: apiModel.api_key,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 599,
                  "content": "\t\t\t\t\tapi_url: apiModel.api_url,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 600,
                  "content": "\t\t\t\t\textra_params: apiModel.extra_params,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 601,
                  "content": "\t\t\t\t\tinstalled_mcp: { mcpServers: {} },",
                  "isContextLine": true
                },
                {
                  "lineNumber": 602,
                  "content": "\t\t\t\t\tlanguage: systemLanguage,"
                },
                {
                  "lineNumber": 603,
                  "content": "\t\t\t\t\tallow_local_system: true,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 604,
                  "content": "\t\t\t\t\tattaches: (messageAttaches || targetChatStore.getState().tasks[newTaskId]?.attaches || []).map(f =&gt; f.filePath),",
                  "isContextLine": true
                },
                {
                  "lineNumber": 605,
                  "content": "\t\t\t\t\tsummary_prompt: &#96;&#96;,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 606,
                  "content": "\t\t\t\t\tnew_agents: [...addWorkers],",
                  "isContextLine": true
                },
                {
                  "lineNumber": 607,
                  "content": "\t\t\t\t\tbrowser_port: browser_port,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 725,
                  "content": "\t\t\t\t\t\t\t\t\tconst obj = {",
                  "isContextLine": true
                },
                {
                  "lineNumber": 726,
                  "content": "\t\t\t\t\t\t\t\t\t\t\"project_id\": project_id,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 727,
                  "content": "\t\t\t\t\t\t\t\t\t\t\"task_id\": newTaskId,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 728,
                  "content": "\t\t\t\t\t\t\t\t\t\t\"user_id\": authStore.user_id,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 729,
                  "content": "\t\t\t\t\t\t\t\t\t\t\"question\": question || messageContent || (targetChatStore.getState().tasks[newTaskId]?.messages[0]?.content ?? ''),",
                  "isContextLine": true
                },
                {
                  "lineNumber": 730,
                  "content": "\t\t\t\t\t\t\t\t\t\t\"language\": systemLanguage,"
                },
                {
                  "lineNumber": 731,
                  "content": "\t\t\t\t\t\t\t\t\t\t\"model_platform\": apiModel.model_platform,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 732,
                  "content": "\t\t\t\t\t\t\t\t\t\t\"model_type\": apiModel.model_type,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 733,
                  "content": "\t\t\t\t\t\t\t\t\t\t\"api_url\": modelType === 'cloud' ? \"cloud\" : apiModel.api_url,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 734,
                  "content": "\t\t\t\t\t\t\t\t\t\t\"max_retries\": 3,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 735,
                  "content": "\t\t\t\t\t\t\t\t\t\t\"file_save_path\": \"string\",",
                  "isContextLine": true
                }
              ]
            }
          ],
          "totalLines": 50,
          "totalMatchedLines": 7
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="semantic_search_full">
<details>
<summary>Tool use: **semantic_search_full**</summary>


Parameters:

```json
{
  "query": "How is task_agent created and how does it use language settings?",
  "topK": 10,
  "explanation": ""
}
```
Result:

```json
{
  "codeResults": [
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\utils\\agent.py",
        "range": {
          "startPosition": {
            "line": 654,
            "column": 24
          },
          "endPosition": {
            "line": 756
          }
        },
        "contents": "@traceroot.trace()\ndef agent_model(\n    agent_name: str,\n    system_message: str | BaseMessage,\n    options: Chat,\n    tools: list[FunctionTool | Callable] | None = None,\n    prune_tool_calls_from_memory: bool = False,\n    tool_names: list[str] | None = None,\n    toolkits_to_register_agent: list[RegisteredAgentToolkit] | None = None,\n    enable_snapshot_clean: bool = False,\n):\n    task_lock = get_task_lock(options.project_id)\n    agent_id = str(uuid.uuid4())\n    traceroot_logger.info(\n        f\"Creating agent: {agent_name} with id: {agent_id} for project: {options.project_id}\"\n    )\n    asyncio.create_task(\n        task_lock.put_queue(\n            ActionCreateAgentData(\n                data={\n                    \"agent_name\": agent_name,\n                    \"agent_id\": agent_id,\n                    \"tools\": tool_names or [],\n                }\n            )\n        )\n    )\n\n    # Build model config, defaulting to streaming for planner\n    extra_params = options.extra_params or {}\n    init_param_keys = {\n        \"api_version\",\n        \"azure_ad_token\",\n        \"azure_ad_token_provider\",\n        \"max_retries\",\n        \"timeout\",\n        \"client\",\n        \"async_client\",\n        \"azure_deployment_name\",\n    }\n\n    init_params = {}\n    model_config: dict[str, Any] = {}\n\n    if options.is_cloud():\n        model_config[\"user\"] = str(options.project_id)\n\n    excluded_keys = {\"model_platform\", \"model_type\", \"api_key\", \"url\"}\n\n    # Distribute extra_params between init_params and model_config\n    for k, v in extra_params.items():\n        if k in excluded_keys:\n            continue\n        # Skip empty values\n        if v is None or (isinstance(v, str) and not v.strip()):\n            continue\n\n        if k in init_param_keys:\n            init_params[k] = v\n        else:\n            model_config[k] = v\n\n    if agent_name == Agents.task_agent:\n        model_config[\"stream\"] = True\n    if agent_name == Agents.browser_agent:\n        try:\n            model_platform_enum =",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 84,
                "column": 1
              },
              "endPosition": {
                "line": 85,
                "column": 5
              }
            },
            {
              "startPosition": {
                "line": 614,
                "column": 5
              },
              "endPosition": {
                "line": 615,
                "column": 5
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "@traceroot.trace()",
            "lineNumber": 658
          },
          {
            "text": "def agent_model(",
            "lineNumber": 659,
            "isSignature": true
          },
          {
            "text": "    agent_name: str,",
            "lineNumber": 660,
            "isSignature": true
          },
          {
            "text": "    system_message: str | BaseMessage,",
            "lineNumber": 661,
            "isSignature": true
          },
          {
            "text": "    options: Chat,",
            "lineNumber": 662,
            "isSignature": true
          },
          {
            "text": "    tools: list[FunctionTool | Callable] | None = None,",
            "lineNumber": 663,
            "isSignature": true
          },
          {
            "text": "    prune_tool_calls_from_memory: bool = False,",
            "lineNumber": 664,
            "isSignature": true
          },
          {
            "text": "    tool_names: list[str] | None = None,",
            "lineNumber": 665,
            "isSignature": true
          },
          {
            "text": "    toolkits_to_register_agent: list[RegisteredAgentToolkit] | None = None,",
            "lineNumber": 666,
            "isSignature": true
          },
          {
            "text": "    enable_snapshot_clean: bool = False,",
            "lineNumber": 667,
            "isSignature": true
          },
          {
            "text": "):",
            "lineNumber": 668,
            "isSignature": true
          },
          {
            "text": "    task_lock = get_task_lock(options.project_id)",
            "lineNumber": 669
          },
          {
            "text": "    agent_id = str(uuid.uuid4())",
            "lineNumber": 670
          },
          {
            "text": "    traceroot_logger.info(",
            "lineNumber": 671
          },
          {
            "text": "        f\"Creating agent: {agent_name} with id: {agent_id} for project: {options.project_id}\"",
            "lineNumber": 672
          },
          {
            "text": "    )",
            "lineNumber": 673
          },
          {
            "text": "    asyncio.create_task(",
            "lineNumber": 674
          },
          {
            "text": "        task_lock.put_queue(",
            "lineNumber": 675
          },
          {
            "text": "            ActionCreateAgentData(",
            "lineNumber": 676
          },
          {
            "text": "                data={",
            "lineNumber": 677
          },
          {
            "text": "                    \"agent_name\": agent_name,",
            "lineNumber": 678
          },
          {
            "text": "                    \"agent_id\": agent_id,",
            "lineNumber": 679
          },
          {
            "text": "                    \"tools\": tool_names or [],",
            "lineNumber": 680
          },
          {
            "text": "                }",
            "lineNumber": 681
          },
          {
            "text": "            )",
            "lineNumber": 682
          },
          {
            "text": "        )",
            "lineNumber": 683
          },
          {
            "text": "    )",
            "lineNumber": 684
          },
          {
            "lineNumber": 685
          },
          {
            "text": "    # Build model config, defaulting to streaming for planner",
            "lineNumber": 686
          },
          {
            "text": "    extra_params = options.extra_params or {}",
            "lineNumber": 687
          },
          {
            "text": "    init_param_keys = {",
            "lineNumber": 688
          },
          {
            "text": "        \"api_version\",",
            "lineNumber": 689
          },
          {
            "text": "        \"azure_ad_token\",",
            "lineNumber": 690
          },
          {
            "text": "        \"azure_ad_token_provider\",",
            "lineNumber": 691
          },
          {
            "text": "        \"max_retries\",",
            "lineNumber": 692
          },
          {
            "text": "        \"timeout\",",
            "lineNumber": 693
          },
          {
            "text": "        \"client\",",
            "lineNumber": 694
          },
          {
            "text": "        \"async_client\",",
            "lineNumber": 695
          },
          {
            "text": "        \"azure_deployment_name\",",
            "lineNumber": 696
          },
          {
            "text": "    }",
            "lineNumber": 697
          },
          {
            "lineNumber": 698
          },
          {
            "text": "    init_params = {}",
            "lineNumber": 699
          },
          {
            "text": "    model_config: dict[str, Any] = {}",
            "lineNumber": 700
          },
          {
            "lineNumber": 701
          },
          {
            "text": "    if options.is_cloud():",
            "lineNumber": 702
          },
          {
            "text": "        model_config[\"user\"] = str(options.project_id)",
            "lineNumber": 703
          },
          {
            "lineNumber": 704
          },
          {
            "text": "    excluded_keys = {\"model_platform\", \"model_type\", \"api_key\", \"url\"}",
            "lineNumber": 705
          },
          {
            "lineNumber": 706
          },
          {
            "text": "    # Distribute extra_params between init_params and model_config",
            "lineNumber": 707
          },
          {
            "text": "    for k, v in extra_params.items():",
            "lineNumber": 708
          },
          {
            "text": "        if k in excluded_keys:",
            "lineNumber": 709
          },
          {
            "text": "            continue",
            "lineNumber": 710
          },
          {
            "text": "        # Skip empty values",
            "lineNumber": 711
          },
          {
            "text": "        if v is None or (isinstance(v, str) and not v.strip()):",
            "lineNumber": 712
          },
          {
            "text": "            continue",
            "lineNumber": 713
          },
          {
            "lineNumber": 714
          },
          {
            "text": "        if k in init_param_keys:",
            "lineNumber": 715
          },
          {
            "text": "            init_params[k] = v",
            "lineNumber": 716
          },
          {
            "text": "        else:",
            "lineNumber": 717
          },
          {
            "text": "            model_config[k] = v",
            "lineNumber": 718
          },
          {
            "lineNumber": 719
          },
          {
            "text": "    if agent_name == Agents.task_agent:",
            "lineNumber": 720
          },
          {
            "text": "        model_config[\"stream\"] = True",
            "lineNumber": 721
          },
          {
            "text": "    if agent_name == Agents.browser_agent:",
            "lineNumber": 722
          },
          {
            "text": "        try:",
            "lineNumber": 723
          },
          {
            "text": "            model_platform_enum =",
            "lineNumber": 724
          }
        ]
      },
      "score": 0.4767381548881531
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\utils\\workforce.py",
        "range": {
          "startPosition": {
            "line": 31,
            "column": 42
          },
          "endPosition": {
            "line": 607
          }
        },
        "contents": "class Workforce(BaseWorkforce):\n    def __init__(\n        self,\n        api_task_id: str,\n        description: str,\n        children: List[BaseNode] | None = None,\n        coordinator_agent: ChatAgent | None = None,\n        task_agent: ChatAgent | None = None,\n        new_worker_agent: ChatAgent | None = None,\n        graceful_shutdown_timeout: float = 3,\n        share_memory: bool = False,\n        use_structured_output_handler: bool = True,\n    ) -&gt; None:\n        self.api_task_id = api_task_id\n        logger.info(\"=\" * 80)\n        logger.info(\"🏭 [WF-LIFECYCLE] Workforce.__init__ STARTED\", extra={\"api_task_id\": api_task_id})\n        logger.info(f\"[WF-LIFECYCLE] Workforce id will be: {id(self)}\")\n        logger.info(f\"[WF-LIFECYCLE] Init params: graceful_shutdown_timeout={graceful_shutdown_timeout}, share_memory={share_memory}\")\n        logger.info(\"=\" * 80)\n        super().__init__(\n            description=description,\n            children=children,\n            coordinator_agent=coordinator_agent,\n            task_agent=task_agent,\n            new_worker_agent=new_worker_agent,\n            graceful_shutdown_timeout=graceful_shutdown_timeout,\n            share_memory=share_memory,\n            use_structured_output_handler=use_structured_output_handler,\n            task_timeout_seconds=1800,  # 30 minutes\n            failure_handling_config=FailureHandlingConfig(\n                enabled_strategies=[\"retry\", \"replan\"],\n            ),\n        )\n        self.task_agent.stream_accumulate = True\n        self.task_agent._stream_accumulate_explicit = True\n        logger.info(f\"[WF-LIFECYCLE] ✅ Workforce.__init__ COMPLETED, id={id(self)}\")\n\n    def eigent_make_sub_tasks(\n        self,\n        task: Task,\n        coordinator_context: str = \"\",\n        on_stream_batch=None,\n        on_stream_text=None,\n    ):\n        ",
        "signatures": {},
        "detailedLines": [
          {
            "text": "class Workforce(BaseWorkforce):",
            "lineNumber": 36,
            "isSignature": true
          },
          {
            "text": "    def __init__(",
            "lineNumber": 37
          },
          {
            "text": "        self,",
            "lineNumber": 38
          },
          {
            "text": "        api_task_id: str,",
            "lineNumber": 39
          },
          {
            "text": "        description: str,",
            "lineNumber": 40
          },
          {
            "text": "        children: List[BaseNode] | None = None,",
            "lineNumber": 41
          },
          {
            "text": "        coordinator_agent: ChatAgent | None = None,",
            "lineNumber": 42
          },
          {
            "text": "        task_agent: ChatAgent | None = None,",
            "lineNumber": 43
          },
          {
            "text": "        new_worker_agent: ChatAgent | None = None,",
            "lineNumber": 44
          },
          {
            "text": "        graceful_shutdown_timeout: float = 3,",
            "lineNumber": 45
          },
          {
            "text": "        share_memory: bool = False,",
            "lineNumber": 46
          },
          {
            "text": "        use_structured_output_handler: bool = True,",
            "lineNumber": 47
          },
          {
            "text": "    ) -&gt; None:",
            "lineNumber": 48
          },
          {
            "text": "        self.api_task_id = api_task_id",
            "lineNumber": 49
          },
          {
            "text": "        logger.info(\"=\" * 80)",
            "lineNumber": 50
          },
          {
            "text": "        logger.info(\"🏭 [WF-LIFECYCLE] Workforce.__init__ STARTED\", extra={\"api_task_id\": api_task_id})",
            "lineNumber": 51
          },
          {
            "text": "        logger.info(f\"[WF-LIFECYCLE] Workforce id will be: {id(self)}\")",
            "lineNumber": 52
          },
          {
            "text": "        logger.info(f\"[WF-LIFECYCLE] Init params: graceful_shutdown_timeout={graceful_shutdown_timeout}, share_memory={share_memory}\")",
            "lineNumber": 53
          },
          {
            "text": "        logger.info(\"=\" * 80)",
            "lineNumber": 54
          },
          {
            "text": "        super().__init__(",
            "lineNumber": 55
          },
          {
            "text": "            description=description,",
            "lineNumber": 56
          },
          {
            "text": "            children=children,",
            "lineNumber": 57
          },
          {
            "text": "            coordinator_agent=coordinator_agent,",
            "lineNumber": 58
          },
          {
            "text": "            task_agent=task_agent,",
            "lineNumber": 59
          },
          {
            "text": "            new_worker_agent=new_worker_agent,",
            "lineNumber": 60
          },
          {
            "text": "            graceful_shutdown_timeout=graceful_shutdown_timeout,",
            "lineNumber": 61
          },
          {
            "text": "            share_memory=share_memory,",
            "lineNumber": 62
          },
          {
            "text": "            use_structured_output_handler=use_structured_output_handler,",
            "lineNumber": 63
          },
          {
            "text": "            task_timeout_seconds=1800,  # 30 minutes",
            "lineNumber": 64
          },
          {
            "text": "            failure_handling_config=FailureHandlingConfig(",
            "lineNumber": 65
          },
          {
            "text": "                enabled_strategies=[\"retry\", \"replan\"],",
            "lineNumber": 66
          },
          {
            "text": "            ),",
            "lineNumber": 67
          },
          {
            "text": "        )",
            "lineNumber": 68
          },
          {
            "text": "        self.task_agent.stream_accumulate = True",
            "lineNumber": 69
          },
          {
            "text": "        self.task_agent._stream_accumulate_explicit = True",
            "lineNumber": 70
          },
          {
            "text": "        logger.info(f\"[WF-LIFECYCLE] ✅ Workforce.__init__ COMPLETED, id={id(self)}\")",
            "lineNumber": 71
          },
          {
            "lineNumber": 72
          },
          {
            "text": "    def eigent_make_sub_tasks(",
            "lineNumber": 73
          },
          {
            "text": "        self,",
            "lineNumber": 74
          },
          {
            "text": "        task: Task,",
            "lineNumber": 75
          },
          {
            "text": "        coordinator_context: str = \"\",",
            "lineNumber": 76
          },
          {
            "text": "        on_stream_batch=None,",
            "lineNumber": 77
          },
          {
            "text": "        on_stream_text=None,",
            "lineNumber": 78
          },
          {
            "text": "    ):",
            "lineNumber": 79
          },
          {
            "text": "        ",
            "lineNumber": 80
          }
        ]
      },
      "score": 0.420803964138031
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\service\\chat_service.py",
        "range": {
          "startPosition": {
            "line": 1300
          },
          "endPosition": {
            "line": 1424
          }
        },
        "contents": "@traceroot.trace()\nasync def construct_workforce(options: Chat) -&gt; tuple[Workforce, ListenChatAgent]:\n\"\"\",\n        }.items()\n    ]\n    new_worker_agent = agent_model(\n        Agents.new_worker_agent,\n        f\"\"\"\n        You are a helpful assistant.\n- You are now working in system {platform.system()} with architecture\n{platform.machine()} at working directory &#96;{working_directory}&#96;. All local file operations must occur here, but you can access files from any place in the file system. For all file system operations, you MUST use absolute paths to ensure precision and avoid ambiguity.\nThe current date is {datetime.date.today()}. For any date-related tasks, you MUST use this as the current date.\n        \"\"\",\n        options,\n        [\n            *HumanToolkit.get_can_use_tools(options.project_id, Agents.new_worker_agent),\n            *(\n                ToolkitMessageIntegration(\n                    message_handler=HumanToolkit(options.project_id, Agents.new_worker_agent).send_message_to_user\n                ).register_toolkits(NoteTakingToolkit(options.project_id, working_directory=working_directory))\n            ).get_tools(),\n        ],\n    )\n    # msg_toolkit = AgentCommunicationToolkit(max_message_history=100)\n\n    searcher = browser_agent(options)\n    developer = await developer_agent(options)\n    documenter = await document_agent(options)\n    multi_modaler = multi_modal_agent(options)\n\n    # msg_toolkit.register_agent(\"Worker\", new_worker_agent)\n    # msg_toolkit.register_agent(\"Browser_Agent\", searcher)\n    # msg_toolkit.register_agent(\"Developer_Agent\", developer)\n    # msg_toolkit.register_agent(\"Document_Agent\", documenter)\n    # msg_toolkit.register_agent(\"Multi_Modal_Agent\", multi_modaler)\n\n    # Convert string model_platform to enum for comparison\n    try:\n        model_platform_enum = ModelPlatformType(options.model_platform.lower())\n    except (ValueError, AttributeError):\n        # If conversion fails, default to non-OpenAI behavior\n        model_platform_enum = None\n\n    workforce =",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 1301,
                "column": 1
              },
              "endPosition": {
                "line": 1302,
                "column": 1
              }
            },
            {
              "startPosition": {
                "line": 1302,
                "column": 1
              },
              "endPosition": {
                "line": 1303,
                "column": 5
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "@traceroot.trace()",
            "lineNumber": 1301
          },
          {
            "text": "async def construct_workforce(options: Chat) -&gt; tuple[Workforce, ListenChatAgent]:",
            "lineNumber": 1302,
            "isSignature": true
          },
          {
            "text": "\"\"\",",
            "lineNumber": 1335
          },
          {
            "text": "        }.items()",
            "lineNumber": 1336
          },
          {
            "text": "    ]",
            "lineNumber": 1337
          },
          {
            "text": "    new_worker_agent = agent_model(",
            "lineNumber": 1338
          },
          {
            "text": "        Agents.new_worker_agent,",
            "lineNumber": 1339
          },
          {
            "text": "        f\"\"\"",
            "lineNumber": 1340
          },
          {
            "text": "        You are a helpful assistant.",
            "lineNumber": 1341
          },
          {
            "text": "- You are now working in system {platform.system()} with architecture",
            "lineNumber": 1342
          },
          {
            "text": "{platform.machine()} at working directory &#96;{working_directory}&#96;. All local file operations must occur here, but you can access files from any place in the file system. For all file system operations, you MUST use absolute paths to ensure precision and avoid ambiguity.",
            "lineNumber": 1343
          },
          {
            "text": "The current date is {datetime.date.today()}. For any date-related tasks, you MUST use this as the current date.",
            "lineNumber": 1344
          },
          {
            "text": "        \"\"\",",
            "lineNumber": 1345
          },
          {
            "text": "        options,",
            "lineNumber": 1346
          },
          {
            "text": "        [",
            "lineNumber": 1347
          },
          {
            "text": "            *HumanToolkit.get_can_use_tools(options.project_id, Agents.new_worker_agent),",
            "lineNumber": 1348
          },
          {
            "text": "            *(",
            "lineNumber": 1349
          },
          {
            "text": "                ToolkitMessageIntegration(",
            "lineNumber": 1350
          },
          {
            "text": "                    message_handler=HumanToolkit(options.project_id, Agents.new_worker_agent).send_message_to_user",
            "lineNumber": 1351
          },
          {
            "text": "                ).register_toolkits(NoteTakingToolkit(options.project_id, working_directory=working_directory))",
            "lineNumber": 1352
          },
          {
            "text": "            ).get_tools(),",
            "lineNumber": 1353
          },
          {
            "text": "        ],",
            "lineNumber": 1354
          },
          {
            "text": "    )",
            "lineNumber": 1355
          },
          {
            "text": "    # msg_toolkit = AgentCommunicationToolkit(max_message_history=100)",
            "lineNumber": 1356
          },
          {
            "lineNumber": 1357
          },
          {
            "text": "    searcher = browser_agent(options)",
            "lineNumber": 1358
          },
          {
            "text": "    developer = await developer_agent(options)",
            "lineNumber": 1359
          },
          {
            "text": "    documenter = await document_agent(options)",
            "lineNumber": 1360
          },
          {
            "text": "    multi_modaler = multi_modal_agent(options)",
            "lineNumber": 1361
          },
          {
            "lineNumber": 1362
          },
          {
            "text": "    # msg_toolkit.register_agent(\"Worker\", new_worker_agent)",
            "lineNumber": 1363
          },
          {
            "text": "    # msg_toolkit.register_agent(\"Browser_Agent\", searcher)",
            "lineNumber": 1364
          },
          {
            "text": "    # msg_toolkit.register_agent(\"Developer_Agent\", developer)",
            "lineNumber": 1365
          },
          {
            "text": "    # msg_toolkit.register_agent(\"Document_Agent\", documenter)",
            "lineNumber": 1366
          },
          {
            "text": "    # msg_toolkit.register_agent(\"Multi_Modal_Agent\", multi_modaler)",
            "lineNumber": 1367
          },
          {
            "lineNumber": 1368
          },
          {
            "text": "    # Convert string model_platform to enum for comparison",
            "lineNumber": 1369
          },
          {
            "text": "    try:",
            "lineNumber": 1370
          },
          {
            "text": "        model_platform_enum = ModelPlatformType(options.model_platform.lower())",
            "lineNumber": 1371
          },
          {
            "text": "    except (ValueError, AttributeError):",
            "lineNumber": 1372
          },
          {
            "text": "        # If conversion fails, default to non-OpenAI behavior",
            "lineNumber": 1373
          },
          {
            "text": "        model_platform_enum = None",
            "lineNumber": 1374
          },
          {
            "lineNumber": 1375
          },
          {
            "text": "    workforce =",
            "lineNumber": 1376
          }
        ]
      },
      "score": 0.4129970073699951
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\controller\\task_controller.py",
        "range": {
          "startPosition": {
            "line": 57,
            "column": 36
          },
          "endPosition": {
            "line": 80
          }
        },
        "contents": "@router.post(\"/task/{id}/add-agent\", name=\"add new agent\")\n@traceroot.trace()\ndef add_agent(id: str, data: NewAgent):\n    logger.info(\"Adding new agent to task\", extra={\"task_id\": id, \"agent_name\": data.name})\n    logger.debug(\"New agent data\", extra={\"task_id\": id, \"agent_data\": data.model_dump_json()})\n    # Set user-specific environment path for this thread\n    set_user_env_path(data.env_path)\n    load_dotenv(dotenv_path=data.env_path)\n    asyncio.run(get_task_lock(id).put_queue(ActionNewAgent(**data.model_dump())))\n    logger.info(\"Agent added to task\", extra={\"task_id\": id, \"agent_name\": data.name})\n    return Response(status_code=204)\n\n\n@router.delete(\"/task/stop-all\", name=\"stop all tasks\")\n@traceroot.trace()\ndef stop_all():\n    logger.warning(\"Stopping all tasks\", extra={\"task_count\": len(task_locks)})",
        "signatures": {},
        "detailedLines": [
          {
            "text": "@router.post(\"/task/{id}/add-agent\", name=\"add new agent\")",
            "lineNumber": 61
          },
          {
            "text": "@traceroot.trace()",
            "lineNumber": 62
          },
          {
            "text": "def add_agent(id: str, data: NewAgent):",
            "lineNumber": 63,
            "isSignature": true
          },
          {
            "text": "    logger.info(\"Adding new agent to task\", extra={\"task_id\": id, \"agent_name\": data.name})",
            "lineNumber": 64
          },
          {
            "text": "    logger.debug(\"New agent data\", extra={\"task_id\": id, \"agent_data\": data.model_dump_json()})",
            "lineNumber": 65
          },
          {
            "text": "    # Set user-specific environment path for this thread",
            "lineNumber": 66
          },
          {
            "text": "    set_user_env_path(data.env_path)",
            "lineNumber": 67
          },
          {
            "text": "    load_dotenv(dotenv_path=data.env_path)",
            "lineNumber": 68
          },
          {
            "text": "    asyncio.run(get_task_lock(id).put_queue(ActionNewAgent(**data.model_dump())))",
            "lineNumber": 69
          },
          {
            "text": "    logger.info(\"Agent added to task\", extra={\"task_id\": id, \"agent_name\": data.name})",
            "lineNumber": 70
          },
          {
            "text": "    return Response(status_code=204)",
            "lineNumber": 71,
            "isSignature": true
          },
          {
            "lineNumber": 72
          },
          {
            "lineNumber": 73
          },
          {
            "text": "@router.delete(\"/task/stop-all\", name=\"stop all tasks\")",
            "lineNumber": 74
          },
          {
            "text": "@traceroot.trace()",
            "lineNumber": 75
          },
          {
            "text": "def stop_all():",
            "lineNumber": 76,
            "isSignature": true
          },
          {
            "text": "    logger.warning(\"Stopping all tasks\", extra={\"task_count\": len(task_locks)})",
            "lineNumber": 77
          }
        ]
      },
      "score": 0.40569794178009033
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\service\\chat_service.py",
        "range": {
          "startPosition": {
            "line": 1452,
            "column": 38
          },
          "endPosition": {
            "line": 1479,
            "column": 94
          }
        },
        "contents": "@traceroot.trace()\nasync def new_agent_model(data: NewAgent | ActionNewAgent, options: Chat):\n    logger.info(\"Creating new agent\", extra={\"agent_name\": data.name, \"project_id\": options.project_id, \"task_id\": options.task_id})\n    logger.debug(\"New agent data\", extra={\"agent_data\": data.model_dump_json()})\n    working_directory = get_working_directory(options)\n    tool_names = []\n    tools = [*await get_toolkits(data.tools, data.name, options.project_id)]\n    for item in data.tools:\n        tool_names.append(titleize(item))\n    if data.mcp_tools is not None:\n        tools = [*tools, *await get_mcp_tools(data.mcp_tools)]\n        for item in data.mcp_tools[\"mcpServers\"].keys():\n            tool_names.append(titleize(item))\n    for item in tools:\n        logger.debug(f\"Agent {data.name} tool: {item.func.__name__}\")\n    logger.info(f\"Agent {data.name} created with {len(tools)} tools: {tool_names}\")\n    # Enhanced system message with platform information\n    enhanced_description = f\"\"\"{data.description}\n- You are now working in system {platform.system()} with architecture\n{platform.machine()} at working directory &#96;{working_directory}&#96;. All local file operations must occur here, but you can access files from any place in the file system. For all file system operations, you MUST use absolute paths to ensure precision and avoid ambiguity.\nThe current date is {datetime.date.today()}. For any date-related tasks, you \nMUST use this as the current date.\n\"\"\"\n\n    return agent_model(data.name, enhanced_description, options, tools, tool_names=tool_names)",
        "signatures": {},
        "detailedLines": [
          {
            "text": "@traceroot.trace()",
            "lineNumber": 1456
          },
          {
            "text": "async def new_agent_model(data: NewAgent | ActionNewAgent, options: Chat):",
            "lineNumber": 1457,
            "isSignature": true
          },
          {
            "text": "    logger.info(\"Creating new agent\", extra={\"agent_name\": data.name, \"project_id\": options.project_id, \"task_id\": options.task_id})",
            "lineNumber": 1458
          },
          {
            "text": "    logger.debug(\"New agent data\", extra={\"agent_data\": data.model_dump_json()})",
            "lineNumber": 1459
          },
          {
            "text": "    working_directory = get_working_directory(options)",
            "lineNumber": 1460
          },
          {
            "text": "    tool_names = []",
            "lineNumber": 1461
          },
          {
            "text": "    tools = [*await get_toolkits(data.tools, data.name, options.project_id)]",
            "lineNumber": 1462
          },
          {
            "text": "    for item in data.tools:",
            "lineNumber": 1463
          },
          {
            "text": "        tool_names.append(titleize(item))",
            "lineNumber": 1464
          },
          {
            "text": "    if data.mcp_tools is not None:",
            "lineNumber": 1465
          },
          {
            "text": "        tools = [*tools, *await get_mcp_tools(data.mcp_tools)]",
            "lineNumber": 1466
          },
          {
            "text": "        for item in data.mcp_tools[\"mcpServers\"].keys():",
            "lineNumber": 1467
          },
          {
            "text": "            tool_names.append(titleize(item))",
            "lineNumber": 1468
          },
          {
            "text": "    for item in tools:",
            "lineNumber": 1469
          },
          {
            "text": "        logger.debug(f\"Agent {data.name} tool: {item.func.__name__}\")",
            "lineNumber": 1470
          },
          {
            "text": "    logger.info(f\"Agent {data.name} created with {len(tools)} tools: {tool_names}\")",
            "lineNumber": 1471
          },
          {
            "text": "    # Enhanced system message with platform information",
            "lineNumber": 1472
          },
          {
            "text": "    enhanced_description = f\"\"\"{data.description}",
            "lineNumber": 1473
          },
          {
            "text": "- You are now working in system {platform.system()} with architecture",
            "lineNumber": 1474
          },
          {
            "text": "{platform.machine()} at working directory &#96;{working_directory}&#96;. All local file operations must occur here, but you can access files from any place in the file system. For all file system operations, you MUST use absolute paths to ensure precision and avoid ambiguity.",
            "lineNumber": 1475
          },
          {
            "text": "The current date is {datetime.date.today()}. For any date-related tasks, you ",
            "lineNumber": 1476
          },
          {
            "text": "MUST use this as the current date.",
            "lineNumber": 1477
          },
          {
            "text": "\"\"\"",
            "lineNumber": 1478
          },
          {
            "lineNumber": 1479
          },
          {
            "text": "    return agent_model(data.name, enhanced_description, options, tools, tool_names=tool_names)",
            "lineNumber": 1480,
            "isSignature": true
          }
        ]
      },
      "score": 0.4047420918941498
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\service\\chat_service.py",
        "range": {
          "startPosition": {
            "line": 1297,
            "column": 17
          },
          "endPosition": {
            "line": 1424
          }
        },
        "contents": "@traceroot.trace()\nasync def construct_workforce(options: Chat) -&gt; tuple[Workforce, ListenChatAgent]:\n    logger.info(\"Constructing workforce\", extra={\"project_id\": options.project_id, \"task_id\": options.task_id})\n    working_directory = get_working_directory(options)\n    logger.debug(\"Working directory set\", extra={\"working_directory\": working_directory})\n    [coordinator_agent, task_agent] = [\n        agent_model(\n            key,\n            prompt,\n            options,\n            [\n                *(\n                    ToolkitMessageIntegration(\n                        message_handler=HumanToolkit(options.project_id, key).send_message_to_user\n                    ).register_toolkits(NoteTakingToolkit(options.project_id, working_directory=working_directory))\n                ).get_tools()\n            ],\n        )\n        for key, prompt in {\n            Agents.coordinator_agent:",
        "signatures": {},
        "detailedLines": [
          {
            "text": "@traceroot.trace()",
            "lineNumber": 1301
          },
          {
            "text": "async def construct_workforce(options: Chat) -&gt; tuple[Workforce, ListenChatAgent]:",
            "lineNumber": 1302,
            "isSignature": true
          },
          {
            "text": "    logger.info(\"Constructing workforce\", extra={\"project_id\": options.project_id, \"task_id\": options.task_id})",
            "lineNumber": 1303
          },
          {
            "text": "    working_directory = get_working_directory(options)",
            "lineNumber": 1304
          },
          {
            "text": "    logger.debug(\"Working directory set\", extra={\"working_directory\": working_directory})",
            "lineNumber": 1305
          },
          {
            "text": "    [coordinator_agent, task_agent] = [",
            "lineNumber": 1306
          },
          {
            "text": "        agent_model(",
            "lineNumber": 1307
          },
          {
            "text": "            key,",
            "lineNumber": 1308
          },
          {
            "text": "            prompt,",
            "lineNumber": 1309
          },
          {
            "text": "            options,",
            "lineNumber": 1310
          },
          {
            "text": "            [",
            "lineNumber": 1311
          },
          {
            "text": "                *(",
            "lineNumber": 1312
          },
          {
            "text": "                    ToolkitMessageIntegration(",
            "lineNumber": 1313
          },
          {
            "text": "                        message_handler=HumanToolkit(options.project_id, key).send_message_to_user",
            "lineNumber": 1314
          },
          {
            "text": "                    ).register_toolkits(NoteTakingToolkit(options.project_id, working_directory=working_directory))",
            "lineNumber": 1315
          },
          {
            "text": "                ).get_tools()",
            "lineNumber": 1316
          },
          {
            "text": "            ],",
            "lineNumber": 1317
          },
          {
            "text": "        )",
            "lineNumber": 1318
          },
          {
            "text": "        for key, prompt in {",
            "lineNumber": 1319
          },
          {
            "text": "            Agents.coordinator_agent:",
            "lineNumber": 1320
          }
        ]
      },
      "score": 0.3934352397918701
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\utils\\agent.py",
        "range": {
          "startPosition": {
            "line": 657
          },
          "endPosition": {
            "line": 765
          }
        },
        "contents": "@traceroot.trace()\ndef agent_model(\n    agent_name: str,\n    system_message: str | BaseMessage,\n    options: Chat,\n    tools: list[FunctionTool | Callable] | None = None,\n    prune_tool_calls_from_memory: bool = False,\n    tool_names: list[str] | None = None,\n    toolkits_to_register_agent: list[RegisteredAgentToolkit] | None = None,\n    enable_snapshot_clean: bool = False,\n):\n\n    if agent_name == Agents.browser_agent:\n        try:\n            model_platform_enum = ModelPlatformType(options.model_platform.lower())\n            if model_platform_enum in {\n                ModelPlatformType.OPENAI,\n                ModelPlatformType.AZURE,\n                ModelPlatformType.AIHUBMIX,\n            }:\n                model_config[\"parallel_tool_calls\"] = False\n        except (ValueError, AttributeError):\n            traceroot_logger.error(\n                f\"Invalid model platform for browser agent: {options.model_platform}\",\n                exc_info=True,\n            )\n            model_platform_enum = None\n\n    return ListenChatAgent(\n        options.project_id,\n        agent_name,\n        system_message,\n        model=ModelFactory.create(\n            model_platform=options.model_platform,\n            model_type=options.model_type,\n            api_key=options.api_key,\n            url=options.api_url,\n            model_config_dict=model_config or None,\n            **init_params,\n        ),\n        # output_language=options.language,\n        tools=tools,\n        agent_id=agent_id,\n        prune_tool_calls_from_memory=prune_tool_calls_from_memory,\n        toolkits_to_register_agent=toolkits_to_register_agent,\n        enable_snapshot_clean=enable_snapshot_clean,\n        stream_accumulate=False,\n    )\n\n\n@traceroot.trace()\ndef question_confirm_agent(options: Chat):\n    return",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 84,
                "column": 1
              },
              "endPosition": {
                "line": 85,
                "column": 5
              }
            },
            {
              "startPosition": {
                "line": 614,
                "column": 5
              },
              "endPosition": {
                "line": 615,
                "column": 5
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "@traceroot.trace()",
            "lineNumber": 658
          },
          {
            "text": "def agent_model(",
            "lineNumber": 659,
            "isSignature": true
          },
          {
            "text": "    agent_name: str,",
            "lineNumber": 660,
            "isSignature": true
          },
          {
            "text": "    system_message: str | BaseMessage,",
            "lineNumber": 661,
            "isSignature": true
          },
          {
            "text": "    options: Chat,",
            "lineNumber": 662,
            "isSignature": true
          },
          {
            "text": "    tools: list[FunctionTool | Callable] | None = None,",
            "lineNumber": 663,
            "isSignature": true
          },
          {
            "text": "    prune_tool_calls_from_memory: bool = False,",
            "lineNumber": 664,
            "isSignature": true
          },
          {
            "text": "    tool_names: list[str] | None = None,",
            "lineNumber": 665,
            "isSignature": true
          },
          {
            "text": "    toolkits_to_register_agent: list[RegisteredAgentToolkit] | None = None,",
            "lineNumber": 666,
            "isSignature": true
          },
          {
            "text": "    enable_snapshot_clean: bool = False,",
            "lineNumber": 667,
            "isSignature": true
          },
          {
            "text": "):",
            "lineNumber": 668,
            "isSignature": true
          },
          {
            "lineNumber": 721
          },
          {
            "text": "    if agent_name == Agents.browser_agent:",
            "lineNumber": 722
          },
          {
            "text": "        try:",
            "lineNumber": 723
          },
          {
            "text": "            model_platform_enum = ModelPlatformType(options.model_platform.lower())",
            "lineNumber": 724
          },
          {
            "text": "            if model_platform_enum in {",
            "lineNumber": 725
          },
          {
            "text": "                ModelPlatformType.OPENAI,",
            "lineNumber": 726
          },
          {
            "text": "                ModelPlatformType.AZURE,",
            "lineNumber": 727
          },
          {
            "text": "                ModelPlatformType.AIHUBMIX,",
            "lineNumber": 728
          },
          {
            "text": "            }:",
            "lineNumber": 729
          },
          {
            "text": "                model_config[\"parallel_tool_calls\"] = False",
            "lineNumber": 730
          },
          {
            "text": "        except (ValueError, AttributeError):",
            "lineNumber": 731
          },
          {
            "text": "            traceroot_logger.error(",
            "lineNumber": 732
          },
          {
            "text": "                f\"Invalid model platform for browser agent: {options.model_platform}\",",
            "lineNumber": 733
          },
          {
            "text": "                exc_info=True,",
            "lineNumber": 734
          },
          {
            "text": "            )",
            "lineNumber": 735
          },
          {
            "text": "            model_platform_enum = None",
            "lineNumber": 736
          },
          {
            "lineNumber": 737
          },
          {
            "text": "    return ListenChatAgent(",
            "lineNumber": 738
          },
          {
            "text": "        options.project_id,",
            "lineNumber": 739
          },
          {
            "text": "        agent_name,",
            "lineNumber": 740
          },
          {
            "text": "        system_message,",
            "lineNumber": 741
          },
          {
            "text": "        model=ModelFactory.create(",
            "lineNumber": 742
          },
          {
            "text": "            model_platform=options.model_platform,",
            "lineNumber": 743
          },
          {
            "text": "            model_type=options.model_type,",
            "lineNumber": 744
          },
          {
            "text": "            api_key=options.api_key,",
            "lineNumber": 745
          },
          {
            "text": "            url=options.api_url,",
            "lineNumber": 746
          },
          {
            "text": "            model_config_dict=model_config or None,",
            "lineNumber": 747
          },
          {
            "text": "            **init_params,",
            "lineNumber": 748
          },
          {
            "text": "        ),",
            "lineNumber": 749
          },
          {
            "text": "        # output_language=options.language,",
            "lineNumber": 750
          },
          {
            "text": "        tools=tools,",
            "lineNumber": 751
          },
          {
            "text": "        agent_id=agent_id,",
            "lineNumber": 752
          },
          {
            "text": "        prune_tool_calls_from_memory=prune_tool_calls_from_memory,",
            "lineNumber": 753
          },
          {
            "text": "        toolkits_to_register_agent=toolkits_to_register_agent,",
            "lineNumber": 754
          },
          {
            "text": "        enable_snapshot_clean=enable_snapshot_clean,",
            "lineNumber": 755
          },
          {
            "text": "        stream_accumulate=False,",
            "lineNumber": 756
          },
          {
            "text": "    )",
            "lineNumber": 757,
            "isSignature": true
          },
          {
            "lineNumber": 758
          },
          {
            "lineNumber": 759
          },
          {
            "text": "@traceroot.trace()",
            "lineNumber": 760
          },
          {
            "text": "def question_confirm_agent(options: Chat):",
            "lineNumber": 761,
            "isSignature": true
          },
          {
            "text": "    return",
            "lineNumber": 762
          }
        ]
      },
      "score": 0.39205870032310486
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\utils\\single_agent_worker.py",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 250
          }
        },
        "contents": "import datetime\nfrom camel.agents.chat_agent import AsyncStreamingChatAgentResponse\nfrom camel.societies.workforce.single_agent_worker import SingleAgentWorker as BaseSingleAgentWorker\nfrom camel.tasks.task import Task, TaskState, is_task_result_insufficient\nfrom utils import traceroot_wrapper as traceroot\n\nfrom app.utils.agent import ListenChatAgent\nfrom camel.societies.workforce.prompts import PROCESS_TASK_PROMPT\nfrom colorama import Fore\nfrom camel.societies.workforce.utils import TaskResult\nfrom camel.utils.context_utils import ContextUtility\n\nlogger = traceroot.get_logger(\"single_agent_worker\")\n\n\nclass SingleAgentWorker(BaseSingleAgentWorker):\n    def __init__(\n        self,\n        description: str,\n        worker: ListenChatAgent,\n        use_agent_pool: bool = True,\n        pool_initial_size: int = 1,\n        pool_max_size: int = 10,\n        auto_scale_pool: bool = True,\n        use_structured_output_handler: bool = True,\n        context_utility: ContextUtility | None = None,\n        enable_workflow_memory: bool = False,\n    ) -&gt; None:\n        logger.info(\"Initializing SingleAgentWorker\", extra={\n            \"description\": description,\n            \"worker_agent_name\": worker.agent_name,\n            \"use_agent_pool\": use_agent_pool,\n            \"pool_max_size\": pool_max_size,\n            \"enable_workflow_memory\": enable_workflow_memory\n        })\n        super().__init__(\n            description=description,\n            worker=worker,\n            use_agent_pool=use_agent_pool,\n            pool_initial_size=pool_initial_size,\n            pool_max_size=pool_max_size,\n            auto_scale_pool=auto_scale_pool,\n            use_structured_output_handler=use_structured_output_handler,\n            context_utility=context_utility,\n            enable_workflow_memory=enable_workflow_memory,\n        )\n        self.worker = worker  # change type hint\n\n    async def _process_task(self, task: Task, dependencies: list[Task]) -&gt; TaskState:\n        ",
        "signatures": {},
        "detailedLines": [
          {
            "text": "import datetime",
            "lineNumber": 1
          },
          {
            "text": "from camel.agents.chat_agent import AsyncStreamingChatAgentResponse",
            "lineNumber": 2
          },
          {
            "text": "from camel.societies.workforce.single_agent_worker import SingleAgentWorker as BaseSingleAgentWorker",
            "lineNumber": 3
          },
          {
            "text": "from camel.tasks.task import Task, TaskState, is_task_result_insufficient",
            "lineNumber": 4
          },
          {
            "text": "from utils import traceroot_wrapper as traceroot",
            "lineNumber": 5
          },
          {
            "lineNumber": 6
          },
          {
            "text": "from app.utils.agent import ListenChatAgent",
            "lineNumber": 7
          },
          {
            "text": "from camel.societies.workforce.prompts import PROCESS_TASK_PROMPT",
            "lineNumber": 8
          },
          {
            "text": "from colorama import Fore",
            "lineNumber": 9
          },
          {
            "text": "from camel.societies.workforce.utils import TaskResult",
            "lineNumber": 10
          },
          {
            "text": "from camel.utils.context_utils import ContextUtility",
            "lineNumber": 11
          },
          {
            "lineNumber": 12
          },
          {
            "text": "logger = traceroot.get_logger(\"single_agent_worker\")",
            "lineNumber": 13
          },
          {
            "lineNumber": 14
          },
          {
            "lineNumber": 15
          },
          {
            "text": "class SingleAgentWorker(BaseSingleAgentWorker):",
            "lineNumber": 16,
            "isSignature": true
          },
          {
            "text": "    def __init__(",
            "lineNumber": 17
          },
          {
            "text": "        self,",
            "lineNumber": 18
          },
          {
            "text": "        description: str,",
            "lineNumber": 19
          },
          {
            "text": "        worker: ListenChatAgent,",
            "lineNumber": 20
          },
          {
            "text": "        use_agent_pool: bool = True,",
            "lineNumber": 21
          },
          {
            "text": "        pool_initial_size: int = 1,",
            "lineNumber": 22
          },
          {
            "text": "        pool_max_size: int = 10,",
            "lineNumber": 23
          },
          {
            "text": "        auto_scale_pool: bool = True,",
            "lineNumber": 24
          },
          {
            "text": "        use_structured_output_handler: bool = True,",
            "lineNumber": 25
          },
          {
            "text": "        context_utility: ContextUtility | None = None,",
            "lineNumber": 26
          },
          {
            "text": "        enable_workflow_memory: bool = False,",
            "lineNumber": 27
          },
          {
            "text": "    ) -&gt; None:",
            "lineNumber": 28
          },
          {
            "text": "        logger.info(\"Initializing SingleAgentWorker\", extra={",
            "lineNumber": 29
          },
          {
            "text": "            \"description\": description,",
            "lineNumber": 30
          },
          {
            "text": "            \"worker_agent_name\": worker.agent_name,",
            "lineNumber": 31
          },
          {
            "text": "            \"use_agent_pool\": use_agent_pool,",
            "lineNumber": 32
          },
          {
            "text": "            \"pool_max_size\": pool_max_size,",
            "lineNumber": 33
          },
          {
            "text": "            \"enable_workflow_memory\": enable_workflow_memory",
            "lineNumber": 34
          },
          {
            "text": "        })",
            "lineNumber": 35
          },
          {
            "text": "        super().__init__(",
            "lineNumber": 36
          },
          {
            "text": "            description=description,",
            "lineNumber": 37
          },
          {
            "text": "            worker=worker,",
            "lineNumber": 38
          },
          {
            "text": "            use_agent_pool=use_agent_pool,",
            "lineNumber": 39
          },
          {
            "text": "            pool_initial_size=pool_initial_size,",
            "lineNumber": 40
          },
          {
            "text": "            pool_max_size=pool_max_size,",
            "lineNumber": 41
          },
          {
            "text": "            auto_scale_pool=auto_scale_pool,",
            "lineNumber": 42
          },
          {
            "text": "            use_structured_output_handler=use_structured_output_handler,",
            "lineNumber": 43
          },
          {
            "text": "            context_utility=context_utility,",
            "lineNumber": 44
          },
          {
            "text": "            enable_workflow_memory=enable_workflow_memory,",
            "lineNumber": 45
          },
          {
            "text": "        )",
            "lineNumber": 46
          },
          {
            "text": "        self.worker = worker  # change type hint",
            "lineNumber": 47
          },
          {
            "lineNumber": 48
          },
          {
            "text": "    async def _process_task(self, task: Task, dependencies: list[Task]) -&gt; TaskState:",
            "lineNumber": 49
          },
          {
            "text": "        ",
            "lineNumber": 50
          }
        ]
      },
      "score": 0.3858571946620941
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\utils\\agent.py",
        "range": {
          "startPosition": {
            "line": 1165,
            "column": 5
          },
          "endPosition": {
            "line": 1388
          }
        },
        "contents": "@traceroot.trace()\nasync def document_agent(options: Chat):\n    working_directory = get_working_directory(options)\n    traceroot_logger.info(\n        f\"Creating document agent for project: {options.project_id} in directory: {working_directory}\"\n    )\n    message_integration = ToolkitMessageIntegration(\n        message_handler=HumanToolkit(\n            options.project_id, Agents.task_agent\n        ).send_message_to_user\n    )\n    file_write_toolkit = FileToolkit(\n        options.project_id, working_directory=working_directory\n    )\n    pptx_toolkit = PPTXToolkit(options.project_id, working_directory=working_directory)\n    pptx_toolkit = message_integration.register_toolkits(pptx_toolkit)\n    mark_it_down_toolkit = MarkItDownToolkit(options.project_id)\n    mark_it_down_toolkit = message_integration.register_toolkits(mark_it_down_toolkit)\n    excel_toolkit = ExcelToolkit(\n        options.project_id, working_directory=working_directory\n    )\n    excel_toolkit = message_integration.register_toolkits(excel_toolkit)\n    note_toolkit = NoteTakingToolkit(\n        options.project_id, Agents.document_agent, working_directory=working_directory\n    )\n    note_toolkit = message_integration.register_toolkits(note_toolkit)\n    terminal_toolkit = TerminalToolkit(\n        options.project_id,\n        Agents.document_agent,\n        safe_mode=True,\n        clone_current_env=False,\n    )\n    terminal_toolkit = message_integration.register_toolkits(terminal_toolkit)\n    tools = [\n        *file_write_toolkit.get_tools(),\n        *pptx_toolkit.get_tools(),\n        *HumanToolkit.get_can_use_tools(options.project_id, Agents.document_agent),\n        *mark_it_down_toolkit.get_tools(),\n        *excel_toolkit.get_tools(),\n        *note_toolkit.get_tools(),\n        *terminal_toolkit.get_tools(),\n        *await GoogleDriveMCPToolkit.get_can_use_tools(\n            options.project_id, options.get_bun_env()\n        ),\n    ]\n    # if env(\"EXA_API_KEY\") or options.is_cloud():\n    #     search_toolkit = SearchToolkit(options.project_id, Agents.document_agent).search_exa",
        "signatures": {},
        "detailedLines": [
          {
            "text": "@traceroot.trace()",
            "lineNumber": 1169
          },
          {
            "text": "async def document_agent(options: Chat):",
            "lineNumber": 1170,
            "isSignature": true
          },
          {
            "text": "    working_directory = get_working_directory(options)",
            "lineNumber": 1171
          },
          {
            "text": "    traceroot_logger.info(",
            "lineNumber": 1172
          },
          {
            "text": "        f\"Creating document agent for project: {options.project_id} in directory: {working_directory}\"",
            "lineNumber": 1173
          },
          {
            "text": "    )",
            "lineNumber": 1174
          },
          {
            "text": "    message_integration = ToolkitMessageIntegration(",
            "lineNumber": 1175
          },
          {
            "text": "        message_handler=HumanToolkit(",
            "lineNumber": 1176
          },
          {
            "text": "            options.project_id, Agents.task_agent",
            "lineNumber": 1177
          },
          {
            "text": "        ).send_message_to_user",
            "lineNumber": 1178
          },
          {
            "text": "    )",
            "lineNumber": 1179
          },
          {
            "text": "    file_write_toolkit = FileToolkit(",
            "lineNumber": 1180
          },
          {
            "text": "        options.project_id, working_directory=working_directory",
            "lineNumber": 1181
          },
          {
            "text": "    )",
            "lineNumber": 1182
          },
          {
            "text": "    pptx_toolkit = PPTXToolkit(options.project_id, working_directory=working_directory)",
            "lineNumber": 1183
          },
          {
            "text": "    pptx_toolkit = message_integration.register_toolkits(pptx_toolkit)",
            "lineNumber": 1184
          },
          {
            "text": "    mark_it_down_toolkit = MarkItDownToolkit(options.project_id)",
            "lineNumber": 1185
          },
          {
            "text": "    mark_it_down_toolkit = message_integration.register_toolkits(mark_it_down_toolkit)",
            "lineNumber": 1186
          },
          {
            "text": "    excel_toolkit = ExcelToolkit(",
            "lineNumber": 1187
          },
          {
            "text": "        options.project_id, working_directory=working_directory",
            "lineNumber": 1188
          },
          {
            "text": "    )",
            "lineNumber": 1189
          },
          {
            "text": "    excel_toolkit = message_integration.register_toolkits(excel_toolkit)",
            "lineNumber": 1190
          },
          {
            "text": "    note_toolkit = NoteTakingToolkit(",
            "lineNumber": 1191
          },
          {
            "text": "        options.project_id, Agents.document_agent, working_directory=working_directory",
            "lineNumber": 1192
          },
          {
            "text": "    )",
            "lineNumber": 1193
          },
          {
            "text": "    note_toolkit = message_integration.register_toolkits(note_toolkit)",
            "lineNumber": 1194
          },
          {
            "text": "    terminal_toolkit = TerminalToolkit(",
            "lineNumber": 1195
          },
          {
            "text": "        options.project_id,",
            "lineNumber": 1196
          },
          {
            "text": "        Agents.document_agent,",
            "lineNumber": 1197
          },
          {
            "text": "        safe_mode=True,",
            "lineNumber": 1198
          },
          {
            "text": "        clone_current_env=False,",
            "lineNumber": 1199
          },
          {
            "text": "    )",
            "lineNumber": 1200
          },
          {
            "text": "    terminal_toolkit = message_integration.register_toolkits(terminal_toolkit)",
            "lineNumber": 1201
          },
          {
            "text": "    tools = [",
            "lineNumber": 1202
          },
          {
            "text": "        *file_write_toolkit.get_tools(),",
            "lineNumber": 1203
          },
          {
            "text": "        *pptx_toolkit.get_tools(),",
            "lineNumber": 1204
          },
          {
            "text": "        *HumanToolkit.get_can_use_tools(options.project_id, Agents.document_agent),",
            "lineNumber": 1205
          },
          {
            "text": "        *mark_it_down_toolkit.get_tools(),",
            "lineNumber": 1206
          },
          {
            "text": "        *excel_toolkit.get_tools(),",
            "lineNumber": 1207
          },
          {
            "text": "        *note_toolkit.get_tools(),",
            "lineNumber": 1208
          },
          {
            "text": "        *terminal_toolkit.get_tools(),",
            "lineNumber": 1209
          },
          {
            "text": "        *await GoogleDriveMCPToolkit.get_can_use_tools(",
            "lineNumber": 1210
          },
          {
            "text": "            options.project_id, options.get_bun_env()",
            "lineNumber": 1211
          },
          {
            "text": "        ),",
            "lineNumber": 1212
          },
          {
            "text": "    ]",
            "lineNumber": 1213
          },
          {
            "text": "    # if env(\"EXA_API_KEY\") or options.is_cloud():",
            "lineNumber": 1214
          },
          {
            "text": "    #     search_toolkit = SearchToolkit(options.project_id, Agents.document_agent).search_exa",
            "lineNumber": 1215
          }
        ]
      },
      "score": 0.38377636671066284
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\utils\\agent.py",
        "range": {
          "startPosition": {
            "line": 1710,
            "column": 5
          },
          "endPosition": {
            "line": 1785
          }
        },
        "contents": "@traceroot.trace()\nasync def mcp_agent(options: Chat):\n    traceroot_logger.info(\n        f\"Creating MCP agent for project: {options.project_id} with {len(options.installed_mcp['mcpServers'])} MCP servers\"\n    )\n    tools = [\n        # *HumanToolkit.get_can_use_tools(options.project_id, Agents.mcp_agent),\n        *McpSearchToolkit(options.project_id).get_tools(),\n    ]\n    if len(options.installed_mcp[\"mcpServers\"]) &gt; 0:\n        try:\n            mcp_tools = await get_mcp_tools(options.installed_mcp)\n            traceroot_logger.info(\n                f\"Retrieved {len(mcp_tools)} MCP tools for task {options.project_id}\"\n            )\n            if mcp_tools:\n                tool_names = [\n                    (\n                        tool.get_function_name()\n                        if hasattr(tool, \"get_function_name\")\n                        else str(tool)\n                    )\n                    for tool in mcp_tools\n                ]\n                traceroot_logger.debug(f\"MCP tools: {tool_names}\")\n            tools = [*tools, *mcp_tools]\n        except Exception as e:\n            traceroot_logger.debug(repr(e))\n\n    task_lock = get_task_lock(options.project_id)\n    agent_id = str(uuid.uuid4())\n    traceroot_logger.info(\n        f\"Creating MCP agent: {Agents.mcp_agent} with id: {agent_id} for task: {options.project_id}\"\n    )\n    asyncio.create_task(\n        task_lock.put_queue(\n            ActionCreateAgentData(\n                data={\n                    \"agent_name\": Agents.mcp_agent,\n                    \"agent_id\": agent_id,\n                    \"tools\": [\n                        key for key in options.installed_mcp[\"mcpServers\"].keys()\n                    ],\n                }\n            )\n        )\n    )\n    return ListenChatAgent(\n        options.project_id,\n        Agents.mcp_agent",
        "signatures": {},
        "detailedLines": [
          {
            "text": "@traceroot.trace()",
            "lineNumber": 1714
          },
          {
            "text": "async def mcp_agent(options: Chat):",
            "lineNumber": 1715,
            "isSignature": true
          },
          {
            "text": "    traceroot_logger.info(",
            "lineNumber": 1716
          },
          {
            "text": "        f\"Creating MCP agent for project: {options.project_id} with {len(options.installed_mcp['mcpServers'])} MCP servers\"",
            "lineNumber": 1717
          },
          {
            "text": "    )",
            "lineNumber": 1718
          },
          {
            "text": "    tools = [",
            "lineNumber": 1719
          },
          {
            "text": "        # *HumanToolkit.get_can_use_tools(options.project_id, Agents.mcp_agent),",
            "lineNumber": 1720
          },
          {
            "text": "        *McpSearchToolkit(options.project_id).get_tools(),",
            "lineNumber": 1721
          },
          {
            "text": "    ]",
            "lineNumber": 1722
          },
          {
            "text": "    if len(options.installed_mcp[\"mcpServers\"]) &gt; 0:",
            "lineNumber": 1723
          },
          {
            "text": "        try:",
            "lineNumber": 1724
          },
          {
            "text": "            mcp_tools = await get_mcp_tools(options.installed_mcp)",
            "lineNumber": 1725
          },
          {
            "text": "            traceroot_logger.info(",
            "lineNumber": 1726
          },
          {
            "text": "                f\"Retrieved {len(mcp_tools)} MCP tools for task {options.project_id}\"",
            "lineNumber": 1727
          },
          {
            "text": "            )",
            "lineNumber": 1728
          },
          {
            "text": "            if mcp_tools:",
            "lineNumber": 1729
          },
          {
            "text": "                tool_names = [",
            "lineNumber": 1730
          },
          {
            "text": "                    (",
            "lineNumber": 1731
          },
          {
            "text": "                        tool.get_function_name()",
            "lineNumber": 1732
          },
          {
            "text": "                        if hasattr(tool, \"get_function_name\")",
            "lineNumber": 1733
          },
          {
            "text": "                        else str(tool)",
            "lineNumber": 1734
          },
          {
            "text": "                    )",
            "lineNumber": 1735
          },
          {
            "text": "                    for tool in mcp_tools",
            "lineNumber": 1736
          },
          {
            "text": "                ]",
            "lineNumber": 1737
          },
          {
            "text": "                traceroot_logger.debug(f\"MCP tools: {tool_names}\")",
            "lineNumber": 1738
          },
          {
            "text": "            tools = [*tools, *mcp_tools]",
            "lineNumber": 1739
          },
          {
            "text": "        except Exception as e:",
            "lineNumber": 1740
          },
          {
            "text": "            traceroot_logger.debug(repr(e))",
            "lineNumber": 1741
          },
          {
            "lineNumber": 1742
          },
          {
            "text": "    task_lock = get_task_lock(options.project_id)",
            "lineNumber": 1743
          },
          {
            "text": "    agent_id = str(uuid.uuid4())",
            "lineNumber": 1744
          },
          {
            "text": "    traceroot_logger.info(",
            "lineNumber": 1745
          },
          {
            "text": "        f\"Creating MCP agent: {Agents.mcp_agent} with id: {agent_id} for task: {options.project_id}\"",
            "lineNumber": 1746
          },
          {
            "text": "    )",
            "lineNumber": 1747
          },
          {
            "text": "    asyncio.create_task(",
            "lineNumber": 1748
          },
          {
            "text": "        task_lock.put_queue(",
            "lineNumber": 1749
          },
          {
            "text": "            ActionCreateAgentData(",
            "lineNumber": 1750
          },
          {
            "text": "                data={",
            "lineNumber": 1751
          },
          {
            "text": "                    \"agent_name\": Agents.mcp_agent,",
            "lineNumber": 1752
          },
          {
            "text": "                    \"agent_id\": agent_id,",
            "lineNumber": 1753
          },
          {
            "text": "                    \"tools\": [",
            "lineNumber": 1754
          },
          {
            "text": "                        key for key in options.installed_mcp[\"mcpServers\"].keys()",
            "lineNumber": 1755
          },
          {
            "text": "                    ],",
            "lineNumber": 1756
          },
          {
            "text": "                }",
            "lineNumber": 1757
          },
          {
            "text": "            )",
            "lineNumber": 1758
          },
          {
            "text": "        )",
            "lineNumber": 1759
          },
          {
            "text": "    )",
            "lineNumber": 1760
          },
          {
            "text": "    return ListenChatAgent(",
            "lineNumber": 1761
          },
          {
            "text": "        options.project_id,",
            "lineNumber": 1762
          },
          {
            "text": "        Agents.mcp_agent",
            "lineNumber": 1763
          }
        ]
      },
      "score": 0.380450963973999
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\service\\chat_service.py",
        "range": {
          "startPosition": {
            "line": 1300
          },
          "endPosition": {
            "line": 1424,
            "column": 25
          }
        },
        "contents": "@traceroot.trace()\nasync def construct_workforce(options: Chat) -&gt; tuple[Workforce, ListenChatAgent]:\n\n        model_platform_enum = None\n\n    workforce = Workforce(\n        options.project_id,\n        \"A workforce\",\n        graceful_shutdown_timeout=3,  # 30 seconds for debugging\n        share_memory=False,\n        coordinator_agent=coordinator_agent,\n        task_agent=task_agent,\n        new_worker_agent=new_worker_agent,\n        use_structured_output_handler=False if model_platform_enum == ModelPlatformType.OPENAI else True,\n    )\n    workforce.add_single_agent_worker(\n        \"Developer Agent: A master-level coding assistant with a powerful \"\n        \"terminal. It can write and execute code, manage files, automate \"\n        \"desktop tasks, and deploy web applications to solve complex \"\n        \"technical challenges.\",\n        developer,\n    )\n    workforce.add_single_agent_worker(\n        \"Browser Agent: Can search the web, extract webpage content, \"\n        \"simulate browser actions, and provide relevant information to \"\n        \"solve the given task.\",\n        searcher,\n    )\n    workforce.add_single_agent_worker(\n        \"Document Agent: A document processing assistant skilled in creating \"\n        \"and modifying a wide range of file formats. It can generate \"\n        \"text-based files/reports (Markdown, JSON, YAML, HTML), \"\n        \"office documents (Word, PDF), presentations (PowerPoint), and \"\n        \"data files (Excel, CSV).\",\n        documenter,\n    )\n    workforce.add_single_agent_worker(\n        \"Multi-Modal Agent: A specialist in media processing. It can \"\n        \"analyze images and audio, transcribe speech, download videos, and \"\n        \"generate new images from text prompts.\",\n        multi_modaler,\n    )\n    # workforce.add_single_agent_worker(\n    #     \"Social Media Agent: A social media management assistant for \"\n    #     \"handling tasks related to WhatsApp, Twitter, LinkedIn, Reddit, \"\n    #     \"Notion, Slack, and other social platforms.\",\n    #     await social_medium_agent(options),\n    # )\n    mcp = await mcp_agent(options)\n    # workforce.add_single_agent_worker(\n    #     \"MCP Agent: A Model Context Protocol agent that provides access \"\n    #     \"to external tools and services through MCP integrations.\",\n    #     mcp,\n    # )\n    return workforce, mcp",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 1301,
                "column": 1
              },
              "endPosition": {
                "line": 1302,
                "column": 1
              }
            },
            {
              "startPosition": {
                "line": 1302,
                "column": 1
              },
              "endPosition": {
                "line": 1303,
                "column": 5
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "@traceroot.trace()",
            "lineNumber": 1301
          },
          {
            "text": "async def construct_workforce(options: Chat) -&gt; tuple[Workforce, ListenChatAgent]:",
            "lineNumber": 1302,
            "isSignature": true
          },
          {
            "lineNumber": 1373
          },
          {
            "text": "        model_platform_enum = None",
            "lineNumber": 1374
          },
          {
            "lineNumber": 1375
          },
          {
            "text": "    workforce = Workforce(",
            "lineNumber": 1376
          },
          {
            "text": "        options.project_id,",
            "lineNumber": 1377
          },
          {
            "text": "        \"A workforce\",",
            "lineNumber": 1378
          },
          {
            "text": "        graceful_shutdown_timeout=3,  # 30 seconds for debugging",
            "lineNumber": 1379
          },
          {
            "text": "        share_memory=False,",
            "lineNumber": 1380
          },
          {
            "text": "        coordinator_agent=coordinator_agent,",
            "lineNumber": 1381
          },
          {
            "text": "        task_agent=task_agent,",
            "lineNumber": 1382
          },
          {
            "text": "        new_worker_agent=new_worker_agent,",
            "lineNumber": 1383
          },
          {
            "text": "        use_structured_output_handler=False if model_platform_enum == ModelPlatformType.OPENAI else True,",
            "lineNumber": 1384
          },
          {
            "text": "    )",
            "lineNumber": 1385
          },
          {
            "text": "    workforce.add_single_agent_worker(",
            "lineNumber": 1386
          },
          {
            "text": "        \"Developer Agent: A master-level coding assistant with a powerful \"",
            "lineNumber": 1387
          },
          {
            "text": "        \"terminal. It can write and execute code, manage files, automate \"",
            "lineNumber": 1388
          },
          {
            "text": "        \"desktop tasks, and deploy web applications to solve complex \"",
            "lineNumber": 1389
          },
          {
            "text": "        \"technical challenges.\",",
            "lineNumber": 1390
          },
          {
            "text": "        developer,",
            "lineNumber": 1391
          },
          {
            "text": "    )",
            "lineNumber": 1392
          },
          {
            "text": "    workforce.add_single_agent_worker(",
            "lineNumber": 1393
          },
          {
            "text": "        \"Browser Agent: Can search the web, extract webpage content, \"",
            "lineNumber": 1394
          },
          {
            "text": "        \"simulate browser actions, and provide relevant information to \"",
            "lineNumber": 1395
          },
          {
            "text": "        \"solve the given task.\",",
            "lineNumber": 1396
          },
          {
            "text": "        searcher,",
            "lineNumber": 1397
          },
          {
            "text": "    )",
            "lineNumber": 1398
          },
          {
            "text": "    workforce.add_single_agent_worker(",
            "lineNumber": 1399
          },
          {
            "text": "        \"Document Agent: A document processing assistant skilled in creating \"",
            "lineNumber": 1400
          },
          {
            "text": "        \"and modifying a wide range of file formats. It can generate \"",
            "lineNumber": 1401
          },
          {
            "text": "        \"text-based files/reports (Markdown, JSON, YAML, HTML), \"",
            "lineNumber": 1402
          },
          {
            "text": "        \"office documents (Word, PDF), presentations (PowerPoint), and \"",
            "lineNumber": 1403
          },
          {
            "text": "        \"data files (Excel, CSV).\",",
            "lineNumber": 1404
          },
          {
            "text": "        documenter,",
            "lineNumber": 1405
          },
          {
            "text": "    )",
            "lineNumber": 1406
          },
          {
            "text": "    workforce.add_single_agent_worker(",
            "lineNumber": 1407
          },
          {
            "text": "        \"Multi-Modal Agent: A specialist in media processing. It can \"",
            "lineNumber": 1408
          },
          {
            "text": "        \"analyze images and audio, transcribe speech, download videos, and \"",
            "lineNumber": 1409
          },
          {
            "text": "        \"generate new images from text prompts.\",",
            "lineNumber": 1410
          },
          {
            "text": "        multi_modaler,",
            "lineNumber": 1411
          },
          {
            "text": "    )",
            "lineNumber": 1412
          },
          {
            "text": "    # workforce.add_single_agent_worker(",
            "lineNumber": 1413
          },
          {
            "text": "    #     \"Social Media Agent: A social media management assistant for \"",
            "lineNumber": 1414
          },
          {
            "text": "    #     \"handling tasks related to WhatsApp, Twitter, LinkedIn, Reddit, \"",
            "lineNumber": 1415
          },
          {
            "text": "    #     \"Notion, Slack, and other social platforms.\",",
            "lineNumber": 1416
          },
          {
            "text": "    #     await social_medium_agent(options),",
            "lineNumber": 1417
          },
          {
            "text": "    # )",
            "lineNumber": 1418
          },
          {
            "text": "    mcp = await mcp_agent(options)",
            "lineNumber": 1419
          },
          {
            "text": "    # workforce.add_single_agent_worker(",
            "lineNumber": 1420
          },
          {
            "text": "    #     \"MCP Agent: A Model Context Protocol agent that provides access \"",
            "lineNumber": 1421
          },
          {
            "text": "    #     \"to external tools and services through MCP integrations.\",",
            "lineNumber": 1422
          },
          {
            "text": "    #     mcp,",
            "lineNumber": 1423
          },
          {
            "text": "    # )",
            "lineNumber": 1424
          },
          {
            "text": "    return workforce, mcp",
            "lineNumber": 1425,
            "isSignature": true
          }
        ]
      },
      "score": 0.38033145666122437
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\utils\\agent.py",
        "range": {
          "startPosition": {
            "line": 1713
          },
          "endPosition": {
            "line": 1831
          }
        },
        "contents": "@traceroot.trace()\nasync def mcp_agent(options: Chat):\n\n    return ListenChatAgent(\n        options.project_id,\n        Agents.mcp_agent,\n        system_message=\"You are a helpful assistant that can help users search mcp servers. The found mcp services will be returned to the user, and you will ask the user via ask_human_via_gui whether they want to install these mcp services.\",\n        model=ModelFactory.create(\n            model_platform=options.model_platform,\n            model_type=options.model_type,\n            api_key=options.api_key,\n            url=options.api_url,\n            model_config_dict=(\n                {\n                    \"user\": str(options.project_id),\n                }\n                if options.is_cloud()\n                else None\n            ),\n            **{\n                k: v\n                for k, v in (options.extra_params or {}).items()\n                if k not in [\"model_platform\", \"model_type\", \"api_key\", \"url\"]\n            },\n        ),\n        # output_language=options.language,\n        tools=tools,\n        agent_id=agent_id,\n    )\n\n\n@traceroot.trace()\nasync def get_toolkits(tools: list[str], agent_name: str, api_task_id: str):\n    ",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 1714,
                "column": 1
              },
              "endPosition": {
                "line": 1715,
                "column": 1
              }
            },
            {
              "startPosition": {
                "line": 1715,
                "column": 1
              },
              "endPosition": {
                "line": 1716,
                "column": 5
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "@traceroot.trace()",
            "lineNumber": 1714
          },
          {
            "text": "async def mcp_agent(options: Chat):",
            "lineNumber": 1715,
            "isSignature": true
          },
          {
            "lineNumber": 1760
          },
          {
            "text": "    return ListenChatAgent(",
            "lineNumber": 1761
          },
          {
            "text": "        options.project_id,",
            "lineNumber": 1762
          },
          {
            "text": "        Agents.mcp_agent,",
            "lineNumber": 1763
          },
          {
            "text": "        system_message=\"You are a helpful assistant that can help users search mcp servers. The found mcp services will be returned to the user, and you will ask the user via ask_human_via_gui whether they want to install these mcp services.\",",
            "lineNumber": 1764
          },
          {
            "text": "        model=ModelFactory.create(",
            "lineNumber": 1765
          },
          {
            "text": "            model_platform=options.model_platform,",
            "lineNumber": 1766
          },
          {
            "text": "            model_type=options.model_type,",
            "lineNumber": 1767
          },
          {
            "text": "            api_key=options.api_key,",
            "lineNumber": 1768
          },
          {
            "text": "            url=options.api_url,",
            "lineNumber": 1769
          },
          {
            "text": "            model_config_dict=(",
            "lineNumber": 1770
          },
          {
            "text": "                {",
            "lineNumber": 1771
          },
          {
            "text": "                    \"user\": str(options.project_id),",
            "lineNumber": 1772
          },
          {
            "text": "                }",
            "lineNumber": 1773
          },
          {
            "text": "                if options.is_cloud()",
            "lineNumber": 1774
          },
          {
            "text": "                else None",
            "lineNumber": 1775
          },
          {
            "text": "            ),",
            "lineNumber": 1776
          },
          {
            "text": "            **{",
            "lineNumber": 1777
          },
          {
            "text": "                k: v",
            "lineNumber": 1778
          },
          {
            "text": "                for k, v in (options.extra_params or {}).items()",
            "lineNumber": 1779
          },
          {
            "text": "                if k not in [\"model_platform\", \"model_type\", \"api_key\", \"url\"]",
            "lineNumber": 1780
          },
          {
            "text": "            },",
            "lineNumber": 1781
          },
          {
            "text": "        ),",
            "lineNumber": 1782
          },
          {
            "text": "        # output_language=options.language,",
            "lineNumber": 1783
          },
          {
            "text": "        tools=tools,",
            "lineNumber": 1784
          },
          {
            "text": "        agent_id=agent_id,",
            "lineNumber": 1785
          },
          {
            "text": "    )",
            "lineNumber": 1786,
            "isSignature": true
          },
          {
            "lineNumber": 1787
          },
          {
            "lineNumber": 1788
          },
          {
            "text": "@traceroot.trace()",
            "lineNumber": 1789
          },
          {
            "text": "async def get_toolkits(tools: list[str], agent_name: str, api_task_id: str):",
            "lineNumber": 1790,
            "isSignature": true
          },
          {
            "text": "    ",
            "lineNumber": 1791
          }
        ]
      },
      "score": 0.3797636032104492
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\src\\store\\chatStore.ts",
        "range": {
          "startPosition": {
            "line": 162
          },
          "endPosition": {
            "line": 2594,
            "column": 1
          }
        },
        "contents": "const chatStore = \n(set, get) =&gt; (\n,\n\t\tstartTask: async (taskId: string, type?: string, shareToken?: string, delayTime?: number, messageContent?: string, messageAttaches?: File[]) =&gt; {\n\t\t\t// ✅ Wait for backend to be ready before starting task (except for replay/share)\n\t\t\tif (!type || type === 'normal') {\n\t\t\t\tconsole.log('[startTask] Checking if backend is ready...');\n\t\t\t\tconst isBackendReady = await waitForBackendReady(15000, 500); // Wait up to 15 seconds\n\n\t\t\t\tif (!isBackendReady) {\n\t\t\t\t\tconsole.error('[startTask] Backend is not ready, cannot start task');\n\t\t\t\t\tconst { addMessages } = get();\n\t\t\t\t\taddMessages(taskId, {\n\t\t\t\t\t\tid: generateUniqueId(),\n\t\t\t\t\t\trole: 'agent',\n\t\t\t\t\t\tcontent: '❌ Backend service is not ready. Please wait a moment and try again, or restart the application if the problem persists.',\n\t\t\t\t\t});\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tconsole.log('[startTask] Backend is ready, proceeding with task...');\n\t\t\t}\n\n\t\t\tconst { token, language, modelType, cloud_model_type, email } = getAuthStore()\n\t\t\tconst workerList = useWorkerList();\n\t\t\tconst { getLastUserMessage, setDelayTime, setType } = get();\n\t\t\tconst baseURL = await getBaseURL();\n\t\t\tlet systemLanguage = language\n\t\t\tif (language === 'system') {\n\t\t\t\tsystemLanguage = await window.ipcRenderer.invoke('get-system-language');\n\t\t\t}\n\t\t\tif (type === 'replay') {\n\t\t\t\tsetDelayTime(taskId, delayTime as number)\n\t\t\t\tsetType(taskId, type)\n\t\t\t}\n\n\t\t\t//ProjectStore must exist as chatStore is already\n\t\t\tconst projectStore = useProjectStore.getState();\n\t\t\tconst project_id = projectStore.activeProjectId;\n\t\t\t//Create a new chatStore on Start\n\t\t\tlet newTaskId = taskId;\n\t\t\tlet targetChatStore = { getState: () =&gt; get() }; // Default to current store\n\t\t\t/**\n\t\t\t * Replay creates its own chatStore for each task with replayProject\n\t\t\t */\n\t\t}\n)\n;",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 163,
                "column": 1
              },
              "endPosition": {
                "line": 163,
                "column": 7
              }
            },
            {
              "startPosition": {
                "line": 163,
                "column": 7
              },
              "endPosition": {
                "line": 163,
                "column": 19
              }
            },
            {
              "startPosition": {
                "line": 163,
                "column": 53
              },
              "endPosition": {
                "line": 163,
                "column": 53
              }
            },
            {
              "startPosition": {
                "line": 164,
                "column": 2
              },
              "endPosition": {
                "line": 164,
                "column": 17
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "const chatStore = ",
            "lineNumber": 163
          },
          {
            "text": "(set, get) =&gt; (",
            "lineNumber": 164
          },
          {
            "text": ",",
            "lineNumber": 330
          },
          {
            "text": "\t\tstartTask: async (taskId: string, type?: string, shareToken?: string, delayTime?: number, messageContent?: string, messageAttaches?: File[]) =&gt; {",
            "lineNumber": 331
          },
          {
            "text": "\t\t\t// ✅ Wait for backend to be ready before starting task (except for replay/share)",
            "lineNumber": 332
          },
          {
            "text": "\t\t\tif (!type || type === 'normal') {",
            "lineNumber": 333
          },
          {
            "text": "\t\t\t\tconsole.log('[startTask] Checking if backend is ready...');",
            "lineNumber": 334
          },
          {
            "text": "\t\t\t\tconst isBackendReady = await waitForBackendReady(15000, 500); // Wait up to 15 seconds",
            "lineNumber": 335
          },
          {
            "lineNumber": 336
          },
          {
            "text": "\t\t\t\tif (!isBackendReady) {",
            "lineNumber": 337
          },
          {
            "text": "\t\t\t\t\tconsole.error('[startTask] Backend is not ready, cannot start task');",
            "lineNumber": 338
          },
          {
            "text": "\t\t\t\t\tconst { addMessages } = get();",
            "lineNumber": 339
          },
          {
            "text": "\t\t\t\t\taddMessages(taskId, {",
            "lineNumber": 340
          },
          {
            "text": "\t\t\t\t\t\tid: generateUniqueId(),",
            "lineNumber": 341
          },
          {
            "text": "\t\t\t\t\t\trole: 'agent',",
            "lineNumber": 342
          },
          {
            "text": "\t\t\t\t\t\tcontent: '❌ Backend service is not ready. Please wait a moment and try again, or restart the application if the problem persists.',",
            "lineNumber": 343
          },
          {
            "text": "\t\t\t\t\t});",
            "lineNumber": 344
          },
          {
            "text": "\t\t\t\t\treturn;",
            "lineNumber": 345
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 346
          },
          {
            "text": "\t\t\t\tconsole.log('[startTask] Backend is ready, proceeding with task...');",
            "lineNumber": 347
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 348
          },
          {
            "lineNumber": 349
          },
          {
            "text": "\t\t\tconst { token, language, modelType, cloud_model_type, email } = getAuthStore()",
            "lineNumber": 350
          },
          {
            "text": "\t\t\tconst workerList = useWorkerList();",
            "lineNumber": 351
          },
          {
            "text": "\t\t\tconst { getLastUserMessage, setDelayTime, setType } = get();",
            "lineNumber": 352
          },
          {
            "text": "\t\t\tconst baseURL = await getBaseURL();",
            "lineNumber": 353
          },
          {
            "text": "\t\t\tlet systemLanguage = language",
            "lineNumber": 354
          },
          {
            "text": "\t\t\tif (language === 'system') {",
            "lineNumber": 355
          },
          {
            "text": "\t\t\t\tsystemLanguage = await window.ipcRenderer.invoke('get-system-language');",
            "lineNumber": 356
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 357
          },
          {
            "text": "\t\t\tif (type === 'replay') {",
            "lineNumber": 358
          },
          {
            "text": "\t\t\t\tsetDelayTime(taskId, delayTime as number)",
            "lineNumber": 359
          },
          {
            "text": "\t\t\t\tsetType(taskId, type)",
            "lineNumber": 360
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 361
          },
          {
            "lineNumber": 362
          },
          {
            "text": "\t\t\t//ProjectStore must exist as chatStore is already",
            "lineNumber": 363
          },
          {
            "text": "\t\t\tconst projectStore = useProjectStore.getState();",
            "lineNumber": 364
          },
          {
            "text": "\t\t\tconst project_id = projectStore.activeProjectId;",
            "lineNumber": 365
          },
          {
            "text": "\t\t\t//Create a new chatStore on Start",
            "lineNumber": 366
          },
          {
            "text": "\t\t\tlet newTaskId = taskId;",
            "lineNumber": 367
          },
          {
            "text": "\t\t\tlet targetChatStore = { getState: () =&gt; get() }; // Default to current store",
            "lineNumber": 368
          },
          {
            "text": "\t\t\t/**",
            "lineNumber": 369
          },
          {
            "text": "\t\t\t * Replay creates its own chatStore for each task with replayProject",
            "lineNumber": 370
          },
          {
            "text": "\t\t\t */",
            "lineNumber": 371
          },
          {
            "text": "\t\t}",
            "lineNumber": 1888
          },
          {
            "text": ")",
            "lineNumber": 2594
          },
          {
            "text": ";",
            "lineNumber": 2595
          }
        ]
      },
      "score": 0.37525665760040283
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\service\\chat_service.py",
        "range": {
          "startPosition": {
            "line": 1300
          },
          "endPosition": {
            "line": 1424
          }
        },
        "contents": "@traceroot.trace()\nasync def construct_workforce(options: Chat) -&gt; tuple[Workforce, ListenChatAgent]:\n\n        for key, prompt in {\n            Agents.coordinator_agent: f\"\"\"\nYou are a helpful coordinator.\n- You are now working in system {platform.system()} with architecture\n{platform.machine()} at working directory &#96;{working_directory}&#96;. All local file operations must occur here, but you can access files from any place in the file system. For all file system operations, you MUST use absolute paths to ensure precision and avoid ambiguity.\nThe current date is {datetime.date.today()}. For any date-related tasks, you MUST use this as the current date.\n\n- If a task assigned to another agent fails, you should re-assign it to the \n&#96;Developer_Agent&#96;. The &#96;Developer_Agent&#96; is a powerful agent with terminal \naccess and can resolve a wide range of issues. \n            \"\"\",\n            Agents.task_agent: f\"\"\"\nYou are a helpful task planner.\n- You are now working in system {platform.system()} with architecture\n{platform.machine()} at working directory &#96;{working_directory}&#96;. All local file operations must occur here, but you can access files from any place in the file system. For all file system operations, you MUST use absolute paths to ensure precision and avoid ambiguity.\nThe current date is {datetime.date.today()}. For any date-related tasks, you MUST use this as the current date.\n        \"\"\",\n        }.items()\n    ]\n    new_worker_agent = agent_model(\n        Agents.new_worker_agent,",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 1301,
                "column": 1
              },
              "endPosition": {
                "line": 1302,
                "column": 1
              }
            },
            {
              "startPosition": {
                "line": 1302,
                "column": 1
              },
              "endPosition": {
                "line": 1303,
                "column": 5
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "@traceroot.trace()",
            "lineNumber": 1301
          },
          {
            "text": "async def construct_workforce(options: Chat) -&gt; tuple[Workforce, ListenChatAgent]:",
            "lineNumber": 1302,
            "isSignature": true
          },
          {
            "lineNumber": 1318
          },
          {
            "text": "        for key, prompt in {",
            "lineNumber": 1319
          },
          {
            "text": "            Agents.coordinator_agent: f\"\"\"",
            "lineNumber": 1320
          },
          {
            "text": "You are a helpful coordinator.",
            "lineNumber": 1321
          },
          {
            "text": "- You are now working in system {platform.system()} with architecture",
            "lineNumber": 1322
          },
          {
            "text": "{platform.machine()} at working directory &#96;{working_directory}&#96;. All local file operations must occur here, but you can access files from any place in the file system. For all file system operations, you MUST use absolute paths to ensure precision and avoid ambiguity.",
            "lineNumber": 1323
          },
          {
            "text": "The current date is {datetime.date.today()}. For any date-related tasks, you MUST use this as the current date.",
            "lineNumber": 1324
          },
          {
            "lineNumber": 1325
          },
          {
            "text": "- If a task assigned to another agent fails, you should re-assign it to the ",
            "lineNumber": 1326
          },
          {
            "text": "&#96;Developer_Agent&#96;. The &#96;Developer_Agent&#96; is a powerful agent with terminal ",
            "lineNumber": 1327
          },
          {
            "text": "access and can resolve a wide range of issues. ",
            "lineNumber": 1328
          },
          {
            "text": "            \"\"\",",
            "lineNumber": 1329
          },
          {
            "text": "            Agents.task_agent: f\"\"\"",
            "lineNumber": 1330
          },
          {
            "text": "You are a helpful task planner.",
            "lineNumber": 1331
          },
          {
            "text": "- You are now working in system {platform.system()} with architecture",
            "lineNumber": 1332
          },
          {
            "text": "{platform.machine()} at working directory &#96;{working_directory}&#96;. All local file operations must occur here, but you can access files from any place in the file system. For all file system operations, you MUST use absolute paths to ensure precision and avoid ambiguity.",
            "lineNumber": 1333
          },
          {
            "text": "The current date is {datetime.date.today()}. For any date-related tasks, you MUST use this as the current date.",
            "lineNumber": 1334
          },
          {
            "text": "        \"\"\",",
            "lineNumber": 1335
          },
          {
            "text": "        }.items()",
            "lineNumber": 1336
          },
          {
            "text": "    ]",
            "lineNumber": 1337
          },
          {
            "text": "    new_worker_agent = agent_model(",
            "lineNumber": 1338
          },
          {
            "text": "        Agents.new_worker_agent,",
            "lineNumber": 1339
          }
        ]
      },
      "score": 0.36969244480133057
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\controller\\chat_controller.py",
        "range": {
          "startPosition": {
            "line": 70,
            "column": 13
          },
          "endPosition": {
            "line": 126
          }
        },
        "contents": "@router.post(\"/chat\", name=\"start chat\")\n@traceroot.trace()\nasync def post(data: Chat, request: Request):\n    chat_logger.info(\n        \"Starting new chat session\", extra={\"project_id\": data.project_id, \"task_id\": data.task_id, \"user\": data.email}\n    )\n    task_lock = get_or_create_task_lock(data.project_id)\n\n    # Set user-specific environment path for this thread\n    set_user_env_path(data.env_path)\n    load_dotenv(dotenv_path=data.env_path)\n\n    os.environ[\"file_save_path\"] = data.file_save_path()\n    os.environ[\"browser_port\"] = str(data.browser_port)\n    os.environ[\"OPENAI_API_KEY\"] = data.api_key\n    os.environ[\"OPENAI_API_BASE_URL\"] = data.api_url or \"https://api.openai.com/v1\"\n    os.environ[\"CAMEL_MODEL_LOG_ENABLED\"] = \"true\"\n\n    # Set user-specific search engine configuration if provided\n    if data.search_config:\n        for key, value in data.search_config.items():\n            if value:  # Only set non-empty values\n                os.environ[key] = value\n                chat_logger.info(f\"Set search config: {key}\", extra={\"project_id\": data.project_id})\n\n    email_sanitized = re.sub(r'[\\\\/*?:\"&lt;&gt;|\\s]', \"_\", data.email.split(\"@\")[0]).strip(\".\")\n    camel_log = (\n        Path.home()\n        / \".eigent\"\n        / email_sanitized\n        / (\"project_\" + data.project_id)\n        / (\"task_\" + data.task_id)\n        / \"camel_logs\"\n    )\n    camel_log.mkdir(parents=True, exist_ok=True)\n\n    os.environ[\"CAMEL_LOG_DIR\"] = str(camel_log)\n\n    if data.is_cloud():\n        os.environ[\"cloud_api_key\"] = data.api_key\n\n    # Set the initial current_task_id in task_lock\n    set_current_task_id(data.project_id, data.task_id)\n\n    # Put initial action in queue to start processing\n    await task_lock.put_queue(ActionImproveData(data=data.question, new_task_id=data.task_id))\n\n    chat_logger.info",
        "signatures": {},
        "detailedLines": [
          {
            "text": "@router.post(\"/chat\", name=\"start chat\")",
            "lineNumber": 74
          },
          {
            "text": "@traceroot.trace()",
            "lineNumber": 75
          },
          {
            "text": "async def post(data: Chat, request: Request):",
            "lineNumber": 76,
            "isSignature": true
          },
          {
            "text": "    chat_logger.info(",
            "lineNumber": 77
          },
          {
            "text": "        \"Starting new chat session\", extra={\"project_id\": data.project_id, \"task_id\": data.task_id, \"user\": data.email}",
            "lineNumber": 78
          },
          {
            "text": "    )",
            "lineNumber": 79
          },
          {
            "text": "    task_lock = get_or_create_task_lock(data.project_id)",
            "lineNumber": 80
          },
          {
            "lineNumber": 81
          },
          {
            "text": "    # Set user-specific environment path for this thread",
            "lineNumber": 82
          },
          {
            "text": "    set_user_env_path(data.env_path)",
            "lineNumber": 83
          },
          {
            "text": "    load_dotenv(dotenv_path=data.env_path)",
            "lineNumber": 84
          },
          {
            "lineNumber": 85
          },
          {
            "text": "    os.environ[\"file_save_path\"] = data.file_save_path()",
            "lineNumber": 86
          },
          {
            "text": "    os.environ[\"browser_port\"] = str(data.browser_port)",
            "lineNumber": 87
          },
          {
            "text": "    os.environ[\"OPENAI_API_KEY\"] = data.api_key",
            "lineNumber": 88
          },
          {
            "text": "    os.environ[\"OPENAI_API_BASE_URL\"] = data.api_url or \"https://api.openai.com/v1\"",
            "lineNumber": 89
          },
          {
            "text": "    os.environ[\"CAMEL_MODEL_LOG_ENABLED\"] = \"true\"",
            "lineNumber": 90
          },
          {
            "lineNumber": 91
          },
          {
            "text": "    # Set user-specific search engine configuration if provided",
            "lineNumber": 92
          },
          {
            "text": "    if data.search_config:",
            "lineNumber": 93
          },
          {
            "text": "        for key, value in data.search_config.items():",
            "lineNumber": 94
          },
          {
            "text": "            if value:  # Only set non-empty values",
            "lineNumber": 95
          },
          {
            "text": "                os.environ[key] = value",
            "lineNumber": 96
          },
          {
            "text": "                chat_logger.info(f\"Set search config: {key}\", extra={\"project_id\": data.project_id})",
            "lineNumber": 97
          },
          {
            "lineNumber": 98
          },
          {
            "text": "    email_sanitized = re.sub(r'[\\\\/*?:\"&lt;&gt;|\\s]', \"_\", data.email.split(\"@\")[0]).strip(\".\")",
            "lineNumber": 99
          },
          {
            "text": "    camel_log = (",
            "lineNumber": 100
          },
          {
            "text": "        Path.home()",
            "lineNumber": 101
          },
          {
            "text": "        / \".eigent\"",
            "lineNumber": 102
          },
          {
            "text": "        / email_sanitized",
            "lineNumber": 103
          },
          {
            "text": "        / (\"project_\" + data.project_id)",
            "lineNumber": 104
          },
          {
            "text": "        / (\"task_\" + data.task_id)",
            "lineNumber": 105
          },
          {
            "text": "        / \"camel_logs\"",
            "lineNumber": 106
          },
          {
            "text": "    )",
            "lineNumber": 107
          },
          {
            "text": "    camel_log.mkdir(parents=True, exist_ok=True)",
            "lineNumber": 108
          },
          {
            "lineNumber": 109
          },
          {
            "text": "    os.environ[\"CAMEL_LOG_DIR\"] = str(camel_log)",
            "lineNumber": 110
          },
          {
            "lineNumber": 111
          },
          {
            "text": "    if data.is_cloud():",
            "lineNumber": 112
          },
          {
            "text": "        os.environ[\"cloud_api_key\"] = data.api_key",
            "lineNumber": 113
          },
          {
            "lineNumber": 114
          },
          {
            "text": "    # Set the initial current_task_id in task_lock",
            "lineNumber": 115
          },
          {
            "text": "    set_current_task_id(data.project_id, data.task_id)",
            "lineNumber": 116
          },
          {
            "lineNumber": 117
          },
          {
            "text": "    # Put initial action in queue to start processing",
            "lineNumber": 118
          },
          {
            "text": "    await task_lock.put_queue(ActionImproveData(data=data.question, new_task_id=data.task_id))",
            "lineNumber": 119
          },
          {
            "lineNumber": 120
          },
          {
            "text": "    chat_logger.info",
            "lineNumber": 121
          }
        ]
      },
      "score": 0.36919069290161133
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\component\\model_validation.py",
        "range": {
          "startPosition": {
            "line": 14,
            "column": 119
          },
          "endPosition": {
            "line": 41,
            "column": 16
          }
        },
        "contents": "def create_agent(\n    model_platform: str, model_type: str, api_key: str = None, url: str = None, model_config_dict: dict = None, **kwargs\n) -&gt; ChatAgent:\n    platform = model_platform\n    mtype = model_type\n    if mtype is None:\n        raise ValueError(f\"Invalid model_type: {model_type}\")\n    if platform is None:\n        raise ValueError(f\"Invalid model_platform: {model_platform}\")\n    model = ModelFactory.create(\n        model_platform=platform,\n        model_type=mtype,\n        api_key=api_key,\n        url=url,\n        timeout=10,\n        model_config_dict=model_config_dict,\n        **kwargs,\n    )\n    agent = ChatAgent(\n        system_message=\"You are a helpful assistant that must use the tool get_website_content to get the content of a website.\",\n        model=model,\n        tools=[get_website_content],\n        step_timeout=900,\n    )\n    return agent",
        "signatures": {},
        "detailedLines": [
          {
            "text": "def create_agent(",
            "lineNumber": 18,
            "isSignature": true
          },
          {
            "text": "    model_platform: str, model_type: str, api_key: str = None, url: str = None, model_config_dict: dict = None, **kwargs",
            "lineNumber": 19,
            "isSignature": true
          },
          {
            "text": ") -&gt; ChatAgent:",
            "lineNumber": 20,
            "isSignature": true
          },
          {
            "text": "    platform = model_platform",
            "lineNumber": 21
          },
          {
            "text": "    mtype = model_type",
            "lineNumber": 22
          },
          {
            "text": "    if mtype is None:",
            "lineNumber": 23
          },
          {
            "text": "        raise ValueError(f\"Invalid model_type: {model_type}\")",
            "lineNumber": 24
          },
          {
            "text": "    if platform is None:",
            "lineNumber": 25
          },
          {
            "text": "        raise ValueError(f\"Invalid model_platform: {model_platform}\")",
            "lineNumber": 26
          },
          {
            "text": "    model = ModelFactory.create(",
            "lineNumber": 27
          },
          {
            "text": "        model_platform=platform,",
            "lineNumber": 28
          },
          {
            "text": "        model_type=mtype,",
            "lineNumber": 29
          },
          {
            "text": "        api_key=api_key,",
            "lineNumber": 30
          },
          {
            "text": "        url=url,",
            "lineNumber": 31
          },
          {
            "text": "        timeout=10,",
            "lineNumber": 32
          },
          {
            "text": "        model_config_dict=model_config_dict,",
            "lineNumber": 33
          },
          {
            "text": "        **kwargs,",
            "lineNumber": 34
          },
          {
            "text": "    )",
            "lineNumber": 35
          },
          {
            "text": "    agent = ChatAgent(",
            "lineNumber": 36
          },
          {
            "text": "        system_message=\"You are a helpful assistant that must use the tool get_website_content to get the content of a website.\",",
            "lineNumber": 37
          },
          {
            "text": "        model=model,",
            "lineNumber": 38
          },
          {
            "text": "        tools=[get_website_content],",
            "lineNumber": 39
          },
          {
            "text": "        step_timeout=900,",
            "lineNumber": 40
          },
          {
            "text": "    )",
            "lineNumber": 41
          },
          {
            "text": "    return agent",
            "lineNumber": 42,
            "isSignature": true
          }
        ]
      },
      "score": 0.3670693635940552
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\utils\\agent.py",
        "range": {
          "startPosition": {
            "line": 80,
            "column": 63
          },
          "endPosition": {
            "line": 654
          }
        },
        "contents": "class ListenChatAgent(ChatAgent):\n    @traceroot.trace()\n    def __init__(\n        self,\n        api_task_id: str,\n        agent_name: str,\n        system_message: BaseMessage | str | None = None,\n        model: (\n            BaseModelBackend\n            | ModelManager\n            | Tuple[str, str]\n            | str\n            | ModelType\n            | Tuple[ModelPlatformType, ModelType]\n            | List[BaseModelBackend]\n            | List[str]\n            | List[ModelType]\n            | List[Tuple[str, str]]\n            | List[Tuple[ModelPlatformType, ModelType]]\n            | None\n        ) = None,\n        memory: AgentMemory | None = None,\n        message_window_size: int | None = None,\n        token_limit: int | None = None,\n        output_language: str | None = None,\n        tools: List[FunctionTool | Callable[..., Any]] | None = None,\n        toolkits_to_register_agent: List[RegisteredAgentToolkit] | None = None,\n        external_tools: (\n            List[FunctionTool | Callable[..., Any] | Dict[str, Any]] | None\n        ) = None,\n        response_terminators: List[ResponseTerminator] | None = None,\n        scheduling_strategy: str = \"round_robin\",\n        max_iteration: int | None = None,\n        agent_id: str | None = None,\n        stop_event: Event | None = None,\n        tool_execution_timeout: float | None = None,\n        mask_tool_output: bool = False,\n        pause_event: asyncio.Event | None = None,\n        prune_tool_calls_from_memory: bool = False,\n        enable_snapshot_clean: bool = False,\n        step_timeout: float | None = 900,\n        **kwargs: Any,\n    ) -&gt; None:\n        super().__init__(\n            system_message=system_message,\n            model=model,\n            memory=memory,\n            message_window_size=message_window_size,\n            token_limit=token_limit,\n            output_language=output_language,\n            tools=tools,\n            toolkits_to_register_agent=toolkits_to_register_agent,\n            external_tools=external_tools,\n            response_terminators=response_terminators,\n            scheduling_strategy=scheduling_strategy,\n            max_iteration=max_iteration,\n            agent_id=agent_id,\n            stop_event=stop_event,\n            tool_execution_timeout=tool_execution_timeout,\n            mask_tool_output=mask_tool_output,\n            pause_event=pause_event,\n            prune_tool_calls_from_memory=prune_tool_calls_from_memory,\n            enable_snapshot_clean=enable_snapshot_clean,\n            step_timeout=step_timeout,\n            **kwargs,\n        )\n        self.api_task_id = api_task_id\n        self.agent_name = agent_name\n\n    process_task_id: str = \"\"\n\n    @traceroot.trace()\n    def step(\n        self,\n        input_message: BaseMessage | str,\n        response_format: type[BaseModel] | None = None,\n    ) -&gt; ChatAgentResponse | StreamingChatAgentResponse:\n        ",
        "signatures": {},
        "detailedLines": [
          {
            "text": "class ListenChatAgent(ChatAgent):",
            "lineNumber": 84,
            "isSignature": true
          },
          {
            "text": "    @traceroot.trace()",
            "lineNumber": 85
          },
          {
            "text": "    def __init__(",
            "lineNumber": 86
          },
          {
            "text": "        self,",
            "lineNumber": 87
          },
          {
            "text": "        api_task_id: str,",
            "lineNumber": 88
          },
          {
            "text": "        agent_name: str,",
            "lineNumber": 89
          },
          {
            "text": "        system_message: BaseMessage | str | None = None,",
            "lineNumber": 90
          },
          {
            "text": "        model: (",
            "lineNumber": 91
          },
          {
            "text": "            BaseModelBackend",
            "lineNumber": 92
          },
          {
            "text": "            | ModelManager",
            "lineNumber": 93
          },
          {
            "text": "            | Tuple[str, str]",
            "lineNumber": 94
          },
          {
            "text": "            | str",
            "lineNumber": 95
          },
          {
            "text": "            | ModelType",
            "lineNumber": 96
          },
          {
            "text": "            | Tuple[ModelPlatformType, ModelType]",
            "lineNumber": 97
          },
          {
            "text": "            | List[BaseModelBackend]",
            "lineNumber": 98
          },
          {
            "text": "            | List[str]",
            "lineNumber": 99
          },
          {
            "text": "            | List[ModelType]",
            "lineNumber": 100
          },
          {
            "text": "            | List[Tuple[str, str]]",
            "lineNumber": 101
          },
          {
            "text": "            | List[Tuple[ModelPlatformType, ModelType]]",
            "lineNumber": 102
          },
          {
            "text": "            | None",
            "lineNumber": 103
          },
          {
            "text": "        ) = None,",
            "lineNumber": 104
          },
          {
            "text": "        memory: AgentMemory | None = None,",
            "lineNumber": 105
          },
          {
            "text": "        message_window_size: int | None = None,",
            "lineNumber": 106
          },
          {
            "text": "        token_limit: int | None = None,",
            "lineNumber": 107
          },
          {
            "text": "        output_language: str | None = None,",
            "lineNumber": 108
          },
          {
            "text": "        tools: List[FunctionTool | Callable[..., Any]] | None = None,",
            "lineNumber": 109
          },
          {
            "text": "        toolkits_to_register_agent: List[RegisteredAgentToolkit] | None = None,",
            "lineNumber": 110
          },
          {
            "text": "        external_tools: (",
            "lineNumber": 111
          },
          {
            "text": "            List[FunctionTool | Callable[..., Any] | Dict[str, Any]] | None",
            "lineNumber": 112
          },
          {
            "text": "        ) = None,",
            "lineNumber": 113
          },
          {
            "text": "        response_terminators: List[ResponseTerminator] | None = None,",
            "lineNumber": 114
          },
          {
            "text": "        scheduling_strategy: str = \"round_robin\",",
            "lineNumber": 115
          },
          {
            "text": "        max_iteration: int | None = None,",
            "lineNumber": 116
          },
          {
            "text": "        agent_id: str | None = None,",
            "lineNumber": 117
          },
          {
            "text": "        stop_event: Event | None = None,",
            "lineNumber": 118
          },
          {
            "text": "        tool_execution_timeout: float | None = None,",
            "lineNumber": 119
          },
          {
            "text": "        mask_tool_output: bool = False,",
            "lineNumber": 120
          },
          {
            "text": "        pause_event: asyncio.Event | None = None,",
            "lineNumber": 121
          },
          {
            "text": "        prune_tool_calls_from_memory: bool = False,",
            "lineNumber": 122
          },
          {
            "text": "        enable_snapshot_clean: bool = False,",
            "lineNumber": 123
          },
          {
            "text": "        step_timeout: float | None = 900,",
            "lineNumber": 124
          },
          {
            "text": "        **kwargs: Any,",
            "lineNumber": 125
          },
          {
            "text": "    ) -&gt; None:",
            "lineNumber": 126
          },
          {
            "text": "        super().__init__(",
            "lineNumber": 127
          },
          {
            "text": "            system_message=system_message,",
            "lineNumber": 128
          },
          {
            "text": "            model=model,",
            "lineNumber": 129
          },
          {
            "text": "            memory=memory,",
            "lineNumber": 130
          },
          {
            "text": "            message_window_size=message_window_size,",
            "lineNumber": 131
          },
          {
            "text": "            token_limit=token_limit,",
            "lineNumber": 132
          },
          {
            "text": "            output_language=output_language,",
            "lineNumber": 133
          },
          {
            "text": "            tools=tools,",
            "lineNumber": 134
          },
          {
            "text": "            toolkits_to_register_agent=toolkits_to_register_agent,",
            "lineNumber": 135
          },
          {
            "text": "            external_tools=external_tools,",
            "lineNumber": 136
          },
          {
            "text": "            response_terminators=response_terminators,",
            "lineNumber": 137
          },
          {
            "text": "            scheduling_strategy=scheduling_strategy,",
            "lineNumber": 138
          },
          {
            "text": "            max_iteration=max_iteration,",
            "lineNumber": 139
          },
          {
            "text": "            agent_id=agent_id,",
            "lineNumber": 140
          },
          {
            "text": "            stop_event=stop_event,",
            "lineNumber": 141
          },
          {
            "text": "            tool_execution_timeout=tool_execution_timeout,",
            "lineNumber": 142
          },
          {
            "text": "            mask_tool_output=mask_tool_output,",
            "lineNumber": 143
          },
          {
            "text": "            pause_event=pause_event,",
            "lineNumber": 144
          },
          {
            "text": "            prune_tool_calls_from_memory=prune_tool_calls_from_memory,",
            "lineNumber": 145
          },
          {
            "text": "            enable_snapshot_clean=enable_snapshot_clean,",
            "lineNumber": 146
          },
          {
            "text": "            step_timeout=step_timeout,",
            "lineNumber": 147
          },
          {
            "text": "            **kwargs,",
            "lineNumber": 148
          },
          {
            "text": "        )",
            "lineNumber": 149
          },
          {
            "text": "        self.api_task_id = api_task_id",
            "lineNumber": 150
          },
          {
            "text": "        self.agent_name = agent_name",
            "lineNumber": 151
          },
          {
            "lineNumber": 152
          },
          {
            "text": "    process_task_id: str = \"\"",
            "lineNumber": 153
          },
          {
            "lineNumber": 154
          },
          {
            "text": "    @traceroot.trace()",
            "lineNumber": 155
          },
          {
            "text": "    def step(",
            "lineNumber": 156
          },
          {
            "text": "        self,",
            "lineNumber": 157
          },
          {
            "text": "        input_message: BaseMessage | str,",
            "lineNumber": 158
          },
          {
            "text": "        response_format: type[BaseModel] | None = None,",
            "lineNumber": 159
          },
          {
            "text": "    ) -&gt; ChatAgentResponse | StreamingChatAgentResponse:",
            "lineNumber": 160
          },
          {
            "text": "        ",
            "lineNumber": 161
          }
        ]
      },
      "score": 0.3638423681259155
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\service\\task.py",
        "range": {
          "startPosition": {
            "line": 219,
            "column": 19
          },
          "endPosition": {
            "line": 368
          }
        },
        "contents": "ActionData = (\n    ActionImproveData\n    | ActionStartData\n    | ActionUpdateTaskData\n    | ActionTaskStateData\n    | ActionAskData\n    | ActionCreateAgentData\n    | ActionActivateAgentData\n    | ActionDeactivateAgentData\n    | ActionAssignTaskData\n    | ActionActivateToolkitData\n    | ActionDeactivateToolkitData\n    | ActionWriteFileData\n    | ActionNoticeData\n    | ActionSearchMcpData\n    | ActionInstallMcpData\n    | ActionTerminalData\n    | ActionStopData\n    | ActionEndData\n    | ActionTimeoutData\n    | ActionSupplementData\n    | ActionTakeControl\n    | ActionNewAgent\n    | ActionBudgetNotEnough\n    | ActionAddTaskData\n    | ActionRemoveTaskData\n    | ActionSkipTaskData\n    | ActionDecomposeTextData\n    | ActionDecomposeProgressData\n)\n\n\nclass Agents(str, Enum):\n    task_agent = \"task_agent\"\n    coordinator_agent = \"coordinator_agent\"\n    new_worker_agent = \"new_worker_agent\"\n    developer_agent = \"developer_agent\"\n    browser_agent = \"browser_agent\"\n    document_agent = \"document_agent\"\n    multi_modal_agent = \"multi_modal_agent\"\n    social_medium_agent = \"social_medium_agent\"\n    mcp_agent = \"mcp_agent\"\n\n\nclass TaskLock:\n    id: str\n    status: Status = Status.confirming",
        "signatures": {},
        "detailedLines": [
          {
            "text": "ActionData = (",
            "lineNumber": 223
          },
          {
            "text": "    ActionImproveData",
            "lineNumber": 224
          },
          {
            "text": "    | ActionStartData",
            "lineNumber": 225
          },
          {
            "text": "    | ActionUpdateTaskData",
            "lineNumber": 226
          },
          {
            "text": "    | ActionTaskStateData",
            "lineNumber": 227
          },
          {
            "text": "    | ActionAskData",
            "lineNumber": 228
          },
          {
            "text": "    | ActionCreateAgentData",
            "lineNumber": 229
          },
          {
            "text": "    | ActionActivateAgentData",
            "lineNumber": 230
          },
          {
            "text": "    | ActionDeactivateAgentData",
            "lineNumber": 231
          },
          {
            "text": "    | ActionAssignTaskData",
            "lineNumber": 232
          },
          {
            "text": "    | ActionActivateToolkitData",
            "lineNumber": 233
          },
          {
            "text": "    | ActionDeactivateToolkitData",
            "lineNumber": 234
          },
          {
            "text": "    | ActionWriteFileData",
            "lineNumber": 235
          },
          {
            "text": "    | ActionNoticeData",
            "lineNumber": 236
          },
          {
            "text": "    | ActionSearchMcpData",
            "lineNumber": 237
          },
          {
            "text": "    | ActionInstallMcpData",
            "lineNumber": 238
          },
          {
            "text": "    | ActionTerminalData",
            "lineNumber": 239
          },
          {
            "text": "    | ActionStopData",
            "lineNumber": 240
          },
          {
            "text": "    | ActionEndData",
            "lineNumber": 241
          },
          {
            "text": "    | ActionTimeoutData",
            "lineNumber": 242
          },
          {
            "text": "    | ActionSupplementData",
            "lineNumber": 243
          },
          {
            "text": "    | ActionTakeControl",
            "lineNumber": 244
          },
          {
            "text": "    | ActionNewAgent",
            "lineNumber": 245
          },
          {
            "text": "    | ActionBudgetNotEnough",
            "lineNumber": 246
          },
          {
            "text": "    | ActionAddTaskData",
            "lineNumber": 247
          },
          {
            "text": "    | ActionRemoveTaskData",
            "lineNumber": 248
          },
          {
            "text": "    | ActionSkipTaskData",
            "lineNumber": 249
          },
          {
            "text": "    | ActionDecomposeTextData",
            "lineNumber": 250
          },
          {
            "text": "    | ActionDecomposeProgressData",
            "lineNumber": 251
          },
          {
            "text": ")",
            "lineNumber": 252
          },
          {
            "lineNumber": 253
          },
          {
            "lineNumber": 254
          },
          {
            "text": "class Agents(str, Enum):",
            "lineNumber": 255,
            "isSignature": true
          },
          {
            "text": "    task_agent = \"task_agent\"",
            "lineNumber": 256
          },
          {
            "text": "    coordinator_agent = \"coordinator_agent\"",
            "lineNumber": 257
          },
          {
            "text": "    new_worker_agent = \"new_worker_agent\"",
            "lineNumber": 258
          },
          {
            "text": "    developer_agent = \"developer_agent\"",
            "lineNumber": 259
          },
          {
            "text": "    browser_agent = \"browser_agent\"",
            "lineNumber": 260
          },
          {
            "text": "    document_agent = \"document_agent\"",
            "lineNumber": 261
          },
          {
            "text": "    multi_modal_agent = \"multi_modal_agent\"",
            "lineNumber": 262
          },
          {
            "text": "    social_medium_agent = \"social_medium_agent\"",
            "lineNumber": 263
          },
          {
            "text": "    mcp_agent = \"mcp_agent\"",
            "lineNumber": 264,
            "isSignature": true
          },
          {
            "lineNumber": 265
          },
          {
            "lineNumber": 266
          },
          {
            "text": "class TaskLock:",
            "lineNumber": 267,
            "isSignature": true
          },
          {
            "text": "    id: str",
            "lineNumber": 268
          },
          {
            "text": "    status: Status = Status.confirming",
            "lineNumber": 269
          }
        ]
      },
      "score": 0.3593132495880127
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\service\\chat_service.py",
        "range": {
          "startPosition": {
            "line": 233,
            "column": 87
          },
          "endPosition": {
            "line": 1075
          }
        },
        "contents": "@sync_step\n@traceroot.trace()\nasync def step_solve(options: Chat, request: Request, task_lock: TaskLock):\n    # if True:\n    #     import faulthandler\n\n    #     faulthandler.enable()\n    #     for second in [5, 10, 20, 30, 60, 120, 240]:\n    #         faulthandler.dump_traceback_later(second)\n\n    start_event_loop = True\n\n    if not hasattr(task_lock, 'conversation_history'):\n        task_lock.conversation_history = []\n    if not hasattr(task_lock, 'last_task_result'):\n        task_lock.last_task_result = \"\"\n    if not hasattr(task_lock, 'question_agent'):\n        task_lock.question_agent = None\n    if not hasattr(task_lock, 'summary_generated'):\n        task_lock.summary_generated = False\n\n    # Create or reuse persistent question_agent\n    if task_lock.question_agent is None:\n        task_lock.question_agent = question_confirm_agent(options)\n        logger.info(f\"Created new persistent question_agent for project {options.project_id}\")\n    else:\n        logger.info(f\"Reusing existing question_agent with {len(task_lock.conversation_history)} history entries\")\n\n    question_agent = task_lock.question_agent\n\n    # Other variables\n    camel_task = None\n    workforce = None\n    last_completed_task_result = \"\"  # Track the last completed task result\n    summary_task_content = \"\"  # Track task summary\n    loop_iteration = 0\n    event_loop = asyncio.get_running_loop()\n    sub_tasks: list[Task] = []\n\n    logger.info(\"=\" * 80)\n    logger.info(\"🚀 [LIFECYCLE] step_solve STARTED\", extra={\"project_id\": options.project_id, \"task_id\": options.task_id})\n    logger.info(\"=\" * 80)\n    logger.debug(\"Step solve options\", extra={\"task_id\": options.task_id, \"model_platform\": options.model_platform})\n\n    while True:\n        loop_iteration += 1",
        "signatures": {},
        "detailedLines": [
          {
            "text": "@sync_step",
            "lineNumber": 237
          },
          {
            "text": "@traceroot.trace()",
            "lineNumber": 238
          },
          {
            "text": "async def step_solve(options: Chat, request: Request, task_lock: TaskLock):",
            "lineNumber": 239,
            "isSignature": true
          },
          {
            "text": "    # if True:",
            "lineNumber": 240,
            "isSignature": true
          },
          {
            "text": "    #     import faulthandler",
            "lineNumber": 241,
            "isSignature": true
          },
          {
            "lineNumber": 242,
            "isSignature": true
          },
          {
            "text": "    #     faulthandler.enable()",
            "lineNumber": 243,
            "isSignature": true
          },
          {
            "text": "    #     for second in [5, 10, 20, 30, 60, 120, 240]:",
            "lineNumber": 244,
            "isSignature": true
          },
          {
            "text": "    #         faulthandler.dump_traceback_later(second)",
            "lineNumber": 245,
            "isSignature": true
          },
          {
            "lineNumber": 246
          },
          {
            "text": "    start_event_loop = True",
            "lineNumber": 247
          },
          {
            "lineNumber": 248
          },
          {
            "text": "    if not hasattr(task_lock, 'conversation_history'):",
            "lineNumber": 249
          },
          {
            "text": "        task_lock.conversation_history = []",
            "lineNumber": 250
          },
          {
            "text": "    if not hasattr(task_lock, 'last_task_result'):",
            "lineNumber": 251
          },
          {
            "text": "        task_lock.last_task_result = \"\"",
            "lineNumber": 252
          },
          {
            "text": "    if not hasattr(task_lock, 'question_agent'):",
            "lineNumber": 253
          },
          {
            "text": "        task_lock.question_agent = None",
            "lineNumber": 254
          },
          {
            "text": "    if not hasattr(task_lock, 'summary_generated'):",
            "lineNumber": 255
          },
          {
            "text": "        task_lock.summary_generated = False",
            "lineNumber": 256
          },
          {
            "lineNumber": 257
          },
          {
            "text": "    # Create or reuse persistent question_agent",
            "lineNumber": 258
          },
          {
            "text": "    if task_lock.question_agent is None:",
            "lineNumber": 259
          },
          {
            "text": "        task_lock.question_agent = question_confirm_agent(options)",
            "lineNumber": 260
          },
          {
            "text": "        logger.info(f\"Created new persistent question_agent for project {options.project_id}\")",
            "lineNumber": 261
          },
          {
            "text": "    else:",
            "lineNumber": 262
          },
          {
            "text": "        logger.info(f\"Reusing existing question_agent with {len(task_lock.conversation_history)} history entries\")",
            "lineNumber": 263
          },
          {
            "lineNumber": 264
          },
          {
            "text": "    question_agent = task_lock.question_agent",
            "lineNumber": 265
          },
          {
            "lineNumber": 266
          },
          {
            "text": "    # Other variables",
            "lineNumber": 267
          },
          {
            "text": "    camel_task = None",
            "lineNumber": 268
          },
          {
            "text": "    workforce = None",
            "lineNumber": 269
          },
          {
            "text": "    last_completed_task_result = \"\"  # Track the last completed task result",
            "lineNumber": 270
          },
          {
            "text": "    summary_task_content = \"\"  # Track task summary",
            "lineNumber": 271
          },
          {
            "text": "    loop_iteration = 0",
            "lineNumber": 272
          },
          {
            "text": "    event_loop = asyncio.get_running_loop()",
            "lineNumber": 273
          },
          {
            "text": "    sub_tasks: list[Task] = []",
            "lineNumber": 274
          },
          {
            "lineNumber": 275
          },
          {
            "text": "    logger.info(\"=\" * 80)",
            "lineNumber": 276
          },
          {
            "text": "    logger.info(\"🚀 [LIFECYCLE] step_solve STARTED\", extra={\"project_id\": options.project_id, \"task_id\": options.task_id})",
            "lineNumber": 277
          },
          {
            "text": "    logger.info(\"=\" * 80)",
            "lineNumber": 278
          },
          {
            "text": "    logger.debug(\"Step solve options\", extra={\"task_id\": options.task_id, \"model_platform\": options.model_platform})",
            "lineNumber": 279
          },
          {
            "lineNumber": 280
          },
          {
            "text": "    while True:",
            "lineNumber": 281
          },
          {
            "text": "        loop_iteration += 1",
            "lineNumber": 282
          }
        ]
      },
      "score": 0.35682475566864014
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\src\\store\\chatStore.ts",
        "range": {
          "startPosition": {
            "line": 162
          },
          "endPosition": {
            "line": 2594,
            "column": 1
          }
        },
        "contents": "const chatStore = \n(set, get) =&gt; (\nasync (taskId: string, type?: string, shareToken?: string, delayTime?: number, messageContent?: string, messageAttaches?: File[]) =&gt; {\n\nasync onmessage(event: any) {\n\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\t// Create agent\n\t\t\t\t\tif (agentMessages.step === \"create_agent\") {\n\t\t\t\t\t\tconst { agent_name, agent_id } = agentMessages.data;\n\t\t\t\t\t\tif (!agent_name || !agent_id) return;\n\n\t\t\t\t\t\t// Add agent to taskAssigning\n\t\t\t\t\t\tif (!['mcp_agent', 'new_worker_agent', 'task_agent', 'task_summary_agent', \"coordinator_agent\", \"question_confirm_agent\"].includes(agent_name)) {\n\t\t\t\t\t\t\t// if (agentNameMap[agent_name as keyof typeof agentNameMap]) {\n\t\t\t\t\t\t\tconst hasAgent = tasks[currentTaskId].taskAssigning.find((agent) =&gt; agent.agent_id === agent_id)\n\n\t\t\t\t\t\t\tif (!hasAgent) {\n\t\t\t\t\t\t\t\tlet activeWebviewIds: any = [];\n\t\t\t\t\t\t\t\tif (agent_name == 'browser_agent') {\n\t\t\t\t\t\t\t\t\tsnapshots.forEach((item: any) =&gt; {\n\t\t\t\t\t\t\t\t\t\tconst imgurl = !item.image_path.includes('/public') ? item.image_path : (import.meta.env.DEV ? import.meta.env.VITE_PROXY_URL : import.meta.env.VITE_BASE_URL) + item.image_path\n\t\t\t\t\t\t\t\t\t\tactiveWebviewIds.push({\n\t\t\t\t\t\t\t\t\t\t\tid: item.id,\n\t\t\t\t\t\t\t\t\t\t\timg: imgurl,\n\t\t\t\t\t\t\t\t\t\t\tprocessTaskId: item.camel_task_id,\n\t\t\t\t\t\t\t\t\t\t\turl: item.browser_url\n\t\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tsetTaskAssigning(currentTaskId, [...tasks[currentTaskId].taskAssigning, {\n\t\t\t\t\t\t\t\t\tagent_id,\n\t\t\t\t\t\t\t\t\tname: agentNameMap[agent_name as keyof typeof agentNameMap] || agent_name,\n\t\t\t\t\t\t\t\t\ttype: agent_name as AgentNameType,\n\t\t\t\t\t\t\t\t\ttasks: [],\n\t\t\t\t\t\t\t\t\tlog: [],\n\t\t\t\t\t\t\t\t\timg: [],\n\t\t\t\t\t\t\t\t\ttools: agentMessages.data.tools,\n\t\t\t\t\t\t\t\t\tactiveWebviewIds: activeWebviewIds,\n\t\t\t\t\t\t\t\t}])\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tif (agentMessages.step === \"wait_confirm\") {\n\t\t\t\t\t\tconst { content, question } = agentMessages.data;\n\t\t\t\t}\n\n\t\t}\n)\n;",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 163,
                "column": 1
              },
              "endPosition": {
                "line": 163,
                "column": 7
              }
            },
            {
              "startPosition": {
                "line": 163,
                "column": 7
              },
              "endPosition": {
                "line": 163,
                "column": 19
              }
            },
            {
              "startPosition": {
                "line": 163,
                "column": 53
              },
              "endPosition": {
                "line": 163,
                "column": 53
              }
            },
            {
              "startPosition": {
                "line": 164,
                "column": 2
              },
              "endPosition": {
                "line": 164,
                "column": 17
              }
            },
            {
              "startPosition": {
                "line": 331,
                "column": 14
              },
              "endPosition": {
                "line": 332,
                "column": 4
              }
            },
            {
              "startPosition": {
                "line": 586,
                "column": 4
              },
              "endPosition": {
                "line": 586,
                "column": 4
              }
            },
            {
              "startPosition": {
                "line": 612,
                "column": 5
              },
              "endPosition": {
                "line": 613,
                "column": 6
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "const chatStore = ",
            "lineNumber": 163
          },
          {
            "text": "(set, get) =&gt; (",
            "lineNumber": 164
          },
          {
            "text": "async (taskId: string, type?: string, shareToken?: string, delayTime?: number, messageContent?: string, messageAttaches?: File[]) =&gt; {",
            "lineNumber": 331
          },
          {
            "lineNumber": 586
          },
          {
            "text": "async onmessage(event: any) {",
            "lineNumber": 612
          },
          {
            "lineNumber": 928
          },
          {
            "text": "\t\t\t\t\t\treturn;",
            "lineNumber": 929
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 930
          },
          {
            "text": "\t\t\t\t\t// Create agent",
            "lineNumber": 931
          },
          {
            "text": "\t\t\t\t\tif (agentMessages.step === \"create_agent\") {",
            "lineNumber": 932
          },
          {
            "text": "\t\t\t\t\t\tconst { agent_name, agent_id } = agentMessages.data;",
            "lineNumber": 933
          },
          {
            "text": "\t\t\t\t\t\tif (!agent_name || !agent_id) return;",
            "lineNumber": 934
          },
          {
            "lineNumber": 935
          },
          {
            "text": "\t\t\t\t\t\t// Add agent to taskAssigning",
            "lineNumber": 936
          },
          {
            "text": "\t\t\t\t\t\tif (!['mcp_agent', 'new_worker_agent', 'task_agent', 'task_summary_agent', \"coordinator_agent\", \"question_confirm_agent\"].includes(agent_name)) {",
            "lineNumber": 937
          },
          {
            "text": "\t\t\t\t\t\t\t// if (agentNameMap[agent_name as keyof typeof agentNameMap]) {",
            "lineNumber": 938
          },
          {
            "text": "\t\t\t\t\t\t\tconst hasAgent = tasks[currentTaskId].taskAssigning.find((agent) =&gt; agent.agent_id === agent_id)",
            "lineNumber": 939
          },
          {
            "lineNumber": 940
          },
          {
            "text": "\t\t\t\t\t\t\tif (!hasAgent) {",
            "lineNumber": 941
          },
          {
            "text": "\t\t\t\t\t\t\t\tlet activeWebviewIds: any = [];",
            "lineNumber": 942
          },
          {
            "text": "\t\t\t\t\t\t\t\tif (agent_name == 'browser_agent') {",
            "lineNumber": 943
          },
          {
            "text": "\t\t\t\t\t\t\t\t\tsnapshots.forEach((item: any) =&gt; {",
            "lineNumber": 944
          },
          {
            "text": "\t\t\t\t\t\t\t\t\t\tconst imgurl = !item.image_path.includes('/public') ? item.image_path : (import.meta.env.DEV ? import.meta.env.VITE_PROXY_URL : import.meta.env.VITE_BASE_URL) + item.image_path",
            "lineNumber": 945
          },
          {
            "text": "\t\t\t\t\t\t\t\t\t\tactiveWebviewIds.push({",
            "lineNumber": 946
          },
          {
            "text": "\t\t\t\t\t\t\t\t\t\t\tid: item.id,",
            "lineNumber": 947
          },
          {
            "text": "\t\t\t\t\t\t\t\t\t\t\timg: imgurl,",
            "lineNumber": 948
          },
          {
            "text": "\t\t\t\t\t\t\t\t\t\t\tprocessTaskId: item.camel_task_id,",
            "lineNumber": 949
          },
          {
            "text": "\t\t\t\t\t\t\t\t\t\t\turl: item.browser_url",
            "lineNumber": 950
          },
          {
            "text": "\t\t\t\t\t\t\t\t\t\t})",
            "lineNumber": 951
          },
          {
            "text": "\t\t\t\t\t\t\t\t\t})",
            "lineNumber": 952
          },
          {
            "text": "\t\t\t\t\t\t\t\t}",
            "lineNumber": 953
          },
          {
            "text": "\t\t\t\t\t\t\t\tsetTaskAssigning(currentTaskId, [...tasks[currentTaskId].taskAssigning, {",
            "lineNumber": 954
          },
          {
            "text": "\t\t\t\t\t\t\t\t\tagent_id,",
            "lineNumber": 955
          },
          {
            "text": "\t\t\t\t\t\t\t\t\tname: agentNameMap[agent_name as keyof typeof agentNameMap] || agent_name,",
            "lineNumber": 956
          },
          {
            "text": "\t\t\t\t\t\t\t\t\ttype: agent_name as AgentNameType,",
            "lineNumber": 957
          },
          {
            "text": "\t\t\t\t\t\t\t\t\ttasks: [],",
            "lineNumber": 958
          },
          {
            "text": "\t\t\t\t\t\t\t\t\tlog: [],",
            "lineNumber": 959
          },
          {
            "text": "\t\t\t\t\t\t\t\t\timg: [],",
            "lineNumber": 960
          },
          {
            "text": "\t\t\t\t\t\t\t\t\ttools: agentMessages.data.tools,",
            "lineNumber": 961
          },
          {
            "text": "\t\t\t\t\t\t\t\t\tactiveWebviewIds: activeWebviewIds,",
            "lineNumber": 962
          },
          {
            "text": "\t\t\t\t\t\t\t\t}])",
            "lineNumber": 963
          },
          {
            "text": "\t\t\t\t\t\t\t}",
            "lineNumber": 964
          },
          {
            "text": "\t\t\t\t\t\t}",
            "lineNumber": 965
          },
          {
            "text": "\t\t\t\t\t\treturn;",
            "lineNumber": 966
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 967
          },
          {
            "text": "\t\t\t\t\tif (agentMessages.step === \"wait_confirm\") {",
            "lineNumber": 968
          },
          {
            "text": "\t\t\t\t\t\tconst { content, question } = agentMessages.data;",
            "lineNumber": 969
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 1836
          },
          {
            "lineNumber": 1886
          },
          {
            "text": "\t\t}",
            "lineNumber": 1888
          },
          {
            "text": ")",
            "lineNumber": 2594
          },
          {
            "text": ";",
            "lineNumber": 2595
          }
        ]
      },
      "score": 0.35318419337272644
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\utils\\agent.py",
        "range": {
          "startPosition": {
            "line": 774,
            "column": 5
          },
          "endPosition": {
            "line": 964
          }
        },
        "contents": "@traceroot.trace()\nasync def developer_agent(options: Chat):\n    working_directory = get_working_directory(options)\n    traceroot_logger.info(\n        f\"Creating developer agent for project: {options.project_id} in directory: {working_directory}\"\n    )\n    message_integration = ToolkitMessageIntegration(\n        message_handler=HumanToolkit(\n            options.project_id, Agents.developer_agent\n        ).send_message_to_user\n    )\n    note_toolkit = NoteTakingToolkit(\n        api_task_id=options.project_id,\n        agent_name=Agents.developer_agent,\n        working_directory=working_directory,\n    )\n    note_toolkit = message_integration.register_toolkits(note_toolkit)\n    web_deploy_toolkit = WebDeployToolkit(api_task_id=options.project_id)\n    web_deploy_toolkit = message_integration.register_toolkits(web_deploy_toolkit)\n    screenshot_toolkit = ScreenshotToolkit(\n        options.project_id, working_directory=working_directory\n    )\n    screenshot_toolkit = message_integration.register_toolkits(screenshot_toolkit)\n\n    terminal_toolkit = TerminalToolkit(\n        options.project_id,\n        Agents.document_agent,\n        safe_mode=True,\n        clone_current_env=False,\n    )\n    terminal_toolkit = message_integration.register_toolkits(terminal_toolkit)\n\n    tools = [\n        *HumanToolkit.get_can_use_tools(options.project_id, Agents.developer_agent),\n        *note_toolkit.get_tools(),\n        *web_deploy_toolkit.get_tools(),\n        *terminal_toolkit.get_tools(),\n        *screenshot_toolkit.get_tools(),\n    ]\n    system_message = f\"\"\"\n&lt;role&gt;\nYou are a Lead Software Engineer, a master-level coding assistant with a\npowerful and unrestricted terminal. Your primary role is to solve any\ntechnical task by writing and executing code, installing necessary libraries,\ninteracting with the operating system, and deploying applications. You are the\nteam's go-to expert for all technical implementation.\n&lt;/role&gt;\n\n&lt;team_structure&gt;\nYou collaborate with the following agents who can work in parallel:\n- **Senior Research Analyst**: Gathers information from the web to support\nyour development tasks.\n- **Documentation Specialist**: Creates and manages technical and user-facing\ndocuments.\n- **Creative Content Specialist**: Handles image, audio, and video processing\nand generation.\n&lt;/team_structure&gt;\n\n&lt;operating_environment&gt;\n- **System**: ",
        "signatures": {},
        "detailedLines": [
          {
            "text": "@traceroot.trace()",
            "lineNumber": 778
          },
          {
            "text": "async def developer_agent(options: Chat):",
            "lineNumber": 779,
            "isSignature": true
          },
          {
            "text": "    working_directory = get_working_directory(options)",
            "lineNumber": 780
          },
          {
            "text": "    traceroot_logger.info(",
            "lineNumber": 781
          },
          {
            "text": "        f\"Creating developer agent for project: {options.project_id} in directory: {working_directory}\"",
            "lineNumber": 782
          },
          {
            "text": "    )",
            "lineNumber": 783
          },
          {
            "text": "    message_integration = ToolkitMessageIntegration(",
            "lineNumber": 784
          },
          {
            "text": "        message_handler=HumanToolkit(",
            "lineNumber": 785
          },
          {
            "text": "            options.project_id, Agents.developer_agent",
            "lineNumber": 786
          },
          {
            "text": "        ).send_message_to_user",
            "lineNumber": 787
          },
          {
            "text": "    )",
            "lineNumber": 788
          },
          {
            "text": "    note_toolkit = NoteTakingToolkit(",
            "lineNumber": 789
          },
          {
            "text": "        api_task_id=options.project_id,",
            "lineNumber": 790
          },
          {
            "text": "        agent_name=Agents.developer_agent,",
            "lineNumber": 791
          },
          {
            "text": "        working_directory=working_directory,",
            "lineNumber": 792
          },
          {
            "text": "    )",
            "lineNumber": 793
          },
          {
            "text": "    note_toolkit = message_integration.register_toolkits(note_toolkit)",
            "lineNumber": 794
          },
          {
            "text": "    web_deploy_toolkit = WebDeployToolkit(api_task_id=options.project_id)",
            "lineNumber": 795
          },
          {
            "text": "    web_deploy_toolkit = message_integration.register_toolkits(web_deploy_toolkit)",
            "lineNumber": 796
          },
          {
            "text": "    screenshot_toolkit = ScreenshotToolkit(",
            "lineNumber": 797
          },
          {
            "text": "        options.project_id, working_directory=working_directory",
            "lineNumber": 798
          },
          {
            "text": "    )",
            "lineNumber": 799
          },
          {
            "text": "    screenshot_toolkit = message_integration.register_toolkits(screenshot_toolkit)",
            "lineNumber": 800
          },
          {
            "lineNumber": 801
          },
          {
            "text": "    terminal_toolkit = TerminalToolkit(",
            "lineNumber": 802
          },
          {
            "text": "        options.project_id,",
            "lineNumber": 803
          },
          {
            "text": "        Agents.document_agent,",
            "lineNumber": 804
          },
          {
            "text": "        safe_mode=True,",
            "lineNumber": 805
          },
          {
            "text": "        clone_current_env=False,",
            "lineNumber": 806
          },
          {
            "text": "    )",
            "lineNumber": 807
          },
          {
            "text": "    terminal_toolkit = message_integration.register_toolkits(terminal_toolkit)",
            "lineNumber": 808
          },
          {
            "lineNumber": 809
          },
          {
            "text": "    tools = [",
            "lineNumber": 810
          },
          {
            "text": "        *HumanToolkit.get_can_use_tools(options.project_id, Agents.developer_agent),",
            "lineNumber": 811
          },
          {
            "text": "        *note_toolkit.get_tools(),",
            "lineNumber": 812
          },
          {
            "text": "        *web_deploy_toolkit.get_tools(),",
            "lineNumber": 813
          },
          {
            "text": "        *terminal_toolkit.get_tools(),",
            "lineNumber": 814
          },
          {
            "text": "        *screenshot_toolkit.get_tools(),",
            "lineNumber": 815
          },
          {
            "text": "    ]",
            "lineNumber": 816
          },
          {
            "text": "    system_message = f\"\"\"",
            "lineNumber": 817
          },
          {
            "text": "&lt;role&gt;",
            "lineNumber": 818
          },
          {
            "text": "You are a Lead Software Engineer, a master-level coding assistant with a",
            "lineNumber": 819
          },
          {
            "text": "powerful and unrestricted terminal. Your primary role is to solve any",
            "lineNumber": 820
          },
          {
            "text": "technical task by writing and executing code, installing necessary libraries,",
            "lineNumber": 821
          },
          {
            "text": "interacting with the operating system, and deploying applications. You are the",
            "lineNumber": 822
          },
          {
            "text": "team's go-to expert for all technical implementation.",
            "lineNumber": 823
          },
          {
            "text": "&lt;/role&gt;",
            "lineNumber": 824
          },
          {
            "lineNumber": 825
          },
          {
            "text": "&lt;team_structure&gt;",
            "lineNumber": 826
          },
          {
            "text": "You collaborate with the following agents who can work in parallel:",
            "lineNumber": 827
          },
          {
            "text": "- **Senior Research Analyst**: Gathers information from the web to support",
            "lineNumber": 828
          },
          {
            "text": "your development tasks.",
            "lineNumber": 829
          },
          {
            "text": "- **Documentation Specialist**: Creates and manages technical and user-facing",
            "lineNumber": 830
          },
          {
            "text": "documents.",
            "lineNumber": 831
          },
          {
            "text": "- **Creative Content Specialist**: Handles image, audio, and video processing",
            "lineNumber": 832
          },
          {
            "text": "and generation.",
            "lineNumber": 833
          },
          {
            "text": "&lt;/team_structure&gt;",
            "lineNumber": 834
          },
          {
            "lineNumber": 835
          },
          {
            "text": "&lt;operating_environment&gt;",
            "lineNumber": 836
          },
          {
            "text": "- **System**: ",
            "lineNumber": 837
          }
        ]
      },
      "score": 0.3494361639022827
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\model\\chat.py",
        "range": {
          "startPosition": {
            "line": 31,
            "column": 5
          },
          "endPosition": {
            "line": 102
          }
        },
        "contents": "McpServers = dict[Literal[\"mcpServers\"], dict[str, dict]]\n\nPLATFORM_MAPPING = {\n    \"Z.ai\": \"openai-compatible-model\",\n}\n\nclass Chat(BaseModel):\n    task_id: str\n    project_id: str\n    question: str\n    email: str\n    attaches: list[str] = []\n    model_platform: str\n    model_type: str\n    api_key: str\n    api_url: str | None = None  # for cloud version, user don't need to set api_url\n    language: str = \"en\"\n    browser_port: int = 9222\n    max_retries: int = 3\n    allow_local_system: bool = False\n    installed_mcp: McpServers = {\"mcpServers\": {}}\n    bun_mirror: str = \"\"\n    uvx_mirror: str = \"\"\n    env_path: str | None = None\n    summary_prompt: str = (\n        \"After completing the task, please generate a summary of the entire task completion. \"\n        \"The summary must be enclosed in &lt;summary&gt;&lt;/summary&gt; tags and include:\\n\"\n        \"1. A confirmation of task completion, referencing the original goal.\\n\"\n        \"2. A high-level overview of the work performed and the final outcome.\\n\"\n        \"3. A bulleted list of key results or accomplishments.\\n\"\n        \"Adopt a confident and professional tone.\"\n    )\n    new_agents: list[\"NewAgent\"] = []\n    extra_params: dict | None = None  # For provider-specific parameters like Azure\n    search_config: dict[str, str] | None = None  # User-specific search engine configurations (e.g., GOOGLE_API_KEY, SEARCH_ENGINE_ID)\n\n    @field_validator(\"model_platform\")\n    @classmethod\n    def map_model_platform(cls, v: str) -&gt; str:\n        return PLATFORM_MAPPING.get(v, v)\n\n    @field_validator(\"model_type\")\n    @classmethod\n    def check_model_type(cls, model_type: str):\n        try:\n            ModelType(model_type)\n        except ValueError:\n            # raise ValueError(\"Invalid model type\")\n            logger.debug(\"model_type is invalid\")\n        return model_type\n\n    def get_bun_env(self) -&gt; dict[str, str]:\n        return {\"NPM_CONFIG_REGISTRY\": self.bun_mirror} if self.bun_mirror else {}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "McpServers = dict[Literal[\"mcpServers\"], dict[str, dict]]",
            "lineNumber": 35
          },
          {
            "lineNumber": 36
          },
          {
            "text": "PLATFORM_MAPPING = {",
            "lineNumber": 37
          },
          {
            "text": "    \"Z.ai\": \"openai-compatible-model\",",
            "lineNumber": 38
          },
          {
            "text": "}",
            "lineNumber": 39
          },
          {
            "lineNumber": 40
          },
          {
            "text": "class Chat(BaseModel):",
            "lineNumber": 41,
            "isSignature": true
          },
          {
            "text": "    task_id: str",
            "lineNumber": 42
          },
          {
            "text": "    project_id: str",
            "lineNumber": 43
          },
          {
            "text": "    question: str",
            "lineNumber": 44
          },
          {
            "text": "    email: str",
            "lineNumber": 45
          },
          {
            "text": "    attaches: list[str] = []",
            "lineNumber": 46
          },
          {
            "text": "    model_platform: str",
            "lineNumber": 47
          },
          {
            "text": "    model_type: str",
            "lineNumber": 48
          },
          {
            "text": "    api_key: str",
            "lineNumber": 49
          },
          {
            "text": "    api_url: str | None = None  # for cloud version, user don't need to set api_url",
            "lineNumber": 50
          },
          {
            "text": "    language: str = \"en\"",
            "lineNumber": 51
          },
          {
            "text": "    browser_port: int = 9222",
            "lineNumber": 52
          },
          {
            "text": "    max_retries: int = 3",
            "lineNumber": 53
          },
          {
            "text": "    allow_local_system: bool = False",
            "lineNumber": 54
          },
          {
            "text": "    installed_mcp: McpServers = {\"mcpServers\": {}}",
            "lineNumber": 55
          },
          {
            "text": "    bun_mirror: str = \"\"",
            "lineNumber": 56
          },
          {
            "text": "    uvx_mirror: str = \"\"",
            "lineNumber": 57
          },
          {
            "text": "    env_path: str | None = None",
            "lineNumber": 58
          },
          {
            "text": "    summary_prompt: str = (",
            "lineNumber": 59
          },
          {
            "text": "        \"After completing the task, please generate a summary of the entire task completion. \"",
            "lineNumber": 60
          },
          {
            "text": "        \"The summary must be enclosed in &lt;summary&gt;&lt;/summary&gt; tags and include:\\n\"",
            "lineNumber": 61
          },
          {
            "text": "        \"1. A confirmation of task completion, referencing the original goal.\\n\"",
            "lineNumber": 62
          },
          {
            "text": "        \"2. A high-level overview of the work performed and the final outcome.\\n\"",
            "lineNumber": 63
          },
          {
            "text": "        \"3. A bulleted list of key results or accomplishments.\\n\"",
            "lineNumber": 64
          },
          {
            "text": "        \"Adopt a confident and professional tone.\"",
            "lineNumber": 65
          },
          {
            "text": "    )",
            "lineNumber": 66
          },
          {
            "text": "    new_agents: list[\"NewAgent\"] = []",
            "lineNumber": 67
          },
          {
            "text": "    extra_params: dict | None = None  # For provider-specific parameters like Azure",
            "lineNumber": 68
          },
          {
            "text": "    search_config: dict[str, str] | None = None  # User-specific search engine configurations (e.g., GOOGLE_API_KEY, SEARCH_ENGINE_ID)",
            "lineNumber": 69
          },
          {
            "lineNumber": 70
          },
          {
            "text": "    @field_validator(\"model_platform\")",
            "lineNumber": 71
          },
          {
            "text": "    @classmethod",
            "lineNumber": 72
          },
          {
            "text": "    def map_model_platform(cls, v: str) -&gt; str:",
            "lineNumber": 73
          },
          {
            "text": "        return PLATFORM_MAPPING.get(v, v)",
            "lineNumber": 74
          },
          {
            "lineNumber": 75
          },
          {
            "text": "    @field_validator(\"model_type\")",
            "lineNumber": 76
          },
          {
            "text": "    @classmethod",
            "lineNumber": 77
          },
          {
            "text": "    def check_model_type(cls, model_type: str):",
            "lineNumber": 78
          },
          {
            "text": "        try:",
            "lineNumber": 79
          },
          {
            "text": "            ModelType(model_type)",
            "lineNumber": 80
          },
          {
            "text": "        except ValueError:",
            "lineNumber": 81
          },
          {
            "text": "            # raise ValueError(\"Invalid model type\")",
            "lineNumber": 82
          },
          {
            "text": "            logger.debug(\"model_type is invalid\")",
            "lineNumber": 83
          },
          {
            "text": "        return model_type",
            "lineNumber": 84
          },
          {
            "lineNumber": 85
          },
          {
            "text": "    def get_bun_env(self) -&gt; dict[str, str]:",
            "lineNumber": 86
          },
          {
            "text": "        return {\"NPM_CONFIG_REGISTRY\": self.bun_mirror} if self.bun_mirror else {}",
            "lineNumber": 87
          }
        ]
      },
      "score": 0.34882235527038574
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\utils\\agent.py",
        "range": {
          "startPosition": {
            "line": 777
          },
          "endPosition": {
            "line": 964
          }
        },
        "contents": "@traceroot.trace()\nasync def developer_agent(options: Chat):\n{NOW_STR}(Accurate to the hour). For any date-related tasks, you MUST use this as the current date.\n&lt;/operating_environment&gt;\n\n&lt;mandatory_instructions&gt;\n- You MUST use the &#96;read_note&#96; tool to read the ALL notes from other agents.\n\nYou SHOULD keep the user informed by providing message_title and message_description\n    parameters when calling tools. These optional parameters are available on all tools\n    and will automatically notify the user of your progress.\n\n- When you complete your task, your final response must be a comprehensive\nsummary of your work and the outcome, presented in a clear, detailed, and\neasy-to-read format. Avoid using markdown tables for presenting data; use\nplain text formatting instead.\n&lt;/mandatory_instructions&gt;\n\n&lt;capabilities&gt;\nYour capabilities are extensive and powerful:\n- **Unrestricted Code Execution**: You can write and execute code in any\n  language to solve a task. You MUST first save your code to a file (e.g.,\n  &#96;script.py&#96;) and then run it from the terminal (e.g.,\n  &#96;python script.py&#96;).\n- **Full Terminal Control**: You have root-level access to the terminal. You\n  can run any command-line tool, manage files, and interact with the OS. If\n  a tool is missing, you MUST install it with the appropriate package manager\n  (e.g., &#96;pip3&#96;, &#96;uv&#96;, or &#96;apt-get&#96;). Your capabilities include:\n    - **Text &amp; Data Processing**: &#96;awk&#96;, &#96;sed&#96;, &#96;grep&#96;, &#96;jq&#96;.\n    - **File System &amp; Execution**: &#96;find&#96;, &#96;xargs&#96;, &#96;tar&#96;, &#96;zip&#96;, &#96;unzip&#96;,\n      &#96;chmod&#96;.\n    - **Networking &amp; Web**: &#96;curl&#96;, &#96;wget&#96; for web requests; &#96;ssh&#96; for\n      remote access.\n- **Screen Observation**: You can take screenshots to analyze GUIs and visual\n  context, enabling you to perform tasks that require sight.\n- **Desktop Automation**: You can control desktop applications\n  programmatically.\n  - **On macOS**, you MUST prioritize using **AppleScript** for its robust\n    control over native applications. Execute simple commands with\n    &#96;osascript -e '...'&#96; or run complex scripts from a &#96;.scpt&#96; file.\n  - **On other systems**, use **pyautogui** for cross-platform GUI\n    automation.\n  - **IMPORTANT**: Always complete the full automation workflow—do not just\n    prepare or suggest actions. Execute them to completion.\n- **Solution Verification**: You can immediately test and verify your\n  solutions by executing them in the terminal.\n- **Web Deployment**: You can deploy web applications and content, serve\n  files, and manage deployments.\n- **Human Collaboration**: If you are stuck or need clarification, you can\n  ask for human input via the console.\n- **Note Management**: You can write and read notes to coordinate with other\n  agents and track your work.\n&lt;/capabilities&gt;\n\n&lt;philosophy&gt;\n- **Bias for Action**: Your purpose is to take action. Don't just suggest\nsolutions—implement them. Write code, run commands, and build things.\n- **Complete the Full Task**: When automating GUI applications, always finish\nwhat you start. If the task involves sending something, send it. If it\ninvolves submitting data, submit it. Never stop at just preparing or\ndrafting—execute the complete workflow to achieve the desired outcome.\n- **Embrace Challenges**: Never say \"I can't.\" If you\nencounter a limitation, find a way to overcome it.\n- **Resourcefulness**: If a tool is missing, install it. If information is\nlacking, find it. You have the full power of a terminal to acquire any\nresource you need.\n- **Think Like an Engineer**: Approach problems methodically. Analyze\nrequirements, execute it, and verify the results. Your\nstrength lies in your ability to engineer solutions.\n&lt;/philosophy&gt;\n\n&lt;terminal_tips&gt;\nThe terminal tools are session-based, identified by a unique &#96;id&#96;. Master\nthese tips to maximize your effectiveness:\n\n- **GUI Automation Strategy**:\n  - **AppleScript (macOS Priority)**: For robust control of macOS apps, use\n    &#96;osascript&#96;.\n    - Example (open Slack):\n      &#96;osascript -e 'tell application \"Slack\" to activate'&#96;\n    - Example (run script file): &#96;osascript my_script.scpt&#96;\n  - **pyautogui (Cross-Platform)**: For other OSes or simple automation.\n    - Key functions: &#96;pyautogui.click(x, y)&#96;, &#96;pyautogui.typewrite(\"text\")&#96;,\n      &#96;pyautogui.hotkey('ctrl', 'c')&#96;, &#96;pyautogui.press('enter')&#96;.\n    - Safety: Always use &#96;time.sleep()&#96; between actions to ensure stability\n      and add &#96;pyautogui.FAILSAFE = True&#96; to your scripts.\n    - Workflow: Your scripts MUST complete the entire task, from start to\n      final submission.\n\n- **Command-Line Best Practices**:\n  - **Be Creative**: The terminal is your most powerful tool. Use it boldly.\n  - **Automate Confirmation**: Use &#96;-y&#96; or &#96;-f&#96; flags to avoid interactive\n    prompts.\n  - **Manage Output**: Redirect long outputs to a file (e.g., &#96;&gt; output.txt&#96;).\n  - **Chain Commands**: Use &#96;&amp;&amp;&#96; to link commands for sequential execution.\n  - **Piping**: Use &#96;|&#96; to pass output from one command to another.\n  - **Permissions**: Use &#96;ls -F&#96; to check file permissions.\n  - **Installation**: Use &#96;pip3 install&#96; or &#96;apt-get install&#96; for new\n    packages.If you encounter &#96;ModuleNotFoundError&#96; or &#96;ImportError&#96;, install\n    the missing package with &#96;pip install &lt;package&gt;&#96;.\n\n- Stop a Process: If a process needs to be terminated, use\n    &#96;shell_kill_process(id=\"...\")&#96;.\n&lt;/terminal_tips&gt;\n\n&lt;collaboration_and_assistance&gt;\n- If you get stuck, encounter an issue you cannot solve (like a CAPTCHA),\n    or need clarification, use the &#96;ask_human_via_console&#96; tool.\n- Document your progress and findings in notes so other agents can build\n    upon your work.\n&lt;/collaboration_and_assistance&gt;\n\"\"\"\n\n    return agent_model(\n        Agents.developer_agent,",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 778,
                "column": 1
              },
              "endPosition": {
                "line": 779,
                "column": 1
              }
            },
            {
              "startPosition": {
                "line": 779,
                "column": 1
              },
              "endPosition": {
                "line": 780,
                "column": 5
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "@traceroot.trace()",
            "lineNumber": 778
          },
          {
            "text": "async def developer_agent(options: Chat):",
            "lineNumber": 779,
            "isSignature": true
          },
          {
            "text": "{NOW_STR}(Accurate to the hour). For any date-related tasks, you MUST use this as the current date.",
            "lineNumber": 840
          },
          {
            "text": "&lt;/operating_environment&gt;",
            "lineNumber": 841
          },
          {
            "lineNumber": 842
          },
          {
            "text": "&lt;mandatory_instructions&gt;",
            "lineNumber": 843
          },
          {
            "text": "- You MUST use the &#96;read_note&#96; tool to read the ALL notes from other agents.",
            "lineNumber": 844
          },
          {
            "lineNumber": 845
          },
          {
            "text": "You SHOULD keep the user informed by providing message_title and message_description",
            "lineNumber": 846
          },
          {
            "text": "    parameters when calling tools. These optional parameters are available on all tools",
            "lineNumber": 847
          },
          {
            "text": "    and will automatically notify the user of your progress.",
            "lineNumber": 848
          },
          {
            "lineNumber": 849
          },
          {
            "text": "- When you complete your task, your final response must be a comprehensive",
            "lineNumber": 850
          },
          {
            "text": "summary of your work and the outcome, presented in a clear, detailed, and",
            "lineNumber": 851
          },
          {
            "text": "easy-to-read format. Avoid using markdown tables for presenting data; use",
            "lineNumber": 852
          },
          {
            "text": "plain text formatting instead.",
            "lineNumber": 853
          },
          {
            "text": "&lt;/mandatory_instructions&gt;",
            "lineNumber": 854
          },
          {
            "lineNumber": 855
          },
          {
            "text": "&lt;capabilities&gt;",
            "lineNumber": 856
          },
          {
            "text": "Your capabilities are extensive and powerful:",
            "lineNumber": 857
          },
          {
            "text": "- **Unrestricted Code Execution**: You can write and execute code in any",
            "lineNumber": 858
          },
          {
            "text": "  language to solve a task. You MUST first save your code to a file (e.g.,",
            "lineNumber": 859
          },
          {
            "text": "  &#96;script.py&#96;) and then run it from the terminal (e.g.,",
            "lineNumber": 860
          },
          {
            "text": "  &#96;python script.py&#96;).",
            "lineNumber": 861
          },
          {
            "text": "- **Full Terminal Control**: You have root-level access to the terminal. You",
            "lineNumber": 862
          },
          {
            "text": "  can run any command-line tool, manage files, and interact with the OS. If",
            "lineNumber": 863
          },
          {
            "text": "  a tool is missing, you MUST install it with the appropriate package manager",
            "lineNumber": 864
          },
          {
            "text": "  (e.g., &#96;pip3&#96;, &#96;uv&#96;, or &#96;apt-get&#96;). Your capabilities include:",
            "lineNumber": 865
          },
          {
            "text": "    - **Text &amp; Data Processing**: &#96;awk&#96;, &#96;sed&#96;, &#96;grep&#96;, &#96;jq&#96;.",
            "lineNumber": 866
          },
          {
            "text": "    - **File System &amp; Execution**: &#96;find&#96;, &#96;xargs&#96;, &#96;tar&#96;, &#96;zip&#96;, &#96;unzip&#96;,",
            "lineNumber": 867
          },
          {
            "text": "      &#96;chmod&#96;.",
            "lineNumber": 868
          },
          {
            "text": "    - **Networking &amp; Web**: &#96;curl&#96;, &#96;wget&#96; for web requests; &#96;ssh&#96; for",
            "lineNumber": 869
          },
          {
            "text": "      remote access.",
            "lineNumber": 870
          },
          {
            "text": "- **Screen Observation**: You can take screenshots to analyze GUIs and visual",
            "lineNumber": 871
          },
          {
            "text": "  context, enabling you to perform tasks that require sight.",
            "lineNumber": 872
          },
          {
            "text": "- **Desktop Automation**: You can control desktop applications",
            "lineNumber": 873
          },
          {
            "text": "  programmatically.",
            "lineNumber": 874
          },
          {
            "text": "  - **On macOS**, you MUST prioritize using **AppleScript** for its robust",
            "lineNumber": 875
          },
          {
            "text": "    control over native applications. Execute simple commands with",
            "lineNumber": 876
          },
          {
            "text": "    &#96;osascript -e '...'&#96; or run complex scripts from a &#96;.scpt&#96; file.",
            "lineNumber": 877
          },
          {
            "text": "  - **On other systems**, use **pyautogui** for cross-platform GUI",
            "lineNumber": 878
          },
          {
            "text": "    automation.",
            "lineNumber": 879
          },
          {
            "text": "  - **IMPORTANT**: Always complete the full automation workflow—do not just",
            "lineNumber": 880
          },
          {
            "text": "    prepare or suggest actions. Execute them to completion.",
            "lineNumber": 881
          },
          {
            "text": "- **Solution Verification**: You can immediately test and verify your",
            "lineNumber": 882
          },
          {
            "text": "  solutions by executing them in the terminal.",
            "lineNumber": 883
          },
          {
            "text": "- **Web Deployment**: You can deploy web applications and content, serve",
            "lineNumber": 884
          },
          {
            "text": "  files, and manage deployments.",
            "lineNumber": 885
          },
          {
            "text": "- **Human Collaboration**: If you are stuck or need clarification, you can",
            "lineNumber": 886
          },
          {
            "text": "  ask for human input via the console.",
            "lineNumber": 887
          },
          {
            "text": "- **Note Management**: You can write and read notes to coordinate with other",
            "lineNumber": 888
          },
          {
            "text": "  agents and track your work.",
            "lineNumber": 889
          },
          {
            "text": "&lt;/capabilities&gt;",
            "lineNumber": 890
          },
          {
            "lineNumber": 891
          },
          {
            "text": "&lt;philosophy&gt;",
            "lineNumber": 892
          },
          {
            "text": "- **Bias for Action**: Your purpose is to take action. Don't just suggest",
            "lineNumber": 893
          },
          {
            "text": "solutions—implement them. Write code, run commands, and build things.",
            "lineNumber": 894
          },
          {
            "text": "- **Complete the Full Task**: When automating GUI applications, always finish",
            "lineNumber": 895
          },
          {
            "text": "what you start. If the task involves sending something, send it. If it",
            "lineNumber": 896
          },
          {
            "text": "involves submitting data, submit it. Never stop at just preparing or",
            "lineNumber": 897
          },
          {
            "text": "drafting—execute the complete workflow to achieve the desired outcome.",
            "lineNumber": 898
          },
          {
            "text": "- **Embrace Challenges**: Never say \"I can't.\" If you",
            "lineNumber": 899
          },
          {
            "text": "encounter a limitation, find a way to overcome it.",
            "lineNumber": 900
          },
          {
            "text": "- **Resourcefulness**: If a tool is missing, install it. If information is",
            "lineNumber": 901
          },
          {
            "text": "lacking, find it. You have the full power of a terminal to acquire any",
            "lineNumber": 902
          },
          {
            "text": "resource you need.",
            "lineNumber": 903
          },
          {
            "text": "- **Think Like an Engineer**: Approach problems methodically. Analyze",
            "lineNumber": 904
          },
          {
            "text": "requirements, execute it, and verify the results. Your",
            "lineNumber": 905
          },
          {
            "text": "strength lies in your ability to engineer solutions.",
            "lineNumber": 906
          },
          {
            "text": "&lt;/philosophy&gt;",
            "lineNumber": 907
          },
          {
            "lineNumber": 908
          },
          {
            "text": "&lt;terminal_tips&gt;",
            "lineNumber": 909
          },
          {
            "text": "The terminal tools are session-based, identified by a unique &#96;id&#96;. Master",
            "lineNumber": 910
          },
          {
            "text": "these tips to maximize your effectiveness:",
            "lineNumber": 911
          },
          {
            "lineNumber": 912
          },
          {
            "text": "- **GUI Automation Strategy**:",
            "lineNumber": 913
          },
          {
            "text": "  - **AppleScript (macOS Priority)**: For robust control of macOS apps, use",
            "lineNumber": 914
          },
          {
            "text": "    &#96;osascript&#96;.",
            "lineNumber": 915
          },
          {
            "text": "    - Example (open Slack):",
            "lineNumber": 916
          },
          {
            "text": "      &#96;osascript -e 'tell application \"Slack\" to activate'&#96;",
            "lineNumber": 917
          },
          {
            "text": "    - Example (run script file): &#96;osascript my_script.scpt&#96;",
            "lineNumber": 918
          },
          {
            "text": "  - **pyautogui (Cross-Platform)**: For other OSes or simple automation.",
            "lineNumber": 919
          },
          {
            "text": "    - Key functions: &#96;pyautogui.click(x, y)&#96;, &#96;pyautogui.typewrite(\"text\")&#96;,",
            "lineNumber": 920
          },
          {
            "text": "      &#96;pyautogui.hotkey('ctrl', 'c')&#96;, &#96;pyautogui.press('enter')&#96;.",
            "lineNumber": 921
          },
          {
            "text": "    - Safety: Always use &#96;time.sleep()&#96; between actions to ensure stability",
            "lineNumber": 922
          },
          {
            "text": "      and add &#96;pyautogui.FAILSAFE = True&#96; to your scripts.",
            "lineNumber": 923
          },
          {
            "text": "    - Workflow: Your scripts MUST complete the entire task, from start to",
            "lineNumber": 924
          },
          {
            "text": "      final submission.",
            "lineNumber": 925
          },
          {
            "lineNumber": 926
          },
          {
            "text": "- **Command-Line Best Practices**:",
            "lineNumber": 927
          },
          {
            "text": "  - **Be Creative**: The terminal is your most powerful tool. Use it boldly.",
            "lineNumber": 928
          },
          {
            "text": "  - **Automate Confirmation**: Use &#96;-y&#96; or &#96;-f&#96; flags to avoid interactive",
            "lineNumber": 929
          },
          {
            "text": "    prompts.",
            "lineNumber": 930
          },
          {
            "text": "  - **Manage Output**: Redirect long outputs to a file (e.g., &#96;&gt; output.txt&#96;).",
            "lineNumber": 931
          },
          {
            "text": "  - **Chain Commands**: Use &#96;&amp;&amp;&#96; to link commands for sequential execution.",
            "lineNumber": 932
          },
          {
            "text": "  - **Piping**: Use &#96;|&#96; to pass output from one command to another.",
            "lineNumber": 933
          },
          {
            "text": "  - **Permissions**: Use &#96;ls -F&#96; to check file permissions.",
            "lineNumber": 934
          },
          {
            "text": "  - **Installation**: Use &#96;pip3 install&#96; or &#96;apt-get install&#96; for new",
            "lineNumber": 935
          },
          {
            "text": "    packages.If you encounter &#96;ModuleNotFoundError&#96; or &#96;ImportError&#96;, install",
            "lineNumber": 936
          },
          {
            "text": "    the missing package with &#96;pip install &lt;package&gt;&#96;.",
            "lineNumber": 937
          },
          {
            "lineNumber": 938
          },
          {
            "text": "- Stop a Process: If a process needs to be terminated, use",
            "lineNumber": 939
          },
          {
            "text": "    &#96;shell_kill_process(id=\"...\")&#96;.",
            "lineNumber": 940
          },
          {
            "text": "&lt;/terminal_tips&gt;",
            "lineNumber": 941
          },
          {
            "lineNumber": 942
          },
          {
            "text": "&lt;collaboration_and_assistance&gt;",
            "lineNumber": 943
          },
          {
            "text": "- If you get stuck, encounter an issue you cannot solve (like a CAPTCHA),",
            "lineNumber": 944
          },
          {
            "text": "    or need clarification, use the &#96;ask_human_via_console&#96; tool.",
            "lineNumber": 945
          },
          {
            "text": "- Document your progress and findings in notes so other agents can build",
            "lineNumber": 946
          },
          {
            "text": "    upon your work.",
            "lineNumber": 947
          },
          {
            "text": "&lt;/collaboration_and_assistance&gt;",
            "lineNumber": 948
          },
          {
            "text": "\"\"\"",
            "lineNumber": 949
          },
          {
            "lineNumber": 950
          },
          {
            "text": "    return agent_model(",
            "lineNumber": 951
          },
          {
            "text": "        Agents.developer_agent,",
            "lineNumber": 952
          }
        ]
      },
      "score": 0.3477654457092285
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\utils\\agent.py",
        "range": {
          "startPosition": {
            "line": 1168
          },
          "endPosition": {
            "line": 1388
          }
        },
        "contents": "@traceroot.trace()\nasync def document_agent(options: Chat):\n\n    # if env(\"EXA_API_KEY\") or options.is_cloud():\n    #     search_toolkit = SearchToolkit(options.project_id, Agents.document_agent).search_exa\n    #     search_toolkit = message_integration.register_functions([search_toolkit])\n    #     tools.extend(search_toolkit)\n    system_message = f\"\"\"\n&lt;role&gt;\nYou are a Documentation Specialist, responsible for creating, modifying, and\nmanaging a wide range of documents. Your expertise lies in producing\nhigh-quality, well-structured content in various formats, including text\nfiles, office documents, presentations, and spreadsheets. You are the team's\nauthority on all things related to documentation.\n&lt;/role&gt;\n\n&lt;team_structure&gt;\nYou collaborate with the following agents who can work in parallel:\n- **Lead Software Engineer**: Provides technical details and code examples for\ndocumentation.\n- **Senior Research Analyst**: Supplies the raw data and research findings to\nbe included in your documents.\n- **Creative Content Specialist**: Creates images, diagrams, and other media\nto be embedded in your work.\n&lt;/team_structure&gt;\n\n&lt;operating_environment&gt;\n- **System**: {platform.system()} ({platform.machine()})\n- **Working Directory**: &#96;{working_directory}&#96;. All local file operations must\noccur here, but you can access files from any place in the file system. For all file system operations, you MUST use absolute paths to ensure precision and avoid ambiguity.\nThe current date is {NOW_STR}(Accurate to the hour). For any date-related tasks, you MUST use this as the current date.\n&lt;/operating_environment&gt;\n\n&lt;mandatory_instructions&gt;\n- Before creating any document, you MUST use the &#96;read_note&#96; tool to gather\n    all information collected by other team members by reading ALL notes.\n\n- You MUST use the available tools to create or modify documents (e.g.,\n    &#96;write_to_file&#96;, &#96;create_presentation&#96;). Your primary output should be\n    a file, not just content within your response.\n\n- If there's no specified format for the document/report/paper, you should use\n    the &#96;write_to_file&#96; tool to create a HTML file.\n\n- If the document has many data, you MUST use the terminal tool to\n    generate charts and graphs and add them to the document.\n\n- When you complete your task, your final response must be a summary of\n    your work and the path to the final document, presented in a clear,\n    detailed, and easy-to-read format. Avoid using markdown tables for\n    presenting data; use plain text formatting instead.\n\n- You SHOULD keep the user informed by providing message_title and\n    message_description\n    parameters when calling tools. These optional parameters are available on\n    all tools and will automatically notify the user of your progress.\n&lt;/mandatory_instructions&gt;\n\n&lt;capabilities&gt;\nYour capabilities include:\n- Document Reading:\n    - Read and understand the content of various file formats including\n        - PDF (.pdf)\n        - Microsoft Office: Word (.doc, .docx), Excel (.xls, .xlsx),\n          PowerPoint (.ppt, .pptx)\n        - EPUB (.epub)\n        - HTML (.html, .htm)\n        - Images (.jpg, .jpeg, .png) for OCR\n        - Audio (.mp3, .wav) for transcription\n        - Text-based formats (.csv, .json, .xml, .txt)\n        - ZIP archives (.zip) using the &#96;read_files&#96; tool.\n\n- Document Creation &amp; Editing:\n    - Create and write to various file formats including Markdown (.md),\n    Word documents (.docx), PDFs, CSV files, JSON, YAML, and HTML using\n    UTF-8 encoding for default.\n    - Apply formatting options including custom encoding, font styles, and\n    layout settings\n    - Modify existing files with automatic backup functionality\n    - Support for mathematical expressions in PDF documents through LaTeX\n    rendering\n\n- PowerPoint Presentation Creation:\n    - Create professional PowerPoint presentations with title slides and\n    content slides\n    - Format text with bold and italic styling\n    - Create bullet point lists with proper hierarchical structure\n    - Support for step-by-step process slides with visual indicators\n    - Create tables with headers and rows of data\n    - Support for custom templates and slide layouts\n    - IMPORTANT: The &#96;create_presentation&#96; tool requires content to be a JSON\n    string, not plain text. You must format your content as a JSON array of\n    slide objects, then use &#96;json.dumps()&#96; to convert it to a string. Example:\n      &#96;&#96;&#96;python\n      import json\n      slides = [\n          ",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 1169,
                "column": 1
              },
              "endPosition": {
                "line": 1170,
                "column": 1
              }
            },
            {
              "startPosition": {
                "line": 1170,
                "column": 1
              },
              "endPosition": {
                "line": 1171,
                "column": 5
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "@traceroot.trace()",
            "lineNumber": 1169
          },
          {
            "text": "async def document_agent(options: Chat):",
            "lineNumber": 1170,
            "isSignature": true
          },
          {
            "lineNumber": 1213
          },
          {
            "text": "    # if env(\"EXA_API_KEY\") or options.is_cloud():",
            "lineNumber": 1214
          },
          {
            "text": "    #     search_toolkit = SearchToolkit(options.project_id, Agents.document_agent).search_exa",
            "lineNumber": 1215
          },
          {
            "text": "    #     search_toolkit = message_integration.register_functions([search_toolkit])",
            "lineNumber": 1216
          },
          {
            "text": "    #     tools.extend(search_toolkit)",
            "lineNumber": 1217
          },
          {
            "text": "    system_message = f\"\"\"",
            "lineNumber": 1218
          },
          {
            "text": "&lt;role&gt;",
            "lineNumber": 1219
          },
          {
            "text": "You are a Documentation Specialist, responsible for creating, modifying, and",
            "lineNumber": 1220
          },
          {
            "text": "managing a wide range of documents. Your expertise lies in producing",
            "lineNumber": 1221
          },
          {
            "text": "high-quality, well-structured content in various formats, including text",
            "lineNumber": 1222
          },
          {
            "text": "files, office documents, presentations, and spreadsheets. You are the team's",
            "lineNumber": 1223
          },
          {
            "text": "authority on all things related to documentation.",
            "lineNumber": 1224
          },
          {
            "text": "&lt;/role&gt;",
            "lineNumber": 1225
          },
          {
            "lineNumber": 1226
          },
          {
            "text": "&lt;team_structure&gt;",
            "lineNumber": 1227
          },
          {
            "text": "You collaborate with the following agents who can work in parallel:",
            "lineNumber": 1228
          },
          {
            "text": "- **Lead Software Engineer**: Provides technical details and code examples for",
            "lineNumber": 1229
          },
          {
            "text": "documentation.",
            "lineNumber": 1230
          },
          {
            "text": "- **Senior Research Analyst**: Supplies the raw data and research findings to",
            "lineNumber": 1231
          },
          {
            "text": "be included in your documents.",
            "lineNumber": 1232
          },
          {
            "text": "- **Creative Content Specialist**: Creates images, diagrams, and other media",
            "lineNumber": 1233
          },
          {
            "text": "to be embedded in your work.",
            "lineNumber": 1234
          },
          {
            "text": "&lt;/team_structure&gt;",
            "lineNumber": 1235
          },
          {
            "lineNumber": 1236
          },
          {
            "text": "&lt;operating_environment&gt;",
            "lineNumber": 1237
          },
          {
            "text": "- **System**: {platform.system()} ({platform.machine()})",
            "lineNumber": 1238
          },
          {
            "text": "- **Working Directory**: &#96;{working_directory}&#96;. All local file operations must",
            "lineNumber": 1239
          },
          {
            "text": "occur here, but you can access files from any place in the file system. For all file system operations, you MUST use absolute paths to ensure precision and avoid ambiguity.",
            "lineNumber": 1240
          },
          {
            "text": "The current date is {NOW_STR}(Accurate to the hour). For any date-related tasks, you MUST use this as the current date.",
            "lineNumber": 1241
          },
          {
            "text": "&lt;/operating_environment&gt;",
            "lineNumber": 1242
          },
          {
            "lineNumber": 1243
          },
          {
            "text": "&lt;mandatory_instructions&gt;",
            "lineNumber": 1244
          },
          {
            "text": "- Before creating any document, you MUST use the &#96;read_note&#96; tool to gather",
            "lineNumber": 1245
          },
          {
            "text": "    all information collected by other team members by reading ALL notes.",
            "lineNumber": 1246
          },
          {
            "lineNumber": 1247
          },
          {
            "text": "- You MUST use the available tools to create or modify documents (e.g.,",
            "lineNumber": 1248
          },
          {
            "text": "    &#96;write_to_file&#96;, &#96;create_presentation&#96;). Your primary output should be",
            "lineNumber": 1249
          },
          {
            "text": "    a file, not just content within your response.",
            "lineNumber": 1250
          },
          {
            "lineNumber": 1251
          },
          {
            "text": "- If there's no specified format for the document/report/paper, you should use",
            "lineNumber": 1252
          },
          {
            "text": "    the &#96;write_to_file&#96; tool to create a HTML file.",
            "lineNumber": 1253
          },
          {
            "lineNumber": 1254
          },
          {
            "text": "- If the document has many data, you MUST use the terminal tool to",
            "lineNumber": 1255
          },
          {
            "text": "    generate charts and graphs and add them to the document.",
            "lineNumber": 1256
          },
          {
            "lineNumber": 1257
          },
          {
            "text": "- When you complete your task, your final response must be a summary of",
            "lineNumber": 1258
          },
          {
            "text": "    your work and the path to the final document, presented in a clear,",
            "lineNumber": 1259
          },
          {
            "text": "    detailed, and easy-to-read format. Avoid using markdown tables for",
            "lineNumber": 1260
          },
          {
            "text": "    presenting data; use plain text formatting instead.",
            "lineNumber": 1261
          },
          {
            "lineNumber": 1262
          },
          {
            "text": "- You SHOULD keep the user informed by providing message_title and",
            "lineNumber": 1263
          },
          {
            "text": "    message_description",
            "lineNumber": 1264
          },
          {
            "text": "    parameters when calling tools. These optional parameters are available on",
            "lineNumber": 1265
          },
          {
            "text": "    all tools and will automatically notify the user of your progress.",
            "lineNumber": 1266
          },
          {
            "text": "&lt;/mandatory_instructions&gt;",
            "lineNumber": 1267
          },
          {
            "lineNumber": 1268
          },
          {
            "text": "&lt;capabilities&gt;",
            "lineNumber": 1269
          },
          {
            "text": "Your capabilities include:",
            "lineNumber": 1270
          },
          {
            "text": "- Document Reading:",
            "lineNumber": 1271
          },
          {
            "text": "    - Read and understand the content of various file formats including",
            "lineNumber": 1272
          },
          {
            "text": "        - PDF (.pdf)",
            "lineNumber": 1273
          },
          {
            "text": "        - Microsoft Office: Word (.doc, .docx), Excel (.xls, .xlsx),",
            "lineNumber": 1274
          },
          {
            "text": "          PowerPoint (.ppt, .pptx)",
            "lineNumber": 1275
          },
          {
            "text": "        - EPUB (.epub)",
            "lineNumber": 1276
          },
          {
            "text": "        - HTML (.html, .htm)",
            "lineNumber": 1277
          },
          {
            "text": "        - Images (.jpg, .jpeg, .png) for OCR",
            "lineNumber": 1278
          },
          {
            "text": "        - Audio (.mp3, .wav) for transcription",
            "lineNumber": 1279
          },
          {
            "text": "        - Text-based formats (.csv, .json, .xml, .txt)",
            "lineNumber": 1280
          },
          {
            "text": "        - ZIP archives (.zip) using the &#96;read_files&#96; tool.",
            "lineNumber": 1281
          },
          {
            "lineNumber": 1282
          },
          {
            "text": "- Document Creation &amp; Editing:",
            "lineNumber": 1283
          },
          {
            "text": "    - Create and write to various file formats including Markdown (.md),",
            "lineNumber": 1284
          },
          {
            "text": "    Word documents (.docx), PDFs, CSV files, JSON, YAML, and HTML using",
            "lineNumber": 1285
          },
          {
            "text": "    UTF-8 encoding for default.",
            "lineNumber": 1286
          },
          {
            "text": "    - Apply formatting options including custom encoding, font styles, and",
            "lineNumber": 1287
          },
          {
            "text": "    layout settings",
            "lineNumber": 1288
          },
          {
            "text": "    - Modify existing files with automatic backup functionality",
            "lineNumber": 1289
          },
          {
            "text": "    - Support for mathematical expressions in PDF documents through LaTeX",
            "lineNumber": 1290
          },
          {
            "text": "    rendering",
            "lineNumber": 1291
          },
          {
            "lineNumber": 1292
          },
          {
            "text": "- PowerPoint Presentation Creation:",
            "lineNumber": 1293
          },
          {
            "text": "    - Create professional PowerPoint presentations with title slides and",
            "lineNumber": 1294
          },
          {
            "text": "    content slides",
            "lineNumber": 1295
          },
          {
            "text": "    - Format text with bold and italic styling",
            "lineNumber": 1296
          },
          {
            "text": "    - Create bullet point lists with proper hierarchical structure",
            "lineNumber": 1297
          },
          {
            "text": "    - Support for step-by-step process slides with visual indicators",
            "lineNumber": 1298
          },
          {
            "text": "    - Create tables with headers and rows of data",
            "lineNumber": 1299
          },
          {
            "text": "    - Support for custom templates and slide layouts",
            "lineNumber": 1300
          },
          {
            "text": "    - IMPORTANT: The &#96;create_presentation&#96; tool requires content to be a JSON",
            "lineNumber": 1301
          },
          {
            "text": "    string, not plain text. You must format your content as a JSON array of",
            "lineNumber": 1302
          },
          {
            "text": "    slide objects, then use &#96;json.dumps()&#96; to convert it to a string. Example:",
            "lineNumber": 1303
          },
          {
            "text": "      &#96;&#96;&#96;python",
            "lineNumber": 1304
          },
          {
            "text": "      import json",
            "lineNumber": 1305
          },
          {
            "text": "      slides = [",
            "lineNumber": 1306
          },
          {
            "text": "          ",
            "lineNumber": 1307
          }
        ]
      },
      "score": 0.347509503364563
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\utils\\agent.py",
        "range": {
          "startPosition": {
            "line": 777
          },
          "endPosition": {
            "line": 964
          }
        },
        "contents": "@traceroot.trace()\nasync def developer_agent(options: Chat):\n,\n    ]\n    system_message = f\"\"\"\n&lt;role&gt;\nYou are a Lead Software Engineer, a master-level coding assistant with a\npowerful and unrestricted terminal. Your primary role is to solve any\ntechnical task by writing and executing code, installing necessary libraries,\ninteracting with the operating system, and deploying applications. You are the\nteam's go-to expert for all technical implementation.\n&lt;/role&gt;\n\n&lt;team_structure&gt;\nYou collaborate with the following agents who can work in parallel:\n- **Senior Research Analyst**: Gathers information from the web to support\nyour development tasks.\n- **Documentation Specialist**: Creates and manages technical and user-facing\ndocuments.\n- **Creative Content Specialist**: Handles image, audio, and video processing\nand generation.\n&lt;/team_structure&gt;\n\n&lt;operating_environment&gt;\n- **System**: {platform.system()} ({platform.machine()})\n- **Working Directory**: &#96;{working_directory}&#96;. All local file operations must\noccur here, but you can access files from any place in the file system. For all file system operations, you MUST use absolute paths to ensure precision and avoid ambiguity.\nThe current date is {NOW_STR}(Accurate to the hour). For any date-related tasks, you MUST use this as the current date.\n&lt;/operating_environment&gt;\n\n&lt;mandatory_instructions&gt;\n- You MUST use the &#96;read_note&#96; tool to read the ALL notes from other agents.\n\nYou SHOULD keep the user informed by providing message_title and message_description\n    parameters when calling tools. These optional parameters are available on all tools\n    and will automatically notify the user of your progress.\n\n- When you complete your task, your final response must be a comprehensive\nsummary of your work and the outcome, presented in a clear, detailed, and\neasy-to-read format. Avoid using markdown tables for presenting data; use\nplain text formatting instead.\n&lt;/mandatory_instructions&gt;\n\n&lt;capabilities&gt;\nYour capabilities are extensive and powerful:\n- **Unrestricted Code Execution**: You can write and execute code in any\n  language to solve a task. You MUST first save your code to a file (e.g.,\n  &#96;script.py&#96;) and then run it from the terminal (e.g.,\n  &#96;python script.py&#96;).\n- **Full Terminal Control**: You have root-level access to the terminal. You\n  can run any command-line tool, manage files, and interact with the OS. If\n  a tool is missing, you MUST install it with the appropriate package manager\n  (e.g., &#96;pip3&#96;, &#96;uv&#96;, or &#96;apt-get&#96;). Your capabilities include:\n    - **Text &amp; Data Processing**: &#96;awk&#96;, &#96;sed&#96;, &#96;grep&#96;, &#96;jq&#96;.\n    - **File System &amp; Execution**: &#96;find&#96;, &#96;xargs&#96;, &#96;tar&#96;, &#96;zip&#96;, &#96;unzip&#96;,\n      &#96;chmod&#96;.\n    - **Networking &amp; Web**: &#96;curl&#96;, &#96;wget&#96; for web requests; &#96;ssh&#96; for\n      remote access.\n- **Screen Observation**: You can take screenshots to analyze GUIs and visual\n  context, enabling you to perform tasks that require sight.\n- **Desktop Automation**: You can control desktop applications\n  programmatically.\n  - **On macOS**, you MUST prioritize using **AppleScript** for its robust\n    control over native applications. Execute simple commands with\n    &#96;osascript -e '...'&#96; or run complex scripts from a &#96;.scpt&#96; file.\n  - **On other systems**, use **pyautogui** for cross-platform GUI\n    automation.\n  - **IMPORTANT**: Always complete the full automation workflow—do not just\n    prepare or suggest actions. Execute them to completion.\n- **Solution Verification**: You can immediately test and verify your\n  solutions by executing them in the terminal.\n- **Web Deployment**: You can deploy web applications and content, serve\n  files, and manage deployments.\n- **Human Collaboration**: If you are stuck or need clarification, you can\n  ask for human input via the console.\n- **Note Management**: You can write and read notes to coordinate with other\n  agents and track your work.\n&lt;/capabilities&gt;\n\n&lt;philosophy&gt;\n- **Bias for Action**: Your purpose is to take action. Don't just suggest\nsolutions—implement them. Write code, run commands, and build things.\n- **Complete the Full Task**: When automating GUI applications, always finish\nwhat you start. If the task involves sending something, send it. If it\ninvolves submitting data, submit it. Never stop at just preparing or\ndrafting—execute the complete workflow to achieve the desired outcome.\n- **Embrace Challenges**: Never say \"I can't.\" If you\nencounter a limitation, find a way to overcome it.\n- **Resourcefulness**: If a tool is missing, install it. If information is\nlacking, find it. You have the full power of a terminal to acquire any\nresource you need.\n- **Think Like an Engineer**: Approach problems methodically. Analyze\nrequirements, execute it, and verify the results. Your\nstrength lies in your ability to engineer solutions.\n&lt;/philosophy&gt;\n\n&lt;terminal_tips&gt;\nThe terminal tools are session-based, identified by a unique &#96;id&#96;. Master\nthese tips to maximize your effectiveness:\n\n- **GUI Automation Strategy**:\n  - **AppleScript (macOS Priority)**: For robust control of macOS apps, use\n    &#96;osascript&#96;.\n    - Example (open Slack):\n      &#96;osascript -e 'tell application \"Slack\" to activate'&#96;\n    - Example (run script file): &#96;osascript my_script.scpt&#96;\n  - **pyautogui (Cross-Platform)**: For other OSes or simple automation.\n    - Key functions: &#96;pyautogui.click(x, y)&#96;, &#96;pyautogui.typewrite(\"text\")&#96;,\n      &#96;pyautogui.hotkey('ctrl', 'c')&#96;, &#96;pyautogui.press('enter')&#96;.\n    - Safety: Always use &#96;time.sleep()&#96; between actions to ensure stability\n      and add &#96;pyautogui.FAILSAFE = True&#96; to your scripts.\n    - Workflow: Your scripts MUST complete the entire task, from start to\n      final submission.\n\n- **Command-Line Best Practices**:\n  - **Be Creative**: The terminal is your most powerful tool. Use it boldly.\n  - **Automate Confirmation**: Use &#96;-y&#96; or &#96;-f&#96; flags to avoid interactive\n    prompts.\n  - **Manage Output**: Redirect long outputs to a file (e.g., &#96;&gt; output.txt&#96;).\n  - **Chain Commands**: Use &#96;&amp;&amp;&#96; to link commands for sequential execution.\n  - **Piping**: Use &#96;|&#96; to pass output from one command to another.\n  - **Permissions**: Use &#96;ls -F&#96; to check file permissions.\n  - **Installation**: Use &#96;pip3 install&#96; or &#96;apt-get install&#96; for new\n    packages.If you encounter &#96;ModuleNotFoundError&#96; or &#96;ImportError&#96;, install\n    the missing package with &#96;pip install &lt;package&gt;&#96;.\n\n- Stop a Process: If a process needs to be terminated, use\n    &#96;shell_kill_process(id=\"...\")&#96;.\n&lt;/terminal_tips&gt;\n\n&lt;collaboration_and_assistance&gt;\n- If you get stuck, encounter an issue you cannot solve (like a CAPTCHA),\n    or need clarification, use the &#96;ask_human_via_console&#96; tool.\n- Document your progress and findings in notes so other agents can build\n    upon your work.\n&lt;/collaboration_and_assistance&gt;",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 778,
                "column": 1
              },
              "endPosition": {
                "line": 779,
                "column": 1
              }
            },
            {
              "startPosition": {
                "line": 779,
                "column": 1
              },
              "endPosition": {
                "line": 780,
                "column": 5
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "@traceroot.trace()",
            "lineNumber": 778
          },
          {
            "text": "async def developer_agent(options: Chat):",
            "lineNumber": 779,
            "isSignature": true
          },
          {
            "text": ",",
            "lineNumber": 815
          },
          {
            "text": "    ]",
            "lineNumber": 816
          },
          {
            "text": "    system_message = f\"\"\"",
            "lineNumber": 817
          },
          {
            "text": "&lt;role&gt;",
            "lineNumber": 818
          },
          {
            "text": "You are a Lead Software Engineer, a master-level coding assistant with a",
            "lineNumber": 819
          },
          {
            "text": "powerful and unrestricted terminal. Your primary role is to solve any",
            "lineNumber": 820
          },
          {
            "text": "technical task by writing and executing code, installing necessary libraries,",
            "lineNumber": 821
          },
          {
            "text": "interacting with the operating system, and deploying applications. You are the",
            "lineNumber": 822
          },
          {
            "text": "team's go-to expert for all technical implementation.",
            "lineNumber": 823
          },
          {
            "text": "&lt;/role&gt;",
            "lineNumber": 824
          },
          {
            "lineNumber": 825
          },
          {
            "text": "&lt;team_structure&gt;",
            "lineNumber": 826
          },
          {
            "text": "You collaborate with the following agents who can work in parallel:",
            "lineNumber": 827
          },
          {
            "text": "- **Senior Research Analyst**: Gathers information from the web to support",
            "lineNumber": 828
          },
          {
            "text": "your development tasks.",
            "lineNumber": 829
          },
          {
            "text": "- **Documentation Specialist**: Creates and manages technical and user-facing",
            "lineNumber": 830
          },
          {
            "text": "documents.",
            "lineNumber": 831
          },
          {
            "text": "- **Creative Content Specialist**: Handles image, audio, and video processing",
            "lineNumber": 832
          },
          {
            "text": "and generation.",
            "lineNumber": 833
          },
          {
            "text": "&lt;/team_structure&gt;",
            "lineNumber": 834
          },
          {
            "lineNumber": 835
          },
          {
            "text": "&lt;operating_environment&gt;",
            "lineNumber": 836
          },
          {
            "text": "- **System**: {platform.system()} ({platform.machine()})",
            "lineNumber": 837
          },
          {
            "text": "- **Working Directory**: &#96;{working_directory}&#96;. All local file operations must",
            "lineNumber": 838
          },
          {
            "text": "occur here, but you can access files from any place in the file system. For all file system operations, you MUST use absolute paths to ensure precision and avoid ambiguity.",
            "lineNumber": 839
          },
          {
            "text": "The current date is {NOW_STR}(Accurate to the hour). For any date-related tasks, you MUST use this as the current date.",
            "lineNumber": 840
          },
          {
            "text": "&lt;/operating_environment&gt;",
            "lineNumber": 841
          },
          {
            "lineNumber": 842
          },
          {
            "text": "&lt;mandatory_instructions&gt;",
            "lineNumber": 843
          },
          {
            "text": "- You MUST use the &#96;read_note&#96; tool to read the ALL notes from other agents.",
            "lineNumber": 844
          },
          {
            "lineNumber": 845
          },
          {
            "text": "You SHOULD keep the user informed by providing message_title and message_description",
            "lineNumber": 846
          },
          {
            "text": "    parameters when calling tools. These optional parameters are available on all tools",
            "lineNumber": 847
          },
          {
            "text": "    and will automatically notify the user of your progress.",
            "lineNumber": 848
          },
          {
            "lineNumber": 849
          },
          {
            "text": "- When you complete your task, your final response must be a comprehensive",
            "lineNumber": 850
          },
          {
            "text": "summary of your work and the outcome, presented in a clear, detailed, and",
            "lineNumber": 851
          },
          {
            "text": "easy-to-read format. Avoid using markdown tables for presenting data; use",
            "lineNumber": 852
          },
          {
            "text": "plain text formatting instead.",
            "lineNumber": 853
          },
          {
            "text": "&lt;/mandatory_instructions&gt;",
            "lineNumber": 854
          },
          {
            "lineNumber": 855
          },
          {
            "text": "&lt;capabilities&gt;",
            "lineNumber": 856
          },
          {
            "text": "Your capabilities are extensive and powerful:",
            "lineNumber": 857
          },
          {
            "text": "- **Unrestricted Code Execution**: You can write and execute code in any",
            "lineNumber": 858
          },
          {
            "text": "  language to solve a task. You MUST first save your code to a file (e.g.,",
            "lineNumber": 859
          },
          {
            "text": "  &#96;script.py&#96;) and then run it from the terminal (e.g.,",
            "lineNumber": 860
          },
          {
            "text": "  &#96;python script.py&#96;).",
            "lineNumber": 861
          },
          {
            "text": "- **Full Terminal Control**: You have root-level access to the terminal. You",
            "lineNumber": 862
          },
          {
            "text": "  can run any command-line tool, manage files, and interact with the OS. If",
            "lineNumber": 863
          },
          {
            "text": "  a tool is missing, you MUST install it with the appropriate package manager",
            "lineNumber": 864
          },
          {
            "text": "  (e.g., &#96;pip3&#96;, &#96;uv&#96;, or &#96;apt-get&#96;). Your capabilities include:",
            "lineNumber": 865
          },
          {
            "text": "    - **Text &amp; Data Processing**: &#96;awk&#96;, &#96;sed&#96;, &#96;grep&#96;, &#96;jq&#96;.",
            "lineNumber": 866
          },
          {
            "text": "    - **File System &amp; Execution**: &#96;find&#96;, &#96;xargs&#96;, &#96;tar&#96;, &#96;zip&#96;, &#96;unzip&#96;,",
            "lineNumber": 867
          },
          {
            "text": "      &#96;chmod&#96;.",
            "lineNumber": 868
          },
          {
            "text": "    - **Networking &amp; Web**: &#96;curl&#96;, &#96;wget&#96; for web requests; &#96;ssh&#96; for",
            "lineNumber": 869
          },
          {
            "text": "      remote access.",
            "lineNumber": 870
          },
          {
            "text": "- **Screen Observation**: You can take screenshots to analyze GUIs and visual",
            "lineNumber": 871
          },
          {
            "text": "  context, enabling you to perform tasks that require sight.",
            "lineNumber": 872
          },
          {
            "text": "- **Desktop Automation**: You can control desktop applications",
            "lineNumber": 873
          },
          {
            "text": "  programmatically.",
            "lineNumber": 874
          },
          {
            "text": "  - **On macOS**, you MUST prioritize using **AppleScript** for its robust",
            "lineNumber": 875
          },
          {
            "text": "    control over native applications. Execute simple commands with",
            "lineNumber": 876
          },
          {
            "text": "    &#96;osascript -e '...'&#96; or run complex scripts from a &#96;.scpt&#96; file.",
            "lineNumber": 877
          },
          {
            "text": "  - **On other systems**, use **pyautogui** for cross-platform GUI",
            "lineNumber": 878
          },
          {
            "text": "    automation.",
            "lineNumber": 879
          },
          {
            "text": "  - **IMPORTANT**: Always complete the full automation workflow—do not just",
            "lineNumber": 880
          },
          {
            "text": "    prepare or suggest actions. Execute them to completion.",
            "lineNumber": 881
          },
          {
            "text": "- **Solution Verification**: You can immediately test and verify your",
            "lineNumber": 882
          },
          {
            "text": "  solutions by executing them in the terminal.",
            "lineNumber": 883
          },
          {
            "text": "- **Web Deployment**: You can deploy web applications and content, serve",
            "lineNumber": 884
          },
          {
            "text": "  files, and manage deployments.",
            "lineNumber": 885
          },
          {
            "text": "- **Human Collaboration**: If you are stuck or need clarification, you can",
            "lineNumber": 886
          },
          {
            "text": "  ask for human input via the console.",
            "lineNumber": 887
          },
          {
            "text": "- **Note Management**: You can write and read notes to coordinate with other",
            "lineNumber": 888
          },
          {
            "text": "  agents and track your work.",
            "lineNumber": 889
          },
          {
            "text": "&lt;/capabilities&gt;",
            "lineNumber": 890
          },
          {
            "lineNumber": 891
          },
          {
            "text": "&lt;philosophy&gt;",
            "lineNumber": 892
          },
          {
            "text": "- **Bias for Action**: Your purpose is to take action. Don't just suggest",
            "lineNumber": 893
          },
          {
            "text": "solutions—implement them. Write code, run commands, and build things.",
            "lineNumber": 894
          },
          {
            "text": "- **Complete the Full Task**: When automating GUI applications, always finish",
            "lineNumber": 895
          },
          {
            "text": "what you start. If the task involves sending something, send it. If it",
            "lineNumber": 896
          },
          {
            "text": "involves submitting data, submit it. Never stop at just preparing or",
            "lineNumber": 897
          },
          {
            "text": "drafting—execute the complete workflow to achieve the desired outcome.",
            "lineNumber": 898
          },
          {
            "text": "- **Embrace Challenges**: Never say \"I can't.\" If you",
            "lineNumber": 899
          },
          {
            "text": "encounter a limitation, find a way to overcome it.",
            "lineNumber": 900
          },
          {
            "text": "- **Resourcefulness**: If a tool is missing, install it. If information is",
            "lineNumber": 901
          },
          {
            "text": "lacking, find it. You have the full power of a terminal to acquire any",
            "lineNumber": 902
          },
          {
            "text": "resource you need.",
            "lineNumber": 903
          },
          {
            "text": "- **Think Like an Engineer**: Approach problems methodically. Analyze",
            "lineNumber": 904
          },
          {
            "text": "requirements, execute it, and verify the results. Your",
            "lineNumber": 905
          },
          {
            "text": "strength lies in your ability to engineer solutions.",
            "lineNumber": 906
          },
          {
            "text": "&lt;/philosophy&gt;",
            "lineNumber": 907
          },
          {
            "lineNumber": 908
          },
          {
            "text": "&lt;terminal_tips&gt;",
            "lineNumber": 909
          },
          {
            "text": "The terminal tools are session-based, identified by a unique &#96;id&#96;. Master",
            "lineNumber": 910
          },
          {
            "text": "these tips to maximize your effectiveness:",
            "lineNumber": 911
          },
          {
            "lineNumber": 912
          },
          {
            "text": "- **GUI Automation Strategy**:",
            "lineNumber": 913
          },
          {
            "text": "  - **AppleScript (macOS Priority)**: For robust control of macOS apps, use",
            "lineNumber": 914
          },
          {
            "text": "    &#96;osascript&#96;.",
            "lineNumber": 915
          },
          {
            "text": "    - Example (open Slack):",
            "lineNumber": 916
          },
          {
            "text": "      &#96;osascript -e 'tell application \"Slack\" to activate'&#96;",
            "lineNumber": 917
          },
          {
            "text": "    - Example (run script file): &#96;osascript my_script.scpt&#96;",
            "lineNumber": 918
          },
          {
            "text": "  - **pyautogui (Cross-Platform)**: For other OSes or simple automation.",
            "lineNumber": 919
          },
          {
            "text": "    - Key functions: &#96;pyautogui.click(x, y)&#96;, &#96;pyautogui.typewrite(\"text\")&#96;,",
            "lineNumber": 920
          },
          {
            "text": "      &#96;pyautogui.hotkey('ctrl', 'c')&#96;, &#96;pyautogui.press('enter')&#96;.",
            "lineNumber": 921
          },
          {
            "text": "    - Safety: Always use &#96;time.sleep()&#96; between actions to ensure stability",
            "lineNumber": 922
          },
          {
            "text": "      and add &#96;pyautogui.FAILSAFE = True&#96; to your scripts.",
            "lineNumber": 923
          },
          {
            "text": "    - Workflow: Your scripts MUST complete the entire task, from start to",
            "lineNumber": 924
          },
          {
            "text": "      final submission.",
            "lineNumber": 925
          },
          {
            "lineNumber": 926
          },
          {
            "text": "- **Command-Line Best Practices**:",
            "lineNumber": 927
          },
          {
            "text": "  - **Be Creative**: The terminal is your most powerful tool. Use it boldly.",
            "lineNumber": 928
          },
          {
            "text": "  - **Automate Confirmation**: Use &#96;-y&#96; or &#96;-f&#96; flags to avoid interactive",
            "lineNumber": 929
          },
          {
            "text": "    prompts.",
            "lineNumber": 930
          },
          {
            "text": "  - **Manage Output**: Redirect long outputs to a file (e.g., &#96;&gt; output.txt&#96;).",
            "lineNumber": 931
          },
          {
            "text": "  - **Chain Commands**: Use &#96;&amp;&amp;&#96; to link commands for sequential execution.",
            "lineNumber": 932
          },
          {
            "text": "  - **Piping**: Use &#96;|&#96; to pass output from one command to another.",
            "lineNumber": 933
          },
          {
            "text": "  - **Permissions**: Use &#96;ls -F&#96; to check file permissions.",
            "lineNumber": 934
          },
          {
            "text": "  - **Installation**: Use &#96;pip3 install&#96; or &#96;apt-get install&#96; for new",
            "lineNumber": 935
          },
          {
            "text": "    packages.If you encounter &#96;ModuleNotFoundError&#96; or &#96;ImportError&#96;, install",
            "lineNumber": 936
          },
          {
            "text": "    the missing package with &#96;pip install &lt;package&gt;&#96;.",
            "lineNumber": 937
          },
          {
            "lineNumber": 938
          },
          {
            "text": "- Stop a Process: If a process needs to be terminated, use",
            "lineNumber": 939
          },
          {
            "text": "    &#96;shell_kill_process(id=\"...\")&#96;.",
            "lineNumber": 940
          },
          {
            "text": "&lt;/terminal_tips&gt;",
            "lineNumber": 941
          },
          {
            "lineNumber": 942
          },
          {
            "text": "&lt;collaboration_and_assistance&gt;",
            "lineNumber": 943
          },
          {
            "text": "- If you get stuck, encounter an issue you cannot solve (like a CAPTCHA),",
            "lineNumber": 944
          },
          {
            "text": "    or need clarification, use the &#96;ask_human_via_console&#96; tool.",
            "lineNumber": 945
          },
          {
            "text": "- Document your progress and findings in notes so other agents can build",
            "lineNumber": 946
          },
          {
            "text": "    upon your work.",
            "lineNumber": 947
          },
          {
            "text": "&lt;/collaboration_and_assistance&gt;",
            "lineNumber": 948
          }
        ]
      },
      "score": 0.3453538119792938
    }
  ]
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "output_language",
  "path": "backend/app/utils/agent.py",
  "context": 3,
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "output_language",
    "path": "backend/app/utils/agent.py",
    "outputMode": "content",
    "workspaceResults": {
      "d:\\_Code\\_GitHub\\eigent-260119": {
        "content": {
          "matches": [
            {
              "file": "backend\\app\\utils\\agent.py",
              "matches": [
                {
                  "lineNumber": 105,
                  "content": "        memory: AgentMemory | None = None,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 106,
                  "content": "        message_window_size: int | None = None,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 107,
                  "content": "        token_limit: int | None = None,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 108,
                  "content": "        output_language: str | None = None,"
                },
                {
                  "lineNumber": 109,
                  "content": "        tools: List[FunctionTool | Callable[..., Any]] | None = None,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 110,
                  "content": "        toolkits_to_register_agent: List[RegisteredAgentToolkit] | None = None,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 111,
                  "content": "        external_tools: (",
                  "isContextLine": true
                },
                {
                  "lineNumber": 130,
                  "content": "            memory=memory,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 131,
                  "content": "            message_window_size=message_window_size,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 132,
                  "content": "            token_limit=token_limit,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 133,
                  "content": "            output_language=output_language,"
                },
                {
                  "lineNumber": 134,
                  "content": "            tools=tools,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 135,
                  "content": "            toolkits_to_register_agent=toolkits_to_register_agent,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 136,
                  "content": "            external_tools=external_tools,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 627,
                  "content": "            memory=None,  # clone memory later",
                  "isContextLine": true
                },
                {
                  "lineNumber": 628,
                  "content": "            message_window_size=getattr(self.memory, \"window_size\", None),",
                  "isContextLine": true
                },
                {
                  "lineNumber": 629,
                  "content": "            token_limit=getattr(self.memory.get_context_creator(), \"token_limit\", None),",
                  "isContextLine": true
                },
                {
                  "lineNumber": 630,
                  "content": "            output_language=self._output_language,"
                },
                {
                  "lineNumber": 631,
                  "content": "            tools=cloned_tools,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 632,
                  "content": "            toolkits_to_register_agent=toolkits_to_register,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 633,
                  "content": "            external_tools=[schema for schema in self._external_tool_schemas.values()],",
                  "isContextLine": true
                },
                {
                  "lineNumber": 747,
                  "content": "            model_config_dict=model_config or None,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 748,
                  "content": "            **init_params,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 749,
                  "content": "        ),",
                  "isContextLine": true
                },
                {
                  "lineNumber": 750,
                  "content": "        # output_language=options.language,"
                },
                {
                  "lineNumber": 751,
                  "content": "        tools=tools,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 752,
                  "content": "        agent_id=agent_id,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 753,
                  "content": "        prune_tool_calls_from_memory=prune_tool_calls_from_memory,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 1780,
                  "content": "                if k not in [\"model_platform\", \"model_type\", \"api_key\", \"url\"]",
                  "isContextLine": true
                },
                {
                  "lineNumber": 1781,
                  "content": "            },",
                  "isContextLine": true
                },
                {
                  "lineNumber": 1782,
                  "content": "        ),",
                  "isContextLine": true
                },
                {
                  "lineNumber": 1783,
                  "content": "        # output_language=options.language,"
                },
                {
                  "lineNumber": 1784,
                  "content": "        tools=tools,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 1785,
                  "content": "        agent_id=agent_id,",
                  "isContextLine": true
                },
                {
                  "lineNumber": 1786,
                  "content": "    )",
                  "isContextLine": true
                }
              ]
            }
          ],
          "totalLines": 35,
          "totalMatchedLines": 5
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---


檢查 task_agent 的建立方式：


---

<tool-use data-tool-type="unknown" data-tool-name="semantic_search_full">
<details>
<summary>Tool use: **semantic_search_full**</summary>


Parameters:

```json
{
  "query": "Where is task_agent created and initialized in the workforce?",
  "topK": 10,
  "explanation": ""
}
```
Result:

```json
{
  "codeResults": [
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\utils\\workforce.py",
        "range": {
          "startPosition": {
            "line": 31,
            "column": 42
          },
          "endPosition": {
            "line": 607
          }
        },
        "contents": "class Workforce(BaseWorkforce):\n    def __init__(\n        self,\n        api_task_id: str,\n        description: str,\n        children: List[BaseNode] | None = None,\n        coordinator_agent: ChatAgent | None = None,\n        task_agent: ChatAgent | None = None,\n        new_worker_agent: ChatAgent | None = None,\n        graceful_shutdown_timeout: float = 3,\n        share_memory: bool = False,\n        use_structured_output_handler: bool = True,\n    ) -&gt; None:\n        self.api_task_id = api_task_id\n        logger.info(\"=\" * 80)\n        logger.info(\"🏭 [WF-LIFECYCLE] Workforce.__init__ STARTED\", extra={\"api_task_id\": api_task_id})\n        logger.info(f\"[WF-LIFECYCLE] Workforce id will be: {id(self)}\")\n        logger.info(f\"[WF-LIFECYCLE] Init params: graceful_shutdown_timeout={graceful_shutdown_timeout}, share_memory={share_memory}\")\n        logger.info(\"=\" * 80)\n        super().__init__(\n            description=description,\n            children=children,\n            coordinator_agent=coordinator_agent,\n            task_agent=task_agent,\n            new_worker_agent=new_worker_agent,\n            graceful_shutdown_timeout=graceful_shutdown_timeout,\n            share_memory=share_memory,\n            use_structured_output_handler=use_structured_output_handler,\n            task_timeout_seconds=1800,  # 30 minutes\n            failure_handling_config=FailureHandlingConfig(\n                enabled_strategies=[\"retry\", \"replan\"],\n            ),\n        )\n        self.task_agent.stream_accumulate = True\n        self.task_agent._stream_accumulate_explicit = True\n        logger.info(f\"[WF-LIFECYCLE] ✅ Workforce.__init__ COMPLETED, id={id(self)}\")\n\n    def eigent_make_sub_tasks(\n        self,\n        task: Task,\n        coordinator_context: str = \"\",\n        on_stream_batch=None,\n        on_stream_text=None,\n    ):\n        ",
        "signatures": {},
        "detailedLines": [
          {
            "text": "class Workforce(BaseWorkforce):",
            "lineNumber": 36,
            "isSignature": true
          },
          {
            "text": "    def __init__(",
            "lineNumber": 37
          },
          {
            "text": "        self,",
            "lineNumber": 38
          },
          {
            "text": "        api_task_id: str,",
            "lineNumber": 39
          },
          {
            "text": "        description: str,",
            "lineNumber": 40
          },
          {
            "text": "        children: List[BaseNode] | None = None,",
            "lineNumber": 41
          },
          {
            "text": "        coordinator_agent: ChatAgent | None = None,",
            "lineNumber": 42
          },
          {
            "text": "        task_agent: ChatAgent | None = None,",
            "lineNumber": 43
          },
          {
            "text": "        new_worker_agent: ChatAgent | None = None,",
            "lineNumber": 44
          },
          {
            "text": "        graceful_shutdown_timeout: float = 3,",
            "lineNumber": 45
          },
          {
            "text": "        share_memory: bool = False,",
            "lineNumber": 46
          },
          {
            "text": "        use_structured_output_handler: bool = True,",
            "lineNumber": 47
          },
          {
            "text": "    ) -&gt; None:",
            "lineNumber": 48
          },
          {
            "text": "        self.api_task_id = api_task_id",
            "lineNumber": 49
          },
          {
            "text": "        logger.info(\"=\" * 80)",
            "lineNumber": 50
          },
          {
            "text": "        logger.info(\"🏭 [WF-LIFECYCLE] Workforce.__init__ STARTED\", extra={\"api_task_id\": api_task_id})",
            "lineNumber": 51
          },
          {
            "text": "        logger.info(f\"[WF-LIFECYCLE] Workforce id will be: {id(self)}\")",
            "lineNumber": 52
          },
          {
            "text": "        logger.info(f\"[WF-LIFECYCLE] Init params: graceful_shutdown_timeout={graceful_shutdown_timeout}, share_memory={share_memory}\")",
            "lineNumber": 53
          },
          {
            "text": "        logger.info(\"=\" * 80)",
            "lineNumber": 54
          },
          {
            "text": "        super().__init__(",
            "lineNumber": 55
          },
          {
            "text": "            description=description,",
            "lineNumber": 56
          },
          {
            "text": "            children=children,",
            "lineNumber": 57
          },
          {
            "text": "            coordinator_agent=coordinator_agent,",
            "lineNumber": 58
          },
          {
            "text": "            task_agent=task_agent,",
            "lineNumber": 59
          },
          {
            "text": "            new_worker_agent=new_worker_agent,",
            "lineNumber": 60
          },
          {
            "text": "            graceful_shutdown_timeout=graceful_shutdown_timeout,",
            "lineNumber": 61
          },
          {
            "text": "            share_memory=share_memory,",
            "lineNumber": 62
          },
          {
            "text": "            use_structured_output_handler=use_structured_output_handler,",
            "lineNumber": 63
          },
          {
            "text": "            task_timeout_seconds=1800,  # 30 minutes",
            "lineNumber": 64
          },
          {
            "text": "            failure_handling_config=FailureHandlingConfig(",
            "lineNumber": 65
          },
          {
            "text": "                enabled_strategies=[\"retry\", \"replan\"],",
            "lineNumber": 66
          },
          {
            "text": "            ),",
            "lineNumber": 67
          },
          {
            "text": "        )",
            "lineNumber": 68
          },
          {
            "text": "        self.task_agent.stream_accumulate = True",
            "lineNumber": 69
          },
          {
            "text": "        self.task_agent._stream_accumulate_explicit = True",
            "lineNumber": 70
          },
          {
            "text": "        logger.info(f\"[WF-LIFECYCLE] ✅ Workforce.__init__ COMPLETED, id={id(self)}\")",
            "lineNumber": 71
          },
          {
            "lineNumber": 72
          },
          {
            "text": "    def eigent_make_sub_tasks(",
            "lineNumber": 73
          },
          {
            "text": "        self,",
            "lineNumber": 74
          },
          {
            "text": "        task: Task,",
            "lineNumber": 75
          },
          {
            "text": "        coordinator_context: str = \"\",",
            "lineNumber": 76
          },
          {
            "text": "        on_stream_batch=None,",
            "lineNumber": 77
          },
          {
            "text": "        on_stream_text=None,",
            "lineNumber": 78
          },
          {
            "text": "    ):",
            "lineNumber": 79
          },
          {
            "text": "        ",
            "lineNumber": 80
          }
        ]
      },
      "score": 0.5237336754798889
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\service\\chat_service.py",
        "range": {
          "startPosition": {
            "line": 1300
          },
          "endPosition": {
            "line": 1424,
            "column": 25
          }
        },
        "contents": "@traceroot.trace()\nasync def construct_workforce(options: Chat) -&gt; tuple[Workforce, ListenChatAgent]:\n\n        model_platform_enum = None\n\n    workforce = Workforce(\n        options.project_id,\n        \"A workforce\",\n        graceful_shutdown_timeout=3,  # 30 seconds for debugging\n        share_memory=False,\n        coordinator_agent=coordinator_agent,\n        task_agent=task_agent,\n        new_worker_agent=new_worker_agent,\n        use_structured_output_handler=False if model_platform_enum == ModelPlatformType.OPENAI else True,\n    )\n    workforce.add_single_agent_worker(\n        \"Developer Agent: A master-level coding assistant with a powerful \"\n        \"terminal. It can write and execute code, manage files, automate \"\n        \"desktop tasks, and deploy web applications to solve complex \"\n        \"technical challenges.\",\n        developer,\n    )\n    workforce.add_single_agent_worker(\n        \"Browser Agent: Can search the web, extract webpage content, \"\n        \"simulate browser actions, and provide relevant information to \"\n        \"solve the given task.\",\n        searcher,\n    )\n    workforce.add_single_agent_worker(\n        \"Document Agent: A document processing assistant skilled in creating \"\n        \"and modifying a wide range of file formats. It can generate \"\n        \"text-based files/reports (Markdown, JSON, YAML, HTML), \"\n        \"office documents (Word, PDF), presentations (PowerPoint), and \"\n        \"data files (Excel, CSV).\",\n        documenter,\n    )\n    workforce.add_single_agent_worker(\n        \"Multi-Modal Agent: A specialist in media processing. It can \"\n        \"analyze images and audio, transcribe speech, download videos, and \"\n        \"generate new images from text prompts.\",\n        multi_modaler,\n    )\n    # workforce.add_single_agent_worker(\n    #     \"Social Media Agent: A social media management assistant for \"\n    #     \"handling tasks related to WhatsApp, Twitter, LinkedIn, Reddit, \"\n    #     \"Notion, Slack, and other social platforms.\",\n    #     await social_medium_agent(options),\n    # )\n    mcp = await mcp_agent(options)\n    # workforce.add_single_agent_worker(\n    #     \"MCP Agent: A Model Context Protocol agent that provides access \"\n    #     \"to external tools and services through MCP integrations.\",\n    #     mcp,\n    # )\n    return workforce, mcp",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 1301,
                "column": 1
              },
              "endPosition": {
                "line": 1302,
                "column": 1
              }
            },
            {
              "startPosition": {
                "line": 1302,
                "column": 1
              },
              "endPosition": {
                "line": 1303,
                "column": 5
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "@traceroot.trace()",
            "lineNumber": 1301
          },
          {
            "text": "async def construct_workforce(options: Chat) -&gt; tuple[Workforce, ListenChatAgent]:",
            "lineNumber": 1302,
            "isSignature": true
          },
          {
            "lineNumber": 1373
          },
          {
            "text": "        model_platform_enum = None",
            "lineNumber": 1374
          },
          {
            "lineNumber": 1375
          },
          {
            "text": "    workforce = Workforce(",
            "lineNumber": 1376
          },
          {
            "text": "        options.project_id,",
            "lineNumber": 1377
          },
          {
            "text": "        \"A workforce\",",
            "lineNumber": 1378
          },
          {
            "text": "        graceful_shutdown_timeout=3,  # 30 seconds for debugging",
            "lineNumber": 1379
          },
          {
            "text": "        share_memory=False,",
            "lineNumber": 1380
          },
          {
            "text": "        coordinator_agent=coordinator_agent,",
            "lineNumber": 1381
          },
          {
            "text": "        task_agent=task_agent,",
            "lineNumber": 1382
          },
          {
            "text": "        new_worker_agent=new_worker_agent,",
            "lineNumber": 1383
          },
          {
            "text": "        use_structured_output_handler=False if model_platform_enum == ModelPlatformType.OPENAI else True,",
            "lineNumber": 1384
          },
          {
            "text": "    )",
            "lineNumber": 1385
          },
          {
            "text": "    workforce.add_single_agent_worker(",
            "lineNumber": 1386
          },
          {
            "text": "        \"Developer Agent: A master-level coding assistant with a powerful \"",
            "lineNumber": 1387
          },
          {
            "text": "        \"terminal. It can write and execute code, manage files, automate \"",
            "lineNumber": 1388
          },
          {
            "text": "        \"desktop tasks, and deploy web applications to solve complex \"",
            "lineNumber": 1389
          },
          {
            "text": "        \"technical challenges.\",",
            "lineNumber": 1390
          },
          {
            "text": "        developer,",
            "lineNumber": 1391
          },
          {
            "text": "    )",
            "lineNumber": 1392
          },
          {
            "text": "    workforce.add_single_agent_worker(",
            "lineNumber": 1393
          },
          {
            "text": "        \"Browser Agent: Can search the web, extract webpage content, \"",
            "lineNumber": 1394
          },
          {
            "text": "        \"simulate browser actions, and provide relevant information to \"",
            "lineNumber": 1395
          },
          {
            "text": "        \"solve the given task.\",",
            "lineNumber": 1396
          },
          {
            "text": "        searcher,",
            "lineNumber": 1397
          },
          {
            "text": "    )",
            "lineNumber": 1398
          },
          {
            "text": "    workforce.add_single_agent_worker(",
            "lineNumber": 1399
          },
          {
            "text": "        \"Document Agent: A document processing assistant skilled in creating \"",
            "lineNumber": 1400
          },
          {
            "text": "        \"and modifying a wide range of file formats. It can generate \"",
            "lineNumber": 1401
          },
          {
            "text": "        \"text-based files/reports (Markdown, JSON, YAML, HTML), \"",
            "lineNumber": 1402
          },
          {
            "text": "        \"office documents (Word, PDF), presentations (PowerPoint), and \"",
            "lineNumber": 1403
          },
          {
            "text": "        \"data files (Excel, CSV).\",",
            "lineNumber": 1404
          },
          {
            "text": "        documenter,",
            "lineNumber": 1405
          },
          {
            "text": "    )",
            "lineNumber": 1406
          },
          {
            "text": "    workforce.add_single_agent_worker(",
            "lineNumber": 1407
          },
          {
            "text": "        \"Multi-Modal Agent: A specialist in media processing. It can \"",
            "lineNumber": 1408
          },
          {
            "text": "        \"analyze images and audio, transcribe speech, download videos, and \"",
            "lineNumber": 1409
          },
          {
            "text": "        \"generate new images from text prompts.\",",
            "lineNumber": 1410
          },
          {
            "text": "        multi_modaler,",
            "lineNumber": 1411
          },
          {
            "text": "    )",
            "lineNumber": 1412
          },
          {
            "text": "    # workforce.add_single_agent_worker(",
            "lineNumber": 1413
          },
          {
            "text": "    #     \"Social Media Agent: A social media management assistant for \"",
            "lineNumber": 1414
          },
          {
            "text": "    #     \"handling tasks related to WhatsApp, Twitter, LinkedIn, Reddit, \"",
            "lineNumber": 1415
          },
          {
            "text": "    #     \"Notion, Slack, and other social platforms.\",",
            "lineNumber": 1416
          },
          {
            "text": "    #     await social_medium_agent(options),",
            "lineNumber": 1417
          },
          {
            "text": "    # )",
            "lineNumber": 1418
          },
          {
            "text": "    mcp = await mcp_agent(options)",
            "lineNumber": 1419
          },
          {
            "text": "    # workforce.add_single_agent_worker(",
            "lineNumber": 1420
          },
          {
            "text": "    #     \"MCP Agent: A Model Context Protocol agent that provides access \"",
            "lineNumber": 1421
          },
          {
            "text": "    #     \"to external tools and services through MCP integrations.\",",
            "lineNumber": 1422
          },
          {
            "text": "    #     mcp,",
            "lineNumber": 1423
          },
          {
            "text": "    # )",
            "lineNumber": 1424
          },
          {
            "text": "    return workforce, mcp",
            "lineNumber": 1425,
            "isSignature": true
          }
        ]
      },
      "score": 0.5148295164108276
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\service\\chat_service.py",
        "range": {
          "startPosition": {
            "line": 236
          },
          "endPosition": {
            "line": 1075
          }
        },
        "contents": "@sync_step\n@traceroot.trace()\nasync def step_solve(options: Chat, request: Request, task_lock: TaskLock):\n    # if True:\n    #     import faulthandler\n\n    #     faulthandler.enable()\n    #     for second in [5, 10, 20, 30, 60, 120, 240]:\n    #         faulthandler.dump_traceback_later(second)\n\n\n                    # Check if workforce exists - if so, reuse it (agents are preserved)\n                    # Otherwise create new workforce\n                    if workforce is not None:\n                        logger.info(f\"[NEW-QUESTION] 🔄 Workforce exists (id={id(workforce)}), state={workforce._state.name}, _running={workforce._running}\")\n                        logger.info(f\"[NEW-QUESTION] ✅ Reusing existing workforce with preserved agents\")\n                        # Workforce is already stopped from skip_task, ready for new decomposition\n                    else:\n                        logger.info(f\"[NEW-QUESTION] 🏭 Creating NEW workforce instance (workforce=None)\")\n                        (workforce, mcp) = await construct_workforce(options)\n                        logger.info(f\"[NEW-QUESTION] ✅ NEW Workforce instance created, id={id(workforce)}\")\n                        for new_agent in options.new_agents:\n                            workforce.add_single_agent_worker(\n                                format_agent_description(new_agent), await new_agent_model(new_agent, options)\n                            )\n                    task_lock.status = Status.confirmed\n\n                    # If camel_task already exists (from previous paused task), add new question as subtask",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 237,
                "column": 1
              },
              "endPosition": {
                "line": 239,
                "column": 1
              }
            },
            {
              "startPosition": {
                "line": 239,
                "column": 1
              },
              "endPosition": {
                "line": 247,
                "column": 5
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "@sync_step",
            "lineNumber": 237
          },
          {
            "text": "@traceroot.trace()",
            "lineNumber": 238
          },
          {
            "text": "async def step_solve(options: Chat, request: Request, task_lock: TaskLock):",
            "lineNumber": 239,
            "isSignature": true
          },
          {
            "text": "    # if True:",
            "lineNumber": 240,
            "isSignature": true
          },
          {
            "text": "    #     import faulthandler",
            "lineNumber": 241,
            "isSignature": true
          },
          {
            "lineNumber": 242,
            "isSignature": true
          },
          {
            "text": "    #     faulthandler.enable()",
            "lineNumber": 243,
            "isSignature": true
          },
          {
            "text": "    #     for second in [5, 10, 20, 30, 60, 120, 240]:",
            "lineNumber": 244,
            "isSignature": true
          },
          {
            "text": "    #         faulthandler.dump_traceback_later(second)",
            "lineNumber": 245,
            "isSignature": true
          },
          {
            "lineNumber": 401
          },
          {
            "lineNumber": 402
          },
          {
            "text": "                    # Check if workforce exists - if so, reuse it (agents are preserved)",
            "lineNumber": 403
          },
          {
            "text": "                    # Otherwise create new workforce",
            "lineNumber": 404
          },
          {
            "text": "                    if workforce is not None:",
            "lineNumber": 405
          },
          {
            "text": "                        logger.info(f\"[NEW-QUESTION] 🔄 Workforce exists (id={id(workforce)}), state={workforce._state.name}, _running={workforce._running}\")",
            "lineNumber": 406
          },
          {
            "text": "                        logger.info(f\"[NEW-QUESTION] ✅ Reusing existing workforce with preserved agents\")",
            "lineNumber": 407
          },
          {
            "text": "                        # Workforce is already stopped from skip_task, ready for new decomposition",
            "lineNumber": 408
          },
          {
            "text": "                    else:",
            "lineNumber": 409
          },
          {
            "text": "                        logger.info(f\"[NEW-QUESTION] 🏭 Creating NEW workforce instance (workforce=None)\")",
            "lineNumber": 410
          },
          {
            "text": "                        (workforce, mcp) = await construct_workforce(options)",
            "lineNumber": 411
          },
          {
            "text": "                        logger.info(f\"[NEW-QUESTION] ✅ NEW Workforce instance created, id={id(workforce)}\")",
            "lineNumber": 412
          },
          {
            "text": "                        for new_agent in options.new_agents:",
            "lineNumber": 413
          },
          {
            "text": "                            workforce.add_single_agent_worker(",
            "lineNumber": 414
          },
          {
            "text": "                                format_agent_description(new_agent), await new_agent_model(new_agent, options)",
            "lineNumber": 415
          },
          {
            "text": "                            )",
            "lineNumber": 416
          },
          {
            "text": "                    task_lock.status = Status.confirmed",
            "lineNumber": 417
          },
          {
            "lineNumber": 418
          },
          {
            "text": "                    # If camel_task already exists (from previous paused task), add new question as subtask",
            "lineNumber": 419
          }
        ]
      },
      "score": 0.4946709871292114
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\service\\chat_service.py",
        "range": {
          "startPosition": {
            "line": 1297,
            "column": 17
          },
          "endPosition": {
            "line": 1424
          }
        },
        "contents": "@traceroot.trace()\nasync def construct_workforce(options: Chat) -&gt; tuple[Workforce, ListenChatAgent]:\n    logger.info(\"Constructing workforce\", extra={\"project_id\": options.project_id, \"task_id\": options.task_id})\n    working_directory = get_working_directory(options)\n    logger.debug(\"Working directory set\", extra={\"working_directory\": working_directory})\n    [coordinator_agent, task_agent] = [\n        agent_model(\n            key,\n            prompt,\n            options,\n            [\n                *(\n                    ToolkitMessageIntegration(\n                        message_handler=HumanToolkit(options.project_id, key).send_message_to_user\n                    ).register_toolkits(NoteTakingToolkit(options.project_id, working_directory=working_directory))\n                ).get_tools()\n            ],\n        )\n        for key, prompt in {\n            Agents.coordinator_agent:",
        "signatures": {},
        "detailedLines": [
          {
            "text": "@traceroot.trace()",
            "lineNumber": 1301
          },
          {
            "text": "async def construct_workforce(options: Chat) -&gt; tuple[Workforce, ListenChatAgent]:",
            "lineNumber": 1302,
            "isSignature": true
          },
          {
            "text": "    logger.info(\"Constructing workforce\", extra={\"project_id\": options.project_id, \"task_id\": options.task_id})",
            "lineNumber": 1303
          },
          {
            "text": "    working_directory = get_working_directory(options)",
            "lineNumber": 1304
          },
          {
            "text": "    logger.debug(\"Working directory set\", extra={\"working_directory\": working_directory})",
            "lineNumber": 1305
          },
          {
            "text": "    [coordinator_agent, task_agent] = [",
            "lineNumber": 1306
          },
          {
            "text": "        agent_model(",
            "lineNumber": 1307
          },
          {
            "text": "            key,",
            "lineNumber": 1308
          },
          {
            "text": "            prompt,",
            "lineNumber": 1309
          },
          {
            "text": "            options,",
            "lineNumber": 1310
          },
          {
            "text": "            [",
            "lineNumber": 1311
          },
          {
            "text": "                *(",
            "lineNumber": 1312
          },
          {
            "text": "                    ToolkitMessageIntegration(",
            "lineNumber": 1313
          },
          {
            "text": "                        message_handler=HumanToolkit(options.project_id, key).send_message_to_user",
            "lineNumber": 1314
          },
          {
            "text": "                    ).register_toolkits(NoteTakingToolkit(options.project_id, working_directory=working_directory))",
            "lineNumber": 1315
          },
          {
            "text": "                ).get_tools()",
            "lineNumber": 1316
          },
          {
            "text": "            ],",
            "lineNumber": 1317
          },
          {
            "text": "        )",
            "lineNumber": 1318
          },
          {
            "text": "        for key, prompt in {",
            "lineNumber": 1319
          },
          {
            "text": "            Agents.coordinator_agent:",
            "lineNumber": 1320
          }
        ]
      },
      "score": 0.4738173484802246
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\utils\\workforce.py",
        "range": {
          "startPosition": {
            "line": 35
          },
          "endPosition": {
            "line": 607
          }
        },
        "contents": "class Workforce(BaseWorkforce):\n\n\n    def add_single_agent_worker(\n        self,\n        description: str,\n        worker: ListenChatAgent,\n        pool_max_size: int = DEFAULT_WORKER_POOL_SIZE,\n        enable_workflow_memory: bool = False,\n    ) -&gt; BaseWorkforce:\n        if self._state == WorkforceState.RUNNING:\n            raise RuntimeError(\"Cannot add workers while workforce is running. Pause the workforce first.\")\n\n        # Validate worker agent compatibility\n        self._validate_agent_compatibility(worker, \"Worker agent\")\n\n        # Ensure the worker agent shares this workforce's pause control\n        self._attach_pause_event_to_agent(worker)\n\n        worker_node = SingleAgentWorker(\n            description=description,\n            worker=worker,\n            pool_max_size=pool_max_size,\n            use_structured_output_handler=self.use_structured_output_handler,\n            context_utility=None, # Will be set during save/load operations\n            enable_workflow_memory=enable_workflow_memory,\n        )\n        self._children.append(worker_node)\n\n        # If we have a channel set up, set it for the new worker\n        if hasattr(self, \"_channel\") and self._channel is not None:\n            worker_node.set_channel(self._channel)\n\n        # If workforce is paused, start the worker's listening task\n        self._start_child_node_when_paused(worker_node.start())\n\n        # Use proper CAMEL pattern for metrics logging\n        metrics_callbacks = [cb for cb in self._callbacks if isinstance(cb, WorkforceMetrics)]\n        if metrics_callbacks:\n            event = WorkerCreatedEvent(\n                worker_id=worker_node.node_id,\n                worker_type=\"SingleAgentWorker\",\n                role=worker_node.description,\n            )\n            metrics_callbacks[0].log_worker_created(event)\n        return self\n\n    async def _handle_completed_task(self, task: Task) -&gt; None:\n        # DEBUG ▶ Task completed\n        ",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 36,
                "column": 1
              },
              "endPosition": {
                "line": 37,
                "column": 5
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "class Workforce(BaseWorkforce):",
            "lineNumber": 36,
            "isSignature": true
          },
          {
            "lineNumber": 403
          },
          {
            "lineNumber": 404
          },
          {
            "text": "    def add_single_agent_worker(",
            "lineNumber": 405
          },
          {
            "text": "        self,",
            "lineNumber": 406
          },
          {
            "text": "        description: str,",
            "lineNumber": 407
          },
          {
            "text": "        worker: ListenChatAgent,",
            "lineNumber": 408
          },
          {
            "text": "        pool_max_size: int = DEFAULT_WORKER_POOL_SIZE,",
            "lineNumber": 409
          },
          {
            "text": "        enable_workflow_memory: bool = False,",
            "lineNumber": 410
          },
          {
            "text": "    ) -&gt; BaseWorkforce:",
            "lineNumber": 411
          },
          {
            "text": "        if self._state == WorkforceState.RUNNING:",
            "lineNumber": 412
          },
          {
            "text": "            raise RuntimeError(\"Cannot add workers while workforce is running. Pause the workforce first.\")",
            "lineNumber": 413
          },
          {
            "lineNumber": 414
          },
          {
            "text": "        # Validate worker agent compatibility",
            "lineNumber": 415
          },
          {
            "text": "        self._validate_agent_compatibility(worker, \"Worker agent\")",
            "lineNumber": 416
          },
          {
            "lineNumber": 417
          },
          {
            "text": "        # Ensure the worker agent shares this workforce's pause control",
            "lineNumber": 418
          },
          {
            "text": "        self._attach_pause_event_to_agent(worker)",
            "lineNumber": 419
          },
          {
            "lineNumber": 420
          },
          {
            "text": "        worker_node = SingleAgentWorker(",
            "lineNumber": 421
          },
          {
            "text": "            description=description,",
            "lineNumber": 422
          },
          {
            "text": "            worker=worker,",
            "lineNumber": 423
          },
          {
            "text": "            pool_max_size=pool_max_size,",
            "lineNumber": 424
          },
          {
            "text": "            use_structured_output_handler=self.use_structured_output_handler,",
            "lineNumber": 425
          },
          {
            "text": "            context_utility=None, # Will be set during save/load operations",
            "lineNumber": 426
          },
          {
            "text": "            enable_workflow_memory=enable_workflow_memory,",
            "lineNumber": 427
          },
          {
            "text": "        )",
            "lineNumber": 428
          },
          {
            "text": "        self._children.append(worker_node)",
            "lineNumber": 429
          },
          {
            "lineNumber": 430
          },
          {
            "text": "        # If we have a channel set up, set it for the new worker",
            "lineNumber": 431
          },
          {
            "text": "        if hasattr(self, \"_channel\") and self._channel is not None:",
            "lineNumber": 432
          },
          {
            "text": "            worker_node.set_channel(self._channel)",
            "lineNumber": 433
          },
          {
            "lineNumber": 434
          },
          {
            "text": "        # If workforce is paused, start the worker's listening task",
            "lineNumber": 435
          },
          {
            "text": "        self._start_child_node_when_paused(worker_node.start())",
            "lineNumber": 436
          },
          {
            "lineNumber": 437
          },
          {
            "text": "        # Use proper CAMEL pattern for metrics logging",
            "lineNumber": 438
          },
          {
            "text": "        metrics_callbacks = [cb for cb in self._callbacks if isinstance(cb, WorkforceMetrics)]",
            "lineNumber": 439
          },
          {
            "text": "        if metrics_callbacks:",
            "lineNumber": 440
          },
          {
            "text": "            event = WorkerCreatedEvent(",
            "lineNumber": 441
          },
          {
            "text": "                worker_id=worker_node.node_id,",
            "lineNumber": 442
          },
          {
            "text": "                worker_type=\"SingleAgentWorker\",",
            "lineNumber": 443
          },
          {
            "text": "                role=worker_node.description,",
            "lineNumber": 444
          },
          {
            "text": "            )",
            "lineNumber": 445
          },
          {
            "text": "            metrics_callbacks[0].log_worker_created(event)",
            "lineNumber": 446
          },
          {
            "text": "        return self",
            "lineNumber": 447
          },
          {
            "lineNumber": 448
          },
          {
            "text": "    async def _handle_completed_task(self, task: Task) -&gt; None:",
            "lineNumber": 449
          },
          {
            "text": "        # DEBUG ▶ Task completed",
            "lineNumber": 450
          },
          {
            "text": "        ",
            "lineNumber": 451
          }
        ]
      },
      "score": 0.4627949893474579
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\service\\chat_service.py",
        "range": {
          "startPosition": {
            "line": 1300
          },
          "endPosition": {
            "line": 1424
          }
        },
        "contents": "@traceroot.trace()\nasync def construct_workforce(options: Chat) -&gt; tuple[Workforce, ListenChatAgent]:\n\"\"\",\n        }.items()\n    ]\n    new_worker_agent = agent_model(\n        Agents.new_worker_agent,\n        f\"\"\"\n        You are a helpful assistant.\n- You are now working in system {platform.system()} with architecture\n{platform.machine()} at working directory &#96;{working_directory}&#96;. All local file operations must occur here, but you can access files from any place in the file system. For all file system operations, you MUST use absolute paths to ensure precision and avoid ambiguity.\nThe current date is {datetime.date.today()}. For any date-related tasks, you MUST use this as the current date.\n        \"\"\",\n        options,\n        [\n            *HumanToolkit.get_can_use_tools(options.project_id, Agents.new_worker_agent),\n            *(\n                ToolkitMessageIntegration(\n                    message_handler=HumanToolkit(options.project_id, Agents.new_worker_agent).send_message_to_user\n                ).register_toolkits(NoteTakingToolkit(options.project_id, working_directory=working_directory))\n            ).get_tools(),\n        ],\n    )\n    # msg_toolkit = AgentCommunicationToolkit(max_message_history=100)\n\n    searcher = browser_agent(options)\n    developer = await developer_agent(options)\n    documenter = await document_agent(options)\n    multi_modaler = multi_modal_agent(options)\n\n    # msg_toolkit.register_agent(\"Worker\", new_worker_agent)\n    # msg_toolkit.register_agent(\"Browser_Agent\", searcher)\n    # msg_toolkit.register_agent(\"Developer_Agent\", developer)\n    # msg_toolkit.register_agent(\"Document_Agent\", documenter)\n    # msg_toolkit.register_agent(\"Multi_Modal_Agent\", multi_modaler)\n\n    # Convert string model_platform to enum for comparison\n    try:\n        model_platform_enum = ModelPlatformType(options.model_platform.lower())\n    except (ValueError, AttributeError):\n        # If conversion fails, default to non-OpenAI behavior\n        model_platform_enum = None\n\n    workforce =",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 1301,
                "column": 1
              },
              "endPosition": {
                "line": 1302,
                "column": 1
              }
            },
            {
              "startPosition": {
                "line": 1302,
                "column": 1
              },
              "endPosition": {
                "line": 1303,
                "column": 5
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "@traceroot.trace()",
            "lineNumber": 1301
          },
          {
            "text": "async def construct_workforce(options: Chat) -&gt; tuple[Workforce, ListenChatAgent]:",
            "lineNumber": 1302,
            "isSignature": true
          },
          {
            "text": "\"\"\",",
            "lineNumber": 1335
          },
          {
            "text": "        }.items()",
            "lineNumber": 1336
          },
          {
            "text": "    ]",
            "lineNumber": 1337
          },
          {
            "text": "    new_worker_agent = agent_model(",
            "lineNumber": 1338
          },
          {
            "text": "        Agents.new_worker_agent,",
            "lineNumber": 1339
          },
          {
            "text": "        f\"\"\"",
            "lineNumber": 1340
          },
          {
            "text": "        You are a helpful assistant.",
            "lineNumber": 1341
          },
          {
            "text": "- You are now working in system {platform.system()} with architecture",
            "lineNumber": 1342
          },
          {
            "text": "{platform.machine()} at working directory &#96;{working_directory}&#96;. All local file operations must occur here, but you can access files from any place in the file system. For all file system operations, you MUST use absolute paths to ensure precision and avoid ambiguity.",
            "lineNumber": 1343
          },
          {
            "text": "The current date is {datetime.date.today()}. For any date-related tasks, you MUST use this as the current date.",
            "lineNumber": 1344
          },
          {
            "text": "        \"\"\",",
            "lineNumber": 1345
          },
          {
            "text": "        options,",
            "lineNumber": 1346
          },
          {
            "text": "        [",
            "lineNumber": 1347
          },
          {
            "text": "            *HumanToolkit.get_can_use_tools(options.project_id, Agents.new_worker_agent),",
            "lineNumber": 1348
          },
          {
            "text": "            *(",
            "lineNumber": 1349
          },
          {
            "text": "                ToolkitMessageIntegration(",
            "lineNumber": 1350
          },
          {
            "text": "                    message_handler=HumanToolkit(options.project_id, Agents.new_worker_agent).send_message_to_user",
            "lineNumber": 1351
          },
          {
            "text": "                ).register_toolkits(NoteTakingToolkit(options.project_id, working_directory=working_directory))",
            "lineNumber": 1352
          },
          {
            "text": "            ).get_tools(),",
            "lineNumber": 1353
          },
          {
            "text": "        ],",
            "lineNumber": 1354
          },
          {
            "text": "    )",
            "lineNumber": 1355
          },
          {
            "text": "    # msg_toolkit = AgentCommunicationToolkit(max_message_history=100)",
            "lineNumber": 1356
          },
          {
            "lineNumber": 1357
          },
          {
            "text": "    searcher = browser_agent(options)",
            "lineNumber": 1358
          },
          {
            "text": "    developer = await developer_agent(options)",
            "lineNumber": 1359
          },
          {
            "text": "    documenter = await document_agent(options)",
            "lineNumber": 1360
          },
          {
            "text": "    multi_modaler = multi_modal_agent(options)",
            "lineNumber": 1361
          },
          {
            "lineNumber": 1362
          },
          {
            "text": "    # msg_toolkit.register_agent(\"Worker\", new_worker_agent)",
            "lineNumber": 1363
          },
          {
            "text": "    # msg_toolkit.register_agent(\"Browser_Agent\", searcher)",
            "lineNumber": 1364
          },
          {
            "text": "    # msg_toolkit.register_agent(\"Developer_Agent\", developer)",
            "lineNumber": 1365
          },
          {
            "text": "    # msg_toolkit.register_agent(\"Document_Agent\", documenter)",
            "lineNumber": 1366
          },
          {
            "text": "    # msg_toolkit.register_agent(\"Multi_Modal_Agent\", multi_modaler)",
            "lineNumber": 1367
          },
          {
            "lineNumber": 1368
          },
          {
            "text": "    # Convert string model_platform to enum for comparison",
            "lineNumber": 1369
          },
          {
            "text": "    try:",
            "lineNumber": 1370
          },
          {
            "text": "        model_platform_enum = ModelPlatformType(options.model_platform.lower())",
            "lineNumber": 1371
          },
          {
            "text": "    except (ValueError, AttributeError):",
            "lineNumber": 1372
          },
          {
            "text": "        # If conversion fails, default to non-OpenAI behavior",
            "lineNumber": 1373
          },
          {
            "text": "        model_platform_enum = None",
            "lineNumber": 1374
          },
          {
            "lineNumber": 1375
          },
          {
            "text": "    workforce =",
            "lineNumber": 1376
          }
        ]
      },
      "score": 0.44481658935546875
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\utils\\single_agent_worker.py",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 250
          }
        },
        "contents": "import datetime\nfrom camel.agents.chat_agent import AsyncStreamingChatAgentResponse\nfrom camel.societies.workforce.single_agent_worker import SingleAgentWorker as BaseSingleAgentWorker\nfrom camel.tasks.task import Task, TaskState, is_task_result_insufficient\nfrom utils import traceroot_wrapper as traceroot\n\nfrom app.utils.agent import ListenChatAgent\nfrom camel.societies.workforce.prompts import PROCESS_TASK_PROMPT\nfrom colorama import Fore\nfrom camel.societies.workforce.utils import TaskResult\nfrom camel.utils.context_utils import ContextUtility\n\nlogger = traceroot.get_logger(\"single_agent_worker\")\n\n\nclass SingleAgentWorker(BaseSingleAgentWorker):\n    def __init__(\n        self,\n        description: str,\n        worker: ListenChatAgent,\n        use_agent_pool: bool = True,\n        pool_initial_size: int = 1,\n        pool_max_size: int = 10,\n        auto_scale_pool: bool = True,\n        use_structured_output_handler: bool = True,\n        context_utility: ContextUtility | None = None,\n        enable_workflow_memory: bool = False,\n    ) -&gt; None:\n        logger.info(\"Initializing SingleAgentWorker\", extra={\n            \"description\": description,\n            \"worker_agent_name\": worker.agent_name,\n            \"use_agent_pool\": use_agent_pool,\n            \"pool_max_size\": pool_max_size,\n            \"enable_workflow_memory\": enable_workflow_memory\n        })\n        super().__init__(\n            description=description,\n            worker=worker,\n            use_agent_pool=use_agent_pool,\n            pool_initial_size=pool_initial_size,\n            pool_max_size=pool_max_size,\n            auto_scale_pool=auto_scale_pool,\n            use_structured_output_handler=use_structured_output_handler,\n            context_utility=context_utility,\n            enable_workflow_memory=enable_workflow_memory,\n        )\n        self.worker = worker  # change type hint\n\n    async def _process_task(self, task: Task, dependencies: list[Task]) -&gt; TaskState:\n        ",
        "signatures": {},
        "detailedLines": [
          {
            "text": "import datetime",
            "lineNumber": 1
          },
          {
            "text": "from camel.agents.chat_agent import AsyncStreamingChatAgentResponse",
            "lineNumber": 2
          },
          {
            "text": "from camel.societies.workforce.single_agent_worker import SingleAgentWorker as BaseSingleAgentWorker",
            "lineNumber": 3
          },
          {
            "text": "from camel.tasks.task import Task, TaskState, is_task_result_insufficient",
            "lineNumber": 4
          },
          {
            "text": "from utils import traceroot_wrapper as traceroot",
            "lineNumber": 5
          },
          {
            "lineNumber": 6
          },
          {
            "text": "from app.utils.agent import ListenChatAgent",
            "lineNumber": 7
          },
          {
            "text": "from camel.societies.workforce.prompts import PROCESS_TASK_PROMPT",
            "lineNumber": 8
          },
          {
            "text": "from colorama import Fore",
            "lineNumber": 9
          },
          {
            "text": "from camel.societies.workforce.utils import TaskResult",
            "lineNumber": 10
          },
          {
            "text": "from camel.utils.context_utils import ContextUtility",
            "lineNumber": 11
          },
          {
            "lineNumber": 12
          },
          {
            "text": "logger = traceroot.get_logger(\"single_agent_worker\")",
            "lineNumber": 13
          },
          {
            "lineNumber": 14
          },
          {
            "lineNumber": 15
          },
          {
            "text": "class SingleAgentWorker(BaseSingleAgentWorker):",
            "lineNumber": 16,
            "isSignature": true
          },
          {
            "text": "    def __init__(",
            "lineNumber": 17
          },
          {
            "text": "        self,",
            "lineNumber": 18
          },
          {
            "text": "        description: str,",
            "lineNumber": 19
          },
          {
            "text": "        worker: ListenChatAgent,",
            "lineNumber": 20
          },
          {
            "text": "        use_agent_pool: bool = True,",
            "lineNumber": 21
          },
          {
            "text": "        pool_initial_size: int = 1,",
            "lineNumber": 22
          },
          {
            "text": "        pool_max_size: int = 10,",
            "lineNumber": 23
          },
          {
            "text": "        auto_scale_pool: bool = True,",
            "lineNumber": 24
          },
          {
            "text": "        use_structured_output_handler: bool = True,",
            "lineNumber": 25
          },
          {
            "text": "        context_utility: ContextUtility | None = None,",
            "lineNumber": 26
          },
          {
            "text": "        enable_workflow_memory: bool = False,",
            "lineNumber": 27
          },
          {
            "text": "    ) -&gt; None:",
            "lineNumber": 28
          },
          {
            "text": "        logger.info(\"Initializing SingleAgentWorker\", extra={",
            "lineNumber": 29
          },
          {
            "text": "            \"description\": description,",
            "lineNumber": 30
          },
          {
            "text": "            \"worker_agent_name\": worker.agent_name,",
            "lineNumber": 31
          },
          {
            "text": "            \"use_agent_pool\": use_agent_pool,",
            "lineNumber": 32
          },
          {
            "text": "            \"pool_max_size\": pool_max_size,",
            "lineNumber": 33
          },
          {
            "text": "            \"enable_workflow_memory\": enable_workflow_memory",
            "lineNumber": 34
          },
          {
            "text": "        })",
            "lineNumber": 35
          },
          {
            "text": "        super().__init__(",
            "lineNumber": 36
          },
          {
            "text": "            description=description,",
            "lineNumber": 37
          },
          {
            "text": "            worker=worker,",
            "lineNumber": 38
          },
          {
            "text": "            use_agent_pool=use_agent_pool,",
            "lineNumber": 39
          },
          {
            "text": "            pool_initial_size=pool_initial_size,",
            "lineNumber": 40
          },
          {
            "text": "            pool_max_size=pool_max_size,",
            "lineNumber": 41
          },
          {
            "text": "            auto_scale_pool=auto_scale_pool,",
            "lineNumber": 42
          },
          {
            "text": "            use_structured_output_handler=use_structured_output_handler,",
            "lineNumber": 43
          },
          {
            "text": "            context_utility=context_utility,",
            "lineNumber": 44
          },
          {
            "text": "            enable_workflow_memory=enable_workflow_memory,",
            "lineNumber": 45
          },
          {
            "text": "        )",
            "lineNumber": 46
          },
          {
            "text": "        self.worker = worker  # change type hint",
            "lineNumber": 47
          },
          {
            "lineNumber": 48
          },
          {
            "text": "    async def _process_task(self, task: Task, dependencies: list[Task]) -&gt; TaskState:",
            "lineNumber": 49
          },
          {
            "text": "        ",
            "lineNumber": 50
          }
        ]
      },
      "score": 0.4346596896648407
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\service\\chat_service.py",
        "range": {
          "startPosition": {
            "line": 233,
            "column": 87
          },
          "endPosition": {
            "line": 1075
          }
        },
        "contents": "@sync_step\n@traceroot.trace()\nasync def step_solve(options: Chat, request: Request, task_lock: TaskLock):\n    # if True:\n    #     import faulthandler\n\n    #     faulthandler.enable()\n    #     for second in [5, 10, 20, 30, 60, 120, 240]:\n    #         faulthandler.dump_traceback_later(second)\n\n    start_event_loop = True\n\n    if not hasattr(task_lock, 'conversation_history'):\n        task_lock.conversation_history = []\n    if not hasattr(task_lock, 'last_task_result'):\n        task_lock.last_task_result = \"\"\n    if not hasattr(task_lock, 'question_agent'):\n        task_lock.question_agent = None\n    if not hasattr(task_lock, 'summary_generated'):\n        task_lock.summary_generated = False\n\n    # Create or reuse persistent question_agent\n    if task_lock.question_agent is None:\n        task_lock.question_agent = question_confirm_agent(options)\n        logger.info(f\"Created new persistent question_agent for project {options.project_id}\")\n    else:\n        logger.info(f\"Reusing existing question_agent with {len(task_lock.conversation_history)} history entries\")\n\n    question_agent = task_lock.question_agent\n\n    # Other variables\n    camel_task = None\n    workforce = None\n    last_completed_task_result = \"\"  # Track the last completed task result\n    summary_task_content = \"\"  # Track task summary\n    loop_iteration = 0\n    event_loop = asyncio.get_running_loop()\n    sub_tasks: list[Task] = []\n\n    logger.info(\"=\" * 80)\n    logger.info(\"🚀 [LIFECYCLE] step_solve STARTED\", extra={\"project_id\": options.project_id, \"task_id\": options.task_id})\n    logger.info(\"=\" * 80)\n    logger.debug(\"Step solve options\", extra={\"task_id\": options.task_id, \"model_platform\": options.model_platform})\n\n    while True:\n        loop_iteration += 1",
        "signatures": {},
        "detailedLines": [
          {
            "text": "@sync_step",
            "lineNumber": 237
          },
          {
            "text": "@traceroot.trace()",
            "lineNumber": 238
          },
          {
            "text": "async def step_solve(options: Chat, request: Request, task_lock: TaskLock):",
            "lineNumber": 239,
            "isSignature": true
          },
          {
            "text": "    # if True:",
            "lineNumber": 240,
            "isSignature": true
          },
          {
            "text": "    #     import faulthandler",
            "lineNumber": 241,
            "isSignature": true
          },
          {
            "lineNumber": 242,
            "isSignature": true
          },
          {
            "text": "    #     faulthandler.enable()",
            "lineNumber": 243,
            "isSignature": true
          },
          {
            "text": "    #     for second in [5, 10, 20, 30, 60, 120, 240]:",
            "lineNumber": 244,
            "isSignature": true
          },
          {
            "text": "    #         faulthandler.dump_traceback_later(second)",
            "lineNumber": 245,
            "isSignature": true
          },
          {
            "lineNumber": 246
          },
          {
            "text": "    start_event_loop = True",
            "lineNumber": 247
          },
          {
            "lineNumber": 248
          },
          {
            "text": "    if not hasattr(task_lock, 'conversation_history'):",
            "lineNumber": 249
          },
          {
            "text": "        task_lock.conversation_history = []",
            "lineNumber": 250
          },
          {
            "text": "    if not hasattr(task_lock, 'last_task_result'):",
            "lineNumber": 251
          },
          {
            "text": "        task_lock.last_task_result = \"\"",
            "lineNumber": 252
          },
          {
            "text": "    if not hasattr(task_lock, 'question_agent'):",
            "lineNumber": 253
          },
          {
            "text": "        task_lock.question_agent = None",
            "lineNumber": 254
          },
          {
            "text": "    if not hasattr(task_lock, 'summary_generated'):",
            "lineNumber": 255
          },
          {
            "text": "        task_lock.summary_generated = False",
            "lineNumber": 256
          },
          {
            "lineNumber": 257
          },
          {
            "text": "    # Create or reuse persistent question_agent",
            "lineNumber": 258
          },
          {
            "text": "    if task_lock.question_agent is None:",
            "lineNumber": 259
          },
          {
            "text": "        task_lock.question_agent = question_confirm_agent(options)",
            "lineNumber": 260
          },
          {
            "text": "        logger.info(f\"Created new persistent question_agent for project {options.project_id}\")",
            "lineNumber": 261
          },
          {
            "text": "    else:",
            "lineNumber": 262
          },
          {
            "text": "        logger.info(f\"Reusing existing question_agent with {len(task_lock.conversation_history)} history entries\")",
            "lineNumber": 263
          },
          {
            "lineNumber": 264
          },
          {
            "text": "    question_agent = task_lock.question_agent",
            "lineNumber": 265
          },
          {
            "lineNumber": 266
          },
          {
            "text": "    # Other variables",
            "lineNumber": 267
          },
          {
            "text": "    camel_task = None",
            "lineNumber": 268
          },
          {
            "text": "    workforce = None",
            "lineNumber": 269
          },
          {
            "text": "    last_completed_task_result = \"\"  # Track the last completed task result",
            "lineNumber": 270
          },
          {
            "text": "    summary_task_content = \"\"  # Track task summary",
            "lineNumber": 271
          },
          {
            "text": "    loop_iteration = 0",
            "lineNumber": 272
          },
          {
            "text": "    event_loop = asyncio.get_running_loop()",
            "lineNumber": 273
          },
          {
            "text": "    sub_tasks: list[Task] = []",
            "lineNumber": 274
          },
          {
            "lineNumber": 275
          },
          {
            "text": "    logger.info(\"=\" * 80)",
            "lineNumber": 276
          },
          {
            "text": "    logger.info(\"🚀 [LIFECYCLE] step_solve STARTED\", extra={\"project_id\": options.project_id, \"task_id\": options.task_id})",
            "lineNumber": 277
          },
          {
            "text": "    logger.info(\"=\" * 80)",
            "lineNumber": 278
          },
          {
            "text": "    logger.debug(\"Step solve options\", extra={\"task_id\": options.task_id, \"model_platform\": options.model_platform})",
            "lineNumber": 279
          },
          {
            "lineNumber": 280
          },
          {
            "text": "    while True:",
            "lineNumber": 281
          },
          {
            "text": "        loop_iteration += 1",
            "lineNumber": 282
          }
        ]
      },
      "score": 0.41496723890304565
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\utils\\agent.py",
        "range": {
          "startPosition": {
            "line": 654,
            "column": 24
          },
          "endPosition": {
            "line": 756
          }
        },
        "contents": "@traceroot.trace()\ndef agent_model(\n    agent_name: str,\n    system_message: str | BaseMessage,\n    options: Chat,\n    tools: list[FunctionTool | Callable] | None = None,\n    prune_tool_calls_from_memory: bool = False,\n    tool_names: list[str] | None = None,\n    toolkits_to_register_agent: list[RegisteredAgentToolkit] | None = None,\n    enable_snapshot_clean: bool = False,\n):\n    task_lock = get_task_lock(options.project_id)\n    agent_id = str(uuid.uuid4())\n    traceroot_logger.info(\n        f\"Creating agent: {agent_name} with id: {agent_id} for project: {options.project_id}\"\n    )\n    asyncio.create_task(\n        task_lock.put_queue(\n            ActionCreateAgentData(\n                data={\n                    \"agent_name\": agent_name,\n                    \"agent_id\": agent_id,\n                    \"tools\": tool_names or [],\n                }\n            )\n        )\n    )\n\n    # Build model config, defaulting to streaming for planner\n    extra_params = options.extra_params or {}\n    init_param_keys = {\n        \"api_version\",\n        \"azure_ad_token\",\n        \"azure_ad_token_provider\",\n        \"max_retries\",\n        \"timeout\",\n        \"client\",\n        \"async_client\",\n        \"azure_deployment_name\",\n    }\n\n    init_params = {}\n    model_config: dict[str, Any] = {}\n\n    if options.is_cloud():\n        model_config[\"user\"] = str(options.project_id)\n\n    excluded_keys = {\"model_platform\", \"model_type\", \"api_key\", \"url\"}\n\n    # Distribute extra_params between init_params and model_config\n    for k, v in extra_params.items():\n        if k in excluded_keys:\n            continue\n        # Skip empty values\n        if v is None or (isinstance(v, str) and not v.strip()):\n            continue\n\n        if k in init_param_keys:\n            init_params[k] = v\n        else:\n            model_config[k] = v\n\n    if agent_name == Agents.task_agent:\n        model_config[\"stream\"] = True\n    if agent_name == Agents.browser_agent:\n        try:\n            model_platform_enum =",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 84,
                "column": 1
              },
              "endPosition": {
                "line": 85,
                "column": 5
              }
            },
            {
              "startPosition": {
                "line": 614,
                "column": 5
              },
              "endPosition": {
                "line": 615,
                "column": 5
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "@traceroot.trace()",
            "lineNumber": 658
          },
          {
            "text": "def agent_model(",
            "lineNumber": 659,
            "isSignature": true
          },
          {
            "text": "    agent_name: str,",
            "lineNumber": 660,
            "isSignature": true
          },
          {
            "text": "    system_message: str | BaseMessage,",
            "lineNumber": 661,
            "isSignature": true
          },
          {
            "text": "    options: Chat,",
            "lineNumber": 662,
            "isSignature": true
          },
          {
            "text": "    tools: list[FunctionTool | Callable] | None = None,",
            "lineNumber": 663,
            "isSignature": true
          },
          {
            "text": "    prune_tool_calls_from_memory: bool = False,",
            "lineNumber": 664,
            "isSignature": true
          },
          {
            "text": "    tool_names: list[str] | None = None,",
            "lineNumber": 665,
            "isSignature": true
          },
          {
            "text": "    toolkits_to_register_agent: list[RegisteredAgentToolkit] | None = None,",
            "lineNumber": 666,
            "isSignature": true
          },
          {
            "text": "    enable_snapshot_clean: bool = False,",
            "lineNumber": 667,
            "isSignature": true
          },
          {
            "text": "):",
            "lineNumber": 668,
            "isSignature": true
          },
          {
            "text": "    task_lock = get_task_lock(options.project_id)",
            "lineNumber": 669
          },
          {
            "text": "    agent_id = str(uuid.uuid4())",
            "lineNumber": 670
          },
          {
            "text": "    traceroot_logger.info(",
            "lineNumber": 671
          },
          {
            "text": "        f\"Creating agent: {agent_name} with id: {agent_id} for project: {options.project_id}\"",
            "lineNumber": 672
          },
          {
            "text": "    )",
            "lineNumber": 673
          },
          {
            "text": "    asyncio.create_task(",
            "lineNumber": 674
          },
          {
            "text": "        task_lock.put_queue(",
            "lineNumber": 675
          },
          {
            "text": "            ActionCreateAgentData(",
            "lineNumber": 676
          },
          {
            "text": "                data={",
            "lineNumber": 677
          },
          {
            "text": "                    \"agent_name\": agent_name,",
            "lineNumber": 678
          },
          {
            "text": "                    \"agent_id\": agent_id,",
            "lineNumber": 679
          },
          {
            "text": "                    \"tools\": tool_names or [],",
            "lineNumber": 680
          },
          {
            "text": "                }",
            "lineNumber": 681
          },
          {
            "text": "            )",
            "lineNumber": 682
          },
          {
            "text": "        )",
            "lineNumber": 683
          },
          {
            "text": "    )",
            "lineNumber": 684
          },
          {
            "lineNumber": 685
          },
          {
            "text": "    # Build model config, defaulting to streaming for planner",
            "lineNumber": 686
          },
          {
            "text": "    extra_params = options.extra_params or {}",
            "lineNumber": 687
          },
          {
            "text": "    init_param_keys = {",
            "lineNumber": 688
          },
          {
            "text": "        \"api_version\",",
            "lineNumber": 689
          },
          {
            "text": "        \"azure_ad_token\",",
            "lineNumber": 690
          },
          {
            "text": "        \"azure_ad_token_provider\",",
            "lineNumber": 691
          },
          {
            "text": "        \"max_retries\",",
            "lineNumber": 692
          },
          {
            "text": "        \"timeout\",",
            "lineNumber": 693
          },
          {
            "text": "        \"client\",",
            "lineNumber": 694
          },
          {
            "text": "        \"async_client\",",
            "lineNumber": 695
          },
          {
            "text": "        \"azure_deployment_name\",",
            "lineNumber": 696
          },
          {
            "text": "    }",
            "lineNumber": 697
          },
          {
            "lineNumber": 698
          },
          {
            "text": "    init_params = {}",
            "lineNumber": 699
          },
          {
            "text": "    model_config: dict[str, Any] = {}",
            "lineNumber": 700
          },
          {
            "lineNumber": 701
          },
          {
            "text": "    if options.is_cloud():",
            "lineNumber": 702
          },
          {
            "text": "        model_config[\"user\"] = str(options.project_id)",
            "lineNumber": 703
          },
          {
            "lineNumber": 704
          },
          {
            "text": "    excluded_keys = {\"model_platform\", \"model_type\", \"api_key\", \"url\"}",
            "lineNumber": 705
          },
          {
            "lineNumber": 706
          },
          {
            "text": "    # Distribute extra_params between init_params and model_config",
            "lineNumber": 707
          },
          {
            "text": "    for k, v in extra_params.items():",
            "lineNumber": 708
          },
          {
            "text": "        if k in excluded_keys:",
            "lineNumber": 709
          },
          {
            "text": "            continue",
            "lineNumber": 710
          },
          {
            "text": "        # Skip empty values",
            "lineNumber": 711
          },
          {
            "text": "        if v is None or (isinstance(v, str) and not v.strip()):",
            "lineNumber": 712
          },
          {
            "text": "            continue",
            "lineNumber": 713
          },
          {
            "lineNumber": 714
          },
          {
            "text": "        if k in init_param_keys:",
            "lineNumber": 715
          },
          {
            "text": "            init_params[k] = v",
            "lineNumber": 716
          },
          {
            "text": "        else:",
            "lineNumber": 717
          },
          {
            "text": "            model_config[k] = v",
            "lineNumber": 718
          },
          {
            "lineNumber": 719
          },
          {
            "text": "    if agent_name == Agents.task_agent:",
            "lineNumber": 720
          },
          {
            "text": "        model_config[\"stream\"] = True",
            "lineNumber": 721
          },
          {
            "text": "    if agent_name == Agents.browser_agent:",
            "lineNumber": 722
          },
          {
            "text": "        try:",
            "lineNumber": 723
          },
          {
            "text": "            model_platform_enum =",
            "lineNumber": 724
          }
        ]
      },
      "score": 0.4132513999938965
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\utils\\workforce.py",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 607
          }
        },
        "contents": "import asyncio\nfrom typing import Generator, List, Optional\nfrom camel.agents import ChatAgent\nfrom camel.societies.workforce.workforce import (\n    Workforce as BaseWorkforce,\n    WorkforceState,\n    DEFAULT_WORKER_POOL_SIZE,\n)\nfrom camel.societies.workforce.utils import FailureHandlingConfig\nfrom camel.societies.workforce.task_channel import TaskChannel\nfrom camel.societies.workforce.base import BaseNode\nfrom camel.societies.workforce.utils import TaskAssignResult\nfrom camel.societies.workforce.workforce_metrics import WorkforceMetrics\nfrom camel.societies.workforce.events import WorkerCreatedEvent\nfrom camel.societies.workforce.prompts import TASK_DECOMPOSE_PROMPT\nfrom camel.tasks.task import Task, TaskState, validate_task_content\nfrom app.component import code\nfrom app.exception.exception import UserException\nfrom app.utils.agent import ListenChatAgent\nfrom app.service.task import (\n    Action,\n    ActionAssignTaskData,\n    ActionEndData,\n    ActionTaskStateData,\n    ActionTimeoutData,\n    get_camel_task,\n    get_task_lock,\n)\nfrom app.utils.single_agent_worker import SingleAgentWorker\nfrom utils import traceroot_wrapper as traceroot\n\nlogger = traceroot.get_logger(\"workforce\")\n\n\n\nclass Workforce(BaseWorkforce):\n    def __init__(\n        self,\n        api_task_id: str,\n        description: str,\n        children: List[BaseNode] | None = None,\n        coordinator_agent: ChatAgent | None = None,\n        task_agent: ChatAgent | None = None,\n        new_worker_agent: ChatAgent | None = None,\n        graceful_shutdown_timeout: float = 3,\n        share_memory: bool = False,\n        use_structured_output_handler: bool = True,\n    ) -&gt; None:\n        ",
        "signatures": {},
        "detailedLines": [
          {
            "text": "import asyncio",
            "lineNumber": 1
          },
          {
            "text": "from typing import Generator, List, Optional",
            "lineNumber": 2
          },
          {
            "text": "from camel.agents import ChatAgent",
            "lineNumber": 3
          },
          {
            "text": "from camel.societies.workforce.workforce import (",
            "lineNumber": 4
          },
          {
            "text": "    Workforce as BaseWorkforce,",
            "lineNumber": 5
          },
          {
            "text": "    WorkforceState,",
            "lineNumber": 6
          },
          {
            "text": "    DEFAULT_WORKER_POOL_SIZE,",
            "lineNumber": 7
          },
          {
            "text": ")",
            "lineNumber": 8
          },
          {
            "text": "from camel.societies.workforce.utils import FailureHandlingConfig",
            "lineNumber": 9
          },
          {
            "text": "from camel.societies.workforce.task_channel import TaskChannel",
            "lineNumber": 10
          },
          {
            "text": "from camel.societies.workforce.base import BaseNode",
            "lineNumber": 11
          },
          {
            "text": "from camel.societies.workforce.utils import TaskAssignResult",
            "lineNumber": 12
          },
          {
            "text": "from camel.societies.workforce.workforce_metrics import WorkforceMetrics",
            "lineNumber": 13
          },
          {
            "text": "from camel.societies.workforce.events import WorkerCreatedEvent",
            "lineNumber": 14
          },
          {
            "text": "from camel.societies.workforce.prompts import TASK_DECOMPOSE_PROMPT",
            "lineNumber": 15
          },
          {
            "text": "from camel.tasks.task import Task, TaskState, validate_task_content",
            "lineNumber": 16
          },
          {
            "text": "from app.component import code",
            "lineNumber": 17
          },
          {
            "text": "from app.exception.exception import UserException",
            "lineNumber": 18
          },
          {
            "text": "from app.utils.agent import ListenChatAgent",
            "lineNumber": 19
          },
          {
            "text": "from app.service.task import (",
            "lineNumber": 20
          },
          {
            "text": "    Action,",
            "lineNumber": 21
          },
          {
            "text": "    ActionAssignTaskData,",
            "lineNumber": 22
          },
          {
            "text": "    ActionEndData,",
            "lineNumber": 23
          },
          {
            "text": "    ActionTaskStateData,",
            "lineNumber": 24
          },
          {
            "text": "    ActionTimeoutData,",
            "lineNumber": 25
          },
          {
            "text": "    get_camel_task,",
            "lineNumber": 26
          },
          {
            "text": "    get_task_lock,",
            "lineNumber": 27
          },
          {
            "text": ")",
            "lineNumber": 28
          },
          {
            "text": "from app.utils.single_agent_worker import SingleAgentWorker",
            "lineNumber": 29
          },
          {
            "text": "from utils import traceroot_wrapper as traceroot",
            "lineNumber": 30
          },
          {
            "lineNumber": 31
          },
          {
            "text": "logger = traceroot.get_logger(\"workforce\")",
            "lineNumber": 32
          },
          {
            "lineNumber": 33
          },
          {
            "lineNumber": 34
          },
          {
            "lineNumber": 35
          },
          {
            "text": "class Workforce(BaseWorkforce):",
            "lineNumber": 36,
            "isSignature": true
          },
          {
            "text": "    def __init__(",
            "lineNumber": 37
          },
          {
            "text": "        self,",
            "lineNumber": 38
          },
          {
            "text": "        api_task_id: str,",
            "lineNumber": 39
          },
          {
            "text": "        description: str,",
            "lineNumber": 40
          },
          {
            "text": "        children: List[BaseNode] | None = None,",
            "lineNumber": 41
          },
          {
            "text": "        coordinator_agent: ChatAgent | None = None,",
            "lineNumber": 42
          },
          {
            "text": "        task_agent: ChatAgent | None = None,",
            "lineNumber": 43
          },
          {
            "text": "        new_worker_agent: ChatAgent | None = None,",
            "lineNumber": 44
          },
          {
            "text": "        graceful_shutdown_timeout: float = 3,",
            "lineNumber": 45
          },
          {
            "text": "        share_memory: bool = False,",
            "lineNumber": 46
          },
          {
            "text": "        use_structured_output_handler: bool = True,",
            "lineNumber": 47
          },
          {
            "text": "    ) -&gt; None:",
            "lineNumber": 48
          },
          {
            "text": "        ",
            "lineNumber": 49
          }
        ]
      },
      "score": 0.4073909521102905
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\service\\chat_service.py",
        "range": {
          "startPosition": {
            "line": 1300
          },
          "endPosition": {
            "line": 1424
          }
        },
        "contents": "@traceroot.trace()\nasync def construct_workforce(options: Chat) -&gt; tuple[Workforce, ListenChatAgent]:\n\n        for key, prompt in {\n            Agents.coordinator_agent: f\"\"\"\nYou are a helpful coordinator.\n- You are now working in system {platform.system()} with architecture\n{platform.machine()} at working directory &#96;{working_directory}&#96;. All local file operations must occur here, but you can access files from any place in the file system. For all file system operations, you MUST use absolute paths to ensure precision and avoid ambiguity.\nThe current date is {datetime.date.today()}. For any date-related tasks, you MUST use this as the current date.\n\n- If a task assigned to another agent fails, you should re-assign it to the \n&#96;Developer_Agent&#96;. The &#96;Developer_Agent&#96; is a powerful agent with terminal \naccess and can resolve a wide range of issues. \n            \"\"\",\n            Agents.task_agent: f\"\"\"\nYou are a helpful task planner.\n- You are now working in system {platform.system()} with architecture\n{platform.machine()} at working directory &#96;{working_directory}&#96;. All local file operations must occur here, but you can access files from any place in the file system. For all file system operations, you MUST use absolute paths to ensure precision and avoid ambiguity.\nThe current date is {datetime.date.today()}. For any date-related tasks, you MUST use this as the current date.\n        \"\"\",\n        }.items()\n    ]\n    new_worker_agent = agent_model(\n        Agents.new_worker_agent,",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 1301,
                "column": 1
              },
              "endPosition": {
                "line": 1302,
                "column": 1
              }
            },
            {
              "startPosition": {
                "line": 1302,
                "column": 1
              },
              "endPosition": {
                "line": 1303,
                "column": 5
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "@traceroot.trace()",
            "lineNumber": 1301
          },
          {
            "text": "async def construct_workforce(options: Chat) -&gt; tuple[Workforce, ListenChatAgent]:",
            "lineNumber": 1302,
            "isSignature": true
          },
          {
            "lineNumber": 1318
          },
          {
            "text": "        for key, prompt in {",
            "lineNumber": 1319
          },
          {
            "text": "            Agents.coordinator_agent: f\"\"\"",
            "lineNumber": 1320
          },
          {
            "text": "You are a helpful coordinator.",
            "lineNumber": 1321
          },
          {
            "text": "- You are now working in system {platform.system()} with architecture",
            "lineNumber": 1322
          },
          {
            "text": "{platform.machine()} at working directory &#96;{working_directory}&#96;. All local file operations must occur here, but you can access files from any place in the file system. For all file system operations, you MUST use absolute paths to ensure precision and avoid ambiguity.",
            "lineNumber": 1323
          },
          {
            "text": "The current date is {datetime.date.today()}. For any date-related tasks, you MUST use this as the current date.",
            "lineNumber": 1324
          },
          {
            "lineNumber": 1325
          },
          {
            "text": "- If a task assigned to another agent fails, you should re-assign it to the ",
            "lineNumber": 1326
          },
          {
            "text": "&#96;Developer_Agent&#96;. The &#96;Developer_Agent&#96; is a powerful agent with terminal ",
            "lineNumber": 1327
          },
          {
            "text": "access and can resolve a wide range of issues. ",
            "lineNumber": 1328
          },
          {
            "text": "            \"\"\",",
            "lineNumber": 1329
          },
          {
            "text": "            Agents.task_agent: f\"\"\"",
            "lineNumber": 1330
          },
          {
            "text": "You are a helpful task planner.",
            "lineNumber": 1331
          },
          {
            "text": "- You are now working in system {platform.system()} with architecture",
            "lineNumber": 1332
          },
          {
            "text": "{platform.machine()} at working directory &#96;{working_directory}&#96;. All local file operations must occur here, but you can access files from any place in the file system. For all file system operations, you MUST use absolute paths to ensure precision and avoid ambiguity.",
            "lineNumber": 1333
          },
          {
            "text": "The current date is {datetime.date.today()}. For any date-related tasks, you MUST use this as the current date.",
            "lineNumber": 1334
          },
          {
            "text": "        \"\"\",",
            "lineNumber": 1335
          },
          {
            "text": "        }.items()",
            "lineNumber": 1336
          },
          {
            "text": "    ]",
            "lineNumber": 1337
          },
          {
            "text": "    new_worker_agent = agent_model(",
            "lineNumber": 1338
          },
          {
            "text": "        Agents.new_worker_agent,",
            "lineNumber": 1339
          }
        ]
      },
      "score": 0.38150259852409363
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\utils\\workforce.py",
        "range": {
          "startPosition": {
            "line": 35
          },
          "endPosition": {
            "line": 607
          }
        },
        "contents": "class Workforce(BaseWorkforce):\n\n\n    def eigent_make_sub_tasks(\n        self,\n        task: Task,\n        coordinator_context: str = \"\",\n        on_stream_batch=None,\n        on_stream_text=None,\n    ):\n        \"\"\"\n        Split process_task method to eigent_make_sub_tasks and eigent_start method.\n\n        Args:\n            task: The main task to decompose\n            coordinator_context: Optional context ONLY for coordinator agent during decomposition.\n                                This context will NOT be passed to subtasks or worker agents.\n            on_stream_batch: Optional callback for streaming batches signature (List[Task], bool)\n            on_stream_text: Optional callback for raw streaming text chunks\n        \"\"\"\n        logger.info(\"=\" * 80)\n        logger.info(\"🧩 [DECOMPOSE] eigent_make_sub_tasks CALLED\", extra={\n            \"api_task_id\": self.api_task_id,\n            \"workforce_id\": id(self),\n            \"task_id\": task.id\n        })\n        logger.info(f\"[DECOMPOSE] Task content preview: '{task.content[:200]}...'\")\n        logger.info(f\"[DECOMPOSE] Has coordinator context: {bool(coordinator_context)}\")\n        logger.info(f\"[DECOMPOSE] Current workforce state: {self._state.name}, _running: {self._running}\")\n        logger.info(\"=\" * 80)\n\n        if not validate_task_content(task.content, task.id):\n            task.state = TaskState.FAILED\n            task.result = \"Task failed: Invalid or empty content provided\"\n            logger.warning(\"❌ [DECOMPOSE] Task rejected: Invalid or empty content\", extra={\n                \"task_id\": task.id,\n                \"content_preview\": task.content[:50] + \"...\" if len(task.content) &gt; 50 else task.content\n            })\n            raise UserException(code.error, task.result)\n\n        logger.info(f\"[DECOMPOSE] Resetting workforce state\")\n        self.reset()\n        self._task = task\n        self.set_channel(TaskChannel())\n        self._state = WorkforceState.RUNNING\n        task.state = TaskState.OPEN\n        logger.info(f\"[DECOMPOSE] Workforce reset complete, state: {self._state.name}\")\n\n        logger.info",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 36,
                "column": 1
              },
              "endPosition": {
                "line": 37,
                "column": 5
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "class Workforce(BaseWorkforce):",
            "lineNumber": 36,
            "isSignature": true
          },
          {
            "lineNumber": 71
          },
          {
            "lineNumber": 72
          },
          {
            "text": "    def eigent_make_sub_tasks(",
            "lineNumber": 73
          },
          {
            "text": "        self,",
            "lineNumber": 74
          },
          {
            "text": "        task: Task,",
            "lineNumber": 75
          },
          {
            "text": "        coordinator_context: str = \"\",",
            "lineNumber": 76
          },
          {
            "text": "        on_stream_batch=None,",
            "lineNumber": 77
          },
          {
            "text": "        on_stream_text=None,",
            "lineNumber": 78
          },
          {
            "text": "    ):",
            "lineNumber": 79
          },
          {
            "text": "        \"\"\"",
            "lineNumber": 80
          },
          {
            "text": "        Split process_task method to eigent_make_sub_tasks and eigent_start method.",
            "lineNumber": 81
          },
          {
            "lineNumber": 82
          },
          {
            "text": "        Args:",
            "lineNumber": 83
          },
          {
            "text": "            task: The main task to decompose",
            "lineNumber": 84
          },
          {
            "text": "            coordinator_context: Optional context ONLY for coordinator agent during decomposition.",
            "lineNumber": 85
          },
          {
            "text": "                                This context will NOT be passed to subtasks or worker agents.",
            "lineNumber": 86
          },
          {
            "text": "            on_stream_batch: Optional callback for streaming batches signature (List[Task], bool)",
            "lineNumber": 87
          },
          {
            "text": "            on_stream_text: Optional callback for raw streaming text chunks",
            "lineNumber": 88
          },
          {
            "text": "        \"\"\"",
            "lineNumber": 89
          },
          {
            "text": "        logger.info(\"=\" * 80)",
            "lineNumber": 90
          },
          {
            "text": "        logger.info(\"🧩 [DECOMPOSE] eigent_make_sub_tasks CALLED\", extra={",
            "lineNumber": 91
          },
          {
            "text": "            \"api_task_id\": self.api_task_id,",
            "lineNumber": 92
          },
          {
            "text": "            \"workforce_id\": id(self),",
            "lineNumber": 93
          },
          {
            "text": "            \"task_id\": task.id",
            "lineNumber": 94
          },
          {
            "text": "        })",
            "lineNumber": 95
          },
          {
            "text": "        logger.info(f\"[DECOMPOSE] Task content preview: '{task.content[:200]}...'\")",
            "lineNumber": 96
          },
          {
            "text": "        logger.info(f\"[DECOMPOSE] Has coordinator context: {bool(coordinator_context)}\")",
            "lineNumber": 97
          },
          {
            "text": "        logger.info(f\"[DECOMPOSE] Current workforce state: {self._state.name}, _running: {self._running}\")",
            "lineNumber": 98
          },
          {
            "text": "        logger.info(\"=\" * 80)",
            "lineNumber": 99
          },
          {
            "lineNumber": 100
          },
          {
            "text": "        if not validate_task_content(task.content, task.id):",
            "lineNumber": 101
          },
          {
            "text": "            task.state = TaskState.FAILED",
            "lineNumber": 102
          },
          {
            "text": "            task.result = \"Task failed: Invalid or empty content provided\"",
            "lineNumber": 103
          },
          {
            "text": "            logger.warning(\"❌ [DECOMPOSE] Task rejected: Invalid or empty content\", extra={",
            "lineNumber": 104
          },
          {
            "text": "                \"task_id\": task.id,",
            "lineNumber": 105
          },
          {
            "text": "                \"content_preview\": task.content[:50] + \"...\" if len(task.content) &gt; 50 else task.content",
            "lineNumber": 106
          },
          {
            "text": "            })",
            "lineNumber": 107
          },
          {
            "text": "            raise UserException(code.error, task.result)",
            "lineNumber": 108
          },
          {
            "lineNumber": 109
          },
          {
            "text": "        logger.info(f\"[DECOMPOSE] Resetting workforce state\")",
            "lineNumber": 110
          },
          {
            "text": "        self.reset()",
            "lineNumber": 111
          },
          {
            "text": "        self._task = task",
            "lineNumber": 112
          },
          {
            "text": "        self.set_channel(TaskChannel())",
            "lineNumber": 113
          },
          {
            "text": "        self._state = WorkforceState.RUNNING",
            "lineNumber": 114
          },
          {
            "text": "        task.state = TaskState.OPEN",
            "lineNumber": 115
          },
          {
            "text": "        logger.info(f\"[DECOMPOSE] Workforce reset complete, state: {self._state.name}\")",
            "lineNumber": 116
          },
          {
            "lineNumber": 117
          },
          {
            "text": "        logger.info",
            "lineNumber": 118
          }
        ]
      },
      "score": 0.3776492476463318
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\service\\chat_service.py",
        "range": {
          "startPosition": {
            "line": 236
          },
          "endPosition": {
            "line": 1075
          }
        },
        "contents": "@sync_step\n@traceroot.trace()\nasync def step_solve(options: Chat, request: Request, task_lock: TaskLock):\n    # if True:\n    #     import faulthandler\n\n    #     faulthandler.enable()\n    #     for second in [5, 10, 20, 30, 60, 120, 240]:\n    #         faulthandler.dump_traceback_later(second)\n\n                \n                task_lock.add_conversation('task_result', {\n                    'task_content': task_content,\n                    'task_result': final_result,\n                    'working_directory': get_working_directory(options, task_lock)\n                })\n\n\n                yield sse_json(\"end\", final_result)\n\n                if workforce is not None:\n                    logger.info(f\"[LIFECYCLE] 🛑 Calling workforce.stop_gracefully() for project {options.project_id}, workforce id={id(workforce)}\")\n                    workforce.stop_gracefully()\n                    logger.info(f\"[LIFECYCLE] ✅ Workforce stopped gracefully for project {options.project_id}\")\n                    workforce = None\n                    logger.info(f\"[LIFECYCLE] Workforce set to None\")\n                else:\n                    logger.warning(f\"[LIFECYCLE] ⚠️  Workforce already None at end action for project {options.project_id}\")\n\n                camel_task = None\n                logger.info(f\"[LIFECYCLE] camel_task set to None\")\n\n                if question_agent is not None:\n                    question_agent.reset()\n                    logger.info(f\"[LIFECYCLE] question_agent reset for project {options.project_id}\")\n            elif item.action == Action.supplement:\n\n                # Check if this might be a misrouted second question\n                if",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 237,
                "column": 1
              },
              "endPosition": {
                "line": 239,
                "column": 1
              }
            },
            {
              "startPosition": {
                "line": 239,
                "column": 1
              },
              "endPosition": {
                "line": 247,
                "column": 5
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "@sync_step",
            "lineNumber": 237
          },
          {
            "text": "@traceroot.trace()",
            "lineNumber": 238
          },
          {
            "text": "async def step_solve(options: Chat, request: Request, task_lock: TaskLock):",
            "lineNumber": 239,
            "isSignature": true
          },
          {
            "text": "    # if True:",
            "lineNumber": 240,
            "isSignature": true
          },
          {
            "text": "    #     import faulthandler",
            "lineNumber": 241,
            "isSignature": true
          },
          {
            "lineNumber": 242,
            "isSignature": true
          },
          {
            "text": "    #     faulthandler.enable()",
            "lineNumber": 243,
            "isSignature": true
          },
          {
            "text": "    #     for second in [5, 10, 20, 30, 60, 120, 240]:",
            "lineNumber": 244,
            "isSignature": true
          },
          {
            "text": "    #         faulthandler.dump_traceback_later(second)",
            "lineNumber": 245,
            "isSignature": true
          },
          {
            "lineNumber": 992
          },
          {
            "text": "                ",
            "lineNumber": 993
          },
          {
            "text": "                task_lock.add_conversation('task_result', {",
            "lineNumber": 994
          },
          {
            "text": "                    'task_content': task_content,",
            "lineNumber": 995
          },
          {
            "text": "                    'task_result': final_result,",
            "lineNumber": 996
          },
          {
            "text": "                    'working_directory': get_working_directory(options, task_lock)",
            "lineNumber": 997
          },
          {
            "text": "                })",
            "lineNumber": 998
          },
          {
            "lineNumber": 999
          },
          {
            "lineNumber": 1000
          },
          {
            "text": "                yield sse_json(\"end\", final_result)",
            "lineNumber": 1001
          },
          {
            "lineNumber": 1002
          },
          {
            "text": "                if workforce is not None:",
            "lineNumber": 1003
          },
          {
            "text": "                    logger.info(f\"[LIFECYCLE] 🛑 Calling workforce.stop_gracefully() for project {options.project_id}, workforce id={id(workforce)}\")",
            "lineNumber": 1004
          },
          {
            "text": "                    workforce.stop_gracefully()",
            "lineNumber": 1005
          },
          {
            "text": "                    logger.info(f\"[LIFECYCLE] ✅ Workforce stopped gracefully for project {options.project_id}\")",
            "lineNumber": 1006
          },
          {
            "text": "                    workforce = None",
            "lineNumber": 1007
          },
          {
            "text": "                    logger.info(f\"[LIFECYCLE] Workforce set to None\")",
            "lineNumber": 1008
          },
          {
            "text": "                else:",
            "lineNumber": 1009
          },
          {
            "text": "                    logger.warning(f\"[LIFECYCLE] ⚠️  Workforce already None at end action for project {options.project_id}\")",
            "lineNumber": 1010
          },
          {
            "lineNumber": 1011
          },
          {
            "text": "                camel_task = None",
            "lineNumber": 1012
          },
          {
            "text": "                logger.info(f\"[LIFECYCLE] camel_task set to None\")",
            "lineNumber": 1013
          },
          {
            "lineNumber": 1014
          },
          {
            "text": "                if question_agent is not None:",
            "lineNumber": 1015
          },
          {
            "text": "                    question_agent.reset()",
            "lineNumber": 1016
          },
          {
            "text": "                    logger.info(f\"[LIFECYCLE] question_agent reset for project {options.project_id}\")",
            "lineNumber": 1017
          },
          {
            "text": "            elif item.action == Action.supplement:",
            "lineNumber": 1018
          },
          {
            "lineNumber": 1019
          },
          {
            "text": "                # Check if this might be a misrouted second question",
            "lineNumber": 1020
          },
          {
            "text": "                if",
            "lineNumber": 1021
          }
        ]
      },
      "score": 0.3700447678565979
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\utils\\agent.py",
        "range": {
          "startPosition": {
            "line": 1710,
            "column": 5
          },
          "endPosition": {
            "line": 1785
          }
        },
        "contents": "@traceroot.trace()\nasync def mcp_agent(options: Chat):\n    traceroot_logger.info(\n        f\"Creating MCP agent for project: {options.project_id} with {len(options.installed_mcp['mcpServers'])} MCP servers\"\n    )\n    tools = [\n        # *HumanToolkit.get_can_use_tools(options.project_id, Agents.mcp_agent),\n        *McpSearchToolkit(options.project_id).get_tools(),\n    ]\n    if len(options.installed_mcp[\"mcpServers\"]) &gt; 0:\n        try:\n            mcp_tools = await get_mcp_tools(options.installed_mcp)\n            traceroot_logger.info(\n                f\"Retrieved {len(mcp_tools)} MCP tools for task {options.project_id}\"\n            )\n            if mcp_tools:\n                tool_names = [\n                    (\n                        tool.get_function_name()\n                        if hasattr(tool, \"get_function_name\")\n                        else str(tool)\n                    )\n                    for tool in mcp_tools\n                ]\n                traceroot_logger.debug(f\"MCP tools: {tool_names}\")\n            tools = [*tools, *mcp_tools]\n        except Exception as e:\n            traceroot_logger.debug(repr(e))\n\n    task_lock = get_task_lock(options.project_id)\n    agent_id = str(uuid.uuid4())\n    traceroot_logger.info(\n        f\"Creating MCP agent: {Agents.mcp_agent} with id: {agent_id} for task: {options.project_id}\"\n    )\n    asyncio.create_task(\n        task_lock.put_queue(\n            ActionCreateAgentData(\n                data={\n                    \"agent_name\": Agents.mcp_agent,\n                    \"agent_id\": agent_id,\n                    \"tools\": [\n                        key for key in options.installed_mcp[\"mcpServers\"].keys()\n                    ],\n                }\n            )\n        )\n    )\n    return ListenChatAgent(\n        options.project_id,\n        Agents.mcp_agent",
        "signatures": {},
        "detailedLines": [
          {
            "text": "@traceroot.trace()",
            "lineNumber": 1714
          },
          {
            "text": "async def mcp_agent(options: Chat):",
            "lineNumber": 1715,
            "isSignature": true
          },
          {
            "text": "    traceroot_logger.info(",
            "lineNumber": 1716
          },
          {
            "text": "        f\"Creating MCP agent for project: {options.project_id} with {len(options.installed_mcp['mcpServers'])} MCP servers\"",
            "lineNumber": 1717
          },
          {
            "text": "    )",
            "lineNumber": 1718
          },
          {
            "text": "    tools = [",
            "lineNumber": 1719
          },
          {
            "text": "        # *HumanToolkit.get_can_use_tools(options.project_id, Agents.mcp_agent),",
            "lineNumber": 1720
          },
          {
            "text": "        *McpSearchToolkit(options.project_id).get_tools(),",
            "lineNumber": 1721
          },
          {
            "text": "    ]",
            "lineNumber": 1722
          },
          {
            "text": "    if len(options.installed_mcp[\"mcpServers\"]) &gt; 0:",
            "lineNumber": 1723
          },
          {
            "text": "        try:",
            "lineNumber": 1724
          },
          {
            "text": "            mcp_tools = await get_mcp_tools(options.installed_mcp)",
            "lineNumber": 1725
          },
          {
            "text": "            traceroot_logger.info(",
            "lineNumber": 1726
          },
          {
            "text": "                f\"Retrieved {len(mcp_tools)} MCP tools for task {options.project_id}\"",
            "lineNumber": 1727
          },
          {
            "text": "            )",
            "lineNumber": 1728
          },
          {
            "text": "            if mcp_tools:",
            "lineNumber": 1729
          },
          {
            "text": "                tool_names = [",
            "lineNumber": 1730
          },
          {
            "text": "                    (",
            "lineNumber": 1731
          },
          {
            "text": "                        tool.get_function_name()",
            "lineNumber": 1732
          },
          {
            "text": "                        if hasattr(tool, \"get_function_name\")",
            "lineNumber": 1733
          },
          {
            "text": "                        else str(tool)",
            "lineNumber": 1734
          },
          {
            "text": "                    )",
            "lineNumber": 1735
          },
          {
            "text": "                    for tool in mcp_tools",
            "lineNumber": 1736
          },
          {
            "text": "                ]",
            "lineNumber": 1737
          },
          {
            "text": "                traceroot_logger.debug(f\"MCP tools: {tool_names}\")",
            "lineNumber": 1738
          },
          {
            "text": "            tools = [*tools, *mcp_tools]",
            "lineNumber": 1739
          },
          {
            "text": "        except Exception as e:",
            "lineNumber": 1740
          },
          {
            "text": "            traceroot_logger.debug(repr(e))",
            "lineNumber": 1741
          },
          {
            "lineNumber": 1742
          },
          {
            "text": "    task_lock = get_task_lock(options.project_id)",
            "lineNumber": 1743
          },
          {
            "text": "    agent_id = str(uuid.uuid4())",
            "lineNumber": 1744
          },
          {
            "text": "    traceroot_logger.info(",
            "lineNumber": 1745
          },
          {
            "text": "        f\"Creating MCP agent: {Agents.mcp_agent} with id: {agent_id} for task: {options.project_id}\"",
            "lineNumber": 1746
          },
          {
            "text": "    )",
            "lineNumber": 1747
          },
          {
            "text": "    asyncio.create_task(",
            "lineNumber": 1748
          },
          {
            "text": "        task_lock.put_queue(",
            "lineNumber": 1749
          },
          {
            "text": "            ActionCreateAgentData(",
            "lineNumber": 1750
          },
          {
            "text": "                data={",
            "lineNumber": 1751
          },
          {
            "text": "                    \"agent_name\": Agents.mcp_agent,",
            "lineNumber": 1752
          },
          {
            "text": "                    \"agent_id\": agent_id,",
            "lineNumber": 1753
          },
          {
            "text": "                    \"tools\": [",
            "lineNumber": 1754
          },
          {
            "text": "                        key for key in options.installed_mcp[\"mcpServers\"].keys()",
            "lineNumber": 1755
          },
          {
            "text": "                    ],",
            "lineNumber": 1756
          },
          {
            "text": "                }",
            "lineNumber": 1757
          },
          {
            "text": "            )",
            "lineNumber": 1758
          },
          {
            "text": "        )",
            "lineNumber": 1759
          },
          {
            "text": "    )",
            "lineNumber": 1760
          },
          {
            "text": "    return ListenChatAgent(",
            "lineNumber": 1761
          },
          {
            "text": "        options.project_id,",
            "lineNumber": 1762
          },
          {
            "text": "        Agents.mcp_agent",
            "lineNumber": 1763
          }
        ]
      },
      "score": 0.3690914511680603
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\src\\store\\chatStore.ts",
        "range": {
          "startPosition": {
            "line": 162
          },
          "endPosition": {
            "line": 2594,
            "column": 1
          }
        },
        "contents": "const chatStore = \n(set, get) =&gt; (\nasync (taskId: string, type?: string, shareToken?: string, delayTime?: number, messageContent?: string, messageAttaches?: File[]) =&gt; {\n\nasync onmessage(event: any) {\n\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\t// Create agent\n\t\t\t\t\tif (agentMessages.step === \"create_agent\") {\n\t\t\t\t\t\tconst { agent_name, agent_id } = agentMessages.data;\n\t\t\t\t\t\tif (!agent_name || !agent_id) return;\n\n\t\t\t\t\t\t// Add agent to taskAssigning\n\t\t\t\t\t\tif (!['mcp_agent', 'new_worker_agent', 'task_agent', 'task_summary_agent', \"coordinator_agent\", \"question_confirm_agent\"].includes(agent_name)) {\n\t\t\t\t\t\t\t// if (agentNameMap[agent_name as keyof typeof agentNameMap]) {\n\t\t\t\t\t\t\tconst hasAgent = tasks[currentTaskId].taskAssigning.find((agent) =&gt; agent.agent_id === agent_id)\n\n\t\t\t\t\t\t\tif (!hasAgent) {\n\t\t\t\t\t\t\t\tlet activeWebviewIds: any = [];\n\t\t\t\t\t\t\t\tif (agent_name == 'browser_agent') {\n\t\t\t\t\t\t\t\t\tsnapshots.forEach((item: any) =&gt; {\n\t\t\t\t\t\t\t\t\t\tconst imgurl = !item.image_path.includes('/public') ? item.image_path : (import.meta.env.DEV ? import.meta.env.VITE_PROXY_URL : import.meta.env.VITE_BASE_URL) + item.image_path\n\t\t\t\t\t\t\t\t\t\tactiveWebviewIds.push({\n\t\t\t\t\t\t\t\t\t\t\tid: item.id,\n\t\t\t\t\t\t\t\t\t\t\timg: imgurl,\n\t\t\t\t\t\t\t\t\t\t\tprocessTaskId: item.camel_task_id,\n\t\t\t\t\t\t\t\t\t\t\turl: item.browser_url\n\t\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tsetTaskAssigning(currentTaskId, [...tasks[currentTaskId].taskAssigning, {\n\t\t\t\t\t\t\t\t\tagent_id,\n\t\t\t\t\t\t\t\t\tname: agentNameMap[agent_name as keyof typeof agentNameMap] || agent_name,\n\t\t\t\t\t\t\t\t\ttype: agent_name as AgentNameType,\n\t\t\t\t\t\t\t\t\ttasks: [],\n\t\t\t\t\t\t\t\t\tlog: [],\n\t\t\t\t\t\t\t\t\timg: [],\n\t\t\t\t\t\t\t\t\ttools: agentMessages.data.tools,\n\t\t\t\t\t\t\t\t\tactiveWebviewIds: activeWebviewIds,\n\t\t\t\t\t\t\t\t}])\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tif (agentMessages.step === \"wait_confirm\") {\n\t\t\t\t\t\tconst { content, question } = agentMessages.data;\n\t\t\t\t}\n\n\t\t}\n)\n;",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 163,
                "column": 1
              },
              "endPosition": {
                "line": 163,
                "column": 7
              }
            },
            {
              "startPosition": {
                "line": 163,
                "column": 7
              },
              "endPosition": {
                "line": 163,
                "column": 19
              }
            },
            {
              "startPosition": {
                "line": 163,
                "column": 53
              },
              "endPosition": {
                "line": 163,
                "column": 53
              }
            },
            {
              "startPosition": {
                "line": 164,
                "column": 2
              },
              "endPosition": {
                "line": 164,
                "column": 17
              }
            },
            {
              "startPosition": {
                "line": 331,
                "column": 14
              },
              "endPosition": {
                "line": 332,
                "column": 4
              }
            },
            {
              "startPosition": {
                "line": 586,
                "column": 4
              },
              "endPosition": {
                "line": 586,
                "column": 4
              }
            },
            {
              "startPosition": {
                "line": 612,
                "column": 5
              },
              "endPosition": {
                "line": 613,
                "column": 6
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "const chatStore = ",
            "lineNumber": 163
          },
          {
            "text": "(set, get) =&gt; (",
            "lineNumber": 164
          },
          {
            "text": "async (taskId: string, type?: string, shareToken?: string, delayTime?: number, messageContent?: string, messageAttaches?: File[]) =&gt; {",
            "lineNumber": 331
          },
          {
            "lineNumber": 586
          },
          {
            "text": "async onmessage(event: any) {",
            "lineNumber": 612
          },
          {
            "lineNumber": 928
          },
          {
            "text": "\t\t\t\t\t\treturn;",
            "lineNumber": 929
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 930
          },
          {
            "text": "\t\t\t\t\t// Create agent",
            "lineNumber": 931
          },
          {
            "text": "\t\t\t\t\tif (agentMessages.step === \"create_agent\") {",
            "lineNumber": 932
          },
          {
            "text": "\t\t\t\t\t\tconst { agent_name, agent_id } = agentMessages.data;",
            "lineNumber": 933
          },
          {
            "text": "\t\t\t\t\t\tif (!agent_name || !agent_id) return;",
            "lineNumber": 934
          },
          {
            "lineNumber": 935
          },
          {
            "text": "\t\t\t\t\t\t// Add agent to taskAssigning",
            "lineNumber": 936
          },
          {
            "text": "\t\t\t\t\t\tif (!['mcp_agent', 'new_worker_agent', 'task_agent', 'task_summary_agent', \"coordinator_agent\", \"question_confirm_agent\"].includes(agent_name)) {",
            "lineNumber": 937
          },
          {
            "text": "\t\t\t\t\t\t\t// if (agentNameMap[agent_name as keyof typeof agentNameMap]) {",
            "lineNumber": 938
          },
          {
            "text": "\t\t\t\t\t\t\tconst hasAgent = tasks[currentTaskId].taskAssigning.find((agent) =&gt; agent.agent_id === agent_id)",
            "lineNumber": 939
          },
          {
            "lineNumber": 940
          },
          {
            "text": "\t\t\t\t\t\t\tif (!hasAgent) {",
            "lineNumber": 941
          },
          {
            "text": "\t\t\t\t\t\t\t\tlet activeWebviewIds: any = [];",
            "lineNumber": 942
          },
          {
            "text": "\t\t\t\t\t\t\t\tif (agent_name == 'browser_agent') {",
            "lineNumber": 943
          },
          {
            "text": "\t\t\t\t\t\t\t\t\tsnapshots.forEach((item: any) =&gt; {",
            "lineNumber": 944
          },
          {
            "text": "\t\t\t\t\t\t\t\t\t\tconst imgurl = !item.image_path.includes('/public') ? item.image_path : (import.meta.env.DEV ? import.meta.env.VITE_PROXY_URL : import.meta.env.VITE_BASE_URL) + item.image_path",
            "lineNumber": 945
          },
          {
            "text": "\t\t\t\t\t\t\t\t\t\tactiveWebviewIds.push({",
            "lineNumber": 946
          },
          {
            "text": "\t\t\t\t\t\t\t\t\t\t\tid: item.id,",
            "lineNumber": 947
          },
          {
            "text": "\t\t\t\t\t\t\t\t\t\t\timg: imgurl,",
            "lineNumber": 948
          },
          {
            "text": "\t\t\t\t\t\t\t\t\t\t\tprocessTaskId: item.camel_task_id,",
            "lineNumber": 949
          },
          {
            "text": "\t\t\t\t\t\t\t\t\t\t\turl: item.browser_url",
            "lineNumber": 950
          },
          {
            "text": "\t\t\t\t\t\t\t\t\t\t})",
            "lineNumber": 951
          },
          {
            "text": "\t\t\t\t\t\t\t\t\t})",
            "lineNumber": 952
          },
          {
            "text": "\t\t\t\t\t\t\t\t}",
            "lineNumber": 953
          },
          {
            "text": "\t\t\t\t\t\t\t\tsetTaskAssigning(currentTaskId, [...tasks[currentTaskId].taskAssigning, {",
            "lineNumber": 954
          },
          {
            "text": "\t\t\t\t\t\t\t\t\tagent_id,",
            "lineNumber": 955
          },
          {
            "text": "\t\t\t\t\t\t\t\t\tname: agentNameMap[agent_name as keyof typeof agentNameMap] || agent_name,",
            "lineNumber": 956
          },
          {
            "text": "\t\t\t\t\t\t\t\t\ttype: agent_name as AgentNameType,",
            "lineNumber": 957
          },
          {
            "text": "\t\t\t\t\t\t\t\t\ttasks: [],",
            "lineNumber": 958
          },
          {
            "text": "\t\t\t\t\t\t\t\t\tlog: [],",
            "lineNumber": 959
          },
          {
            "text": "\t\t\t\t\t\t\t\t\timg: [],",
            "lineNumber": 960
          },
          {
            "text": "\t\t\t\t\t\t\t\t\ttools: agentMessages.data.tools,",
            "lineNumber": 961
          },
          {
            "text": "\t\t\t\t\t\t\t\t\tactiveWebviewIds: activeWebviewIds,",
            "lineNumber": 962
          },
          {
            "text": "\t\t\t\t\t\t\t\t}])",
            "lineNumber": 963
          },
          {
            "text": "\t\t\t\t\t\t\t}",
            "lineNumber": 964
          },
          {
            "text": "\t\t\t\t\t\t}",
            "lineNumber": 965
          },
          {
            "text": "\t\t\t\t\t\treturn;",
            "lineNumber": 966
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 967
          },
          {
            "text": "\t\t\t\t\tif (agentMessages.step === \"wait_confirm\") {",
            "lineNumber": 968
          },
          {
            "text": "\t\t\t\t\t\tconst { content, question } = agentMessages.data;",
            "lineNumber": 969
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 1836
          },
          {
            "lineNumber": 1886
          },
          {
            "text": "\t\t}",
            "lineNumber": 1888
          },
          {
            "text": ")",
            "lineNumber": 2594
          },
          {
            "text": ";",
            "lineNumber": 2595
          }
        ]
      },
      "score": 0.3680323362350464
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\controller\\task_controller.py",
        "range": {
          "startPosition": {
            "line": 57,
            "column": 36
          },
          "endPosition": {
            "line": 80
          }
        },
        "contents": "@router.post(\"/task/{id}/add-agent\", name=\"add new agent\")\n@traceroot.trace()\ndef add_agent(id: str, data: NewAgent):\n    logger.info(\"Adding new agent to task\", extra={\"task_id\": id, \"agent_name\": data.name})\n    logger.debug(\"New agent data\", extra={\"task_id\": id, \"agent_data\": data.model_dump_json()})\n    # Set user-specific environment path for this thread\n    set_user_env_path(data.env_path)\n    load_dotenv(dotenv_path=data.env_path)\n    asyncio.run(get_task_lock(id).put_queue(ActionNewAgent(**data.model_dump())))\n    logger.info(\"Agent added to task\", extra={\"task_id\": id, \"agent_name\": data.name})\n    return Response(status_code=204)\n\n\n@router.delete(\"/task/stop-all\", name=\"stop all tasks\")\n@traceroot.trace()\ndef stop_all():\n    logger.warning(\"Stopping all tasks\", extra={\"task_count\": len(task_locks)})",
        "signatures": {},
        "detailedLines": [
          {
            "text": "@router.post(\"/task/{id}/add-agent\", name=\"add new agent\")",
            "lineNumber": 61
          },
          {
            "text": "@traceroot.trace()",
            "lineNumber": 62
          },
          {
            "text": "def add_agent(id: str, data: NewAgent):",
            "lineNumber": 63,
            "isSignature": true
          },
          {
            "text": "    logger.info(\"Adding new agent to task\", extra={\"task_id\": id, \"agent_name\": data.name})",
            "lineNumber": 64
          },
          {
            "text": "    logger.debug(\"New agent data\", extra={\"task_id\": id, \"agent_data\": data.model_dump_json()})",
            "lineNumber": 65
          },
          {
            "text": "    # Set user-specific environment path for this thread",
            "lineNumber": 66
          },
          {
            "text": "    set_user_env_path(data.env_path)",
            "lineNumber": 67
          },
          {
            "text": "    load_dotenv(dotenv_path=data.env_path)",
            "lineNumber": 68
          },
          {
            "text": "    asyncio.run(get_task_lock(id).put_queue(ActionNewAgent(**data.model_dump())))",
            "lineNumber": 69
          },
          {
            "text": "    logger.info(\"Agent added to task\", extra={\"task_id\": id, \"agent_name\": data.name})",
            "lineNumber": 70
          },
          {
            "text": "    return Response(status_code=204)",
            "lineNumber": 71,
            "isSignature": true
          },
          {
            "lineNumber": 72
          },
          {
            "lineNumber": 73
          },
          {
            "text": "@router.delete(\"/task/stop-all\", name=\"stop all tasks\")",
            "lineNumber": 74
          },
          {
            "text": "@traceroot.trace()",
            "lineNumber": 75
          },
          {
            "text": "def stop_all():",
            "lineNumber": 76,
            "isSignature": true
          },
          {
            "text": "    logger.warning(\"Stopping all tasks\", extra={\"task_count\": len(task_locks)})",
            "lineNumber": 77
          }
        ]
      },
      "score": 0.36540481448173523
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\utils\\workforce.py",
        "range": {
          "startPosition": {
            "line": 35
          },
          "endPosition": {
            "line": 607
          }
        },
        "contents": "class Workforce(BaseWorkforce):\ndef eigent_make_sub_tasks(\n        self,\n        task: Task,\n        coordinator_context: str = \"\",\n        on_stream_batch=None,\n        on_stream_text=None,\n    ):\n\n        logger.info(f\"[DECOMPOSE] Workforce reset complete, state: {self._state.name}\")\n\n        logger.info(f\"[DECOMPOSE] Calling handle_decompose_append_task\")\n        subtasks = asyncio.run(\n            self.handle_decompose_append_task(\n                task, \n                reset=False, \n                coordinator_context=coordinator_context,\n                on_stream_batch=on_stream_batch, \n                on_stream_text=on_stream_text\n            )\n        )\n        logger.info(\"=\" * 80)\n        logger.info(f\"✅ [DECOMPOSE] Task decomposition COMPLETED\", extra={\n            \"api_task_id\": self.api_task_id,\n            \"task_id\": task.id,\n            \"subtasks_count\": len(subtasks)\n        })\n        logger.info(\"=\" * 80)\n        return subtasks\n\n    async def eigent_start(self, subtasks: list[Task]):\n        \"\"\"start the workforce\"\"\"\n        logger.info(\"=\" * 80)\n        logger.info(\"▶️  [WF-LIFECYCLE] eigent_start CALLED\", extra={\"api_task_id\": self.api_task_id, \"workforce_id\": id(self)})\n        logger.info(f\"[WF-LIFECYCLE] Starting workforce execution with {len(subtasks)} subtasks\")\n        logger.info(f\"[WF-LIFECYCLE] Current workforce state: {self._state.name}, _running: {self._running}\")\n        logger.info(\"=\" * 80)\n        self._pending_tasks.extendleft(reversed(subtasks))\n        # Save initial snapshot\n        self.save_snapshot(\"Initial task decomposition\")\n\n        try:\n            logger.info(f\"[WF-LIFECYCLE] Calling base class start() method\")",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 36,
                "column": 1
              },
              "endPosition": {
                "line": 37,
                "column": 5
              }
            },
            {
              "startPosition": {
                "line": 73,
                "column": 5
              },
              "endPosition": {
                "line": 80,
                "column": 9
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "class Workforce(BaseWorkforce):",
            "lineNumber": 36,
            "isSignature": true
          },
          {
            "text": "def eigent_make_sub_tasks(",
            "lineNumber": 73
          },
          {
            "text": "        self,",
            "lineNumber": 74
          },
          {
            "text": "        task: Task,",
            "lineNumber": 75
          },
          {
            "text": "        coordinator_context: str = \"\",",
            "lineNumber": 76
          },
          {
            "text": "        on_stream_batch=None,",
            "lineNumber": 77
          },
          {
            "text": "        on_stream_text=None,",
            "lineNumber": 78
          },
          {
            "text": "    ):",
            "lineNumber": 79
          },
          {
            "lineNumber": 115
          },
          {
            "text": "        logger.info(f\"[DECOMPOSE] Workforce reset complete, state: {self._state.name}\")",
            "lineNumber": 116
          },
          {
            "lineNumber": 117
          },
          {
            "text": "        logger.info(f\"[DECOMPOSE] Calling handle_decompose_append_task\")",
            "lineNumber": 118
          },
          {
            "text": "        subtasks = asyncio.run(",
            "lineNumber": 119
          },
          {
            "text": "            self.handle_decompose_append_task(",
            "lineNumber": 120
          },
          {
            "text": "                task, ",
            "lineNumber": 121
          },
          {
            "text": "                reset=False, ",
            "lineNumber": 122
          },
          {
            "text": "                coordinator_context=coordinator_context,",
            "lineNumber": 123
          },
          {
            "text": "                on_stream_batch=on_stream_batch, ",
            "lineNumber": 124
          },
          {
            "text": "                on_stream_text=on_stream_text",
            "lineNumber": 125
          },
          {
            "text": "            )",
            "lineNumber": 126
          },
          {
            "text": "        )",
            "lineNumber": 127
          },
          {
            "text": "        logger.info(\"=\" * 80)",
            "lineNumber": 128
          },
          {
            "text": "        logger.info(f\"✅ [DECOMPOSE] Task decomposition COMPLETED\", extra={",
            "lineNumber": 129
          },
          {
            "text": "            \"api_task_id\": self.api_task_id,",
            "lineNumber": 130
          },
          {
            "text": "            \"task_id\": task.id,",
            "lineNumber": 131
          },
          {
            "text": "            \"subtasks_count\": len(subtasks)",
            "lineNumber": 132
          },
          {
            "text": "        })",
            "lineNumber": 133
          },
          {
            "text": "        logger.info(\"=\" * 80)",
            "lineNumber": 134
          },
          {
            "text": "        return subtasks",
            "lineNumber": 135
          },
          {
            "lineNumber": 136
          },
          {
            "text": "    async def eigent_start(self, subtasks: list[Task]):",
            "lineNumber": 137
          },
          {
            "text": "        \"\"\"start the workforce\"\"\"",
            "lineNumber": 138
          },
          {
            "text": "        logger.info(\"=\" * 80)",
            "lineNumber": 139
          },
          {
            "text": "        logger.info(\"▶️  [WF-LIFECYCLE] eigent_start CALLED\", extra={\"api_task_id\": self.api_task_id, \"workforce_id\": id(self)})",
            "lineNumber": 140
          },
          {
            "text": "        logger.info(f\"[WF-LIFECYCLE] Starting workforce execution with {len(subtasks)} subtasks\")",
            "lineNumber": 141
          },
          {
            "text": "        logger.info(f\"[WF-LIFECYCLE] Current workforce state: {self._state.name}, _running: {self._running}\")",
            "lineNumber": 142
          },
          {
            "text": "        logger.info(\"=\" * 80)",
            "lineNumber": 143
          },
          {
            "text": "        self._pending_tasks.extendleft(reversed(subtasks))",
            "lineNumber": 144
          },
          {
            "text": "        # Save initial snapshot",
            "lineNumber": 145
          },
          {
            "text": "        self.save_snapshot(\"Initial task decomposition\")",
            "lineNumber": 146
          },
          {
            "lineNumber": 147
          },
          {
            "text": "        try:",
            "lineNumber": 148
          },
          {
            "text": "            logger.info(f\"[WF-LIFECYCLE] Calling base class start() method\")",
            "lineNumber": 149
          }
        ]
      },
      "score": 0.35858070850372314
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\service\\chat_service.py",
        "range": {
          "startPosition": {
            "line": 1452,
            "column": 38
          },
          "endPosition": {
            "line": 1479,
            "column": 94
          }
        },
        "contents": "@traceroot.trace()\nasync def new_agent_model(data: NewAgent | ActionNewAgent, options: Chat):\n    logger.info(\"Creating new agent\", extra={\"agent_name\": data.name, \"project_id\": options.project_id, \"task_id\": options.task_id})\n    logger.debug(\"New agent data\", extra={\"agent_data\": data.model_dump_json()})\n    working_directory = get_working_directory(options)\n    tool_names = []\n    tools = [*await get_toolkits(data.tools, data.name, options.project_id)]\n    for item in data.tools:\n        tool_names.append(titleize(item))\n    if data.mcp_tools is not None:\n        tools = [*tools, *await get_mcp_tools(data.mcp_tools)]\n        for item in data.mcp_tools[\"mcpServers\"].keys():\n            tool_names.append(titleize(item))\n    for item in tools:\n        logger.debug(f\"Agent {data.name} tool: {item.func.__name__}\")\n    logger.info(f\"Agent {data.name} created with {len(tools)} tools: {tool_names}\")\n    # Enhanced system message with platform information\n    enhanced_description = f\"\"\"{data.description}\n- You are now working in system {platform.system()} with architecture\n{platform.machine()} at working directory &#96;{working_directory}&#96;. All local file operations must occur here, but you can access files from any place in the file system. For all file system operations, you MUST use absolute paths to ensure precision and avoid ambiguity.\nThe current date is {datetime.date.today()}. For any date-related tasks, you \nMUST use this as the current date.\n\"\"\"\n\n    return agent_model(data.name, enhanced_description, options, tools, tool_names=tool_names)",
        "signatures": {},
        "detailedLines": [
          {
            "text": "@traceroot.trace()",
            "lineNumber": 1456
          },
          {
            "text": "async def new_agent_model(data: NewAgent | ActionNewAgent, options: Chat):",
            "lineNumber": 1457,
            "isSignature": true
          },
          {
            "text": "    logger.info(\"Creating new agent\", extra={\"agent_name\": data.name, \"project_id\": options.project_id, \"task_id\": options.task_id})",
            "lineNumber": 1458
          },
          {
            "text": "    logger.debug(\"New agent data\", extra={\"agent_data\": data.model_dump_json()})",
            "lineNumber": 1459
          },
          {
            "text": "    working_directory = get_working_directory(options)",
            "lineNumber": 1460
          },
          {
            "text": "    tool_names = []",
            "lineNumber": 1461
          },
          {
            "text": "    tools = [*await get_toolkits(data.tools, data.name, options.project_id)]",
            "lineNumber": 1462
          },
          {
            "text": "    for item in data.tools:",
            "lineNumber": 1463
          },
          {
            "text": "        tool_names.append(titleize(item))",
            "lineNumber": 1464
          },
          {
            "text": "    if data.mcp_tools is not None:",
            "lineNumber": 1465
          },
          {
            "text": "        tools = [*tools, *await get_mcp_tools(data.mcp_tools)]",
            "lineNumber": 1466
          },
          {
            "text": "        for item in data.mcp_tools[\"mcpServers\"].keys():",
            "lineNumber": 1467
          },
          {
            "text": "            tool_names.append(titleize(item))",
            "lineNumber": 1468
          },
          {
            "text": "    for item in tools:",
            "lineNumber": 1469
          },
          {
            "text": "        logger.debug(f\"Agent {data.name} tool: {item.func.__name__}\")",
            "lineNumber": 1470
          },
          {
            "text": "    logger.info(f\"Agent {data.name} created with {len(tools)} tools: {tool_names}\")",
            "lineNumber": 1471
          },
          {
            "text": "    # Enhanced system message with platform information",
            "lineNumber": 1472
          },
          {
            "text": "    enhanced_description = f\"\"\"{data.description}",
            "lineNumber": 1473
          },
          {
            "text": "- You are now working in system {platform.system()} with architecture",
            "lineNumber": 1474
          },
          {
            "text": "{platform.machine()} at working directory &#96;{working_directory}&#96;. All local file operations must occur here, but you can access files from any place in the file system. For all file system operations, you MUST use absolute paths to ensure precision and avoid ambiguity.",
            "lineNumber": 1475
          },
          {
            "text": "The current date is {datetime.date.today()}. For any date-related tasks, you ",
            "lineNumber": 1476
          },
          {
            "text": "MUST use this as the current date.",
            "lineNumber": 1477
          },
          {
            "text": "\"\"\"",
            "lineNumber": 1478
          },
          {
            "lineNumber": 1479
          },
          {
            "text": "    return agent_model(data.name, enhanced_description, options, tools, tool_names=tool_names)",
            "lineNumber": 1480,
            "isSignature": true
          }
        ]
      },
      "score": 0.3584004044532776
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\utils\\agent.py",
        "range": {
          "startPosition": {
            "line": 1165,
            "column": 5
          },
          "endPosition": {
            "line": 1388
          }
        },
        "contents": "@traceroot.trace()\nasync def document_agent(options: Chat):\n    working_directory = get_working_directory(options)\n    traceroot_logger.info(\n        f\"Creating document agent for project: {options.project_id} in directory: {working_directory}\"\n    )\n    message_integration = ToolkitMessageIntegration(\n        message_handler=HumanToolkit(\n            options.project_id, Agents.task_agent\n        ).send_message_to_user\n    )\n    file_write_toolkit = FileToolkit(\n        options.project_id, working_directory=working_directory\n    )\n    pptx_toolkit = PPTXToolkit(options.project_id, working_directory=working_directory)\n    pptx_toolkit = message_integration.register_toolkits(pptx_toolkit)\n    mark_it_down_toolkit = MarkItDownToolkit(options.project_id)\n    mark_it_down_toolkit = message_integration.register_toolkits(mark_it_down_toolkit)\n    excel_toolkit = ExcelToolkit(\n        options.project_id, working_directory=working_directory\n    )\n    excel_toolkit = message_integration.register_toolkits(excel_toolkit)\n    note_toolkit = NoteTakingToolkit(\n        options.project_id, Agents.document_agent, working_directory=working_directory\n    )\n    note_toolkit = message_integration.register_toolkits(note_toolkit)\n    terminal_toolkit = TerminalToolkit(\n        options.project_id,\n        Agents.document_agent,\n        safe_mode=True,\n        clone_current_env=False,\n    )\n    terminal_toolkit = message_integration.register_toolkits(terminal_toolkit)\n    tools = [\n        *file_write_toolkit.get_tools(),\n        *pptx_toolkit.get_tools(),\n        *HumanToolkit.get_can_use_tools(options.project_id, Agents.document_agent),\n        *mark_it_down_toolkit.get_tools(),\n        *excel_toolkit.get_tools(),\n        *note_toolkit.get_tools(),\n        *terminal_toolkit.get_tools(),\n        *await GoogleDriveMCPToolkit.get_can_use_tools(\n            options.project_id, options.get_bun_env()\n        ),\n    ]\n    # if env(\"EXA_API_KEY\") or options.is_cloud():\n    #     search_toolkit = SearchToolkit(options.project_id, Agents.document_agent).search_exa",
        "signatures": {},
        "detailedLines": [
          {
            "text": "@traceroot.trace()",
            "lineNumber": 1169
          },
          {
            "text": "async def document_agent(options: Chat):",
            "lineNumber": 1170,
            "isSignature": true
          },
          {
            "text": "    working_directory = get_working_directory(options)",
            "lineNumber": 1171
          },
          {
            "text": "    traceroot_logger.info(",
            "lineNumber": 1172
          },
          {
            "text": "        f\"Creating document agent for project: {options.project_id} in directory: {working_directory}\"",
            "lineNumber": 1173
          },
          {
            "text": "    )",
            "lineNumber": 1174
          },
          {
            "text": "    message_integration = ToolkitMessageIntegration(",
            "lineNumber": 1175
          },
          {
            "text": "        message_handler=HumanToolkit(",
            "lineNumber": 1176
          },
          {
            "text": "            options.project_id, Agents.task_agent",
            "lineNumber": 1177
          },
          {
            "text": "        ).send_message_to_user",
            "lineNumber": 1178
          },
          {
            "text": "    )",
            "lineNumber": 1179
          },
          {
            "text": "    file_write_toolkit = FileToolkit(",
            "lineNumber": 1180
          },
          {
            "text": "        options.project_id, working_directory=working_directory",
            "lineNumber": 1181
          },
          {
            "text": "    )",
            "lineNumber": 1182
          },
          {
            "text": "    pptx_toolkit = PPTXToolkit(options.project_id, working_directory=working_directory)",
            "lineNumber": 1183
          },
          {
            "text": "    pptx_toolkit = message_integration.register_toolkits(pptx_toolkit)",
            "lineNumber": 1184
          },
          {
            "text": "    mark_it_down_toolkit = MarkItDownToolkit(options.project_id)",
            "lineNumber": 1185
          },
          {
            "text": "    mark_it_down_toolkit = message_integration.register_toolkits(mark_it_down_toolkit)",
            "lineNumber": 1186
          },
          {
            "text": "    excel_toolkit = ExcelToolkit(",
            "lineNumber": 1187
          },
          {
            "text": "        options.project_id, working_directory=working_directory",
            "lineNumber": 1188
          },
          {
            "text": "    )",
            "lineNumber": 1189
          },
          {
            "text": "    excel_toolkit = message_integration.register_toolkits(excel_toolkit)",
            "lineNumber": 1190
          },
          {
            "text": "    note_toolkit = NoteTakingToolkit(",
            "lineNumber": 1191
          },
          {
            "text": "        options.project_id, Agents.document_agent, working_directory=working_directory",
            "lineNumber": 1192
          },
          {
            "text": "    )",
            "lineNumber": 1193
          },
          {
            "text": "    note_toolkit = message_integration.register_toolkits(note_toolkit)",
            "lineNumber": 1194
          },
          {
            "text": "    terminal_toolkit = TerminalToolkit(",
            "lineNumber": 1195
          },
          {
            "text": "        options.project_id,",
            "lineNumber": 1196
          },
          {
            "text": "        Agents.document_agent,",
            "lineNumber": 1197
          },
          {
            "text": "        safe_mode=True,",
            "lineNumber": 1198
          },
          {
            "text": "        clone_current_env=False,",
            "lineNumber": 1199
          },
          {
            "text": "    )",
            "lineNumber": 1200
          },
          {
            "text": "    terminal_toolkit = message_integration.register_toolkits(terminal_toolkit)",
            "lineNumber": 1201
          },
          {
            "text": "    tools = [",
            "lineNumber": 1202
          },
          {
            "text": "        *file_write_toolkit.get_tools(),",
            "lineNumber": 1203
          },
          {
            "text": "        *pptx_toolkit.get_tools(),",
            "lineNumber": 1204
          },
          {
            "text": "        *HumanToolkit.get_can_use_tools(options.project_id, Agents.document_agent),",
            "lineNumber": 1205
          },
          {
            "text": "        *mark_it_down_toolkit.get_tools(),",
            "lineNumber": 1206
          },
          {
            "text": "        *excel_toolkit.get_tools(),",
            "lineNumber": 1207
          },
          {
            "text": "        *note_toolkit.get_tools(),",
            "lineNumber": 1208
          },
          {
            "text": "        *terminal_toolkit.get_tools(),",
            "lineNumber": 1209
          },
          {
            "text": "        *await GoogleDriveMCPToolkit.get_can_use_tools(",
            "lineNumber": 1210
          },
          {
            "text": "            options.project_id, options.get_bun_env()",
            "lineNumber": 1211
          },
          {
            "text": "        ),",
            "lineNumber": 1212
          },
          {
            "text": "    ]",
            "lineNumber": 1213
          },
          {
            "text": "    # if env(\"EXA_API_KEY\") or options.is_cloud():",
            "lineNumber": 1214
          },
          {
            "text": "    #     search_toolkit = SearchToolkit(options.project_id, Agents.document_agent).search_exa",
            "lineNumber": 1215
          }
        ]
      },
      "score": 0.3580726981163025
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\service\\chat_service.py",
        "range": {
          "startPosition": {
            "line": 1300
          },
          "endPosition": {
            "line": 1452
          }
        },
        "contents": "@traceroot.trace()\nasync def construct_workforce(options: Chat) -&gt; tuple[Workforce, ListenChatAgent]:\n\n    # workforce.add_single_agent_worker(\n    #     \"MCP Agent: A Model Context Protocol agent that provides access \"\n    #     \"to external tools and services through MCP integrations.\",\n    #     mcp,\n    # )\n    return workforce, mcp\n\n\ndef format_agent_description(agent_data: NewAgent | ActionNewAgent) -&gt; str:\n    ",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 1301,
                "column": 1
              },
              "endPosition": {
                "line": 1302,
                "column": 1
              }
            },
            {
              "startPosition": {
                "line": 1302,
                "column": 1
              },
              "endPosition": {
                "line": 1303,
                "column": 5
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "@traceroot.trace()",
            "lineNumber": 1301
          },
          {
            "text": "async def construct_workforce(options: Chat) -&gt; tuple[Workforce, ListenChatAgent]:",
            "lineNumber": 1302,
            "isSignature": true
          },
          {
            "lineNumber": 1419
          },
          {
            "text": "    # workforce.add_single_agent_worker(",
            "lineNumber": 1420
          },
          {
            "text": "    #     \"MCP Agent: A Model Context Protocol agent that provides access \"",
            "lineNumber": 1421
          },
          {
            "text": "    #     \"to external tools and services through MCP integrations.\",",
            "lineNumber": 1422
          },
          {
            "text": "    #     mcp,",
            "lineNumber": 1423
          },
          {
            "text": "    # )",
            "lineNumber": 1424
          },
          {
            "text": "    return workforce, mcp",
            "lineNumber": 1425,
            "isSignature": true
          },
          {
            "lineNumber": 1426
          },
          {
            "lineNumber": 1427
          },
          {
            "text": "def format_agent_description(agent_data: NewAgent | ActionNewAgent) -&gt; str:",
            "lineNumber": 1428,
            "isSignature": true
          },
          {
            "text": "    ",
            "lineNumber": 1429
          }
        ]
      },
      "score": 0.3560008108615875
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\utils\\agent.py",
        "range": {
          "startPosition": {
            "line": 774,
            "column": 5
          },
          "endPosition": {
            "line": 964
          }
        },
        "contents": "@traceroot.trace()\nasync def developer_agent(options: Chat):\n    working_directory = get_working_directory(options)\n    traceroot_logger.info(\n        f\"Creating developer agent for project: {options.project_id} in directory: {working_directory}\"\n    )\n    message_integration = ToolkitMessageIntegration(\n        message_handler=HumanToolkit(\n            options.project_id, Agents.developer_agent\n        ).send_message_to_user\n    )\n    note_toolkit = NoteTakingToolkit(\n        api_task_id=options.project_id,\n        agent_name=Agents.developer_agent,\n        working_directory=working_directory,\n    )\n    note_toolkit = message_integration.register_toolkits(note_toolkit)\n    web_deploy_toolkit = WebDeployToolkit(api_task_id=options.project_id)\n    web_deploy_toolkit = message_integration.register_toolkits(web_deploy_toolkit)\n    screenshot_toolkit = ScreenshotToolkit(\n        options.project_id, working_directory=working_directory\n    )\n    screenshot_toolkit = message_integration.register_toolkits(screenshot_toolkit)\n\n    terminal_toolkit = TerminalToolkit(\n        options.project_id,\n        Agents.document_agent,\n        safe_mode=True,\n        clone_current_env=False,\n    )\n    terminal_toolkit = message_integration.register_toolkits(terminal_toolkit)\n\n    tools = [\n        *HumanToolkit.get_can_use_tools(options.project_id, Agents.developer_agent),\n        *note_toolkit.get_tools(),\n        *web_deploy_toolkit.get_tools(),\n        *terminal_toolkit.get_tools(),\n        *screenshot_toolkit.get_tools(),\n    ]\n    system_message = f\"\"\"\n&lt;role&gt;\nYou are a Lead Software Engineer, a master-level coding assistant with a\npowerful and unrestricted terminal. Your primary role is to solve any\ntechnical task by writing and executing code, installing necessary libraries,\ninteracting with the operating system, and deploying applications. You are the\nteam's go-to expert for all technical implementation.\n&lt;/role&gt;\n\n&lt;team_structure&gt;\nYou collaborate with the following agents who can work in parallel:\n- **Senior Research Analyst**: Gathers information from the web to support\nyour development tasks.\n- **Documentation Specialist**: Creates and manages technical and user-facing\ndocuments.\n- **Creative Content Specialist**: Handles image, audio, and video processing\nand generation.\n&lt;/team_structure&gt;\n\n&lt;operating_environment&gt;\n- **System**: ",
        "signatures": {},
        "detailedLines": [
          {
            "text": "@traceroot.trace()",
            "lineNumber": 778
          },
          {
            "text": "async def developer_agent(options: Chat):",
            "lineNumber": 779,
            "isSignature": true
          },
          {
            "text": "    working_directory = get_working_directory(options)",
            "lineNumber": 780
          },
          {
            "text": "    traceroot_logger.info(",
            "lineNumber": 781
          },
          {
            "text": "        f\"Creating developer agent for project: {options.project_id} in directory: {working_directory}\"",
            "lineNumber": 782
          },
          {
            "text": "    )",
            "lineNumber": 783
          },
          {
            "text": "    message_integration = ToolkitMessageIntegration(",
            "lineNumber": 784
          },
          {
            "text": "        message_handler=HumanToolkit(",
            "lineNumber": 785
          },
          {
            "text": "            options.project_id, Agents.developer_agent",
            "lineNumber": 786
          },
          {
            "text": "        ).send_message_to_user",
            "lineNumber": 787
          },
          {
            "text": "    )",
            "lineNumber": 788
          },
          {
            "text": "    note_toolkit = NoteTakingToolkit(",
            "lineNumber": 789
          },
          {
            "text": "        api_task_id=options.project_id,",
            "lineNumber": 790
          },
          {
            "text": "        agent_name=Agents.developer_agent,",
            "lineNumber": 791
          },
          {
            "text": "        working_directory=working_directory,",
            "lineNumber": 792
          },
          {
            "text": "    )",
            "lineNumber": 793
          },
          {
            "text": "    note_toolkit = message_integration.register_toolkits(note_toolkit)",
            "lineNumber": 794
          },
          {
            "text": "    web_deploy_toolkit = WebDeployToolkit(api_task_id=options.project_id)",
            "lineNumber": 795
          },
          {
            "text": "    web_deploy_toolkit = message_integration.register_toolkits(web_deploy_toolkit)",
            "lineNumber": 796
          },
          {
            "text": "    screenshot_toolkit = ScreenshotToolkit(",
            "lineNumber": 797
          },
          {
            "text": "        options.project_id, working_directory=working_directory",
            "lineNumber": 798
          },
          {
            "text": "    )",
            "lineNumber": 799
          },
          {
            "text": "    screenshot_toolkit = message_integration.register_toolkits(screenshot_toolkit)",
            "lineNumber": 800
          },
          {
            "lineNumber": 801
          },
          {
            "text": "    terminal_toolkit = TerminalToolkit(",
            "lineNumber": 802
          },
          {
            "text": "        options.project_id,",
            "lineNumber": 803
          },
          {
            "text": "        Agents.document_agent,",
            "lineNumber": 804
          },
          {
            "text": "        safe_mode=True,",
            "lineNumber": 805
          },
          {
            "text": "        clone_current_env=False,",
            "lineNumber": 806
          },
          {
            "text": "    )",
            "lineNumber": 807
          },
          {
            "text": "    terminal_toolkit = message_integration.register_toolkits(terminal_toolkit)",
            "lineNumber": 808
          },
          {
            "lineNumber": 809
          },
          {
            "text": "    tools = [",
            "lineNumber": 810
          },
          {
            "text": "        *HumanToolkit.get_can_use_tools(options.project_id, Agents.developer_agent),",
            "lineNumber": 811
          },
          {
            "text": "        *note_toolkit.get_tools(),",
            "lineNumber": 812
          },
          {
            "text": "        *web_deploy_toolkit.get_tools(),",
            "lineNumber": 813
          },
          {
            "text": "        *terminal_toolkit.get_tools(),",
            "lineNumber": 814
          },
          {
            "text": "        *screenshot_toolkit.get_tools(),",
            "lineNumber": 815
          },
          {
            "text": "    ]",
            "lineNumber": 816
          },
          {
            "text": "    system_message = f\"\"\"",
            "lineNumber": 817
          },
          {
            "text": "&lt;role&gt;",
            "lineNumber": 818
          },
          {
            "text": "You are a Lead Software Engineer, a master-level coding assistant with a",
            "lineNumber": 819
          },
          {
            "text": "powerful and unrestricted terminal. Your primary role is to solve any",
            "lineNumber": 820
          },
          {
            "text": "technical task by writing and executing code, installing necessary libraries,",
            "lineNumber": 821
          },
          {
            "text": "interacting with the operating system, and deploying applications. You are the",
            "lineNumber": 822
          },
          {
            "text": "team's go-to expert for all technical implementation.",
            "lineNumber": 823
          },
          {
            "text": "&lt;/role&gt;",
            "lineNumber": 824
          },
          {
            "lineNumber": 825
          },
          {
            "text": "&lt;team_structure&gt;",
            "lineNumber": 826
          },
          {
            "text": "You collaborate with the following agents who can work in parallel:",
            "lineNumber": 827
          },
          {
            "text": "- **Senior Research Analyst**: Gathers information from the web to support",
            "lineNumber": 828
          },
          {
            "text": "your development tasks.",
            "lineNumber": 829
          },
          {
            "text": "- **Documentation Specialist**: Creates and manages technical and user-facing",
            "lineNumber": 830
          },
          {
            "text": "documents.",
            "lineNumber": 831
          },
          {
            "text": "- **Creative Content Specialist**: Handles image, audio, and video processing",
            "lineNumber": 832
          },
          {
            "text": "and generation.",
            "lineNumber": 833
          },
          {
            "text": "&lt;/team_structure&gt;",
            "lineNumber": 834
          },
          {
            "lineNumber": 835
          },
          {
            "text": "&lt;operating_environment&gt;",
            "lineNumber": 836
          },
          {
            "text": "- **System**: ",
            "lineNumber": 837
          }
        ]
      },
      "score": 0.35405638813972473
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\pass\\sequence_diagram.md",
        "range": {
          "startPosition": {
            "line": 78
          },
          "endPosition": {
            "line": 115
          }
        },
        "contents": "        CS-&gt;&gt;Agent: L228: Creating developer_agent\n        CS-&gt;&gt;Agent: L230: Creating document agent\n        CS-&gt;&gt;Toolkit: L232: Initializing TerminalToolkit\n        CS-&gt;&gt;Agent: L234: Creating document_agent\n        CS-&gt;&gt;Agent: L236: Creating multi-modal agent\n        CS-&gt;&gt;Toolkit: L238: Initializing TerminalToolkit\n        CS-&gt;&gt;Agent: L240: Creating multi_modal_agent\n        WF-&gt;&gt;WF: L243: Workforce.__init__ STARTED\n        WF--&gt;&gt;CS: L252: Workforce.__init__ COMPLETED, id=1858562309904\n        CS-&gt;&gt;SAW: L253: Initializing SingleAgentWorker\n        CS-&gt;&gt;Toolkit: L258: HybridBrowserToolkit Initializing\n        Toolkit--&gt;&gt;CS: L261: HybridBrowserToolkit Initialization complete\n        CS-&gt;&gt;Agent: L270: Creating MCP agent\n        CS-&gt;&gt;CS: L274: NEW Workforce instance created\n        CS-&gt;&gt;CS: L275: Creating NEW camel_task\n        \n        Note over User,TS: 任務分解階段\n        CS-&gt;&gt;WF: L276: Starting task decomposition via workforce.eigent_make_sub_tasks\n        WF-&gt;&gt;WF: L282: eigent_make_sub_tasks CALLED\n        WF-&gt;&gt;WF: L287: Resetting workforce state\n        sync_step-&gt;&gt;sync_step: L294: Failed to sync step (❌Error)\n        WF-&gt;&gt;Toolkit: L296: HybridBrowserToolkit Initializing\n        Toolkit--&gt;&gt;WF: L299: HybridBrowserToolkit&lt;br/&gt; Initialization complete\n        WF-&gt;&gt;WF: L304: Workforce reset complete, state: RUNNING\n        WF-&gt;&gt;WF: L305: Calling handle_decompose_append_task\n        WF-&gt;&gt;WF: L308: handle_decompose_append_task CALLED\n        WF-&gt;&gt;WF: L309: Calling _decompose_task without context\n        WF-&gt;&gt;WF: L314: Collected 1 subtasks from generator\n        WF-&gt;&gt;WF: L315: Appended 1 subtasks to pending tasks\n        WF-&gt;&gt;WF: L320: Task decomposition COMPLETED\n        WF--&gt;&gt;CS: L322: Task decomposed into 1 subtasks\n        \n        Note over User,TS: 生成任務摘要\n        CS-&gt;&gt;CS: L323: Generating task summary\n        CS-&gt;&gt;Agent: L324: Creating task_summary_agent\n        Agent-&gt;&gt;Agent: L330: Agent task_summary_agent starting step\n        Agent--&gt;&gt;CS: L356: Agent task_summary_agent completed step",
        "signatures": {},
        "detailedLines": [
          {
            "text": "        CS-&gt;&gt;Agent: L228: Creating developer_agent",
            "lineNumber": 79
          },
          {
            "text": "        CS-&gt;&gt;Agent: L230: Creating document agent",
            "lineNumber": 80
          },
          {
            "text": "        CS-&gt;&gt;Toolkit: L232: Initializing TerminalToolkit",
            "lineNumber": 81
          },
          {
            "text": "        CS-&gt;&gt;Agent: L234: Creating document_agent",
            "lineNumber": 82
          },
          {
            "text": "        CS-&gt;&gt;Agent: L236: Creating multi-modal agent",
            "lineNumber": 83
          },
          {
            "text": "        CS-&gt;&gt;Toolkit: L238: Initializing TerminalToolkit",
            "lineNumber": 84
          },
          {
            "text": "        CS-&gt;&gt;Agent: L240: Creating multi_modal_agent",
            "lineNumber": 85
          },
          {
            "text": "        WF-&gt;&gt;WF: L243: Workforce.__init__ STARTED",
            "lineNumber": 86
          },
          {
            "text": "        WF--&gt;&gt;CS: L252: Workforce.__init__ COMPLETED, id=1858562309904",
            "lineNumber": 87
          },
          {
            "text": "        CS-&gt;&gt;SAW: L253: Initializing SingleAgentWorker",
            "lineNumber": 88
          },
          {
            "text": "        CS-&gt;&gt;Toolkit: L258: HybridBrowserToolkit Initializing",
            "lineNumber": 89
          },
          {
            "text": "        Toolkit--&gt;&gt;CS: L261: HybridBrowserToolkit Initialization complete",
            "lineNumber": 90
          },
          {
            "text": "        CS-&gt;&gt;Agent: L270: Creating MCP agent",
            "lineNumber": 91
          },
          {
            "text": "        CS-&gt;&gt;CS: L274: NEW Workforce instance created",
            "lineNumber": 92
          },
          {
            "text": "        CS-&gt;&gt;CS: L275: Creating NEW camel_task",
            "lineNumber": 93
          },
          {
            "text": "        ",
            "lineNumber": 94
          },
          {
            "text": "        Note over User,TS: 任務分解階段",
            "lineNumber": 95
          },
          {
            "text": "        CS-&gt;&gt;WF: L276: Starting task decomposition via workforce.eigent_make_sub_tasks",
            "lineNumber": 96
          },
          {
            "text": "        WF-&gt;&gt;WF: L282: eigent_make_sub_tasks CALLED",
            "lineNumber": 97
          },
          {
            "text": "        WF-&gt;&gt;WF: L287: Resetting workforce state",
            "lineNumber": 98
          },
          {
            "text": "        sync_step-&gt;&gt;sync_step: L294: Failed to sync step (❌Error)",
            "lineNumber": 99
          },
          {
            "text": "        WF-&gt;&gt;Toolkit: L296: HybridBrowserToolkit Initializing",
            "lineNumber": 100
          },
          {
            "text": "        Toolkit--&gt;&gt;WF: L299: HybridBrowserToolkit&lt;br/&gt; Initialization complete",
            "lineNumber": 101
          },
          {
            "text": "        WF-&gt;&gt;WF: L304: Workforce reset complete, state: RUNNING",
            "lineNumber": 102
          },
          {
            "text": "        WF-&gt;&gt;WF: L305: Calling handle_decompose_append_task",
            "lineNumber": 103
          },
          {
            "text": "        WF-&gt;&gt;WF: L308: handle_decompose_append_task CALLED",
            "lineNumber": 104
          },
          {
            "text": "        WF-&gt;&gt;WF: L309: Calling _decompose_task without context",
            "lineNumber": 105
          },
          {
            "text": "        WF-&gt;&gt;WF: L314: Collected 1 subtasks from generator",
            "lineNumber": 106
          },
          {
            "text": "        WF-&gt;&gt;WF: L315: Appended 1 subtasks to pending tasks",
            "lineNumber": 107
          },
          {
            "text": "        WF-&gt;&gt;WF: L320: Task decomposition COMPLETED",
            "lineNumber": 108
          },
          {
            "text": "        WF--&gt;&gt;CS: L322: Task decomposed into 1 subtasks",
            "lineNumber": 109
          },
          {
            "text": "        ",
            "lineNumber": 110
          },
          {
            "text": "        Note over User,TS: 生成任務摘要",
            "lineNumber": 111
          },
          {
            "text": "        CS-&gt;&gt;CS: L323: Generating task summary",
            "lineNumber": 112
          },
          {
            "text": "        CS-&gt;&gt;Agent: L324: Creating task_summary_agent",
            "lineNumber": 113
          },
          {
            "text": "        Agent-&gt;&gt;Agent: L330: Agent task_summary_agent starting step",
            "lineNumber": 114
          },
          {
            "text": "        Agent--&gt;&gt;CS: L356: Agent task_summary_agent completed step",
            "lineNumber": 115
          }
        ]
      },
      "score": 0.35342198610305786
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\component\\model_validation.py",
        "range": {
          "startPosition": {
            "line": 14,
            "column": 119
          },
          "endPosition": {
            "line": 41,
            "column": 16
          }
        },
        "contents": "def create_agent(\n    model_platform: str, model_type: str, api_key: str = None, url: str = None, model_config_dict: dict = None, **kwargs\n) -&gt; ChatAgent:\n    platform = model_platform\n    mtype = model_type\n    if mtype is None:\n        raise ValueError(f\"Invalid model_type: {model_type}\")\n    if platform is None:\n        raise ValueError(f\"Invalid model_platform: {model_platform}\")\n    model = ModelFactory.create(\n        model_platform=platform,\n        model_type=mtype,\n        api_key=api_key,\n        url=url,\n        timeout=10,\n        model_config_dict=model_config_dict,\n        **kwargs,\n    )\n    agent = ChatAgent(\n        system_message=\"You are a helpful assistant that must use the tool get_website_content to get the content of a website.\",\n        model=model,\n        tools=[get_website_content],\n        step_timeout=900,\n    )\n    return agent",
        "signatures": {},
        "detailedLines": [
          {
            "text": "def create_agent(",
            "lineNumber": 18,
            "isSignature": true
          },
          {
            "text": "    model_platform: str, model_type: str, api_key: str = None, url: str = None, model_config_dict: dict = None, **kwargs",
            "lineNumber": 19,
            "isSignature": true
          },
          {
            "text": ") -&gt; ChatAgent:",
            "lineNumber": 20,
            "isSignature": true
          },
          {
            "text": "    platform = model_platform",
            "lineNumber": 21
          },
          {
            "text": "    mtype = model_type",
            "lineNumber": 22
          },
          {
            "text": "    if mtype is None:",
            "lineNumber": 23
          },
          {
            "text": "        raise ValueError(f\"Invalid model_type: {model_type}\")",
            "lineNumber": 24
          },
          {
            "text": "    if platform is None:",
            "lineNumber": 25
          },
          {
            "text": "        raise ValueError(f\"Invalid model_platform: {model_platform}\")",
            "lineNumber": 26
          },
          {
            "text": "    model = ModelFactory.create(",
            "lineNumber": 27
          },
          {
            "text": "        model_platform=platform,",
            "lineNumber": 28
          },
          {
            "text": "        model_type=mtype,",
            "lineNumber": 29
          },
          {
            "text": "        api_key=api_key,",
            "lineNumber": 30
          },
          {
            "text": "        url=url,",
            "lineNumber": 31
          },
          {
            "text": "        timeout=10,",
            "lineNumber": 32
          },
          {
            "text": "        model_config_dict=model_config_dict,",
            "lineNumber": 33
          },
          {
            "text": "        **kwargs,",
            "lineNumber": 34
          },
          {
            "text": "    )",
            "lineNumber": 35
          },
          {
            "text": "    agent = ChatAgent(",
            "lineNumber": 36
          },
          {
            "text": "        system_message=\"You are a helpful assistant that must use the tool get_website_content to get the content of a website.\",",
            "lineNumber": 37
          },
          {
            "text": "        model=model,",
            "lineNumber": 38
          },
          {
            "text": "        tools=[get_website_content],",
            "lineNumber": 39
          },
          {
            "text": "        step_timeout=900,",
            "lineNumber": 40
          },
          {
            "text": "    )",
            "lineNumber": 41
          },
          {
            "text": "    return agent",
            "lineNumber": 42,
            "isSignature": true
          }
        ]
      },
      "score": 0.35337376594543457
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\docs\\core\\workforce.md",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 46
          }
        },
        "contents": "---\ntitle: Workforce\ndescription: Understand core concepts and features that power Eigent.\nicon: cubes\n---\n## Concept: What is a Workforce?\n\nWorkforce is CAMEL-AI's multi-agent teamwork engine. \n\nInstead of relying on a single agent, Workforce lets you organize a *team* of specialized agents—each with its own strengths—under a single, coordinated system. You can quickly assemble, configure, and launch collaborative agent \"workforces\" for any task that needs parallelization, diverse expertise, or complex workflows.\n\nWith Workforce, agents plan, solve, and verify work together—like a project team in an organization, but fully automated.\n\n\n&lt;aside&gt;\n**📌 Key advantages of Workforce:**\n\n- Instantly scale from single-agent to multi-agent workflows\n- Built-in coordination, planning, and failure recovery\n- Ideal for hackathons, evaluations, code review, brainstorming, and more\n- Configure roles, toolsets, and communication patterns for *any* scenario\n&lt;/aside&gt;\n\n## System Design\n\n### **Architecture: How Workforce Works**\n\nWorkforce uses a **hierarchical, modular design** for real-world team problem-solving.\n![Workforce](/docs/images/workforce.jpg)\n\nSee how the coordinator and task planner agents orchestrate a multi-agent workflow:\n\n- **Workforce:** The “team” as a whole.\n- **Worker nodes:** Individual contributors—each node can contain one or more agents, each with their own capabilities.\n- **Coordinator agent:** The “project manager”—routes tasks to worker nodes based on their role and skills.\n- **Task planner agent:** The “strategy lead”—breaks down big jobs into smaller, doable subtasks and organizes the workflow.\n\n### **Communication: A Shared Task Channel**\n\nEvery Workforce gets a **shared task channel** when it’s created.\n**How it works:**\n- All tasks are posted into this channel.\n- Worker nodes “listen” and accept their assigned tasks.\n- Results are posted back to the channel, where they’re available as dependencies for the next steps.\n\n*This design lets agents build on each other’s work and ensures no knowledge is lost between steps.*",
        "signatures": {},
        "detailedLines": [
          {
            "text": "---",
            "lineNumber": 1
          },
          {
            "text": "title: Workforce",
            "lineNumber": 2
          },
          {
            "text": "description: Understand core concepts and features that power Eigent.",
            "lineNumber": 3
          },
          {
            "text": "icon: cubes",
            "lineNumber": 4
          },
          {
            "text": "---",
            "lineNumber": 5
          },
          {
            "text": "## Concept: What is a Workforce?",
            "lineNumber": 6
          },
          {
            "lineNumber": 7
          },
          {
            "text": "Workforce is CAMEL-AI's multi-agent teamwork engine. ",
            "lineNumber": 8
          },
          {
            "lineNumber": 9
          },
          {
            "text": "Instead of relying on a single agent, Workforce lets you organize a *team* of specialized agents—each with its own strengths—under a single, coordinated system. You can quickly assemble, configure, and launch collaborative agent \"workforces\" for any task that needs parallelization, diverse expertise, or complex workflows.",
            "lineNumber": 10
          },
          {
            "lineNumber": 11
          },
          {
            "text": "With Workforce, agents plan, solve, and verify work together—like a project team in an organization, but fully automated.",
            "lineNumber": 12
          },
          {
            "lineNumber": 13
          },
          {
            "lineNumber": 14
          },
          {
            "text": "&lt;aside&gt;",
            "lineNumber": 15
          },
          {
            "text": "**📌 Key advantages of Workforce:**",
            "lineNumber": 16
          },
          {
            "lineNumber": 17
          },
          {
            "text": "- Instantly scale from single-agent to multi-agent workflows",
            "lineNumber": 18
          },
          {
            "text": "- Built-in coordination, planning, and failure recovery",
            "lineNumber": 19
          },
          {
            "text": "- Ideal for hackathons, evaluations, code review, brainstorming, and more",
            "lineNumber": 20
          },
          {
            "text": "- Configure roles, toolsets, and communication patterns for *any* scenario",
            "lineNumber": 21
          },
          {
            "text": "&lt;/aside&gt;",
            "lineNumber": 22
          },
          {
            "lineNumber": 23
          },
          {
            "text": "## System Design",
            "lineNumber": 24
          },
          {
            "lineNumber": 25
          },
          {
            "text": "### **Architecture: How Workforce Works**",
            "lineNumber": 26
          },
          {
            "lineNumber": 27
          },
          {
            "text": "Workforce uses a **hierarchical, modular design** for real-world team problem-solving.",
            "lineNumber": 28
          },
          {
            "text": "![Workforce](/docs/images/workforce.jpg)",
            "lineNumber": 29
          },
          {
            "lineNumber": 30
          },
          {
            "text": "See how the coordinator and task planner agents orchestrate a multi-agent workflow:",
            "lineNumber": 31
          },
          {
            "lineNumber": 32
          },
          {
            "text": "- **Workforce:** The “team” as a whole.",
            "lineNumber": 33
          },
          {
            "text": "- **Worker nodes:** Individual contributors—each node can contain one or more agents, each with their own capabilities.",
            "lineNumber": 34
          },
          {
            "text": "- **Coordinator agent:** The “project manager”—routes tasks to worker nodes based on their role and skills.",
            "lineNumber": 35
          },
          {
            "text": "- **Task planner agent:** The “strategy lead”—breaks down big jobs into smaller, doable subtasks and organizes the workflow.",
            "lineNumber": 36
          },
          {
            "lineNumber": 37
          },
          {
            "text": "### **Communication: A Shared Task Channel**",
            "lineNumber": 38
          },
          {
            "lineNumber": 39
          },
          {
            "text": "Every Workforce gets a **shared task channel** when it’s created.",
            "lineNumber": 40
          },
          {
            "text": "**How it works:**",
            "lineNumber": 41
          },
          {
            "text": "- All tasks are posted into this channel.",
            "lineNumber": 42
          },
          {
            "text": "- Worker nodes “listen” and accept their assigned tasks.",
            "lineNumber": 43
          },
          {
            "text": "- Results are posted back to the channel, where they’re available as dependencies for the next steps.",
            "lineNumber": 44
          },
          {
            "lineNumber": 45
          },
          {
            "text": "*This design lets agents build on each other’s work and ensures no knowledge is lost between steps.*",
            "lineNumber": 46
          }
        ]
      },
      "score": 0.3479098677635193
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": ".\\backend\\app\\service\\chat_service.py",
        "range": {
          "startPosition": {
            "line": 236
          },
          "endPosition": {
            "line": 1075
          }
        },
        "contents": "@sync_step\n@traceroot.trace()\nasync def step_solve(options: Chat, request: Request, task_lock: TaskLock):\n    # if True:\n    #     import faulthandler\n\n    #     faulthandler.enable()\n    #     for second in [5, 10, 20, 30, 60, 120, 240]:\n    #         faulthandler.dump_traceback_later(second)\n\n            elif item.action == Action.terminal:\n                yield sse_json(\n                    \"terminal\",\n                    {\"output\": item.data, \"process_task_id\": item.process_task_id},\n                )\n            elif item.action == Action.pause:\n                if workforce is not None:\n                    workforce.pause()\n                    logger.info(f\"Workforce paused for project {options.project_id}\")\n                else:\n                    logger.warning(f\"Cannot pause: workforce is None for project {options.project_id}\")\n            elif item.action == Action.resume:\n                if workforce is not None:\n                    workforce.resume()\n                    logger.info(f\"Workforce resumed for project {options.project_id}\")\n                else:\n                    logger.warning(f\"Cannot resume: workforce is None for project {options.project_id}\")\n            elif item.action == Action.decompose_text:\n                yield sse_json(\"decompose_text\", item.data)\n            elif item.action == Action.decompose_progress:\n                yield sse_json(\"to_sub_tasks\", item.data)\n            elif item.action == Action.new_agent:\n                if workforce is not None:\n                    workforce.pause()\n                    workforce.add_single_agent_worker(\n                        format_agent_description(item), await new_agent_model(item, options)\n                    )\n                    workforce.resume()\n            elif item.action == Action.timeout:\n                logger.info(\"=\" * 80)",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 237,
                "column": 1
              },
              "endPosition": {
                "line": 239,
                "column": 1
              }
            },
            {
              "startPosition": {
                "line": 239,
                "column": 1
              },
              "endPosition": {
                "line": 247,
                "column": 5
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "@sync_step",
            "lineNumber": 237
          },
          {
            "text": "@traceroot.trace()",
            "lineNumber": 238
          },
          {
            "text": "async def step_solve(options: Chat, request: Request, task_lock: TaskLock):",
            "lineNumber": 239,
            "isSignature": true
          },
          {
            "text": "    # if True:",
            "lineNumber": 240,
            "isSignature": true
          },
          {
            "text": "    #     import faulthandler",
            "lineNumber": 241,
            "isSignature": true
          },
          {
            "lineNumber": 242,
            "isSignature": true
          },
          {
            "text": "    #     faulthandler.enable()",
            "lineNumber": 243,
            "isSignature": true
          },
          {
            "text": "    #     for second in [5, 10, 20, 30, 60, 120, 240]:",
            "lineNumber": 244,
            "isSignature": true
          },
          {
            "text": "    #         faulthandler.dump_traceback_later(second)",
            "lineNumber": 245,
            "isSignature": true
          },
          {
            "lineNumber": 911
          },
          {
            "text": "            elif item.action == Action.terminal:",
            "lineNumber": 912
          },
          {
            "text": "                yield sse_json(",
            "lineNumber": 913
          },
          {
            "text": "                    \"terminal\",",
            "lineNumber": 914
          },
          {
            "text": "                    {\"output\": item.data, \"process_task_id\": item.process_task_id},",
            "lineNumber": 915
          },
          {
            "text": "                )",
            "lineNumber": 916
          },
          {
            "text": "            elif item.action == Action.pause:",
            "lineNumber": 917
          },
          {
            "text": "                if workforce is not None:",
            "lineNumber": 918
          },
          {
            "text": "                    workforce.pause()",
            "lineNumber": 919
          },
          {
            "text": "                    logger.info(f\"Workforce paused for project {options.project_id}\")",
            "lineNumber": 920
          },
          {
            "text": "                else:",
            "lineNumber": 921
          },
          {
            "text": "                    logger.warning(f\"Cannot pause: workforce is None for project {options.project_id}\")",
            "lineNumber": 922
          },
          {
            "text": "            elif item.action == Action.resume:",
            "lineNumber": 923
          },
          {
            "text": "                if workforce is not None:",
            "lineNumber": 924
          },
          {
            "text": "                    workforce.resume()",
            "lineNumber": 925
          },
          {
            "text": "                    logger.info(f\"Workforce resumed for project {options.project_id}\")",
            "lineNumber": 926
          },
          {
            "text": "                else:",
            "lineNumber": 927
          },
          {
            "text": "                    logger.warning(f\"Cannot resume: workforce is None for project {options.project_id}\")",
            "lineNumber": 928
          },
          {
            "text": "            elif item.action == Action.decompose_text:",
            "lineNumber": 929
          },
          {
            "text": "                yield sse_json(\"decompose_text\", item.data)",
            "lineNumber": 930
          },
          {
            "text": "            elif item.action == Action.decompose_progress:",
            "lineNumber": 931
          },
          {
            "text": "                yield sse_json(\"to_sub_tasks\", item.data)",
            "lineNumber": 932
          },
          {
            "text": "            elif item.action == Action.new_agent:",
            "lineNumber": 933
          },
          {
            "text": "                if workforce is not None:",
            "lineNumber": 934
          },
          {
            "text": "                    workforce.pause()",
            "lineNumber": 935
          },
          {
            "text": "                    workforce.add_single_agent_worker(",
            "lineNumber": 936
          },
          {
            "text": "                        format_agent_description(item), await new_agent_model(item, options)",
            "lineNumber": 937
          },
          {
            "text": "                    )",
            "lineNumber": 938
          },
          {
            "text": "                    workforce.resume()",
            "lineNumber": 939
          },
          {
            "text": "            elif item.action == Action.timeout:",
            "lineNumber": 940
          },
          {
            "text": "                logger.info(\"=\" * 80)",
            "lineNumber": 941
          }
        ]
      },
      "score": 0.3448909521102905
    }
  ]
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: d:\_Code\_GitHub\eigent-260119\backend\app\service\chat_service.py</summary>

</details>
</tool-use>

---


問題：`agent_model` 中 `output_language=options.language` 被註解，導致所有 Agent 未使用用戶選擇的語言。建立修復計畫並開始修復：


---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Error parsing todo list data</summary>

</details>
</tool-use>

---

