# 專案資料載入問題分析與修復方案

## 問題描述

程式重新啟動後，透過下拉選單選擇過去執行過的專案時，只有使用者輸入的 `question` 可以正常呈現，其他執行訊息（如子任務、代理執行狀態、執行結果等）都無法正常呈現。

## 資料儲存與讀取機制分析

### 1. 資料儲存位置

#### 資料庫表結構

1. **`ChatHistory` 表**（`server/app/model/chat/chat_history.py`）
   - 儲存專案基本資訊：
     - `task_id`: 任務 ID
     - `project_id`: 專案 ID
     - `question`: 使用者輸入的問題
     - `project_name`: 專案名稱
     - `summary`: 專案摘要
     - `status`: 任務狀態（ongoing=1, done=2）
     - `tokens`: Token 使用量
     - `created_at`, `updated_at`: 時間戳記

2. **`ChatStep` 表**（`server/app/model/chat/chat_step.py`）
   - 儲存每個執行步驟的詳細資料：
     - `task_id`: 任務 ID（索引欄位）
     - `step`: 步驟類型（如 "to_sub_tasks", "assign_task", "task_state" 等）
     - `data`: 步驟資料（JSON 格式）
     - `timestamp`: 時間戳記
     - `created_at`: 建立時間

#### 資料儲存流程

1. **專案建立時**：
   - 使用者輸入問題後，建立 `ChatHistory` 記錄
   - `task_id` 和 `project_id` 被記錄

2. **任務執行時**：
   - 透過 `sync_step` 裝飾器（`backend/app/utils/server/sync_step.py`）自動儲存每個 SSE 事件
   - 每個步驟（如任務分解、代理分配、任務狀態更新等）都會被儲存到 `ChatStep` 表
   - `task_id` 的確定邏輯：
     ```python
     task_id = task_lock.current_task_id if task_lock.current_task_id else chat.task_id
     ```

### 2. 資料讀取流程

#### 前端讀取流程

1. **專案列表載入**：
   - 前端呼叫 `/api/chat/histories/grouped?include_tasks=true`
   - 後端從 `ChatHistory` 表讀取並分組返回
   - 前端顯示專案列表（包含 `question` 和基本資訊）

2. **選擇歷史專案時**：
   - 使用者點擊專案，觸發 `replayProject`（`src/lib/replay.ts`）
   - `replayProject` 呼叫 `projectStore.replayProject`（`src/store/projectStore.ts`）
   - `projectStore.replayProject` 為每個 `taskId` 建立 chatStore 並呼叫 `chatStore.replay`

3. **Replay 執行**：
   - `chatStore.replay`（`src/store/chatStore.ts:1890`）：
     - 接收 `taskId`（歷史任務 ID）、`question`、`delay`
     - 呼叫 `create(taskId, "replay")` 建立新任務
     - 呼叫 `startTask(taskId, "replay", ...)`
   - `startTask`（`src/store/chatStore.ts:331`）：
     - 當 `type === "replay"` 時，構建 API URL：
       ```typescript
       `${base_Url}/api/chat/steps/playback/${newTaskId}?delay_time=${delayTime}`
       ```
     - 連接到 SSE 端點並接收 `ChatStep` 資料
     - 處理每個步驟並更新 UI

#### 後端 Playback API

- 端點：`/api/chat/steps/playback/{task_id}`（`server/app/controller/chat/step_controller.py:37`）
- 功能：從 `ChatStep` 表查詢指定 `task_id` 的所有步驟，透過 SSE 串流返回

## 問題診斷

### 核心問題：ChatStep 表為空

**問題根源**：

1. **`ChatStep` 表是空的**：
   - 檢查發現 `ChatStep` 資料表目前沒有任何資料
   - 但 `chat_snapshot` 表有 65 筆資料（這些是瀏覽器截圖，不是執行步驟）

2. **`sync_step` 裝飾器未執行**：
   - `sync_step` 裝飾器（`backend/app/utils/server/sync_step.py`）需要 `SERVER_URL` 環境變數才能運作
   - 如果 `SERVER_URL` 未設定，會跳過儲存步驟（第19-21行）：
     ```python
     if not server_url:
         yield value
         continue  # 跳過儲存
     ```
   - 這導致所有執行步驟都沒有被儲存到 `ChatStep` 表

3. **Replay 功能依賴 `ChatStep` 表**：
   - Replay 功能透過 `/api/chat/steps/playback/{task_id}` 端點讀取 `ChatStep` 表的資料
   - 因為表是空的，所以無法載入任何執行步驟
   - 結果：只有 `question`（來自 `ChatHistory`）能顯示，其他執行訊息都無法顯示

### 次要問題：task_id 不匹配（已修復）

1. **`ProjectGroup.tsx` 使用了錯誤的 `taskId`**：
   - 原本使用 `project.project_id` 作為 `taskId`
   - 已修復為使用 `task.task_id`（正確的任務 ID）

2. **`chat_snapshot` 與 `ChatStep` 的區別**：
   - `chat_snapshot`：儲存瀏覽器截圖（`browser_url`, `image_path`），用於顯示瀏覽器操作畫面
   - `ChatStep`：儲存執行步驟（`step`, `data`），用於 replay 完整執行過程
   - 兩者用途不同，無法互相替代

## 修復方案

### 方案 1：設定 SERVER_URL 環境變數（優先且必要）

**問題**：`ChatStep` 表為空，因為 `sync_step` 需要 `SERVER_URL` 才能儲存資料

**修復步驟**：

1. **確認 `SERVER_URL` 環境變數**：
   - 檢查 `~/.eigent/.env` 或環境變數設定
   - 確認 `SERVER_URL` 是否已設定

2. **設定 `SERVER_URL`**：
   - **Cloud-Connected 模式**：預設為 `https://dev.eigent.ai/api`（由 Electron 設定）
   - **Local Deployment 模式**：設定為 `http://localhost:3001`（Local Server URL）
   - 在 `~/.eigent/.env` 中添加：
     ```env
     SERVER_URL=http://localhost:3001
     ```

3. **驗證設定**：
   - 重新啟動程式
   - 執行一個新任務
   - 檢查 `ChatStep` 表是否有新資料被儲存
   - 檢查後端日誌，確認 `sync_step` 正常運作

**注意**：此修復只能解決**未來的任務**，無法恢復已經丟失的歷史資料。

### 方案 2：修正 task_id 匹配邏輯（已完成）

**問題**：`replayProject` 使用了錯誤的 `taskId`

**修復狀態**：✅ 已完成

**修復內容**：
- 已修復 `src/components/GroupedHistoryView/ProjectGroup.tsx`
- 使用 `task.task_id` 而不是 `project.project_id` 作為 replay 的 `taskId`

### 方案 3：改進錯誤處理與使用者提示

**問題**：當 `ChatStep` 表為空時，使用者無法知道為什麼無法 replay

**修復步驟**：

1. **後端改進**：
   - 在 `/api/chat/steps/playback/{task_id}` 端點中
   - 當查詢不到資料時，返回更詳細的錯誤訊息
   - 提示可能是 `SERVER_URL` 未設定導致資料未儲存

2. **前端改進**：
   - 當 replay 失敗時，顯示明確的錯誤訊息
   - 提示使用者檢查 `SERVER_URL` 設定
   - 說明歷史資料可能無法恢復，但未來的任務會正常儲存

### 方案 4：添加日誌與監控

**問題**：無法追蹤 `sync_step` 是否正常運作

**修復步驟**：

1. **添加日誌**：
   - 在 `sync_step.py` 中添加更詳細的日誌
   - 記錄 `SERVER_URL` 是否設定
   - 記錄每次儲存嘗試的結果（成功/失敗）
   - 記錄 `task_id` 和 `step` 類型

2. **驗證儲存**：
   - 在任務執行後，查詢 `ChatStep` 表確認資料已儲存
   - 添加健康檢查端點，報告 `ChatStep` 儲存狀態

## 實施建議

### 優先順序

1. **立即修復**：方案 1（設定 `SERVER_URL` 環境變數）- **必須執行**
2. **已完成**：方案 2（修正 task_id 匹配邏輯）- ✅ 已完成
3. **短期改進**：方案 3（改進錯誤處理與使用者提示）
4. **長期優化**：方案 4（添加日誌與監控）

### 驗證步驟

1. **環境變數檢查**：
   - 確認 `SERVER_URL` 環境變數已設定
   - 檢查 `~/.eigent/.env` 檔案
   - 確認後端可以連接到 Server API

2. **資料驗證**：
   - 執行一個新任務
   - 檢查資料庫中 `ChatStep` 表是否有新資料被儲存
   - 確認 `task_id` 與 `ChatHistory.task_id` 一致

3. **功能測試**：
   - 建立新專案並執行任務
   - 重新啟動程式
   - 選擇**新建立的專案**並驗證所有資訊都能正常呈現
   - **注意**：舊的歷史專案（在設定 `SERVER_URL` 之前建立的）可能無法正常 replay

4. **日誌檢查**：
   - 檢查後端日誌，確認 `sync_step` 正常運作
   - 確認 `ChatStep` 儲存成功
   - 檢查前端日誌，確認 replay 使用的 `task_id` 正確

## 預期結果

修復後，選擇歷史專案時應該能夠正常呈現：
- ✅ 使用者輸入的 `question`
- ✅ 任務分解結果（子任務列表）
- ✅ 代理分配資訊
- ✅ 任務執行狀態
- ✅ 任務執行結果
- ✅ 其他執行過程中的訊息
